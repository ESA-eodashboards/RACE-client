const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/raw.DxtaBMev.js","assets/chunks/basedecoder.B2c5_Eok.js","assets/chunks/lzw.BikwkTY2.js","assets/chunks/jpeg.CbvpOiPg.js","assets/chunks/deflate.B4_27dB1.js","assets/chunks/pako.esm.BkaqWuDM.js","assets/chunks/packbits.D6Qr5eNi.js","assets/chunks/lerc.zdXlyJRY.js","assets/chunks/commonjsHelpers.Cpj98o6Y.js","assets/chunks/WMTS.DiEl4CxN.js","assets/chunks/framework.67QTkEGu.js","assets/chunks/item.BmAbL_Ub.js","assets/chunks/webimage.CU41Mh7j.js"])))=>i.map(i=>d[i]);
var Eu=Object.defineProperty;var xu=(i,e,t)=>e in i?Eu(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Q=(i,e,t)=>xu(i,typeof e!="symbol"?e+"":e,t);import{bA as bu,aq as je,aR as se,bB as Tu,bC as Ie,bD as wu,bE as Su,aZ as Ai,bF as Bn,aw as Jr,av as xr,au as tn,o as Ht,as as pt,ar as Qe,bG as rn,bH as z,bI as U,bJ as F,bK as fs,bL as Li,bM as Ru,bN as vu,bO as Ct,bP as Ii,ac as tl,bQ as X,bR as b,bS as q,bT as de,bU as Ze,bV as br,bW as Lt,bX as $r,bY as rl,bZ as Ci,b_ as Fi,b$ as M,c0 as x,c1 as C,c2 as nn,c3 as xe,c4 as Ue,c5 as ds,c6 as il,c7 as Mi,c8 as kt,c9 as Pu,ca as nl,w as _t,k as et,cb as ce,at as Au,cc as Lu,ay as Mt,ab as Co,cd as Iu,ce as it,cf as dt,ah as gs,aO as Cu,aN as Fu,cg as Oi,ch as Mu,ci as jr,cj as Ou,ck as Nu,an as sl,bk as Ni,cl as Fo,bj as Si,cm as Mo,bz as Di,J as jt,ao as sn,h as Du,cn as Uu,co as Gu,cp as gt,a5 as Vr,a4 as on,cq as Ft,cr as Ri,ad as gr,A as Me,q as Ee,cs as pr,ct as cr,cu as Bu,a2 as he,D as ol,N as Fe,x as ps,cv as zu,e as ku,cw as $u,cx as zn,R as Tn,bh as Qr,y as Xr,l as Et,aC as It,$ as Ot,K as an,aH as ms,Y as Tt,cy as _s,u as Ui,T as ju,E as Be,cz as K,cA as ys,cB as nt,cC as Vu,cD as Es,cE as kn,cF as $n,cG as Nt,cH as Xu,cI as jn,cJ as Wu,cK as Hu,cL as sr,cM as Zu,cN as Oo,cO as Yu,cP as qu,aF as al,cQ as Wr,cR as Ku,cS as Ju,cT as fe,cU as xs,cV as Hr,cW as $e,cX as Dt,cY as Tr,cZ as Qu,c_ as H,c$ as ll,d0 as Vt,d1 as eh,d2 as th,bs as cl,d3 as st,d4 as rh,d5 as ih,d6 as ul,d7 as hl,aa as bs,d8 as nh,bf as sh,d9 as oh,da as fl,db as ah,dc as lh,dd as ch,B as dl,de as uh,bg as hh,al as Vn,bi as No,df as fh,dg as dh,dh as gh,di as ph,dj as mh,bc as Ts,bm as qt,dk as Kt,dl as _h,dm as yh,t as Eh,dn as wn,dp as Zr,dq as ln,dr as xh,aG as bh,X as Th,ds as Do,dt as Uo,b4 as wr,a_ as Jt,a$ as ws,du as St,bv as Ss,dv as gl,dw as wh,dx as Sh,aS as Rh,ba as Rs,be as vh,a9 as Ph,aU as Xn,b7 as pl,b8 as Gi,b9 as Ah,dy as ml,bb as Lh,b5 as Ih,b6 as Wn,aM as _l,aQ as Ch,aP as Fh,dz as vs,dA as Go,ai as Mh,ak as Oh,dB as Hn,dC as yl,dD as Bo,dE as zo,dF as Bi,dG as El,dH as Nh,dI as xl,Q as Dh,dJ as Ps,dK as Uh,dL as Gh,dM as Bh,dN as zh,dO as kh,dP as $h,bu as jh,aD as Vh,dQ as Xh,s as Wh,dR as Hh,dS as Zh}from"./WMTS.DiEl4CxN.js";import{g as bl}from"./commonjsHelpers.Cpj98o6Y.js";import{a1 as Gt}from"./framework.67QTkEGu.js";import{S as Yh,a as qh,u as As,b as Tl,C as wl,I as Ls,M as Kh,A as di,c as Fr,d as Jh,f as Qh,g as ko,i as $o}from"./item.BmAbL_Ub.js";class Is extends Yh{constructor(e,t=null,r={},n=[]){super(e,t,r,n)}getAll(){return[]}}class ef extends qh{constructor(e,t=null){super(e,t)}}class tf extends Is{constructor(e,t=null){const r={collections:n=>n.map(s=>new wl(s))};super(e,t,r)}getObjectType(){return"CollectionCollection"}getAll(){return this.collections}isCollectionCollection(){return!0}toGeoJSON(){return{type:"FeatureCollection",features:this.collections.map(t=>t.toGeoJSON()).filter(t=>t!==null)}}getBoundingBox(){return As(this.getBoundingBoxes())}getBoundingBoxes(){return this.collections.map(e=>e.getBoundingBox())}getTemporalExtent(){return Tl(this.getTemporalExtents())}getTemporalExtents(){return this.collections.map(e=>e.getTemporalExtent())}}class Sl extends Is{constructor(e,t=null){const r={features:n=>n.map(s=>new Ls(s))};super(e,t,r)}getObjectType(){return"ItemCollection"}getAll(){return this.features}toGeoJSON(){return this.toJSON()}getBoundingBox(){return As(this.getBoundingBoxes())}getBoundingBoxes(){return this.features.map(e=>e.getBoundingBox())}getTemporalExtent(){return Tl(this.getTemporalExtents())}getTemporalExtents(){return this.features.map(e=>e.getTemporalExtent())}}function gi(i,e=!0,t=!1){return e&&(i=Kh.stac(i,t)),i.type==="Feature"?new Ls(i):i.type==="FeatureCollection"?new Sl(i):i.type==="Collection"||!i.type&&typeof i.extent<"u"&&typeof i.license<"u"?new wl(i):!i.type&&Array.isArray(i.collections)?new tf(i):new ef(i)}const rf={Point:af,LineString:lf,Polygon:ff,MultiPoint:uf,MultiLineString:cf,MultiPolygon:hf},nf={Point:df,LineString:gf,Polygon:pf,MultiPoint:_f,MultiLineString:mf,MultiPolygon:yf};class sf extends bu{constructor(e){e=e||{},super(),this.geometryName_=e.geometryName}readFeatureFromObject(e,t,r){const n=e,s=jo(n.geometry,t),o=new je;if(this.geometryName_&&o.setGeometryName(this.geometryName_),o.setGeometry(s),n.attributes){o.setProperties(n.attributes,!0);const a=n.attributes[r];a!==void 0&&o.setId(a)}return o}readFeaturesFromObject(e,t){if(t=t||{},e.features){const r=e,n=[],s=r.features;for(let o=0,a=s.length;o<a;++o)n.push(this.readFeatureFromObject(s[o],t,e.objectIdFieldName));return n}return[this.readFeatureFromObject(e,t)]}readGeometryFromObject(e,t){return jo(e,t)}readProjectionFromObject(e){if(e.spatialReference&&e.spatialReference.wkid!==void 0){const r=e.spatialReference.wkid;return se("EPSG:"+r)}return null}writeGeometryObject(e,t){return Vo(e,this.adaptOptions(t))}writeFeatureObject(e,t){t=this.adaptOptions(t);const r={};if(!e.hasProperties())return r.attributes={},r;const n=e.getProperties(),s=e.getGeometry();if(s){r.geometry=Vo(s,t);const o=t&&(t.dataProjection||t.featureProjection);o&&(r.geometry.spatialReference={wkid:Number(se(o).getCode().split(":").pop())}),delete n[e.getGeometryName()]}return Tu(n)?r.attributes={}:r.attributes=n,r}writeFeaturesObject(e,t){t=this.adaptOptions(t);const r=[];for(let n=0,s=e.length;n<s;++n)r.push(this.writeFeatureObject(e[n],t));return{features:r}}}function jo(i,e){if(!i)return null;let t;if(typeof i.x=="number"&&typeof i.y=="number")t="Point";else if(i.points)t="MultiPoint";else if(i.paths)i.paths.length===1?t="LineString":t="MultiLineString";else if(i.rings){const n=i,s=Sr(n),o=of(n.rings,s);o.length===1?(t="Polygon",i=Object.assign({},i,{rings:o[0]})):(t="MultiPolygon",i=Object.assign({},i,{rings:o}))}const r=rf[t];return Ie(r(i),!1,e)}function of(i,e){const t=[],r=[],n=[];let s,o;for(s=0,o=i.length;s<o;++s)t.length=0,wu(t,0,i[s],e.length),Su(t,0,t.length,e.length)?r.push([i[s]]):n.push(i[s]);for(;n.length;){const a=n.shift();let c=!1;for(s=r.length-1;s>=0;s--){const l=r[s][0];if(Ai(new Bn(l).getExtent(),new Bn(a).getExtent())){r[s].push(a),c=!0;break}}c||r.push([a.reverse()])}return r}function af(i){let e;return i.m!==void 0&&i.z!==void 0?e=new Qe([i.x,i.y,i.z,i.m],"XYZM"):i.z!==void 0?e=new Qe([i.x,i.y,i.z],"XYZ"):i.m!==void 0?e=new Qe([i.x,i.y,i.m],"XYM"):e=new Qe([i.x,i.y]),e}function lf(i){const e=Sr(i);return new pt(i.paths[0],e)}function cf(i){const e=Sr(i);return new xr(i.paths,e)}function Sr(i){let e="XY";return i.hasZ===!0&&i.hasM===!0?e="XYZM":i.hasZ===!0?e="XYZ":i.hasM===!0&&(e="XYM"),e}function uf(i){const e=Sr(i);return new tn(i.points,e)}function hf(i){const e=Sr(i);return new Jr(i.rings,e)}function ff(i){const e=Sr(i);return new Ht(i.rings,e)}function df(i,e){const t=i.getCoordinates();let r;const n=i.getLayout();if(n==="XYZ")r={x:t[0],y:t[1],z:t[2]};else if(n==="XYM")r={x:t[0],y:t[1],m:t[2]};else if(n==="XYZM")r={x:t[0],y:t[1],z:t[2],m:t[3]};else if(n==="XY")r={x:t[0],y:t[1]};else throw new Error("Invalid geometry layout");return r}function ei(i){const e=i.getLayout();return{hasZ:e==="XYZ"||e==="XYZM",hasM:e==="XYM"||e==="XYZM"}}function gf(i,e){const t=ei(i);return{hasZ:t.hasZ,hasM:t.hasM,paths:[i.getCoordinates()]}}function pf(i,e){const t=ei(i);return{hasZ:t.hasZ,hasM:t.hasM,rings:i.getCoordinates(!1)}}function mf(i,e){const t=ei(i);return{hasZ:t.hasZ,hasM:t.hasM,paths:i.getCoordinates()}}function _f(i,e){const t=ei(i);return{hasZ:t.hasZ,hasM:t.hasM,points:i.getCoordinates()}}function yf(i,e){const t=ei(i),r=i.getCoordinates(!1),n=[];for(let s=0;s<r.length;s++)for(let o=r[s].length-1;o>=0;o--)n.push(r[s][o]);return{hasZ:t.hasZ,hasM:t.hasM,rings:n}}function Vo(i,e){const t=nf[i.getType()];return t(Ie(i,!0,e),e)}const bt="http://www.opengis.net/gml",Ef=/^\s*$/;class D extends rn{constructor(e){super(),e=e||{},this.featureType=e.featureType,this.featureNS=e.featureNS,this.srsName=e.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:U(this.readFeaturesInternal),featureMembers:z(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(e,t){const r=e.localName;let n=null;if(r=="FeatureCollection")n=F([],this.FEATURE_COLLECTION_PARSERS,e,t,this);else if(r=="featureMembers"||r=="featureMember"||r=="member"){const s=t[0];let o=s.featureType,a=s.featureNS;const c="p",l="p0";if(!o&&e.childNodes){o=[],a={};for(let f=0,d=e.childNodes.length;f<d;++f){const g=e.childNodes[f];if(g.nodeType===1){const p=g.nodeName.split(":").pop();if(!o.includes(p)){let m="",y=0;const _=g.namespaceURI;for(const E in a){if(a[E]===_){m=E;break}++y}m||(m=c+y,a[m]=_),o.push(m+":"+p)}}}r!="featureMember"&&(s.featureType=o,s.featureNS=a)}if(typeof a=="string"){const f=a;a={},a[l]=f}const u={},h=Array.isArray(o)?o:[o];for(const f in a){const d={};for(let g=0,p=h.length;g<p;++g)(h[g].includes(":")?h[g].split(":")[0]:l)===f&&(d[h[g].split(":").pop()]=r=="featureMembers"?U(this.readFeatureElement,this):z(this.readFeatureElement,this));u[a[f]]=d}r=="featureMember"||r=="member"?n=F(void 0,u,e,t):n=F([],u,e,t)}return n===null&&(n=[]),n}readGeometryOrExtent(e,t){const r=t[0];return r.srsName=e.firstElementChild.getAttribute("srsName"),r.srsDimension=e.firstElementChild.getAttribute("srsDimension"),F(null,this.GEOMETRY_PARSERS,e,t,this)}readExtentElement(e,t){const r=t[0],n=this.readGeometryOrExtent(e,t);return n?fs(n,r):void 0}readGeometryElement(e,t){const r=t[0],n=this.readGeometryOrExtent(e,t);return n?Ie(n,!1,r):void 0}readFeatureElementInternal(e,t,r){let n;const s={};for(let c=e.firstElementChild;c;c=c.nextElementSibling){let l;const u=c.localName;c.childNodes.length===0||c.childNodes.length===1&&(c.firstChild.nodeType===3||c.firstChild.nodeType===4)?(l=Li(c,!1),Ef.test(l)&&(l=void 0)):(r&&(l=u==="boundedBy"?this.readExtentElement(c,t):this.readGeometryElement(c,t)),l?u!=="boundedBy"&&(n=u):l=this.readFeatureElementInternal(c,t,!1));const h=c.attributes.length;if(h>0&&!(l instanceof Ru)){l={_content_:l};for(let f=0;f<h;f++){const d=c.attributes[f].name;l[d]=c.attributes[f].value}}s[u]?(s[u]instanceof Array||(s[u]=[s[u]]),s[u].push(l)):s[u]=l}if(!r)return s;const o=new je(s);n&&o.setGeometryName(n);const a=e.getAttribute("fid")||vu(e,this.namespace,"id");return a&&o.setId(a),o}readFeatureElement(e,t){return this.readFeatureElementInternal(e,t,!0)}readPoint(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Qe(r,"XYZ")}readMultiPoint(e,t){const r=F([],this.MULTIPOINT_PARSERS,e,t,this);if(r)return new tn(r)}readMultiLineString(e,t){const r=F([],this.MULTILINESTRING_PARSERS,e,t,this);if(r)return new xr(r)}readMultiPolygon(e,t){const r=F([],this.MULTIPOLYGON_PARSERS,e,t,this);if(r)return new Jr(r)}pointMemberParser(e,t){Ct(this.POINTMEMBER_PARSERS,e,t,this)}lineStringMemberParser(e,t){Ct(this.LINESTRINGMEMBER_PARSERS,e,t,this)}polygonMemberParser(e,t){Ct(this.POLYGONMEMBER_PARSERS,e,t,this)}readLineString(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new pt(r,"XYZ")}readFlatLinearRing(e,t){const r=F(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(r)return r}readLinearRing(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Bn(r,"XYZ")}readPolygon(e,t){const r=F([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(r&&r[0]){const n=r[0],s=[n.length];let o,a;for(o=1,a=r.length;o<a;++o)Ii(n,r[o]),s.push(n.length);return new Ht(n,"XYZ",s)}}readFlatCoordinatesFromNode(e,t){return F(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}readGeometryFromNode(e,t){const r=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return r||null}readFeaturesFromNode(e,t){const r={featureType:this.featureType,featureNS:this.featureNS};return r&&Object.assign(r,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[r])||[]}readProjectionFromNode(e){return se(this.srsName?this.srsName:e.firstElementChild.getAttribute("srsName"))}}D.prototype.namespace=bt;D.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}};D.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}};D.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}};D.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:U(D.prototype.pointMemberParser),pointMembers:U(D.prototype.pointMemberParser)}};D.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:U(D.prototype.lineStringMemberParser),lineStringMembers:U(D.prototype.lineStringMemberParser)}};D.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:U(D.prototype.polygonMemberParser),polygonMembers:U(D.prototype.polygonMemberParser)}};D.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:U(D.prototype.readFlatCoordinatesFromNode)}};D.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:U(D.prototype.readLineString)}};D.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:U(D.prototype.readPolygon)}};D.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:z(D.prototype.readFlatLinearRing)}};const xf=bt+" http://schemas.opengis.net/gml/2.1.2/feature.xsd",bf={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class Y extends D{constructor(e){e=e||{},super(e),this.FEATURE_COLLECTION_PARSERS[bt].featureMember=U(this.readFeaturesInternal),this.schemaLocation=e.schemaLocation?e.schemaLocation:xf}readFlatCoordinates(e,t){const r=Li(e,!1).replace(/^\s*|\s*$/g,""),s=t[0].srsName;let o="enu";if(s){const l=se(s);l&&(o=l.getAxisOrientation())}const a=r.trim().split(/\s+/),c=[];for(let l=0,u=a.length;l<u;l++){const h=a[l].split(/,+/),f=parseFloat(h[0]),d=parseFloat(h[1]),g=h.length===3?parseFloat(h[2]):0;o.startsWith("en")?c.push(f,d,g):c.push(d,f,g)}return c}readBox(e,t){const r=F([null],this.BOX_PARSERS_,e,t,this);return tl(r[1][0],r[1][1],r[1][3],r[1][4])}innerBoundaryIsParser(e,t){const r=F(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}outerBoundaryIsParser(e,t){const r=F(void 0,this.RING_PARSERS,e,t,this);if(r){const n=t[t.length-1];n[0]=r}}GEOMETRY_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="MultiLineString"&&a===!0&&(r="MultiCurve")),X("http://www.opengis.net/gml",r)}writeFeatureElement(e,t,r){const n=t.getId();n&&e.setAttribute("fid",n);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const c=[],l=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const d=h[f];d!=null&&(c.push(f),l.push(d),f==a||typeof d.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=b(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=b(q)))}}const u=Object.assign({},s);u.node=e,de(u,s.serializers,Ze(void 0,o),l,r,c)}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}else if(e.nodeName==="Curve"){const o=X(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeLineStringOrCurveMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,r))}writeMultiCurveOrLineString(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const c=t.getLineStrings();de({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,c,r,void 0,this)}writeGeometryElement(e,t,r){const n=r[r.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=fs(t,n):o=Ie(t,!0,n),de(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}createCoordinatesNode_(e){const t=X(e,"coordinates");return t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," "),t}writeCoordinates_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=t.getCoordinates(),c=a.length,l=new Array(c);for(let u=0;u<c;++u){const h=a[u];l[u]=this.getCoords_(h,o,s)}q(e,l.join(" "))}writeCurveSegments_(e,t,r){const n=X(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,r)}writeSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();de({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=X(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}RING_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),X(s.namespaceURI,o!==void 0?"innerBoundaryIs":"outerBoundaryIs")}writeSurfacePatches_(e,t,r){const n=X(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r)}writeRing(e,t,r){const n=X(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,r)}getCoords_(e,t,r){let s=(t?se(t).getAxisOrientation():"enu").startsWith("en")?e[0]+","+e[1]:e[1]+","+e[0];if(r){const o=e[2]||0;s+=","+o}return s}writePoint(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(a);const c=t.getCoordinates(),l=this.getCoords_(c,o,s);q(a,l)}writeMultiPoint(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=t.getPoints();de({node:e,hasZ:s,srsName:o},this.POINTMEMBER_SERIALIZERS,Ze("pointMember"),a,r,void 0,this)}writePointMember(e,t,r){const n=X(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,r)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}writeMultiSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const c=t.getPolygons();de({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,c,r,void 0,this)}writeSurfaceOrPolygonMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r))}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];de({node:e},this.ENVELOPE_SERIALIZERS,br,a,r,o,this)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const n=t[t.length-1].node;return X("http://www.opengis.net/gml",bf[n.nodeName])}}Y.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{coordinates:z(Y.prototype.readFlatCoordinates)}};Y.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{innerBoundaryIs:Y.prototype.innerBoundaryIsParser,outerBoundaryIs:Y.prototype.outerBoundaryIsParser}};Y.prototype.BOX_PARSERS_={"http://www.opengis.net/gml":{coordinates:U(Y.prototype.readFlatCoordinates)}};Y.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:z(D.prototype.readPoint),MultiPoint:z(D.prototype.readMultiPoint),LineString:z(D.prototype.readLineString),MultiLineString:z(D.prototype.readMultiLineString),LinearRing:z(D.prototype.readLinearRing),Polygon:z(D.prototype.readPolygon),MultiPolygon:z(D.prototype.readMultiPolygon),Box:z(Y.prototype.readBox)}};Y.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:b(Y.prototype.writeCurveOrLineString),MultiCurve:b(Y.prototype.writeMultiCurveOrLineString),Point:b(Y.prototype.writePoint),MultiPoint:b(Y.prototype.writeMultiPoint),LineString:b(Y.prototype.writeCurveOrLineString),MultiLineString:b(Y.prototype.writeMultiCurveOrLineString),LinearRing:b(Y.prototype.writeLinearRing),Polygon:b(Y.prototype.writeSurfaceOrPolygon),MultiPolygon:b(Y.prototype.writeMultiSurfaceOrPolygon),Surface:b(Y.prototype.writeSurfaceOrPolygon),MultiSurface:b(Y.prototype.writeMultiSurfaceOrPolygon),Envelope:b(Y.prototype.writeEnvelope)}};Y.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:b(Y.prototype.writeLineStringOrCurveMember),curveMember:b(Y.prototype.writeLineStringOrCurveMember)}};Y.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{outerBoundaryIs:b(Y.prototype.writeRing),innerBoundaryIs:b(Y.prototype.writeRing)}};Y.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:b(Y.prototype.writePointMember)}};Y.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:b(Y.prototype.writeSurfaceOrPolygonMember),polygonMember:b(Y.prototype.writeSurfaceOrPolygonMember)}};Y.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:b(q),upperCorner:b(q)}};const Tf=bt+" http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",wf={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class P extends D{constructor(e){e=e||{},super(e),this.surface_=e.surface!==void 0?e.surface:!1,this.curve_=e.curve!==void 0?e.curve:!1,this.multiCurve_=e.multiCurve!==void 0?e.multiCurve:!0,this.multiSurface_=e.multiSurface!==void 0?e.multiSurface:!0,this.schemaLocation=e.schemaLocation?e.schemaLocation:Tf,this.hasZ=e.hasZ!==void 0?e.hasZ:!1}readMultiCurve(e,t){const r=F([],this.MULTICURVE_PARSERS,e,t,this);if(r)return new xr(r)}readFlatCurveRing(e,t){const r=F([],this.MULTICURVE_PARSERS,e,t,this),n=[];for(let s=0,o=r.length;s<o;++s)Ii(n,r[s].getFlatCoordinates());return n}readMultiSurface(e,t){const r=F([],this.MULTISURFACE_PARSERS,e,t,this);if(r)return new Jr(r)}curveMemberParser(e,t){Ct(this.CURVEMEMBER_PARSERS,e,t,this)}surfaceMemberParser(e,t){Ct(this.SURFACEMEMBER_PARSERS,e,t,this)}readPatch(e,t){return F([null],this.PATCHES_PARSERS,e,t,this)}readSegment(e,t){return F([],this.SEGMENTS_PARSERS,e,t,this)}readPolygonPatch(e,t){return F([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this)}readLineStringSegment(e,t){return F([null],this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}interiorParser(e,t){const r=F(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}exteriorParser(e,t){const r=F(void 0,this.RING_PARSERS,e,t,this);if(r){const n=t[t.length-1];n[0]=r}}readSurface(e,t){const r=F([null],this.SURFACE_PARSERS,e,t,this);if(r&&r[0]){const n=r[0],s=[n.length];let o,a;for(o=1,a=r.length;o<a;++o)Ii(n,r[o]),s.push(n.length);return new Ht(n,"XYZ",s)}}readCurve(e,t){const r=F([null],this.CURVE_PARSERS,e,t,this);if(r)return new pt(r,"XYZ")}readEnvelope(e,t){const r=F([null],this.ENVELOPE_PARSERS,e,t,this);return tl(r[1][0],r[1][1],r[2][0],r[2][1])}readFlatPos(e,t){let r=Li(e,!1);const n=/^\s*([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)\s*/,s=[];let o;for(;o=n.exec(r);)s.push(parseFloat(o[1])),r=r.substr(o[0].length);if(r!=="")return;const c=t[0].srsName;if((c?se(c).getAxisOrientation():"enu")==="neu")for(let h=0,f=s.length;h<f;h+=3){const d=s[h],g=s[h+1];s[h]=g,s[h+1]=d}const u=s.length;if(u==2&&s.push(0),u!==0)return s}readFlatPosList(e,t){const r=Li(e,!1).replace(/^\s*|\s*$/g,""),n=t[0],s=n.srsName,o=n.srsDimension,a=s?se(s).getAxisOrientation():"enu",c=r.split(/\s+/);let l=2;e.getAttribute("srsDimension")?l=Lt(e.getAttribute("srsDimension")):e.getAttribute("dimension")?l=Lt(e.getAttribute("dimension")):e.parentNode.getAttribute("srsDimension")?l=Lt(e.parentNode.getAttribute("srsDimension")):o&&(l=Lt(o));const u=a.startsWith("en");let h,f,d;const g=[];for(let p=0,m=c.length;p<m;p+=l)h=parseFloat(c[p]),f=parseFloat(c[p+1]),d=l===3?parseFloat(c[p+2]):0,u?g.push(h,f,d):g.push(f,h,d);return g}writePos_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,c=a?se(a).getAxisOrientation():"enu",l=t.getCoordinates();let u=c.startsWith("en")?l[0]+" "+l[1]:l[1]+" "+l[0];if(s){const h=l[2]||0;u+=" "+h}q(e,u)}getCoords_(e,t,r){let s=(t?se(t).getAxisOrientation():"enu").startsWith("en")?e[0]+" "+e[1]:e[1]+" "+e[0];if(r){const o=e[2]||0;s+=" "+o}return s}writePosList_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,c=t.getCoordinates(),l=c.length,u=new Array(l);let h;for(let f=0;f<l;++f)h=c[f],u[f]=this.getCoords_(h,a,s);q(e,u.join(" "))}writePoint(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=X(e.namespaceURI,"pos");e.appendChild(o),this.writePos_(o,t,r)}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];de({node:e},this.ENVELOPE_SERIALIZERS,br,a,r,o,this)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=X(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}RING_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),X(s.namespaceURI,o!==void 0?"interior":"exterior")}writeSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();de({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=X(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=X(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}else if(e.nodeName==="Curve"){const o=X(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeMultiSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const c=t.getPolygons();de({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,c,r,void 0,this)}writeMultiPoint(e,t,r){const n=r[r.length-1],s=n.srsName,o=n.hasZ;s&&e.setAttribute("srsName",s);const a=t.getPoints();de({node:e,hasZ:o,srsName:s},this.POINTMEMBER_SERIALIZERS,Ze("pointMember"),a,r,void 0,this)}writeMultiCurveOrLineString(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const c=t.getLineStrings();de({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,c,r,void 0,this)}writeRing(e,t,r){const n=X(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,r)}writeSurfaceOrPolygonMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r))}writePointMember(e,t,r){const n=X(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,r)}writeLineStringOrCurveMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,r))}writeSurfacePatches_(e,t,r){const n=X(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r)}writeCurveSegments_(e,t,r){const n=X(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,r)}writeGeometryElement(e,t,r){const n=r[r.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=fs(t,n):o=Ie(t,!0,n),de(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}writeFeatureElement(e,t,r){const n=t.getId();n&&e.setAttribute("fid",n);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const c=[],l=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const d=h[f];d!=null&&(c.push(f),l.push(d),f==a||typeof d.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=b(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=b(q)))}}const u=Object.assign({},s);u.node=e,de(u,s.serializers,Ze(void 0,o),l,r,c)}writeFeatureMembers_(e,t,r){const n=r[r.length-1],s=n.featureType,o=n.featureNS,a={};a[o]={},a[o][s]=b(this.writeFeatureElement,this);const c=Object.assign({},n);c.node=e,de(c,a,Ze(s,o),t,r)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const n=t[t.length-1].node;return X(this.namespace,wf[n.nodeName])}GEOMETRY_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.curve,c=n.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="LineString"&&a===!0?r="Curve":r==="MultiLineString"&&c===!0&&(r="MultiCurve")),X(this.namespace,r)}writeGeometryNode(e,t){t=this.adaptOptions(t);const r=X(this.namespace,"geom"),n={node:r,hasZ:this.hasZ,srsName:this.srsName,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_};return t&&Object.assign(n,t),this.writeGeometryElement(r,e,[n]),r}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=X(this.namespace,"featureMembers");r.setAttributeNS($r,"xsi:schemaLocation",this.schemaLocation);const n={srsName:this.srsName,hasZ:this.hasZ,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_,featureNS:this.featureNS,featureType:this.featureType};return t&&Object.assign(n,t),this.writeFeatureMembers_(r,e,[n]),r}}P.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{pos:z(P.prototype.readFlatPos),posList:z(P.prototype.readFlatPosList),coordinates:z(Y.prototype.readFlatCoordinates)}};P.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{interior:P.prototype.interiorParser,exterior:P.prototype.exteriorParser}};P.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:z(D.prototype.readPoint),MultiPoint:z(D.prototype.readMultiPoint),LineString:z(D.prototype.readLineString),MultiLineString:z(D.prototype.readMultiLineString),LinearRing:z(D.prototype.readLinearRing),Polygon:z(D.prototype.readPolygon),MultiPolygon:z(D.prototype.readMultiPolygon),Surface:z(P.prototype.readSurface),MultiSurface:z(P.prototype.readMultiSurface),Curve:z(P.prototype.readCurve),MultiCurve:z(P.prototype.readMultiCurve),Envelope:z(P.prototype.readEnvelope)}};P.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml":{curveMember:U(P.prototype.curveMemberParser),curveMembers:U(P.prototype.curveMemberParser)}};P.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml":{surfaceMember:U(P.prototype.surfaceMemberParser),surfaceMembers:U(P.prototype.surfaceMemberParser)}};P.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:U(D.prototype.readLineString),Curve:U(P.prototype.readCurve)}};P.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:U(D.prototype.readPolygon),Surface:U(P.prototype.readSurface)}};P.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml":{patches:z(P.prototype.readPatch)}};P.prototype.CURVE_PARSERS={"http://www.opengis.net/gml":{segments:z(P.prototype.readSegment)}};P.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml":{lowerCorner:U(P.prototype.readFlatPosList),upperCorner:U(P.prototype.readFlatPosList)}};P.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml":{PolygonPatch:z(P.prototype.readPolygonPatch)}};P.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml":{LineStringSegment:rl(P.prototype.readLineStringSegment)}};D.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:z(D.prototype.readFlatLinearRing),Ring:z(P.prototype.readFlatCurveRing)}};P.prototype.writeFeatures;P.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{exterior:b(P.prototype.writeRing),interior:b(P.prototype.writeRing)}};P.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:b(q),upperCorner:b(q)}};P.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:b(P.prototype.writeSurfaceOrPolygonMember),polygonMember:b(P.prototype.writeSurfaceOrPolygonMember)}};P.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:b(P.prototype.writePointMember)}};P.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:b(P.prototype.writeLineStringOrCurveMember),curveMember:b(P.prototype.writeLineStringOrCurveMember)}};P.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:b(P.prototype.writeCurveOrLineString),MultiCurve:b(P.prototype.writeMultiCurveOrLineString),Point:b(P.prototype.writePoint),MultiPoint:b(P.prototype.writeMultiPoint),LineString:b(P.prototype.writeCurveOrLineString),MultiLineString:b(P.prototype.writeMultiCurveOrLineString),LinearRing:b(P.prototype.writeLinearRing),Polygon:b(P.prototype.writeSurfaceOrPolygon),MultiPolygon:b(P.prototype.writeMultiSurfaceOrPolygon),Surface:b(P.prototype.writeSurfaceOrPolygon),MultiSurface:b(P.prototype.writeMultiSurfaceOrPolygon),Envelope:b(P.prototype.writeEnvelope)}};const Cs=P;Cs.prototype.writeFeatures;Cs.prototype.writeFeaturesNode;const ye=[null,"http://www.topografix.com/GPX/1/0","http://www.topografix.com/GPX/1/1"],Sf="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",Rf={rte:Rl,trk:vl,wpt:Pl},vf=M(ye,{rte:U(Rl),trk:U(vl),wpt:U(Pl)}),Pf=M(ye,{text:x(C,"linkText"),type:x(C,"linkType")}),Af=M(ye,{name:x(C),email:td,link:ti}),Lf=M(ye,{name:x(C),desc:x(C),author:x(Jf),copyright:x(Qf),link:ti,time:x(nn),keywords:x(C),bounds:ed,extensions:cn}),If=M(ye,{year:x(xe),license:x(C)}),Cf=M(ye,{rte:b(sd),trk:b(od),wpt:b(ld)});class Ff extends rn{constructor(e){super(),e=e||{},this.dataProjection=se("EPSG:4326"),this.readExtensions_=e.readExtensions}handleReadExtensions_(e){e||(e=[]);for(let t=0,r=e.length;t<r;++t){const n=e[t];if(this.readExtensions_){const s=n.get("extensionsNode_")||null;this.readExtensions_(n,s)}n.set("extensionsNode_",void 0)}}readMetadata(e){return e?typeof e=="string"?this.readMetadataFromDocument(Ci(e)):Fi(e)?this.readMetadataFromDocument(e):this.readMetadataFromNode(e):null}readMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType===Node.ELEMENT_NODE){const r=this.readMetadataFromNode(t);if(r)return r}return null}readMetadataFromNode(e){if(!ye.includes(e.namespaceURI))return null;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(ye.includes(t.namespaceURI)&&t.localName==="metadata")return F({},Lf,t,[]);return null}readFeatureFromNode(e,t){if(!ye.includes(e.namespaceURI))return null;const r=Rf[e.localName];if(!r)return null;const n=r(e,[this.getReadOptions(e,t)]);return n?(this.handleReadExtensions_([n]),n):null}readFeaturesFromNode(e,t){if(!ye.includes(e.namespaceURI))return[];if(e.localName=="gpx"){const r=F([],vf,e,[this.getReadOptions(e,t)]);return r?(this.handleReadExtensions_(r),r):[]}return[]}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=X("http://www.topografix.com/GPX/1/1","gpx");return r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi",$r),r.setAttributeNS($r,"xsi:schemaLocation",Sf),r.setAttribute("version","1.1"),r.setAttribute("creator","OpenLayers"),de({node:r},Cf,Kf,e,[t]),r}}const Mf=M(ye,{name:x(C),cmt:x(C),desc:x(C),src:x(C),link:ti,number:x(xe),extensions:cn,type:x(C),rtept:rd}),Of=M(ye,{ele:x(Ue),time:x(nn)}),Nf=M(ye,{name:x(C),cmt:x(C),desc:x(C),src:x(C),link:ti,number:x(xe),type:x(C),extensions:cn,trkseg:nd}),Df=M(ye,{trkpt:id}),Uf=M(ye,{ele:x(Ue),time:x(nn)}),Gf=M(ye,{ele:x(Ue),time:x(nn),magvar:x(Ue),geoidheight:x(Ue),name:x(C),cmt:x(C),desc:x(C),src:x(C),link:ti,sym:x(C),type:x(C),fix:x(C),sat:x(xe),hdop:x(Ue),vdop:x(Ue),pdop:x(Ue),ageofdgpsdata:x(Ue),dgpsid:x(xe),extensions:cn}),Bf=["text","type"],zf=M(ye,{text:b(q),type:b(q)}),kf=M(ye,["name","cmt","desc","src","link","number","type","rtept"]),$f=M(ye,{name:b(q),cmt:b(q),desc:b(q),src:b(q),link:b(Os),number:b(Mi),type:b(q),rtept:il(b(Ns))}),jf=M(ye,["ele","time"]),Vf=M(ye,["name","cmt","desc","src","link","number","type","trkseg"]),Xf=M(ye,{name:b(q),cmt:b(q),desc:b(q),src:b(q),link:b(Os),number:b(Mi),type:b(q),trkseg:il(b(ad))}),Wf=Ze("trkpt"),Hf=M(ye,{trkpt:b(Ns)}),Zf=M(ye,["ele","time","magvar","geoidheight","name","cmt","desc","src","link","sym","type","fix","sat","hdop","vdop","pdop","ageofdgpsdata","dgpsid"]),Yf=M(ye,{ele:b(kt),time:b(Pu),magvar:b(kt),geoidheight:b(kt),name:b(q),cmt:b(q),desc:b(q),src:b(q),link:b(Os),sym:b(q),type:b(q),fix:b(q),sat:b(Mi),hdop:b(kt),vdop:b(kt),pdop:b(kt),ageofdgpsdata:b(kt),dgpsid:b(Mi)}),qf={Point:"wpt",LineString:"rte",MultiLineString:"trk"};function Kf(i,e,t){const r=i.getGeometry();if(r){const n=qf[r.getType()];if(n){const s=e[e.length-1].node;return X(s.namespaceURI,n)}}}function Fs(i,e,t,r){return i.push(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat"))),"ele"in r?(i.push(r.ele),delete r.ele,e.hasZ=!0):i.push(0),"time"in r?(i.push(r.time),delete r.time,e.hasM=!0):i.push(0),i}function Ms(i,e,t){let r="XY",n=2;if(i.hasZ&&i.hasM?(r="XYZM",n=4):i.hasZ?(r="XYZ",n=3):i.hasM&&(r="XYM",n=3),n!==4){for(let s=0,o=e.length/4;s<o;s++)e[s*n]=e[s*4],e[s*n+1]=e[s*4+1],i.hasZ&&(e[s*n+2]=e[s*4+2]),i.hasM&&(e[s*n+2]=e[s*4+3]);if(e.length=e.length/4*n,t)for(let s=0,o=t.length;s<o;s++)t[s]=t[s]/4*n}return r}function Jf(i,e){const t=F({},Af,i,e);if(t)return t}function Qf(i,e){const t=F({},If,i,e);if(t){const r=i.getAttribute("author");return r!==null&&(t.author=r),t}}function ed(i,e){const t=e[e.length-1],r=i.getAttribute("minlat"),n=i.getAttribute("minlon"),s=i.getAttribute("maxlat"),o=i.getAttribute("maxlon");n!==null&&r!==null&&o!==null&&s!==null&&(t.bounds=[[parseFloat(n),parseFloat(r)],[parseFloat(o),parseFloat(s)]])}function td(i,e){const t=e[e.length-1],r=i.getAttribute("id"),n=i.getAttribute("domain");r!==null&&n!==null&&(t.email=`${r}@${n}`)}function ti(i,e){const t=e[e.length-1],r=i.getAttribute("href");r!==null&&(t.link=r),Ct(Pf,i,e)}function cn(i,e){const t=e[e.length-1];t.extensionsNode_=i}function rd(i,e){const t=F({},Of,i,e);if(t){const r=e[e.length-1],n=r.flatCoordinates,s=r.layoutOptions;Fs(n,s,i,t)}}function id(i,e){const t=F({},Uf,i,e);if(t){const r=e[e.length-1],n=r.flatCoordinates,s=r.layoutOptions;Fs(n,s,i,t)}}function nd(i,e){const t=e[e.length-1];Ct(Df,i,e);const r=t.flatCoordinates;t.ends.push(r.length)}function Rl(i,e){const t=e[0],r=F({flatCoordinates:[],layoutOptions:{}},Mf,i,e);if(!r)return;const n=r.flatCoordinates;delete r.flatCoordinates;const s=r.layoutOptions;delete r.layoutOptions;const o=Ms(s,n),a=new pt(n,o);Ie(a,!1,t);const c=new je(a);return c.setProperties(r,!0),c}function vl(i,e){const t=e[0],r=F({flatCoordinates:[],ends:[],layoutOptions:{}},Nf,i,e);if(!r)return;const n=r.flatCoordinates;delete r.flatCoordinates;const s=r.ends;delete r.ends;const o=r.layoutOptions;delete r.layoutOptions;const a=Ms(o,n,s),c=new xr(n,a,s);Ie(c,!1,t);const l=new je(c);return l.setProperties(r,!0),l}function Pl(i,e){const t=e[0],r=F({},Gf,i,e);if(!r)return;const n={},s=Fs([],n,i,r),o=Ms(n,s),a=new Qe(s,o);Ie(a,!1,t);const c=new je(a);return c.setProperties(r,!0),c}function Os(i,e,t){i.setAttribute("href",e);const n=t[t.length-1].properties,s=[n.linkText,n.linkType];de({node:i},zf,br,s,t,Bf)}function Ns(i,e,t){const r=t[t.length-1],s=r.node.namespaceURI,o=r.properties;switch(i.setAttributeNS(null,"lat",String(e[1])),i.setAttributeNS(null,"lon",String(e[0])),r.geometryLayout){case"XYZM":e[3]!==0&&(o.time=e[3]);case"XYZ":e[2]!==0&&(o.ele=e[2]);break;case"XYM":e[2]!==0&&(o.time=e[2]);break}const c=i.nodeName=="rtept"?jf[s]:Zf[s],l=ds(o,c);de({node:i,properties:o},Yf,br,l,t,c)}function sd(i,e,t){const r=t[0],n=e.getProperties(),s={node:i};s.properties=n;const o=e.getGeometry();if(o.getType()=="LineString"){const u=Ie(o,!0,r);s.geometryLayout=u.getLayout(),n.rtept=u.getCoordinates()}const a=t[t.length-1].node,c=kf[a.namespaceURI],l=ds(n,c);de(s,$f,br,l,t,c)}function od(i,e,t){const r=t[0],n=e.getProperties(),s={node:i};s.properties=n;const o=e.getGeometry();if(o.getType()=="MultiLineString"){const u=Ie(o,!0,r);n.trkseg=u.getLineStrings()}const a=t[t.length-1].node,c=Vf[a.namespaceURI],l=ds(n,c);de(s,Xf,br,l,t,c)}function ad(i,e,t){const r={node:i};r.geometryLayout=e.getLayout(),r.properties={},de(r,Hf,Wf,e.getCoordinates(),t)}function ld(i,e,t){const r=t[0],n=t[t.length-1];n.properties=e.getProperties();const s=e.getGeometry();if(s.getType()=="Point"){const o=Ie(s,!0,r);n.geometryLayout=o.getLayout(),Ns(i,o.getCoordinates(),t)}}class Ds extends nl{constructor(){super()}getType(){return"text"}readFeature(e,t){return this.readFeatureFromText(pi(e),this.adaptOptions(t))}readFeatureFromText(e,t){return _t()}readFeatures(e,t){return this.readFeaturesFromText(pi(e),this.adaptOptions(t))}readFeaturesFromText(e,t){return _t()}readGeometry(e,t){return this.readGeometryFromText(pi(e),this.adaptOptions(t))}readGeometryFromText(e,t){return _t()}readProjection(e){return this.readProjectionFromText(pi(e))}readProjectionFromText(e){return this.dataProjection}writeFeature(e,t){return this.writeFeatureText(e,this.adaptOptions(t))}writeFeatureText(e,t){return _t()}writeFeatures(e,t){return this.writeFeaturesText(e,this.adaptOptions(t))}writeFeaturesText(e,t){return _t()}writeGeometry(e,t){return this.writeGeometryText(e,this.adaptOptions(t))}writeGeometryText(e,t){return _t()}}function pi(i){return typeof i=="string"?i:""}const cd=/^B(\d{2})(\d{2})(\d{2})(\d{2})(\d{5})([NS])(\d{3})(\d{5})([EW])([AV])(\d{5})(\d{5})/,ud=/^H.([A-Z]{3}).*?:(.*)/,hd=/^HFDTE(\d{2})(\d{2})(\d{2})/,fd=/^HFDTEDATE:(\d{2})(\d{2})(\d{2}),(\d{2})/,dd=/\r\n|\r|\n/;class gd extends Ds{constructor(e){super(),e=e||{},this.dataProjection=se("EPSG:4326"),this.altitudeMode_=e.altitudeMode?e.altitudeMode:"none",this.lad_=!1,this.lod_=!1,this.ladStart_=0,this.ladStop_=0,this.lodStart_=0,this.lodStop_=0}readFeatureFromText(e,t){const r=this.altitudeMode_,n=e.split(dd),s={},o=[];let a=2e3,c=0,l=1,u=-1,h,f;for(h=0,f=n.length;h<f;++h){const m=n[h];let y;if(m.charAt(0)=="B"){if(y=cd.exec(m),y){const _=parseInt(y[1],10),E=parseInt(y[2],10),w=parseInt(y[3],10);let S=parseInt(y[4],10)+parseInt(y[5],10)/6e4;this.lad_&&(S+=parseInt(m.slice(this.ladStart_,this.ladStop_),10)/6e4/10**(this.ladStop_-this.ladStart_)),y[6]=="S"&&(S=-S);let T=parseInt(y[7],10)+parseInt(y[8],10)/6e4;if(this.lod_&&(T+=parseInt(m.slice(this.lodStart_,this.lodStop_),10)/6e4/10**(this.lodStop_-this.lodStart_)),y[9]=="W"&&(T=-T),o.push(T,S),r!="none"){let I;r=="gps"?I=parseInt(y[11],10):r=="barometric"?I=parseInt(y[12],10):I=0,o.push(I)}let v=Date.UTC(a,c,l,_,E,w);v<u&&(v=Date.UTC(a,c,l+1,_,E,w)),o.push(v/1e3),u=v}}else if(m.charAt(0)=="H")y=fd.exec(m),y?(l=parseInt(y[1],10),c=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=hd.exec(m),y?(l=parseInt(y[1],10),c=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=ud.exec(m),y&&(s[y[1]]=y[2].trim())));else if(m.charAt(0)=="I"){const _=parseInt(m.slice(1,3),10);for(let E=0;E<_;E++){const w=m.slice(7+E*7,10+E*7);if(w==="LAD"||w==="LOD"){const S=parseInt(m.slice(3+E*7,5+E*7),10)-1,T=parseInt(m.slice(5+E*7,7+E*7),10);w==="LAD"?(this.lad_=!0,this.ladStart_=S,this.ladStop_=T):w==="LOD"&&(this.lod_=!0,this.lodStart_=S,this.lodStop_=T)}}}}if(o.length===0)return null;const d=r=="none"?"XYM":"XYZM",g=new pt(o,d),p=new je(Ie(g,!1,t));return p.setProperties(s,!0),p}readFeaturesFromText(e,t){const r=this.readFeatureFromText(e,t);return r?[r]:[]}}const we={VERSION1:"version1",VERSION2:"version2",VERSION3:"version3"},Zt={};Zt[we.VERSION1]={level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}};Zt[we.VERSION2]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}};Zt[we.VERSION3]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH","sizeByWh"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["default"]}};Zt.none={none:{supports:[],formats:[],qualities:[]}};const pd=/^https?:\/\/library\.stanford\.edu\/iiif\/image-api\/(?:1\.1\/)?compliance\.html#level[0-2]$/,Xo=/^https?:\/\/iiif\.io\/api\/image\/2\/level[0-2](?:\.json)?$/,md=/(^https?:\/\/iiif\.io\/api\/image\/3\/level[0-2](?:\.json)?$)|(^level[0-2]$)/;function _d(i){let e=i.getComplianceLevelSupportedFeatures();return e===void 0&&(e=Zt[we.VERSION1].level0),{url:i.imageInfo["@id"]===void 0?void 0:i.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),supports:e.supports,formats:[...e.formats,i.imageInfo.formats===void 0?[]:i.imageInfo.formats],qualities:[...e.qualities,i.imageInfo.qualities===void 0?[]:i.imageInfo.qualities],resolutions:i.imageInfo.scale_factors,tileSize:i.imageInfo.tile_width!==void 0?i.imageInfo.tile_height!==void 0?[i.imageInfo.tile_width,i.imageInfo.tile_height]:[i.imageInfo.tile_width,i.imageInfo.tile_width]:i.imageInfo.tile_height!=null?[i.imageInfo.tile_height,i.imageInfo.tile_height]:void 0}}function yd(i){const e=i.getComplianceLevelSupportedFeatures(),t=Array.isArray(i.imageInfo.profile)&&i.imageInfo.profile.length>1,r=t&&i.imageInfo.profile[1].supports?i.imageInfo.profile[1].supports:[],n=t&&i.imageInfo.profile[1].formats?i.imageInfo.profile[1].formats:[],s=t&&i.imageInfo.profile[1].qualities?i.imageInfo.profile[1].qualities:[];return{url:i.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),sizes:i.imageInfo.sizes===void 0?void 0:i.imageInfo.sizes.map(function(o){return[o.width,o.height]}),tileSize:i.imageInfo.tiles===void 0?void 0:[i.imageInfo.tiles.map(function(o){return o.width})[0],i.imageInfo.tiles.map(function(o){return o.height===void 0?o.width:o.height})[0]],resolutions:i.imageInfo.tiles===void 0?void 0:i.imageInfo.tiles.map(function(o){return o.scaleFactors})[0],supports:[...e.supports,...r],formats:[...e.formats,...n],qualities:[...e.qualities,...s]}}function Ed(i){const e=i.getComplianceLevelSupportedFeatures(),t=i.imageInfo.extraFormats===void 0?e.formats:[...e.formats,...i.imageInfo.extraFormats],r=i.imageInfo.preferredFormats!==void 0&&Array.isArray(i.imageInfo.preferredFormats)&&i.imageInfo.preferredFormats.length>0?i.imageInfo.preferredFormats.filter(function(n){return["jpg","png","gif"].includes(n)}).reduce(function(n,s){return n===void 0&&t.includes(s)?s:n},void 0):void 0;return{url:i.imageInfo.id,sizes:i.imageInfo.sizes===void 0?void 0:i.imageInfo.sizes.map(function(n){return[n.width,n.height]}),tileSize:i.imageInfo.tiles===void 0?void 0:[i.imageInfo.tiles.map(function(n){return n.width})[0],i.imageInfo.tiles.map(function(n){return n.height})[0]],resolutions:i.imageInfo.tiles===void 0?void 0:i.imageInfo.tiles.map(function(n){return n.scaleFactors})[0],supports:i.imageInfo.extraFeatures===void 0?e.supports:[...e.supports,...i.imageInfo.extraFeatures],formats:t,qualities:i.imageInfo.extraQualities===void 0?e.qualities:[...e.qualities,...i.imageInfo.extraQualities],preferredFormat:r}}const un={};un[we.VERSION1]=_d;un[we.VERSION2]=yd;un[we.VERSION3]=Ed;class xd{constructor(e){this.setImageInfo(e)}setImageInfo(e){typeof e=="string"?this.imageInfo=JSON.parse(e):this.imageInfo=e}getImageApiVersion(){if(this.imageInfo===void 0)return;let e=this.imageInfo["@context"]||"ol-no-context";typeof e=="string"&&(e=[e]);for(let t=0;t<e.length;t++)switch(e[t]){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":case"http://iiif.io/api/image/1/context.json":return we.VERSION1;case"http://iiif.io/api/image/2/context.json":return we.VERSION2;case"http://iiif.io/api/image/3/context.json":return we.VERSION3;case"ol-no-context":if(this.getComplianceLevelEntryFromProfile(we.VERSION1)&&this.imageInfo.identifier)return we.VERSION1;break}et(!1,"Cannot determine IIIF Image API version from provided image information JSON")}getComplianceLevelEntryFromProfile(e){if(!(this.imageInfo===void 0||this.imageInfo.profile===void 0))switch(e===void 0&&(e=this.getImageApiVersion()),e){case we.VERSION1:if(pd.test(this.imageInfo.profile))return this.imageInfo.profile;break;case we.VERSION3:if(md.test(this.imageInfo.profile))return this.imageInfo.profile;break;case we.VERSION2:if(typeof this.imageInfo.profile=="string"&&Xo.test(this.imageInfo.profile))return this.imageInfo.profile;if(Array.isArray(this.imageInfo.profile)&&this.imageInfo.profile.length>0&&typeof this.imageInfo.profile[0]=="string"&&Xo.test(this.imageInfo.profile[0]))return this.imageInfo.profile[0];break}}getComplianceLevelFromProfile(e){const t=this.getComplianceLevelEntryFromProfile(e);if(t===void 0)return;const r=t.match(/level[0-2](?:\.json)?$/g);return Array.isArray(r)?r[0].replace(".json",""):void 0}getComplianceLevelSupportedFeatures(){if(this.imageInfo===void 0)return;const e=this.getImageApiVersion(),t=this.getComplianceLevelFromProfile(e);return t===void 0?Zt.none.none:Zt[e][t]}getTileSourceOptions(e){const t=e||{},r=this.getImageApiVersion();if(r===void 0)return;const n=r===void 0?void 0:un[r](this);if(n!==void 0)return{url:n.url,version:r,size:[this.imageInfo.width,this.imageInfo.height],sizes:n.sizes,format:t.format!==void 0&&n.formats.includes(t.format)?t.format:n.preferredFormat!==void 0?n.preferredFormat:"jpg",supports:n.supports,quality:t.quality&&n.qualities.includes(t.quality)?t.quality:n.qualities.includes("native")?"native":"default",resolutions:Array.isArray(n.resolutions)?n.resolutions.sort(function(s,o){return o-s}):void 0,tileSize:n.tileSize}}}class Us{read(e){if(!e)return null;if(typeof e=="string"){const t=Ci(e);return this.readFromDocument(t)}return Fi(e)?this.readFromDocument(e):this.readFromNode(e)}readFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFromNode(t);return null}readFromNode(e){_t()}}const bd="http://www.w3.org/1999/xlink";function Rr(i){return i.getAttributeNS(bd,"href")}const Ve=[null,"http://www.opengis.net/ows/1.1"],Td=M(Ve,{ServiceIdentification:x(Wd),ServiceProvider:x(Zd),OperationsMetadata:x(Vd)});class Al extends Us{constructor(){super()}readFromNode(e){const t=F({},Td,e,[]);return t||null}}const wd=M(Ve,{DeliveryPoint:x(C),City:x(C),AdministrativeArea:x(C),PostalCode:x(C),Country:x(C),ElectronicMailAddress:x(C)}),Sd=M(Ve,{Value:ce(Yd)}),Rd=M(Ve,{AllowedValues:x(Ud)}),vd=M(Ve,{Phone:x(Xd),Address:x(Dd)}),Pd=M(Ve,{HTTP:x($d)}),Ad=M(Ve,{Get:ce(kd),Post:void 0}),Ld=M(Ve,{DCP:x(zd)}),Id=M(Ve,{Operation:jd}),Cd=M(Ve,{Voice:x(C),Facsimile:x(C)}),Fd=M(Ve,{Constraint:ce(Gd)}),Md=M(Ve,{IndividualName:x(C),PositionName:x(C),ContactInfo:x(Bd)}),Od=M(Ve,{Abstract:x(C),AccessConstraints:x(C),Fees:x(C),Title:x(C),ServiceTypeVersion:x(C),ServiceType:x(C)}),Nd=M(Ve,{ProviderName:x(C),ProviderSite:x(Rr),ServiceContact:x(Hd)});function Dd(i,e){return F({},wd,i,e)}function Ud(i,e){return F({},Sd,i,e)}function Gd(i,e){const t=i.getAttribute("name");if(t)return F({name:t},Rd,i,e)}function Bd(i,e){return F({},vd,i,e)}function zd(i,e){return F({},Pd,i,e)}function kd(i,e){const t=Rr(i);if(t)return F({href:t},Fd,i,e)}function $d(i,e){return F({},Ad,i,e)}function jd(i,e){const t=i.getAttribute("name"),r=F({},Ld,i,e);if(!r)return;const n=e[e.length-1];n[t]=r}function Vd(i,e){return F({},Id,i,e)}function Xd(i,e){return F({},Cd,i,e)}function Wd(i,e){return F({},Od,i,e)}function Hd(i,e){return F({},Md,i,e)}function Zd(i,e){return F({},Nd,i,e)}function Yd(i,e){return C(i)}function Wo(i,e,t,r,n,s){n!==void 0?(n=n,s=s!==void 0?s:0):(n=[],s=0);let o=e;for(;o<t;){const a=i[o++];n[s++]=i[o++],n[s++]=a;for(let c=2;c<r;++c)n[s++]=i[o++]}return n.length=s,n}class qd extends Ds{constructor(e){super(),e=e||{},this.dataProjection=se("EPSG:4326"),this.factor_=e.factor?e.factor:1e5,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY"}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t);return new je(r)}readFeaturesFromText(e,t){return[this.readFeatureFromText(e,t)]}readGeometryFromText(e,t){const r=Au(this.geometryLayout_),n=Jd(e,r,this.factor_);Wo(n,0,n.length,r,n);const s=Lu(n,0,n.length,r),o=new pt(s,this.geometryLayout_);return Ie(o,!1,this.adaptOptions(t))}writeFeatureText(e,t){const r=e.getGeometry();if(r)return this.writeGeometryText(r,t);throw new Error("Expected `feature` to have a geometry")}writeFeaturesText(e,t){return this.writeFeatureText(e[0],t)}writeGeometryText(e,t){e=Ie(e,!0,this.adaptOptions(t));const r=e.getFlatCoordinates(),n=e.getStride();return Wo(r,0,r.length,n,r),Kd(r,n,this.factor_)}}function Kd(i,e,t){t=t||1e5;let r;const n=new Array(e);for(r=0;r<e;++r)n[r]=0;for(let s=0,o=i.length;s<o;)for(r=0;r<e;++r,++s){const a=i[s],c=a-n[r];n[r]=a,i[s]=c}return Qd(i,t)}function Jd(i,e,t){t=t||1e5;let r;const n=new Array(e);for(r=0;r<e;++r)n[r]=0;const s=eg(i,t);for(let o=0,a=s.length;o<a;)for(r=0;r<e;++r,++o)n[r]+=s[o],s[o]=n[r];return s}function Qd(i,e){e=e||1e5;for(let t=0,r=i.length;t<r;++t)i[t]=Math.round(i[t]*e);return tg(i)}function eg(i,e){e=e||1e5;const t=rg(i);for(let r=0,n=t.length;r<n;++r)t[r]/=e;return t}function tg(i){for(let e=0,t=i.length;e<t;++e){const r=i[e];i[e]=r<0?~(r<<1):r<<1}return ig(i)}function rg(i){const e=ng(i);for(let t=0,r=e.length;t<r;++t){const n=e[t];e[t]=n&1?~(n>>1):n>>1}return e}function ig(i){let e="";for(let t=0,r=i.length;t<r;++t)e+=sg(i[t]);return e}function ng(i){const e=[];let t=0,r=0;for(let n=0,s=i.length;n<s;++n){const o=i.charCodeAt(n)-63;t|=(o&31)<<r,o<32?(e.push(t),t=0,r=0):r+=5}return e}function sg(i){let e,t="";for(;i>=32;)e=(32|i&31)+63,t+=String.fromCharCode(e),i>>=5;return e=i+63,t+=String.fromCharCode(e),t}class te extends P{constructor(e){e=e||{},super(e),this.schemaLocation=e.schemaLocation?e.schemaLocation:this.namespace+" http://schemas.opengis.net/gml/3.2.1/gml.xsd"}writeGeometryElement(e,t,r){const n=r[r.length-1];r[r.length-1]=Object.assign({multiCurve:!0,multiSurface:!0},n),super.writeGeometryElement(e,t,r)}}te.prototype.namespace="http://www.opengis.net/gml/3.2";te.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml/3.2":{pos:z(P.prototype.readFlatPos),posList:z(P.prototype.readFlatPosList),coordinates:z(Y.prototype.readFlatCoordinates)}};te.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml/3.2":{interior:P.prototype.interiorParser,exterior:P.prototype.exteriorParser}};te.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml/3.2":{Point:z(D.prototype.readPoint),MultiPoint:z(D.prototype.readMultiPoint),LineString:z(D.prototype.readLineString),MultiLineString:z(D.prototype.readMultiLineString),LinearRing:z(D.prototype.readLinearRing),Polygon:z(D.prototype.readPolygon),MultiPolygon:z(D.prototype.readMultiPolygon),Surface:z(te.prototype.readSurface),MultiSurface:z(P.prototype.readMultiSurface),Curve:z(te.prototype.readCurve),MultiCurve:z(P.prototype.readMultiCurve),Envelope:z(te.prototype.readEnvelope)}};te.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml/3.2":{curveMember:U(P.prototype.curveMemberParser),curveMembers:U(P.prototype.curveMemberParser)}};te.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{surfaceMember:U(P.prototype.surfaceMemberParser),surfaceMembers:U(P.prototype.surfaceMemberParser)}};te.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:U(D.prototype.readLineString),Curve:U(P.prototype.readCurve)}};te.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:U(D.prototype.readPolygon),Surface:U(P.prototype.readSurface)}};te.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{patches:z(P.prototype.readPatch)}};te.prototype.CURVE_PARSERS={"http://www.opengis.net/gml/3.2":{segments:z(P.prototype.readSegment)}};te.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml/3.2":{lowerCorner:U(P.prototype.readFlatPosList),upperCorner:U(P.prototype.readFlatPosList)}};te.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml/3.2":{PolygonPatch:z(P.prototype.readPolygonPatch)}};te.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml/3.2":{LineStringSegment:rl(P.prototype.readLineStringSegment)}};te.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml/3.2":{pointMember:U(D.prototype.pointMemberParser),pointMembers:U(D.prototype.pointMemberParser)}};te.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml/3.2":{lineStringMember:U(D.prototype.lineStringMemberParser),lineStringMembers:U(D.prototype.lineStringMemberParser)}};te.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml/3.2":{polygonMember:U(D.prototype.polygonMemberParser),polygonMembers:U(D.prototype.polygonMemberParser)}};te.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Point:U(D.prototype.readFlatCoordinatesFromNode)}};te.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:U(D.prototype.readLineString)}};te.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:U(D.prototype.readPolygon)}};te.prototype.RING_PARSERS={"http://www.opengis.net/gml/3.2":{LinearRing:z(D.prototype.readFlatLinearRing),Ring:z(te.prototype.readFlatCurveRing)}};te.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml/3.2":{exterior:b(P.prototype.writeRing),interior:b(P.prototype.writeRing)}};te.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lowerCorner:b(q),upperCorner:b(q)}};te.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{surfaceMember:b(P.prototype.writeSurfaceOrPolygonMember),polygonMember:b(P.prototype.writeSurfaceOrPolygonMember)}};te.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{pointMember:b(P.prototype.writePointMember)}};te.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lineStringMember:b(P.prototype.writeLineStringOrCurveMember),curveMember:b(P.prototype.writeLineStringOrCurveMember)}};te.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml/3.2":{Curve:b(P.prototype.writeCurveOrLineString),MultiCurve:b(P.prototype.writeMultiCurveOrLineString),Point:b(te.prototype.writePoint),MultiPoint:b(P.prototype.writeMultiPoint),LineString:b(P.prototype.writeCurveOrLineString),MultiLineString:b(P.prototype.writeMultiCurveOrLineString),LinearRing:b(P.prototype.writeLinearRing),Polygon:b(P.prototype.writeSurfaceOrPolygon),MultiPolygon:b(P.prototype.writeMultiSurfaceOrPolygon),Surface:b(P.prototype.writeSurfaceOrPolygon),MultiSurface:b(P.prototype.writeMultiSurfaceOrPolygon),Envelope:b(P.prototype.writeEnvelope)}};class Ll{constructor(e){this.tagName_=e}getTagName(){return this.tagName_}}class og extends Ll{constructor(e,t){super(e),this.conditions=t,et(this.conditions.length>=2,"At least 2 conditions are required")}}class ag extends og{constructor(e){super("And",Array.prototype.slice.call(arguments))}}class lg extends Ll{constructor(e,t,r){if(super("BBOX"),this.geometryName=e,this.extent=t,t.length!==4)throw new Error("Expected an extent with four values ([minX, minY, maxX, maxY])");this.srsName=r}}function cg(i){const e=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(ag,e))}function ug(i,e,t){return new lg(i,e,t)}const Ho={"http://www.opengis.net/gml":{boundedBy:x(D.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:U(D.prototype.readFeaturesInternal)}},hg={"http://www.opengis.net/wfs":{totalInserted:x(xe),totalUpdated:x(xe),totalDeleted:x(xe)},"http://www.opengis.net/wfs/2.0":{totalInserted:x(xe),totalUpdated:x(xe),totalDeleted:x(xe)}},fg={"http://www.opengis.net/wfs":{TransactionSummary:x(Yo,"transactionSummary"),InsertResults:x(Ko,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:x(Yo,"transactionSummary"),InsertResults:x(Ko,"insertIds")}},dg={"http://www.opengis.net/wfs":{PropertyName:b(q)},"http://www.opengis.net/wfs/2.0":{PropertyName:b(q)}},Il={"http://www.opengis.net/wfs":{Insert:b(Jo),Update:b(ea),Delete:b(Qo),Property:b(ta),Native:b(ra)},"http://www.opengis.net/wfs/2.0":{Insert:b(Jo),Update:b(ea),Delete:b(Qo),Property:b(ta),Native:b(ra)}},Cl="feature",Gs="http://www.w3.org/2000/xmlns/",Bs={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},Zn={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},zs={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},Zo={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},ks={"2.0.0":te,"1.1.0":P,"1.0.0":Y},gg="1.1.0";class pg extends rn{constructor(e){super(),e=e||{},this.version_=e.version?e.version:gg,this.featureType_=e.featureType,this.featureNS_=e.featureNS,this.gmlFormat_=e.gmlFormat?e.gmlFormat:new ks[this.version_],this.schemaLocation_=e.schemaLocation?e.schemaLocation:Zo[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(e){this.featureType_=e}readFeaturesFromNode(e,t){const r={node:e};Object.assign(r,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(r,this.getReadOptions(e,t||{}));const n=[r];let s;this.version_==="2.0.0"?s=Ho:s=this.gmlFormat_.FEATURE_COLLECTION_PARSERS;let o=F([],s,e,n,this.gmlFormat_);return o||(o=[]),o}readTransactionResponse(e){if(e){if(typeof e=="string"){const t=Ci(e);return this.readTransactionResponseFromDocument(t)}return Fi(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)}}readFeatureCollectionMetadata(e){if(e){if(typeof e=="string"){const t=Ci(e);return this.readFeatureCollectionMetadataFromDocument(t)}return Fi(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)}}readFeatureCollectionMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(t)}readFeatureCollectionMetadataFromNode(e){const t={},r=Lt(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=r,F(t,Ho,e,[],this.gmlFormat_)}readTransactionResponseFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(t)}readTransactionResponseFromNode(e){return F({},fg,e,[])}writeGetFeature(e){const t=X(Zn[this.version_],"GetFeature");t.setAttribute("service","WFS"),t.setAttribute("version",this.version_),e.handle&&t.setAttribute("handle",e.handle),e.outputFormat&&t.setAttribute("outputFormat",e.outputFormat),e.maxFeatures!==void 0&&t.setAttribute("maxFeatures",String(e.maxFeatures)),e.resultType&&t.setAttribute("resultType",e.resultType),e.startIndex!==void 0&&t.setAttribute("startIndex",String(e.startIndex)),e.count!==void 0&&t.setAttribute("count",String(e.count)),e.viewParams!==void 0&&t.setAttribute("viewParams",e.viewParams),t.setAttributeNS($r,"xsi:schemaLocation",this.schemaLocation_);const r={node:t};if(Object.assign(r,{version:this.version_,srsName:e.srsName,featureNS:e.featureNS?e.featureNS:this.featureNS_,featurePrefix:e.featurePrefix,propertyNames:e.propertyNames?e.propertyNames:[]}),et(Array.isArray(e.featureTypes),"`options.featureTypes` must be an Array"),typeof e.featureTypes[0]=="string"){let n=e.filter;e.bbox&&(et(e.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),n=this.combineBboxAndFilter(e.geometryName,e.bbox,e.srsName,n)),Object.assign(r,{geometryName:e.geometryName,filter:n}),fa(t,e.featureTypes,[r])}else e.featureTypes.forEach(n=>{const s=this.combineBboxAndFilter(n.geometryName,n.bbox,e.srsName,e.filter);Object.assign(r,{geometryName:n.geometryName,filter:s}),fa(t,[n.name],[r])});return t}combineBboxAndFilter(e,t,r,n){const s=ug(e,t,r);return n?cg(n,s):s}writeTransaction(e,t,r,n){const s=[],o=n.version?n.version:this.version_,a=X(Zn[o],"Transaction");a.setAttribute("service","WFS"),a.setAttribute("version",o);let c;n&&(c=n.gmlOptions?n.gmlOptions:{},n.handle&&a.setAttribute("handle",n.handle)),a.setAttributeNS($r,"xsi:schemaLocation",Zo[o]);const l=mg(a,c,o,n);return e&&mi("Insert",e,s,l),t&&mi("Update",t,s,l),r&&mi("Delete",r,s,l),n.nativeElements&&mi("Native",n.nativeElements,s,l),a}readProjectionFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(t);return null}readProjectionFromNode(e){if(e.firstElementChild&&e.firstElementChild.firstElementChild){e=e.firstElementChild.firstElementChild;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(!(t.childNodes.length===0||t.childNodes.length===1&&t.firstChild.nodeType===3)){const r=[{}];return this.gmlFormat_.readGeometryElement(t,r),se(r.pop().srsName)}}return null}}function mg(i,e,t,r){const n=r.featurePrefix?r.featurePrefix:Cl;let s;return t==="1.0.0"?s=2:t==="1.1.0"?s=3:t==="2.0.0"&&(s=3.2),Object.assign({node:i},{version:t,featureNS:r.featureNS,featureType:r.featureType,featurePrefix:n,gmlVersion:s,hasZ:r.hasZ,srsName:r.srsName},e)}function mi(i,e,t,r){de(r,Il,Ze(i),e,t)}function Yo(i,e){return F({},hg,i,e)}const _g={"http://www.opengis.net/ogc":{FeatureId:U(function(i,e){return i.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:U(function(i,e){return i.getAttribute("fid")})}};function qo(i,e){Ct(_g,i,e)}const yg={"http://www.opengis.net/wfs":{Feature:qo},"http://www.opengis.net/wfs/2.0":{Feature:qo}};function Ko(i,e){return F([],yg,i,e)}function Jo(i,e,t){const r=t[t.length-1],n=r.featureType,s=r.featureNS,o=r.gmlVersion,a=X(s,n);i.appendChild(a),o===2?Y.prototype.writeFeatureElement(a,e,t):o===3?P.prototype.writeFeatureElement(a,e,t):te.prototype.writeFeatureElement(a,e,t)}function Fl(i,e,t){const n=t[t.length-1].version,s=Bs[n],o=X(s,"Filter"),a=X(s,"FeatureId");o.appendChild(a),a.setAttribute("fid",e),i.appendChild(o)}function $s(i,e){i=i||Cl;const t=i+":";return e.startsWith(t)?e:t+e}function Qo(i,e,t){const r=t[t.length-1];et(e.getId()!==void 0,"Features must have an id set");const n=r.featureType,s=r.featurePrefix,o=r.featureNS,a=$s(s,n);i.setAttribute("typeName",a),i.setAttributeNS(Gs,"xmlns:"+s,o);const c=e.getId();c!==void 0&&Fl(i,c,t)}function ea(i,e,t){const r=t[t.length-1];et(e.getId()!==void 0,"Features must have an id set");const n=r.version,s=r.featureType,o=r.featurePrefix,a=r.featureNS,c=$s(o,s),l=e.getGeometryName();i.setAttribute("typeName",c),i.setAttributeNS(Gs,"xmlns:"+o,a);const u=e.getId();if(u!==void 0){const h=e.getKeys(),f=[];for(let d=0,g=h.length;d<g;d++){const p=e.get(h[d]);if(p!==void 0){let m=h[d];p&&typeof p.getSimplifiedGeometry=="function"&&(m=l),f.push({name:m,value:p})}}de({version:n,gmlVersion:r.gmlVersion,node:i,hasZ:r.hasZ,srsName:r.srsName},Il,Ze("Property"),f,t),Fl(i,u,t)}}function ta(i,e,t){const r=t[t.length-1],n=r.version,s=Zn[n],a=X(s,n==="2.0.0"?"ValueReference":"Name"),c=r.gmlVersion;if(i.appendChild(a),q(a,e.name),e.value!==void 0&&e.value!==null){const l=X(s,"Value");i.appendChild(l),e.value&&typeof e.value.getSimplifiedGeometry=="function"?c===2?Y.prototype.writeGeometryElement(l,e.value,t):c===3?P.prototype.writeGeometryElement(l,e.value,t):te.prototype.writeGeometryElement(l,e.value,t):q(l,e.value)}}function ra(i,e,t){e.vendorId&&i.setAttribute("vendorId",e.vendorId),e.safeToIgnore!==void 0&&i.setAttribute("safeToIgnore",String(e.safeToIgnore)),e.value!==void 0&&q(i,e.value)}const hn={"http://www.opengis.net/wfs":{Query:b(ia)},"http://www.opengis.net/wfs/2.0":{Query:b(ia)},"http://www.opengis.net/ogc":{During:b(oa),And:b(_i),Or:b(_i),Not:b(aa),BBOX:b(na),Contains:b(Pt),Intersects:b(Pt),Within:b(Pt),DWithin:b(sa),PropertyIsEqualTo:b(Ye),PropertyIsNotEqualTo:b(Ye),PropertyIsLessThan:b(Ye),PropertyIsLessThanOrEqualTo:b(Ye),PropertyIsGreaterThan:b(Ye),PropertyIsGreaterThanOrEqualTo:b(Ye),PropertyIsNull:b(la),PropertyIsBetween:b(ca),PropertyIsLike:b(ua)},"http://www.opengis.net/fes/2.0":{During:b(oa),And:b(_i),Or:b(_i),Not:b(aa),BBOX:b(na),Contains:b(Pt),Disjoint:b(Pt),Intersects:b(Pt),ResourceId:b(xg),Within:b(Pt),DWithin:b(sa),PropertyIsEqualTo:b(Ye),PropertyIsNotEqualTo:b(Ye),PropertyIsLessThan:b(Ye),PropertyIsLessThanOrEqualTo:b(Ye),PropertyIsGreaterThan:b(Ye),PropertyIsGreaterThanOrEqualTo:b(Ye),PropertyIsNull:b(la),PropertyIsBetween:b(ca),PropertyIsLike:b(ua)}};function ia(i,e,t){const r=t[t.length-1],n=r.version,s=r.featurePrefix,o=r.featureNS,a=r.propertyNames,c=r.srsName;let l;s?l=$s(s,e):l=e;let u;n==="2.0.0"?u="typeNames":u="typeName",i.setAttribute(u,l),c&&i.setAttribute("srsName",c),o&&i.setAttributeNS(Gs,"xmlns:"+s,o);const h=Object.assign({},r);h.node=i,de(h,dg,Ze("PropertyName"),a,t);const f=r.filter;if(f){const d=X(fn(n),"Filter");i.appendChild(d),Eg(d,f,t)}}function Eg(i,e,t){const r=t[t.length-1],n={node:i};Object.assign(n,{context:r}),de(n,hn,Ze(e.getTagName()),[e],t)}function na(i,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=ks[s];vr(s,i,e.geometryName),o.prototype.writeGeometryElement(i,e.extent,t)}function xg(i,e,t){i.setAttribute("rid",e.rid)}function Pt(i,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=ks[s];vr(s,i,e.geometryName),o.prototype.writeGeometryElement(i,e.geometry,t)}function sa(i,e,t){const s=t[t.length-1].context.version;Pt(i,e,t);const o=X(fn(s),"Distance");q(o,e.distance.toString()),s==="2.0.0"?o.setAttribute("uom",e.unit):o.setAttribute("units",e.unit),i.appendChild(o)}function oa(i,e,t){const s=t[t.length-1].context.version;zi(zs[s],"ValueReference",i,e.propertyName);const o=X(bt,"TimePeriod");i.appendChild(o);const a=X(bt,"begin");o.appendChild(a),ha(a,e.begin);const c=X(bt,"end");o.appendChild(c),ha(c,e.end)}function _i(i,e,t){const n=t[t.length-1].context,s={node:i};Object.assign(s,{context:n});const o=e.conditions;for(let a=0,c=o.length;a<c;++a){const l=o[a];de(s,hn,Ze(l.getTagName()),[l],t)}}function aa(i,e,t){const n=t[t.length-1].context,s={node:i};Object.assign(s,{context:n});const o=e.condition;de(s,hn,Ze(o.getTagName()),[o],t)}function Ye(i,e,t){const s=t[t.length-1].context.version;e.matchCase!==void 0&&i.setAttribute("matchCase",e.matchCase.toString()),vr(s,i,e.propertyName),ki(s,i,""+e.expression)}function la(i,e,t){const s=t[t.length-1].context.version;vr(s,i,e.propertyName)}function ca(i,e,t){const s=t[t.length-1].context.version,o=fn(s);vr(s,i,e.propertyName);const a=X(o,"LowerBoundary");i.appendChild(a),ki(s,a,""+e.lowerBoundary);const c=X(o,"UpperBoundary");i.appendChild(c),ki(s,c,""+e.upperBoundary)}function ua(i,e,t){const s=t[t.length-1].context.version;i.setAttribute("wildCard",e.wildCard),i.setAttribute("singleChar",e.singleChar),i.setAttribute("escapeChar",e.escapeChar),e.matchCase!==void 0&&i.setAttribute("matchCase",e.matchCase.toString()),vr(s,i,e.propertyName),ki(s,i,""+e.pattern)}function zi(i,e,t,r){const n=X(i,e);q(n,r),t.appendChild(n)}function ki(i,e,t){zi(fn(i),"Literal",e,t)}function vr(i,e,t){i==="2.0.0"?zi(zs[i],"ValueReference",e,t):zi(Bs[i],"PropertyName",e,t)}function ha(i,e){const t=X(bt,"TimeInstant");i.appendChild(t);const r=X(bt,"timePosition");t.appendChild(r),q(r,e)}function fa(i,e,t){const r=t[t.length-1],n=Object.assign({},r);n.node=i,de(n,hn,Ze("Query"),e,t)}function fn(i){let e;return i==="2.0.0"?e=zs[i]:e=Bs[i],e}const ue={POINT:1,LINE_STRING:2,POLYGON:3,MULTI_POINT:4,MULTI_LINE_STRING:5,MULTI_POLYGON:6,GEOMETRY_COLLECTION:7,POLYHEDRAL_SURFACE:15,TIN:16,TRIANGLE:17};class da{constructor(e){this.view_=e,this.pos_=0,this.initialized_=!1,this.isLittleEndian_=!1,this.hasZ_=!1,this.hasM_=!1,this.srid_=null,this.layout_="XY"}readUint8(){return this.view_.getUint8(this.pos_++)}readUint32(e){return this.view_.getUint32((this.pos_+=4)-4,e!==void 0?e:this.isLittleEndian_)}readDouble(e){return this.view_.getFloat64((this.pos_+=8)-8,e!==void 0?e:this.isLittleEndian_)}readPoint(){const e=[];return e.push(this.readDouble()),e.push(this.readDouble()),this.hasZ_&&e.push(this.readDouble()),this.hasM_&&e.push(this.readDouble()),e}readLineString(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readPoint());return t}readPolygon(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readLineString());return t}readWkbHeader(e){const r=this.readUint8()>0,n=this.readUint32(r),s=Math.floor((n&268435455)/1e3),o=!!(n&2147483648)||s===1||s===3,a=!!(n&1073741824)||s===2||s===3,c=!!(n&536870912),l=(n&268435455)%1e3,u=["XY",o?"Z":"",a?"M":""].join(""),h=c?this.readUint32(r):null;if(e!==void 0&&e!==l)throw new Error("Unexpected WKB geometry type "+l);if(this.initialized_){if(this.isLittleEndian_!==r)throw new Error("Inconsistent endian");if(this.layout_!==u)throw new Error("Inconsistent geometry layout");if(h&&this.srid_!==h)throw new Error("Inconsistent coordinate system (SRID)")}else this.isLittleEndian_=r,this.hasZ_=o,this.hasM_=a,this.layout_=u,this.srid_=h,this.initialized_=!0;return l}readWkbPayload(e){switch(e){case ue.POINT:return this.readPoint();case ue.LINE_STRING:return this.readLineString();case ue.POLYGON:case ue.TRIANGLE:return this.readPolygon();case ue.MULTI_POINT:return this.readMultiPoint();case ue.MULTI_LINE_STRING:return this.readMultiLineString();case ue.MULTI_POLYGON:case ue.POLYHEDRAL_SURFACE:case ue.TIN:return this.readMultiPolygon();case ue.GEOMETRY_COLLECTION:return this.readGeometryCollection();default:throw new Error("Unsupported WKB geometry type "+e+" is found")}}readWkbBlock(e){return this.readWkbPayload(this.readWkbHeader(e))}readWkbCollection(e,t){const r=this.readUint32(),n=[];for(let s=0;s<r;s++){const o=e.call(this,t);o&&n.push(o)}return n}readMultiPoint(){return this.readWkbCollection(this.readWkbBlock,ue.POINT)}readMultiLineString(){return this.readWkbCollection(this.readWkbBlock,ue.LINE_STRING)}readMultiPolygon(){return this.readWkbCollection(this.readWkbBlock,ue.POLYGON)}readGeometryCollection(){return this.readWkbCollection(this.readGeometry)}readGeometry(){const e=this.readWkbHeader(),t=this.readWkbPayload(e);switch(e){case ue.POINT:return new Qe(t,this.layout_);case ue.LINE_STRING:return new pt(t,this.layout_);case ue.POLYGON:case ue.TRIANGLE:return new Ht(t,this.layout_);case ue.MULTI_POINT:return new tn(t,this.layout_);case ue.MULTI_LINE_STRING:return new xr(t,this.layout_);case ue.MULTI_POLYGON:case ue.POLYHEDRAL_SURFACE:case ue.TIN:return new Jr(t,this.layout_);case ue.GEOMETRY_COLLECTION:return new Mt(t);default:return null}}getSrid(){return this.srid_}}class bg{constructor(e){e=e||{},this.layout_=e.layout,this.isLittleEndian_=e.littleEndian!==!1,this.isEWKB_=e.ewkb!==!1,this.writeQueue_=[],this.nodata_=Object.assign({X:0,Y:0,Z:0,M:0},e.nodata)}writeUint8(e){this.writeQueue_.push([1,e])}writeUint32(e){this.writeQueue_.push([4,e])}writeDouble(e){this.writeQueue_.push([8,e])}writePoint(e,t){const r=Object.assign.apply(null,t.split("").map((n,s)=>({[n]:e[s]})));for(const n of this.layout_)this.writeDouble(n in r?r[n]:this.nodata_[n])}writeLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writePoint(e[r],t)}writePolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeLineString(e[r],t)}writeWkbHeader(e,t){e%=1e3,this.layout_.includes("Z")&&(e+=this.isEWKB_?2147483648:1e3),this.layout_.includes("M")&&(e+=this.isEWKB_?1073741824:2e3),this.isEWKB_&&Number.isInteger(t)&&(e|=536870912),this.writeUint8(this.isLittleEndian_?1:0),this.writeUint32(e),this.isEWKB_&&Number.isInteger(t)&&this.writeUint32(t)}writeMultiPoint(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(1),this.writePoint(e[r],t)}writeMultiLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(2),this.writeLineString(e[r],t)}writeMultiPolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(3),this.writePolygon(e[r],t)}writeGeometryCollection(e){this.writeUint32(e.length);for(let t=0;t<e.length;t++)this.writeGeometry(e[t])}findMinimumLayout(e,t="XYZM"){const r=(n,s)=>n===s?n:n==="XYZM"?s:s==="XYZM"?n:"XY";if(e instanceof Co)return r(e.getLayout(),t);if(e instanceof Mt){const n=e.getGeometriesArray();for(let s=0;s<n.length&&t!=="XY";s++)t=this.findMinimumLayout(n[s],t)}return t}writeGeometry(e,t){const r={Point:ue.POINT,LineString:ue.LINE_STRING,Polygon:ue.POLYGON,MultiPoint:ue.MULTI_POINT,MultiLineString:ue.MULTI_LINE_STRING,MultiPolygon:ue.MULTI_POLYGON,GeometryCollection:ue.GEOMETRY_COLLECTION},n=e.getType(),s=r[n];if(!s)throw new Error("GeometryType "+n+" is not supported");this.layout_||(this.layout_=this.findMinimumLayout(e)),this.writeWkbHeader(s,t),e instanceof Co?{Point:this.writePoint,LineString:this.writeLineString,Polygon:this.writePolygon,MultiPoint:this.writeMultiPoint,MultiLineString:this.writeMultiLineString,MultiPolygon:this.writeMultiPolygon}[n].call(this,e.getCoordinates(),e.getLayout()):e instanceof Mt&&this.writeGeometryCollection(e.getGeometriesArray())}getBuffer(){const e=this.writeQueue_.reduce((s,o)=>s+o[0],0),t=new ArrayBuffer(e),r=new DataView(t);let n=0;return this.writeQueue_.forEach(s=>{switch(s[0]){case 1:r.setUint8(n,s[1]);break;case 4:r.setUint32(n,s[1],this.isLittleEndian_);break;case 8:r.setFloat64(n,s[1],this.isLittleEndian_);break}n+=s[0]}),t}}class Tg extends nl{constructor(e){super(),e=e||{},this.splitCollection=!!e.splitCollection,this.viewCache_=null,this.hex_=e.hex!==!1,this.littleEndian_=e.littleEndian!==!1,this.ewkb_=e.ewkb!==!1,this.layout_=e.geometryLayout,this.nodataZ_=e.nodataZ||0,this.nodataM_=e.nodataM||0,this.srid_=e.srid}getType(){return this.hex_?"text":"arraybuffer"}readFeature(e,t){return new je({geometry:this.readGeometry(e,t)})}readFeatures(e,t){let r=[];const n=this.readGeometry(e,t);return this.splitCollection&&n instanceof Mt?r=n.getGeometriesArray():r=[n],r.map(s=>new je({geometry:s}))}readGeometry(e,t){const r=ga(e);if(!r)return null;const s=new da(r).readGeometry();return this.viewCache_=r,t=this.getReadOptions(e,t),this.viewCache_=null,Ie(s,!1,t)}readProjection(e){const t=this.viewCache_||ga(e);if(!t)return;const r=new da(t);return r.readWkbHeader(),r.getSrid()&&se("EPSG:"+r.getSrid())||void 0}writeFeature(e,t){return this.writeGeometry(e.getGeometry(),t)}writeFeatures(e,t){return this.writeGeometry(new Mt(e.map(r=>r.getGeometry())),t)}writeGeometry(e,t){t=this.adaptOptions(t);const r=new bg({layout:this.layout_,littleEndian:this.littleEndian_,ewkb:this.ewkb_,nodata:{Z:this.nodataZ_,M:this.nodataM_}});let n=Number.isInteger(this.srid_)?Number(this.srid_):null;if(this.srid_!==!1&&!Number.isInteger(this.srid_)){const o=t.dataProjection&&se(t.dataProjection);if(o){const a=o.getCode();a.startsWith("EPSG:")&&(n=Number(a.substring(5)))}}r.writeGeometry(Ie(e,!0,t),n);const s=r.getBuffer();return this.hex_?wg(s):s}}function wg(i){const e=new Uint8Array(i);return Array.from(e.values()).map(t=>(t<16?"0":"")+Number(t).toString(16).toUpperCase()).join("")}function Sg(i){const e=new Uint8Array(i.length/2);for(let t=0;t<i.length/2;t++)e[t]=parseInt(i.substr(t*2,2),16);return new DataView(e.buffer)}function ga(i){return typeof i=="string"?Sg(i):ArrayBuffer.isView(i)?i instanceof DataView?i:new DataView(i.buffer,i.byteOffset,i.byteLength):i instanceof ArrayBuffer?new DataView(i):null}const Rg={POINT:Qe,LINESTRING:pt,POLYGON:Ht,MULTIPOINT:tn,MULTILINESTRING:xr,MULTIPOLYGON:Jr},Ml="EMPTY",Ol="Z",Nl="M",vg="ZM",le={START:0,TEXT:1,LEFT_PAREN:2,RIGHT_PAREN:3,NUMBER:4,COMMA:5,EOF:6},Pg={Point:"POINT",LineString:"LINESTRING",Polygon:"POLYGON",MultiPoint:"MULTIPOINT",MultiLineString:"MULTILINESTRING",MultiPolygon:"MULTIPOLYGON",GeometryCollection:"GEOMETRYCOLLECTION",Circle:"CIRCLE"};class Ag{constructor(e){this.wkt=e,this.index_=-1}isAlpha_(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}isNumeric_(e,t){return t=t!==void 0?t:!1,e>="0"&&e<="9"||e=="."&&!t}isWhiteSpace_(e){return e==" "||e=="	"||e=="\r"||e==`
`}nextChar_(){return this.wkt.charAt(++this.index_)}nextToken(){const e=this.nextChar_(),t=this.index_;let r=e,n;if(e=="(")n=le.LEFT_PAREN;else if(e==",")n=le.COMMA;else if(e==")")n=le.RIGHT_PAREN;else if(this.isNumeric_(e)||e=="-")n=le.NUMBER,r=this.readNumber_();else if(this.isAlpha_(e))n=le.TEXT,r=this.readText_();else{if(this.isWhiteSpace_(e))return this.nextToken();if(e==="")n=le.EOF;else throw new Error("Unexpected character: "+e)}return{position:t,value:r,type:n}}readNumber_(){let e;const t=this.index_;let r=!1,n=!1;do e=="."?r=!0:(e=="e"||e=="E")&&(n=!0),e=this.nextChar_();while(this.isNumeric_(e,r)||!n&&(e=="e"||e=="E")||n&&(e=="-"||e=="+"));return parseFloat(this.wkt.substring(t,this.index_--))}readText_(){let e;const t=this.index_;do e=this.nextChar_();while(this.isAlpha_(e));return this.wkt.substring(t,this.index_--).toUpperCase()}}class Lg{constructor(e){this.lexer_=e,this.token_={position:0,type:le.START},this.layout_="XY"}consume_(){this.token_=this.lexer_.nextToken()}isTokenType(e){return this.token_.type==e}match(e){const t=this.isTokenType(e);return t&&this.consume_(),t}parse(){return this.consume_(),this.parseGeometry_()}parseGeometryLayout_(){let e="XY";const t=this.token_;if(this.isTokenType(le.TEXT)){const r=t.value;r===Ol?e="XYZ":r===Nl?e="XYM":r===vg&&(e="XYZM"),e!=="XY"&&this.consume_()}return e}parseGeometryCollectionText_(){if(this.match(le.LEFT_PAREN)){const e=[];do e.push(this.parseGeometry_());while(this.match(le.COMMA));if(this.match(le.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePointText_(){if(this.match(le.LEFT_PAREN)){const e=this.parsePoint_();if(this.match(le.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseLineStringText_(){if(this.match(le.LEFT_PAREN)){const e=this.parsePointList_();if(this.match(le.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePolygonText_(){if(this.match(le.LEFT_PAREN)){const e=this.parseLineStringTextList_();if(this.match(le.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiPointText_(){if(this.match(le.LEFT_PAREN)){let e;if(this.token_.type==le.LEFT_PAREN?e=this.parsePointTextList_():e=this.parsePointList_(),this.match(le.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiLineStringText_(){if(this.match(le.LEFT_PAREN)){const e=this.parseLineStringTextList_();if(this.match(le.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiPolygonText_(){if(this.match(le.LEFT_PAREN)){const e=this.parsePolygonTextList_();if(this.match(le.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePoint_(){const e=[],t=this.layout_.length;for(let r=0;r<t;++r){const n=this.token_;if(this.match(le.NUMBER))e.push(n.value);else break}if(e.length==t)return e;throw new Error(this.formatErrorMessage_())}parsePointList_(){const e=[this.parsePoint_()];for(;this.match(le.COMMA);)e.push(this.parsePoint_());return e}parsePointTextList_(){const e=[this.parsePointText_()];for(;this.match(le.COMMA);)e.push(this.parsePointText_());return e}parseLineStringTextList_(){const e=[this.parseLineStringText_()];for(;this.match(le.COMMA);)e.push(this.parseLineStringText_());return e}parsePolygonTextList_(){const e=[this.parsePolygonText_()];for(;this.match(le.COMMA);)e.push(this.parsePolygonText_());return e}isEmptyGeometry_(){const e=this.isTokenType(le.TEXT)&&this.token_.value==Ml;return e&&this.consume_(),e}formatErrorMessage_(){return"Unexpected `"+this.token_.value+"` at position "+this.token_.position+" in `"+this.lexer_.wkt+"`"}parseGeometry_(){const e=this.token_;if(this.match(le.TEXT)){const t=e.value;this.layout_=this.parseGeometryLayout_();const r=this.isEmptyGeometry_();if(t=="GEOMETRYCOLLECTION"){if(r)return new Mt([]);const o=this.parseGeometryCollectionText_();return new Mt(o)}const n=Rg[t];if(!n)throw new Error("Invalid geometry type: "+t);let s;if(r)t=="POINT"?s=[NaN,NaN]:s=[];else switch(t){case"POINT":{s=this.parsePointText_();break}case"LINESTRING":{s=this.parseLineStringText_();break}case"POLYGON":{s=this.parsePolygonText_();break}case"MULTIPOINT":{s=this.parseMultiPointText_();break}case"MULTILINESTRING":{s=this.parseMultiLineStringText_();break}case"MULTIPOLYGON":{s=this.parseMultiPolygonText_();break}}return new n(s,this.layout_)}throw new Error(this.formatErrorMessage_())}}class Ig extends Ds{constructor(e){super(),e=e||{},this.splitCollection_=e.splitCollection!==void 0?e.splitCollection:!1}parse_(e){const t=new Ag(e);return new Lg(t).parse()}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t),n=new je;return n.setGeometry(r),n}readFeaturesFromText(e,t){let r=[];const n=this.readGeometryFromText(e,t);this.splitCollection_&&n.getType()=="GeometryCollection"?r=n.getGeometriesArray():r=[n];const s=[];for(let o=0,a=r.length;o<a;++o){const c=new je;c.setGeometry(r[o]),s.push(c)}return s}readGeometryFromText(e,t){const r=this.parse_(e);return Ie(r,!1,t)}writeFeatureText(e,t){const r=e.getGeometry();return r?this.writeGeometryText(r,t):""}writeFeaturesText(e,t){if(e.length==1)return this.writeFeatureText(e[0],t);const r=[];for(let s=0,o=e.length;s<o;++s)r.push(e[s].getGeometry());const n=new Mt(r);return this.writeGeometryText(n,t)}writeGeometryText(e,t){return Gl(Ie(e,!0,t))}}function Dl(i){const e=i.getCoordinates();return e.length===0?"":e.join(" ")}function Cg(i){const e=[],t=i.getPoints();for(let r=0,n=t.length;r<n;++r)e.push("("+Dl(t[r])+")");return e.join(",")}function Fg(i){const e=[],t=i.getGeometries();for(let r=0,n=t.length;r<n;++r)e.push(Gl(t[r]));return e.join(",")}function js(i){const e=i.getCoordinates(),t=[];for(let r=0,n=e.length;r<n;++r)t.push(e[r].join(" "));return t.join(",")}function Mg(i){const e=[],t=i.getLineStrings();for(let r=0,n=t.length;r<n;++r)e.push("("+js(t[r])+")");return e.join(",")}function Ul(i){const e=[],t=i.getLinearRings();for(let r=0,n=t.length;r<n;++r)e.push("("+js(t[r])+")");return e.join(",")}function Og(i){const e=[],t=i.getPolygons();for(let r=0,n=t.length;r<n;++r)e.push("("+Ul(t[r])+")");return e.join(",")}function Ng(i){const e=i.getLayout();let t="";return(e==="XYZ"||e==="XYZM")&&(t+=Ol),(e==="XYM"||e==="XYZM")&&(t+=Nl),t}const Dg={Point:Dl,LineString:js,Polygon:Ul,MultiPoint:Cg,MultiLineString:Mg,MultiPolygon:Og,GeometryCollection:Fg};function Gl(i){const e=i.getType(),t=Dg[e],r=t(i);let n=Pg[e];if(typeof i.getFlatCoordinates=="function"){const s=Ng(i);s.length>0&&(n+=" "+s)}return r.length===0?n+" "+Ml:n+"("+r+")"}const Se=[null,"http://www.opengis.net/wms"];function Pr(i){return Iu(i[0].version,"1.3")>=0}const Ug=M(Se,{Service:x(op),Capability:x(sp)}),Bl={Request:x(pp),Exception:x(up),Layer:x(hp)},Gg=M(Se,{...Bl,UserDefinedSymbolization:x(ip)}),Bg=M(Se,Bl);class zg extends Us{constructor(){super(),this.version=void 0}readFromNode(e){this.version=e.getAttribute("version").trim();const t=F({version:this.version},Ug,e,[]);return t||null}}const zl={Name:x(C),Title:x(C),Abstract:x(C),KeywordList:x(Wl),OnlineResource:x(Rr),ContactInformation:x(ap),Fees:x(C),AccessConstraints:x(C)},kg=M(Se,zl),$g=M(Se,{...zl,LayerLimit:x(xe),MaxWidth:x(xe),MaxHeight:x(xe)}),jg=M(Se,{ContactPersonPrimary:x(lp),ContactPosition:x(C),ContactAddress:x(cp),ContactVoiceTelephone:x(C),ContactFacsimileTelephone:x(C),ContactElectronicMailAddress:x(C)}),Vg=M(Se,{ContactPerson:x(C),ContactOrganization:x(C)}),Xg=M(Se,{AddressType:x(C),Address:x(C),City:x(C),StateOrProvince:x(C),PostCode:x(C),Country:x(C)}),Wg=M(Se,{Format:U(C)}),kl={Name:x(C),Title:x(C),Abstract:x(C),KeywordList:x(Wl),BoundingBox:ce(Vl),Dimension:ce(fp),Attribution:x(rp),AuthorityURL:ce(yp),Identifier:ce(C),MetadataURL:ce(Ep),DataURL:ce(wt),FeatureListURL:ce(wt),Style:ce(xp),Layer:ce(dn)},$l=M(Se,{...kl,SRS:ce(C),Extent:x(dp),ScaleHint:ce(gp),LatLonBoundingBox:x((i,e)=>Vl(i,e,!1)),Layer:ce(dn)}),jl=M(Se,{...kl,CRS:ce(C),EX_GeographicBoundingBox:x(np),MinScaleDenominator:x(Ue),MaxScaleDenominator:x(Ue),Layer:ce(dn)}),Hg=M(Se,{Title:x(C),OnlineResource:x(Rr),LogoURL:x(Xl)}),Zg=M(Se,{westBoundLongitude:x(Ue),eastBoundLongitude:x(Ue),southBoundLatitude:x(Ue),northBoundLatitude:x(Ue)}),Yg=M(Se,{GetCapabilities:x(Sn),GetMap:x(Sn),GetFeatureInfo:x(Sn)}),qg=M(Se,{Format:ce(C),DCPType:ce(mp)}),Kg=M(Se,{HTTP:x(_p)}),Jg=M(Se,{Get:x(wt),Post:x(wt)}),Qg=M(Se,{Name:x(C),Title:x(C),Abstract:x(C),LegendURL:ce(Xl),StyleSheetURL:x(wt),StyleURL:x(wt)}),ep=M(Se,{Format:x(C),OnlineResource:x(Rr)}),tp=M(Se,{Keyword:U(C)});function rp(i,e){return F({},Hg,i,e)}function ip(i,e){return{SupportSLD:!!it(i.getAttribute("UserDefinedSymbolization")),UserLayer:!!it(i.getAttribute("UserLayer")),UserStyle:!!it(i.getAttribute("UserStyle")),RemoteWFS:!!it(i.getAttribute("RemoteWFS"))}}function Vl(i,e,t=!0){const r=[dt(i.getAttribute("minx")),dt(i.getAttribute("miny")),dt(i.getAttribute("maxx")),dt(i.getAttribute("maxy"))],n=[dt(i.getAttribute("resx")),dt(i.getAttribute("resy"))],s={extent:r,res:n};return t&&(Pr(e)?s.crs=i.getAttribute("CRS"):s.srs=i.getAttribute("SRS")),s}function np(i,e){const t=F({},Zg,i,e);if(!t)return;const r=t.westBoundLongitude,n=t.southBoundLatitude,s=t.eastBoundLongitude,o=t.northBoundLatitude;if(!(r===void 0||n===void 0||s===void 0||o===void 0))return[r,n,s,o]}function sp(i,e){return F({},Pr(e)?Bg:Gg,i,e)}function op(i,e){return F({},Pr(e)?$g:kg,i,e)}function ap(i,e){return F({},jg,i,e)}function lp(i,e){return F({},Vg,i,e)}function cp(i,e){return F({},Xg,i,e)}function up(i,e){return F([],Wg,i,e)}function hp(i,e){const t=F({},Pr(e)?jl:$l,i,e);return t.Layer===void 0?Object.assign(t,dn(i,e)):t}function dn(i,e){const t=Pr(e),r=e[e.length-1],n=F({},t?jl:$l,i,e);if(!n)return;let s=it(i.getAttribute("queryable"));s===void 0&&(s=r.queryable),n.queryable=s!==void 0?s:!1;let o=Lt(i.getAttribute("cascaded"));o===void 0&&(o=r.cascaded),n.cascaded=o;let a=it(i.getAttribute("opaque"));a===void 0&&(a=r.opaque),n.opaque=a!==void 0?a:!1;let c=it(i.getAttribute("noSubsets"));c===void 0&&(c=r.noSubsets),n.noSubsets=c!==void 0?c:!1;let l=dt(i.getAttribute("fixedWidth"));l||(l=r.fixedWidth),n.fixedWidth=l;let u=dt(i.getAttribute("fixedHeight"));u||(u=r.fixedHeight),n.fixedHeight=u;const h=["Style","AuthorityURL"];t?h.push("CRS"):h.push("SRS","Dimension"),h.forEach(function(d){if(d in r){const g=n[d]||[];n[d]=g.concat(r[d])}});const f=["BoundingBox","Attribution"];return t?f.push("Dimension","EX_GeographicBoundingBox","MinScaleDenominator","MaxScaleDenominator"):f.push("LatLonBoundingBox","ScaleHint","Extent"),f.forEach(function(d){if(!(d in n)){const g=r[d];n[d]=g}}),n}function fp(i,e){const t={name:i.getAttribute("name"),units:i.getAttribute("units"),unitSymbol:i.getAttribute("unitSymbol")};return Pr(e)&&Object.assign(t,{default:i.getAttribute("default"),multipleValues:it(i.getAttribute("multipleValues")),nearestValue:it(i.getAttribute("nearestValue")),current:it(i.getAttribute("current")),values:C(i)}),t}function dp(i,e){return{name:i.getAttribute("name"),default:i.getAttribute("default"),nearestValue:it(i.getAttribute("nearestValue"))}}function gp(i,e){return{min:dt(i.getAttribute("min")),max:dt(i.getAttribute("max"))}}function wt(i,e){return F({},ep,i,e)}function pp(i,e){return F({},Yg,i,e)}function mp(i,e){return F({},Kg,i,e)}function _p(i,e){return F({},Jg,i,e)}function Sn(i,e){return F({},qg,i,e)}function Xl(i,e){const t=wt(i,e);if(t){const r=[Lt(i.getAttribute("width")),Lt(i.getAttribute("height"))];return t.size=r,t}}function yp(i,e){const t=wt(i,e);if(t)return t.name=i.getAttribute("name"),t}function Ep(i,e){const t=wt(i,e);if(t)return t.type=i.getAttribute("type"),t}function xp(i,e){return F({},Qg,i,e)}function Wl(i,e){return F([],tp,i,e)}const bp="_feature",Tp="_layer";class wp extends rn{constructor(e){super(),e=e||{},this.featureNS_="http://mapserver.gis.umn.edu/mapserver",this.gmlFormat_=new Y,this.layers_=e.layers?e.layers:null}getLayers(){return this.layers_}setLayers(e){this.layers_=e}readFeatures_(e,t){e.setAttribute("namespaceURI",this.featureNS_);const r=e.localName;let n=[];if(e.childNodes.length===0)return n;if(r=="msGMLOutput")for(let s=0,o=e.childNodes.length;s<o;s++){const a=e.childNodes[s];if(a.nodeType!==Node.ELEMENT_NODE)continue;const c=a,l=t[0],u=Tp,h=c.localName.replace(u,"");if(this.layers_&&!this.layers_.includes(h))continue;const f=h+bp;l.featureType=f,l.featureNS=this.featureNS_;const d={};d[f]=U(this.gmlFormat_.readFeatureElement,this.gmlFormat_);const g=M([l.featureNS,null],d);c.setAttribute("namespaceURI",this.featureNS_);const p=F([],g,c,t,this.gmlFormat_);p&&Ii(n,p)}if(r=="FeatureCollection"){const s=F([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,e,[{}],this.gmlFormat_);s&&(n=s)}return n}readFeaturesFromNode(e,t){const r={};return t&&Object.assign(r,this.getReadOptions(e,t)),this.readFeatures_(e,[r])}}const mt=[null,"http://www.opengis.net/wmts/1.0"],Ar=[null,"http://www.opengis.net/ows/1.1"],Sp=M(mt,{Contents:x(Op)});let Vs=class extends Us{constructor(){super(),this.owsParser_=new Al}readFromNode(e){let t=e.getAttribute("version");t&&(t=t.trim());let r=this.owsParser_.readFromNode(e);return r?(r.version=t,r=F(r,Sp,e,[]),r||null):null}};const Rp=M(mt,{Layer:ce(Np),TileMatrixSet:ce(Dp)}),vp=M(mt,{Style:ce(Up),Format:ce(C),TileMatrixSetLink:ce(Gp),Dimension:ce(Bp),ResourceURL:ce(zp)},M(Ar,{Title:x(C),Abstract:x(C),WGS84BoundingBox:x(Zl),BoundingBox:ce(kp),Identifier:x(C)})),Pp=M(mt,{LegendURL:ce($p)},M(Ar,{Title:x(C),Identifier:x(C)})),Ap=M(mt,{TileMatrixSet:x(C),TileMatrixSetLimits:x(Vp)}),Lp=M(mt,{TileMatrixLimits:U(Xp)}),Ip=M(mt,{TileMatrix:x(C),MinTileRow:x(xe),MaxTileRow:x(xe),MinTileCol:x(xe),MaxTileCol:x(xe)}),Cp=M(mt,{Default:x(C),Value:ce(C)},M(Ar,{Identifier:x(C)})),Hl=M(Ar,{LowerCorner:U(Yn),UpperCorner:U(Yn)}),Fp=M(mt,{WellKnownScaleSet:x(C),TileMatrix:ce(jp)},M(Ar,{SupportedCRS:x(C),Identifier:x(C),BoundingBox:x(Zl)})),Mp=M(mt,{TopLeftCorner:x(Yn),ScaleDenominator:x(Ue),TileWidth:x(xe),TileHeight:x(xe),MatrixWidth:x(xe),MatrixHeight:x(xe)},M(Ar,{Identifier:x(C)}));function Op(i,e){return F({},Rp,i,e)}function Np(i,e){return F({},vp,i,e)}function Dp(i,e){return F({},Fp,i,e)}function Up(i,e){const t=F({},Pp,i,e);if(!t)return;const r=i.getAttribute("isDefault")==="true";return t.isDefault=r,t}function Gp(i,e){return F({},Ap,i,e)}function Bp(i,e){return F({},Cp,i,e)}function zp(i,e){const t=i.getAttribute("format"),r=i.getAttribute("template"),n=i.getAttribute("resourceType"),s={};return t&&(s.format=t),r&&(s.template=r),n&&(s.resourceType=n),s}function Zl(i,e){const t=F([],Hl,i,e);if(t.length==2)return gs(t)}function kp(i,e){const t=i.getAttribute("crs"),r=F([],Hl,i,e);if(r.length==2)return{extent:gs(r),crs:t}}function $p(i,e){const t={};return t.format=i.getAttribute("format"),t.href=Rr(i),t}function Yn(i,e){const t=C(i).split(/\s+/);if(!t||t.length!=2)return;const r=+t[0],n=+t[1];if(!(isNaN(r)||isNaN(n)))return[r,n]}function jp(i,e){return F({},Mp,i,e)}function Vp(i,e){return F([],Lp,i,e)}function Xp(i,e){return F({},Ip,i,e)}window.eoxMapAdvancedOlFormats={EsriJSON:sf,GML:Cs,GPX:Ff,IGC:gd,IIIFInfo:xd,KML:Fu,OWS:Al,Polyline:qd,TopoJSON:Cu,WFS:pg,WKB:Tg,WKT:Ig,WMSCapabilities:zg,WMSGetFeatureInfo:wp,WMTSCapabilities:Vs};function Yl(i,e,t){const r=[];let n=i(0),s=i(1),o=e(n),a=e(s);const c=[s,n],l=[a,o],u=[1,0],h={};let f=1e5,d,g,p,m,y,_;for(;--f>0&&u.length>0;)p=u.pop(),n=c.pop(),o=l.pop(),_=p.toString(),_ in h||(r.push(o[0],o[1]),h[_]=!0),m=u.pop(),s=c.pop(),a=l.pop(),y=(p+m)/2,d=i(y),g=e(d),Mu(g[0],g[1],o[0],o[1],a[0],a[1])<t?(r.push(a[0],a[1]),_=m.toString(),h[_]=!0):(u.push(m,y,y,p),l.push(a,g,g,o),c.push(s,d,d,n));return r}function Wp(i,e,t,r,n){const s=se("EPSG:4326");return Yl(function(o){return[i,e+(t-e)*o]},Oi(s,r),n)}function Hp(i,e,t,r,n){const s=se("EPSG:4326");return Yl(function(o){return[e+(t-e)*o,i]},Oi(s,r),n)}function Zp(i){if(!(i.context instanceof CanvasRenderingContext2D))throw new Error("Only works for render events from Canvas 2D layers");const e=i.inversePixelTransform[0],t=i.inversePixelTransform[1],r=Math.sqrt(e*e+t*t),n=i.frameState,s=jr(i.inversePixelTransform.slice(),n.coordinateToPixelTransform),o=Ou(n.viewState.resolution,r);let a;return new Nu(i.context,r,n.extent,s,n.viewState.rotation,o,a)}const Yp=new Ni({color:"rgba(0,0,0,0.2)"}),qp=[90,45,30,20,10,5,2,1,30/60,20/60,10/60,5/60,2/60,1/60,30/3600,20/3600,10/3600,5/3600,2/3600,1/3600];class Kp extends sl{constructor(e){e=e||{};const t=Object.assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},e);delete t.maxLines,delete t.strokeStyle,delete t.targetSize,delete t.showLabels,delete t.lonLabelFormatter,delete t.latLabelFormatter,delete t.lonLabelPosition,delete t.latLabelPosition,delete t.lonLabelStyle,delete t.latLabelStyle,delete t.intervals,super(t),this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.maxX_=1/0,this.maxY_=1/0,this.minX_=-1/0,this.minY_=-1/0,this.targetSize_=e.targetSize!==void 0?e.targetSize:100,this.maxLines_=e.maxLines!==void 0?e.maxLines:100,this.meridians_=[],this.parallels_=[],this.strokeStyle_=e.strokeStyle!==void 0?e.strokeStyle:Yp,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.bottomLeft_=null,this.bottomRight_=null,this.topLeft_=null,this.topRight_=null,this.meridiansLabels_=null,this.parallelsLabels_=null,e.showLabels&&(this.lonLabelFormatter_=e.lonLabelFormatter==null?Fo.bind(this,"EW"):e.lonLabelFormatter,this.latLabelFormatter_=e.latLabelFormatter==null?Fo.bind(this,"NS"):e.latLabelFormatter,this.lonLabelPosition_=e.lonLabelPosition==null?0:e.lonLabelPosition,this.latLabelPosition_=e.latLabelPosition==null?1:e.latLabelPosition,this.lonLabelStyleBase_=new Si({text:e.lonLabelStyle!==void 0?e.lonLabelStyle.clone():new Mo({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new Di({color:"rgba(0,0,0,1)"}),stroke:new Ni({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=r=>{const n=r.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(n),this.lonLabelStyleBase_},this.latLabelStyleBase_=new Si({text:e.latLabelStyle!==void 0?e.latLabelStyle.clone():new Mo({font:"12px Calibri,sans-serif",textAlign:"right",fill:new Di({color:"rgba(0,0,0,1)"}),stroke:new Ni({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=r=>{const n=r.get("graticule_label");return this.latLabelStyleBase_.getText().setText(n),this.latLabelStyleBase_},this.meridiansLabels_=[],this.parallelsLabels_=[],this.addEventListener(jt.POSTRENDER,this.drawLabels_.bind(this))),this.intervals_=e.intervals!==void 0?e.intervals:qp,this.setSource(new sn({loader:this.loaderFunction.bind(this),strategy:this.strategyFunction.bind(this),features:new Du,overlaps:!1,useSpatialIndex:!1,wrapX:e.wrapX})),this.featurePool_=[],this.lineStyle_=new Si({stroke:this.strokeStyle_}),this.loadedExtent_=null,this.renderedExtent_=null,this.renderedResolution_=null,this.setRenderOrder(null)}strategyFunction(e,t){let r=e.slice();return this.projection_&&this.getSource().getWrapX()&&Uu(r,this.projection_),this.loadedExtent_&&(Gu(this.loadedExtent_,r,t)?r=this.loadedExtent_.slice():this.getSource().removeLoadedExtent(this.loadedExtent_)),[r]}loaderFunction(e,t,r){this.loadedExtent_=e;const n=this.getSource(),s=this.getExtent()||[-1/0,-1/0,1/0,1/0],o=gt(s,e);if(this.renderedExtent_&&Vr(this.renderedExtent_,o)&&this.renderedResolution_===t||(this.renderedExtent_=o,this.renderedResolution_=t,on(o)))return;const a=Ft(o),c=t*t/4;(!this.projection_||!Ri(this.projection_,r))&&this.updateProjectionInfo_(r),this.createGraticule_(o,a,t,c);let u=this.meridians_.length+this.parallels_.length;this.meridiansLabels_&&(u+=this.meridians_.length),this.parallelsLabels_&&(u+=this.parallels_.length);let h;for(;u>this.featurePool_.length;)h=new je,this.featurePool_.push(h);const f=n.getFeaturesCollection();f.clear();let d=0,g,p;for(g=0,p=this.meridians_.length;g<p;++g)h=this.featurePool_[d++],h.setGeometry(this.meridians_[g]),h.setStyle(this.lineStyle_),f.push(h);for(g=0,p=this.parallels_.length;g<p;++g)h=this.featurePool_[d++],h.setGeometry(this.parallels_[g]),h.setStyle(this.lineStyle_),f.push(h)}addMeridian_(e,t,r,n,s,o){const a=this.getMeridian_(e,t,r,n,o);if(gr(a.getExtent(),s)){if(this.meridiansLabels_){const c=this.lonLabelFormatter_(e);o in this.meridiansLabels_?this.meridiansLabels_[o].text=c:this.meridiansLabels_[o]={geom:new Qe([]),text:c}}this.meridians_[o++]=a}return o}addParallel_(e,t,r,n,s,o){const a=this.getParallel_(e,t,r,n,o);if(gr(a.getExtent(),s)){if(this.parallelsLabels_){const c=this.latLabelFormatter_(e);o in this.parallelsLabels_?this.parallelsLabels_[o].text=c:this.parallelsLabels_[o]={geom:new Qe([]),text:c}}this.parallels_[o++]=a}return o}drawLabels_(e){const t=e.frameState.viewState.rotation,r=e.frameState.viewState.resolution,n=e.frameState.size,s=e.frameState.extent,o=Ft(s);let a=s;if(t){const g=n[0]*r,p=n[1]*r;a=[o[0]-g/2,o[1]-p/2,o[0]+g/2,o[1]+p/2]}let c=0,l=0,u=this.latLabelPosition_<.5;const h=this.projection_.getExtent(),f=Me(h);if(this.getSource().getWrapX()&&this.projection_.canWrapX()&&!Ai(h,s)){c=Math.floor((s[0]-h[0])/f),l=Math.ceil((s[2]-h[2])/f);const g=Math.abs(t)>Math.PI/2;u=u!==g}const d=Zp(e);for(let g=c;g<=l;++g){let p=this.meridians_.length+this.parallels_.length,m,y,_,E;if(this.meridiansLabels_)for(y=0,_=this.meridiansLabels_.length;y<_;++y){const w=this.meridians_[y];if(!t&&g===0)E=this.getMeridianPoint_(w,s,y);else{const S=w.clone();S.translate(g*f,0),S.rotate(-t,o),E=this.getMeridianPoint_(S,a,y),E.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(E),m.set("graticule_label",this.meridiansLabels_[y].text),d.drawFeature(m,this.lonLabelStyle_(m))}if(this.parallelsLabels_&&(g===c&&u||g===l&&!u))for(y=0,_=this.parallels_.length;y<_;++y){const w=this.parallels_[y];if(!t&&g===0)E=this.getParallelPoint_(w,s,y);else{const S=w.clone();S.translate(g*f,0),S.rotate(-t,o),E=this.getParallelPoint_(S,a,y),E.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(E),m.set("graticule_label",this.parallelsLabels_[y].text),d.drawFeature(m,this.latLabelStyle_(m))}}}createGraticule_(e,t,r,n){const s=this.getInterval_(r);if(s==-1){this.meridians_.length=0,this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),this.parallelsLabels_&&(this.parallelsLabels_.length=0);return}let o=!1;const a=this.projection_.getExtent(),c=Me(a);this.getSource().getWrapX()&&this.projection_.canWrapX()&&!Ai(a,e)&&(Me(e)>=c?(e[0]=a[0],e[2]=a[2]):o=!0);const l=[Ee(t[0],this.minX_,this.maxX_),Ee(t[1],this.minY_,this.maxY_)],u=this.toLonLatTransform_(l);isNaN(u[1])&&(u[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_);let h=Ee(u[0],this.minLon_,this.maxLon_),f=Ee(u[1],this.minLat_,this.maxLat_);const d=this.maxLines_;let g,p,m,y,_=e;o||(_=[Ee(e[0],this.minX_,this.maxX_),Ee(e[1],this.minY_,this.maxY_),Ee(e[2],this.minX_,this.maxX_),Ee(e[3],this.minY_,this.maxY_)]);const E=pr(_,this.toLonLatTransform_,void 0,8);let w=E[3],S=E[2],T=E[1],v=E[0];if(o||(cr(_,this.bottomLeft_)&&(v=this.minLon_,T=this.minLat_),cr(_,this.bottomRight_)&&(S=this.maxLon_,T=this.minLat_),cr(_,this.topLeft_)&&(v=this.minLon_,w=this.maxLat_),cr(_,this.topRight_)&&(S=this.maxLon_,w=this.maxLat_),w=Ee(w,f,this.maxLat_),S=Ee(S,h,this.maxLon_),T=Ee(T,this.minLat_,f),v=Ee(v,this.minLon_,h)),h=Math.floor(h/s)*s,y=Ee(h,this.minLon_,this.maxLon_),p=this.addMeridian_(y,T,w,n,e,0),g=0,o)for(;(y-=s)>=v&&g++<d;)p=this.addMeridian_(y,T,w,n,e,p);else for(;y!=this.minLon_&&g++<d;)y=Math.max(y-s,this.minLon_),p=this.addMeridian_(y,T,w,n,e,p);if(y=Ee(h,this.minLon_,this.maxLon_),g=0,o)for(;(y+=s)<=S&&g++<d;)p=this.addMeridian_(y,T,w,n,e,p);else for(;y!=this.maxLon_&&g++<d;)y=Math.min(y+s,this.maxLon_),p=this.addMeridian_(y,T,w,n,e,p);for(this.meridians_.length=p,this.meridiansLabels_&&(this.meridiansLabels_.length=p),f=Math.floor(f/s)*s,m=Ee(f,this.minLat_,this.maxLat_),p=this.addParallel_(m,v,S,n,e,0),g=0;m!=this.minLat_&&g++<d;)m=Math.max(m-s,this.minLat_),p=this.addParallel_(m,v,S,n,e,p);for(m=Ee(f,this.minLat_,this.maxLat_),g=0;m!=this.maxLat_&&g++<d;)m=Math.min(m+s,this.maxLat_),p=this.addParallel_(m,v,S,n,e,p);this.parallels_.length=p,this.parallelsLabels_&&(this.parallelsLabels_.length=p)}getInterval_(e){const t=this.projectionCenterLonLat_[0],r=this.projectionCenterLonLat_[1];let n=-1;const s=Math.pow(this.targetSize_*e,2),o=[],a=[];for(let c=0,l=this.intervals_.length;c<l;++c){const u=Ee(this.intervals_[c]/2,0,90),h=Ee(r,-90+u,90-u);if(o[0]=t-u,o[1]=h-u,a[0]=t+u,a[1]=h+u,this.fromLonLatTransform_(o,o),this.fromLonLatTransform_(a,a),Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2)<=s)break;n=this.intervals_[c]}return n}getMeridian_(e,t,r,n,s){const o=Wp(e,t,r,this.projection_,n);let a=this.meridians_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):(a=new pt(o,"XY"),this.meridians_[s]=a),a}getMeridianPoint_(e,t,r){const n=e.getFlatCoordinates();let s=1,o=n.length-1;n[s]>n[o]&&(s=o,o=1);const a=Math.max(t[1],n[s]),c=Math.min(t[3],n[o]),l=Ee(t[1]+Math.abs(t[1]-t[3])*this.lonLabelPosition_,a,c),h=[n[s-1]+(n[o-1]-n[s-1])*(l-n[s])/(n[o]-n[s]),l],f=this.meridiansLabels_[r].geom;return f.setCoordinates(h),f}getMeridians(){return this.meridians_}getParallel_(e,t,r,n,s){const o=Hp(e,t,r,this.projection_,n);let a=this.parallels_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):a=new pt(o,"XY"),a}getParallelPoint_(e,t,r){const n=e.getFlatCoordinates();let s=0,o=n.length-2;n[s]>n[o]&&(s=o,o=0);const a=Math.max(t[0],n[s]),c=Math.min(t[2],n[o]),l=Ee(t[0]+Math.abs(t[0]-t[2])*this.latLabelPosition_,a,c),u=n[s+1]+(n[o+1]-n[s+1])*(l-n[s])/(n[o]-n[s]),h=[l,u],f=this.parallelsLabels_[r].geom;return f.setCoordinates(h),f}getParallels(){return this.parallels_}updateProjectionInfo_(e){const t=se("EPSG:4326"),r=e.getWorldExtent();this.maxLat_=r[3],this.maxLon_=r[2],this.minLat_=r[1],this.minLon_=r[0];const n=Oi(e,t);if(this.minLon_<this.maxLon_)this.toLonLatTransform_=n;else{const o=this.minLon_+this.maxLon_/2;this.maxLon_+=360,this.toLonLatTransform_=function(a,c,l){l=l||2;const u=n(a,c,l);for(let h=0,f=u.length;h<f;h+=l)u[h]<o&&(u[h]+=360);return u}}this.fromLonLatTransform_=Oi(t,e);const s=pr([this.minLon_,this.minLat_,this.maxLon_,this.maxLat_],this.fromLonLatTransform_,void 0,8);this.minX_=s[0],this.maxX_=s[2],this.minY_=s[1],this.maxY_=s[3],this.bottomLeft_=this.fromLonLatTransform_([this.minLon_,this.minLat_]),this.bottomRight_=this.fromLonLatTransform_([this.maxLon_,this.minLat_]),this.topLeft_=this.fromLonLatTransform_([this.minLon_,this.maxLat_]),this.topRight_=this.fromLonLatTransform_([this.maxLon_,this.maxLat_]),this.projectionCenterLonLat_=this.toLonLatTransform_(Ft(e.getExtent())),isNaN(this.projectionCenterLonLat_[1])&&(this.projectionCenterLonLat_[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_),this.projection_=e}}const Ur={GENERATE_POLYGON_BUFFERS:"GENERATE_POLYGON_BUFFERS",GENERATE_POINT_BUFFERS:"GENERATE_POINT_BUFFERS",GENERATE_LINE_STRING_BUFFERS:"GENERATE_LINE_STRING_BUFFERS"},pa=.985;function ql(i,e){e=e||[];const t=256,r=t-1;return e[0]=Math.floor(i/t/t/t)/r,e[1]=Math.floor(i/t/t)%t/r,e[2]=Math.floor(i/t)%t/r,e[3]=i%t/r,e}function Kl(i){let e=0;const t=256,r=t-1;return e+=Math.round(i[0]*t*t*t*r),e+=Math.round(i[1]*t*t*r),e+=Math.round(i[2]*t*r),e+=Math.round(i[3]*r),e}function Jp(i){const e=Array.isArray(i)?i:[i];if("style"in e[0]){const t=[],r=e,n=[];for(const s of r){const o=Array.isArray(s.style)?s.style:[s.style];let a=s.filter;s.else&&n.length&&(a=["all",...n.map(l=>["!",l])],s.filter&&a.push(s.filter),a.length<3&&(a=a[1])),s.filter&&n.push(s.filter);const c=o.map(l=>({style:l,...a&&{filter:a}}));t.push(...c)}return t}return"builder"in e[0]?e:e.map(t=>({style:t}))}const ri=34962,ii=34963,Xs=35044,$i=35048,Qp=5121,em=5123,tm=5125,Jl=5126,ma=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function rm(i,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!Bu},e);const t=ma.length;for(let r=0;r<t;++r)try{const n=i.getContext(ma[r],e);if(n)return n}catch{}return null}const im={STATIC_DRAW:Xs};class mr{constructor(e,t){this.array_=null,this.type_=e,et(e===ri||e===ii,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:im.STATIC_DRAW}ofSize(e){return this.array_=new(yi(this.type_))(e),this}fromArray(e){return this.array_=yi(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(yi(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=yi(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function yi(i){switch(i){case ri:return Float32Array;case ii:return Uint32Array;default:return Float32Array}}function Qt(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function ji(i,e){return i[0]=e[0],i[1]=e[1],i[4]=e[2],i[5]=e[3],i[12]=e[4],i[13]=e[5],i}function qn(i,e,t,r,n,s,o){o=o??Qt();const a=1/(i-e),c=1/(t-r),l=1/(n-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*c,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*l,o[11]=0,o[12]=(i+e)*a,o[13]=(r+t)*c,o[14]=(s+n)*l,o[15]=1,o}function _a(i,e,t,r,n){return n=n??Qt(),n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e,n[4]=i[4]*t,n[5]=i[5]*t,n[6]=i[6]*t,n[7]=i[7]*t,n[8]=i[8]*r,n[9]=i[9]*r,n[10]=i[10]*r,n[11]=i[11]*r,n[12]=i[12],n[13]=i[13],n[14]=i[14],n[15]=i[15],n}function nm(i,e,t,r,n){n=n??Qt();let s,o,a,c,l,u,h,f,d,g,p,m;return i===n?(n[12]=i[0]*e+i[4]*t+i[8]*r+i[12],n[13]=i[1]*e+i[5]*t+i[9]*r+i[13],n[14]=i[2]*e+i[6]*t+i[10]*r+i[14],n[15]=i[3]*e+i[7]*t+i[11]*r+i[15]):(s=i[0],o=i[1],a=i[2],c=i[3],l=i[4],u=i[5],h=i[6],f=i[7],d=i[8],g=i[9],p=i[10],m=i[11],n[0]=s,n[1]=o,n[2]=a,n[3]=c,n[4]=l,n[5]=u,n[6]=h,n[7]=f,n[8]=d,n[9]=g,n[10]=p,n[11]=m,n[12]=s*e+l*t+d*r+i[12],n[13]=o*e+u*t+g*r+i[13],n[14]=a*e+h*t+p*r+i[14],n[15]=c*e+f*t+m*r+i[15]),n}function sm(i,e,t,r){return r=r??Qt(),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=i,r[13]=e,r[14]=t,r[15]=1,r}const Ei={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},om=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,am=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class ya{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||om),t.compileShader(r);const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,e.fragmentShader||am),t.compileShader(n),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,n),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const n=0,s=t.RGBA,o=0,a=t.RGBA,c=t.UNSIGNED_BYTE,l=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,n,s,r[0],r[1],o,a,c,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,n){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const c=he(s.canvas);if(!e.renderTargets[c]){const l=s.getContextAttributes();l&&l.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[c]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(s,e),s.drawArrays(s.TRIANGLES,0,6),n&&n(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,n=1;this.uniforms_.forEach(function(s){if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${n}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(s.location,n++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(s.location,r[0],r[1]);return;case 3:t.uniform3f(s.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(s.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(s.location,r)})}}const ft={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},be={UNSIGNED_BYTE:Qp,UNSIGNED_SHORT:em,UNSIGNED_INT:tm,FLOAT:Jl},Vi={};function Ea(i){return"shared/"+i}let xa=0;function lm(){const i="unique/"+xa;return xa+=1,i}function cm(i){let e=Vi[i];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:rm(t)},Vi[i]=e}return e.users+=1,e.context}function um(i){const e=Vi[i];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const n=t.canvas;n.width=1,n.height=1,delete Vi[i]}class hm extends ol{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?Ea(e.canvasCacheKey):lm(),this.gl_=cm(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(Ei.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(Ei.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=Fe(),this.offsetScaleMatrix_=Fe(),this.tmpMat4_=Qt(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new ya({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new ya({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now()}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===Ea(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.gl_,r=he(e);let n=this.bufferCache_[r];if(!n){const s=t.createBuffer();n={buffer:e,webGlBuffer:s},this.bufferCache_[r]=n}t.bindBuffer(e.getType(),n.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=he(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(Ei.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(Ei.RESTORED,this.boundHandleWebGLContextRestored_),um(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const n=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let c=this.postProcessPasses_.length-1;c>=0;c--)this.postProcessPasses_[c].init(e);n.bindTexture(n.TEXTURE_2D,null),n.clearColor(0,0,0,0),n.depthRange(0,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,t?n.ZERO:n.ONE_MINUS_SRC_ALPHA),r?(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL)):n.disable(n.DEPTH_TEST)}bindFrameBuffer(e,t){const r=this.getGL();r.bindFramebuffer(r.FRAMEBUFFER,e),t&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const r=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}bindTexture(e,t,r){const n=this.gl_;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.getUniformLocation(r),t)}bindAttribute(e,t,r){const n=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(t);n.enableVertexAttribArray(s),n.vertexAttribPointer(s,r,n.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,r,n){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,r?s.ZERO:s.ONE_MINUS_SRC_ALPHA),n?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const n=r.UNSIGNED_INT,s=4,o=t-e,a=e*s;r.drawElements(r.TRIANGLES,o,n,a)}finalizeDraw(e,t,r){for(let n=0,s=this.postProcessPasses_.length;n<s;n++)n===s-1?this.postProcessPasses_[n].apply(e,null,t,r):this.postProcessPasses_[n].apply(e,this.postProcessPasses_[n+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,n=e.pixelRatio;this.setUniformFloatValue(ft.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(ft.ZOOM,e.viewState.zoom),this.setUniformFloatValue(ft.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(ft.PIXEL_RATIO,n),this.setUniformFloatVec2(ft.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(ft.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(ft.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(ft.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,n=0;this.uniforms_.forEach(s=>{if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData||r instanceof WebGLTexture){r instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=r):s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,n,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(r instanceof HTMLImageElement)||r.complete;!(r instanceof WebGLTexture)&&o&&s.prevValue!==r&&(s.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),n++}else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(s.name,ji(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(s.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(s.name),r)})}useProgram(e,t){this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const r=this.gl_,n=r.createShader(t);return r.shaderSource(n,e),r.compileShader(n),n}getProgram(e,t){const r=this.gl_,n=this.compileShader(e,r.FRAGMENT_SHADER),s=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,n),r.attachShader(o,s),r.linkProgram(o),!r.getShaderParameter(n,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(n)}`;throw new Error(a)}if(r.deleteShader(n),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=he(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=he(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,n=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return ps(t,0,0,2/(s*r[0]),2/(s*r[1]),-n,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}enableAttributeArray_(e,t,r,n,s){const o=this.getAttributeLocation(e);o<0||(this.gl_.enableVertexAttribArray(o),this.gl_.vertexAttribPointer(o,t,r,!1,n,s))}enableAttributes(e){const t=fm(e);let r=0;for(let n=0;n<e.length;n++){const s=e[n];this.enableAttributeArray_(s.name,s.size,s.type||Jl,t,r),r+=s.size*Ql(s.type)}}handleWebGLContextLost(e){zu(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r,n){const s=this.gl_;r=r||s.createTexture();const o=n?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,c=s.RGBA,l=0,u=s.RGBA,h=s.UNSIGNED_BYTE;return t instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,c,e[0],e[1],l,u,h,t):t?s.texImage2D(s.TEXTURE_2D,a,c,u,h,t):s.texImage2D(s.TEXTURE_2D,a,c,e[0],e[1],l,u,h,null),r}}function fm(i){let e=0;for(let t=0;t<i.length;t++){const r=i[t];e+=r.size*Ql(r.type)}return e}function Ql(i){switch(i){case be.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case be.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case be.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case be.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}const at=new Uint8Array(4);class ec{constructor(e,t){this.helper_=e;const r=e.getGL();this.texture_=r.createTexture(),this.framebuffer_=r.createFramebuffer(),this.depthbuffer_=r.createRenderbuffer(),this.size_=t||[1,1],this.data_=new Uint8Array(0),this.dataCacheDirty_=!0,this.updateSize_()}setSize(e){ku(e,this.size_)||(this.size_[0]=e[0],this.size_[1]=e[1],this.updateSize_())}getSize(){return this.size_}clearCachedData(){this.dataCacheDirty_=!0}readAll(){if(this.dataCacheDirty_){const e=this.size_,t=this.helper_.getGL();t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.readPixels(0,0,e[0],e[1],t.RGBA,t.UNSIGNED_BYTE,this.data_),this.dataCacheDirty_=!1}return this.data_}readPixel(e,t){if(e<0||t<0||e>this.size_[0]||t>=this.size_[1])return at[0]=0,at[1]=0,at[2]=0,at[3]=0,at;this.readAll();const r=Math.floor(e)+(this.size_[1]-Math.floor(t)-1)*this.size_[0];return at[0]=this.data_[r*4],at[1]=this.data_[r*4+1],at[2]=this.data_[r*4+2],at[3]=this.data_[r*4+3],at}getTexture(){return this.texture_}getFramebuffer(){return this.framebuffer_}getDepthbuffer(){return this.depthbuffer_}updateSize_(){const e=this.size_,t=this.helper_.getGL();this.texture_=this.helper_.createTexture(e,null,this.texture_),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.viewport(0,0,e[0],e[1]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture_,0),t.bindRenderbuffer(t.RENDERBUFFER,this.depthbuffer_),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],e[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthbuffer_),this.data_=new Uint8Array(e[0]*e[1]*4)}}function tc(){const i='const t="GENERATE_POLYGON_BUFFERS",e="GENERATE_POINT_BUFFERS",n="GENERATE_LINE_STRING_BUFFERS";function r(t,e,n=2){const r=e&&e.length,o=r?e[0]*n:t.length;let u=x(t,0,o,n,!0);const f=[];if(!u||u.next===u.prev)return f;let s,l,h;if(r&&(u=function(t,e,n,r){const o=[];for(let n=0,i=e.length;n<i;n++){const u=x(t,e[n]*r,n<i-1?e[n+1]*r:t.length,r,!1);u===u.next&&(u.steiner=!0),o.push(p(u))}o.sort(c);for(let t=0;t<o.length;t++)n=a(o[t],n);return n}(t,e,u,n)),t.length>80*n){s=1/0,l=1/0;let e=-1/0,r=-1/0;for(let x=n;x<o;x+=n){const n=t[x],o=t[x+1];n<s&&(s=n),o<l&&(l=o),n>e&&(e=n),o>r&&(r=o)}h=Math.max(e-s,r-l),h=0!==h?32767/h:0}return i(u,f,n,s,l,h,0),f}function x(t,e,n,r,x){let o;if(x===function(t,e,n,r){let x=0;for(let o=e,i=n-r;o<n;o+=r)x+=(t[i]-t[o])*(t[o+1]+t[i+1]),i=o;return x}(t,e,n,r)>0)for(let x=e;x<n;x+=r)o=I(x/r|0,t[x],t[x+1],o);else for(let x=n-r;x>=e;x-=r)o=I(x/r|0,t[x],t[x+1],o);return o&&m(o,o.next)&&(z(o),o=o.next),o}function o(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!m(r,r.next)&&0!==M(r.prev,r,r.next))r=r.next;else{if(z(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function i(t,e,n,r,x,c,a){if(!t)return;!a&&c&&function(t,e,n,r){let x=t;do{0===x.z&&(x.z=y(x.x,x.y,e,n,r)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==t);x.prevZ.nextZ=null,x.prevZ=null,function(t){let e,n=1;do{let r,x=t;t=null;let o=null;for(e=0;x;){e++;let i=x,u=0;for(let t=0;t<n&&(u++,i=i.nextZ,i);t++);let f=n;for(;u>0||f>0&&i;)0!==u&&(0===f||!i||x.z<=i.z)?(r=x,x=x.nextZ,u--):(r=i,i=i.nextZ,f--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;x=i}o.nextZ=null,n*=2}while(e>1)}(x)}(t,r,x,c);let h=t;for(;t.prev!==t.next;){const y=t.prev,p=t.next;if(c?f(t,r,x,c):u(t))e.push(y.i,t.i,p.i),z(t),t=p.next,h=p.next;else if((t=p)===h){a?1===a?i(t=s(o(t),e),e,n,r,x,c,2):2===a&&l(t,e,n,r,x,c):i(o(t),e,n,r,x,c,1);break}}}function u(t){const e=t.prev,n=t,r=t.next;if(M(e,n,r)>=0)return!1;const x=e.x,o=n.x,i=r.x,u=e.y,f=n.y,s=r.y,l=Math.min(x,o,i),c=Math.min(u,f,s),a=Math.max(x,o,i),h=Math.max(u,f,s);let y=r.next;for(;y!==e;){if(y.x>=l&&y.x<=a&&y.y>=c&&y.y<=h&&g(x,u,o,f,i,s,y.x,y.y)&&M(y.prev,y,y.next)>=0)return!1;y=y.next}return!0}function f(t,e,n,r){const x=t.prev,o=t,i=t.next;if(M(x,o,i)>=0)return!1;const u=x.x,f=o.x,s=i.x,l=x.y,c=o.y,a=i.y,h=Math.min(u,f,s),p=Math.min(l,c,a),v=Math.max(u,f,s),b=Math.max(l,c,a),m=y(h,p,e,n,r),Z=y(v,b,e,n,r);let d=t.prevZ,w=t.nextZ;for(;d&&d.z>=m&&w&&w.z<=Z;){if(d.x>=h&&d.x<=v&&d.y>=p&&d.y<=b&&d!==x&&d!==i&&g(u,l,f,c,s,a,d.x,d.y)&&M(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,w.x>=h&&w.x<=v&&w.y>=p&&w.y<=b&&w!==x&&w!==i&&g(u,l,f,c,s,a,w.x,w.y)&&M(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;d&&d.z>=m;){if(d.x>=h&&d.x<=v&&d.y>=p&&d.y<=b&&d!==x&&d!==i&&g(u,l,f,c,s,a,d.x,d.y)&&M(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;w&&w.z<=Z;){if(w.x>=h&&w.x<=v&&w.y>=p&&w.y<=b&&w!==x&&w!==i&&g(u,l,f,c,s,a,w.x,w.y)&&M(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function s(t,e){let n=t;do{const r=n.prev,x=n.next.next;!m(r,x)&&Z(r,n,n.next,x)&&A(r,x)&&A(x,r)&&(e.push(r.i,n.i,x.i),z(n),z(n.next),n=t=x),n=n.next}while(n!==t);return o(n)}function l(t,e,n,r,x,u){let f=t;do{let t=f.next.next;for(;t!==f.prev;){if(f.i!==t.i&&b(f,t)){let s=E(f,t);return f=o(f,f.next),s=o(s,s.next),i(f,e,n,r,x,u,0),void i(s,e,n,r,x,u,0)}t=t.next}f=f.next}while(f!==t)}function c(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function a(t,e){const n=function(t,e){let n=e;const r=t.x,x=t.y;let o,i=-1/0;if(m(t,n))return n;do{if(m(t,n.next))return n.next;if(x<=n.y&&x>=n.next.y&&n.next.y!==n.y){const t=n.x+(x-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>i&&(i=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const u=o,f=o.x,s=o.y;let l=1/0;n=o;do{if(r>=n.x&&n.x>=f&&r!==n.x&&v(x<s?r:i,x,f,s,x<s?i:r,x,n.x,n.y)){const e=Math.abs(x-n.y)/(r-n.x);A(n,t)&&(e<l||e===l&&(n.x>o.x||n.x===o.x&&h(o,n)))&&(o=n,l=e)}n=n.next}while(n!==u);return o}(t,e);if(!n)return e;const r=E(n,t);return o(r,r.next),o(n,n.next)}function h(t,e){return M(t.prev,t,e.prev)<0&&M(e.next,t,t.next)<0}function y(t,e,n,r,x){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*x|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*x|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function p(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function v(t,e,n,r,x,o,i,u){return(x-i)*(e-u)>=(t-i)*(o-u)&&(t-i)*(r-u)>=(n-i)*(e-u)&&(n-i)*(o-u)>=(x-i)*(r-u)}function g(t,e,n,r,x,o,i,u){return!(t===i&&e===u)&&v(t,e,n,r,x,o,i,u)}function b(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Z(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(A(t,e)&&A(e,t)&&function(t,e){let n=t,r=!1;const x=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&x<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(M(t.prev,t,e.prev)||M(t,e.prev,e))||m(t,e)&&M(t.prev,t,t.next)>0&&M(e.prev,e,e.next)>0)}function M(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function m(t,e){return t.x===e.x&&t.y===e.y}function Z(t,e,n,r){const x=w(M(t,e,n)),o=w(M(t,e,r)),i=w(M(n,r,t)),u=w(M(n,r,e));return x!==o&&i!==u||(!(0!==x||!d(t,n,e))||(!(0!==o||!d(t,r,e))||(!(0!==i||!d(n,t,r))||!(0!==u||!d(n,e,r)))))}function d(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function w(t){return t>0?1:t<0?-1:0}function A(t,e){return M(t.prev,t,t.next)<0?M(t,e,t.next)>=0&&M(t,t.prev,e)>=0:M(t,e,t.prev)<0||M(t,t.next,e)<0}function E(t,e){const n=F(t.i,t.x,t.y),r=F(e.i,e.x,e.y),x=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=x,x.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function I(t,e,n,r){const x=F(t,e,n);return r?(x.next=r.next,x.prev=r,r.next.prev=x,r.next=x):(x.prev=x,x.next=x),x}function z(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function F(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function P(t,e){const n=e[0],r=e[1];return e[0]=t[0]*n+t[2]*r+t[4],e[1]=t[1]*n+t[3]*r+t[5],e}function B(t,e){const n=(r=e)[0]*r[3]-r[1]*r[2];var r;!function(t,e){if(!t)throw new Error(e)}(0!==n,"Transformation matrix cannot be inverted");const x=e[0],o=e[1],i=e[2],u=e[3],f=e[4],s=e[5];return t[0]=u/n,t[1]=-o/n,t[2]=-i/n,t[3]=x/n,t[4]=(i*s-u*f)/n,t[5]=-(x*s-o*f)/n,t}new Array(6);const N=[],R={vertexPosition:0,indexPosition:0};function S(t,e,n,r,x){t[e+0]=n,t[e+1]=r,t[e+2]=x}function T(t,e,n,r,x,o){const i=3+x,u=t[e+0],f=t[e+1],s=N;s.length=x;for(let n=0;n<s.length;n++)s[n]=t[e+2+n];let l=o?o.vertexPosition:0,c=o?o.indexPosition:0;const a=l/i;return S(n,l,u,f,0),s.length&&n.set(s,l+3),l+=i,S(n,l,u,f,1),s.length&&n.set(s,l+3),l+=i,S(n,l,u,f,2),s.length&&n.set(s,l+3),l+=i,S(n,l,u,f,3),s.length&&n.set(s,l+3),l+=i,r[c++]=a,r[c++]=a+1,r[c++]=a+3,r[c++]=a+1,r[c++]=a+2,r[c++]=a+3,R.vertexPosition=l,R.indexPosition=c,R}function _(t,e,n,r,x,o,i,u,f,s,l){const c=10+u.length,a=o.length/c,h=[t[e+0],t[e+1]],y=[t[n],t[n+1]],p=t[e+2],v=t[n+2],g=P(f,[...h]),b=P(f,[...y]);function M(t,e,n){const r=Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])),x=[(e[0]-t[0])/r,(e[1]-t[1])/r],o=[-x[1],x[0]],i=Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1])),u=[(n[0]-t[0])/i,(n[1]-t[1])/i],f=0===r||0===i?0:Math.acos((s=u[0]*x[0]+u[1]*x[1],l=-1,c=1,Math.min(Math.max(s,l),c)));var s,l,c;return u[0]*o[0]+u[1]*o[1]>0?f:2*Math.PI-f}let m=-1,Z=-1,d=l;const w=null!==x;if(null!==r){m=M(g,b,P(f,[...[t[r],t[r+1]]])),Math.cos(m)<=.985&&(d+=Math.tan((m-Math.PI)/2))}if(w){Z=M(b,g,P(f,[...[t[x],t[x+1]]])),Math.cos(Z)<=.985&&(d+=Math.tan((Math.PI-Z)/2))}function A(t,e){return 0===e?1e4*t:Math.sign(e)*(1e4*t+Math.abs(e))}return o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(0,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(1,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(2,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(3,l)),o.push(...u),i.push(a,a+1,a+2,a+1,a+3,a+2),{length:s+Math.sqrt((b[0]-g[0])*(b[0]-g[0])+(b[1]-g[1])*(b[1]-g[1])),angle:d}}function O(t,e,n,x,o){const i=2+o;let u=e;const f=t.slice(u,u+o);u+=o;const s=t[u++];let l=0;const c=new Array(s-1);for(let e=0;e<s;e++)l+=t[u++],e<s-1&&(c[e]=l);const a=t.slice(u,u+2*l),h=r(a,c,2);for(let t=0;t<h.length;t++)x.push(h[t]+n.length/i);for(let t=0;t<a.length;t+=2)n.push(a[t],a[t+1],...f);return u+2*l}const U=self;U.onmessage=r=>{const x=r.data;switch(x.type){case e:{const t=3,e=2,n=x.customAttributesSize,r=e+n,o=new Float32Array(x.renderInstructions),i=o.length/r,u=4*i*(n+t),f=new Uint32Array(6*i),s=new Float32Array(u);let l;for(let t=0;t<o.length;t+=r)l=T(o,t,s,f,n,l);const c=Object.assign({vertexBuffer:s.buffer,indexBuffer:f.buffer,renderInstructions:o.buffer},x);U.postMessage(c,[s.buffer,f.buffer,o.buffer]);break}case n:{const t=[],e=[],n=x.customAttributesSize,r=3,o=new Float32Array(x.renderInstructions);let i=0;const u=[1,0,0,1,0,0];let f,s;for(B(u,x.renderInstructionsTransform);i<o.length;){s=Array.from(o.slice(i,i+n)),i+=n,f=o[i++];const x=i,l=i+(f-1)*r,c=o[x]===o[l]&&o[x+1]===o[l+1];let a=0,h=0;for(let n=0;n<f-1;n++){let y=null;n>0?y=i+(n-1)*r:c&&(y=l-r);let p=null;n<f-2?p=i+(n+2)*r:c&&(p=x+r);const v=_(o,i+n*r,i+(n+1)*r,y,p,t,e,s,u,a,h);a=v.length,h=v.angle}i+=f*r}const l=Uint32Array.from(e),c=Float32Array.from(t),a=Object.assign({vertexBuffer:c.buffer,indexBuffer:l.buffer,renderInstructions:o.buffer},x);U.postMessage(a,[c.buffer,l.buffer,o.buffer]);break}case t:{const t=[],e=[],n=x.customAttributesSize,r=new Float32Array(x.renderInstructions);let o=0;for(;o<r.length;)o=O(r,o,t,e,n);const i=Uint32Array.from(e),u=Float32Array.from(t),f=Object.assign({vertexBuffer:u.buffer,indexBuffer:i.buffer,renderInstructions:r.buffer},x);U.postMessage(f,[u.buffer,i.buffer,r.buffer]);break}}};';return new Worker(typeof Blob>"u"?"data:application/javascript;base64,"+Buffer.from(i,"binary").toString("base64"):URL.createObjectURL(new Blob([i],{type:"application/javascript"})))}class ni extends $u{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=Fe(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(zn.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(jt.PRECOMPOSE)){const n=new Tn(jt.PRECOMPOSE,void 0,t,e);r.dispatchEvent(n)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(jt.POSTCOMPOSE)){const n=new Tn(jt.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,n;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const c=e.layerStatesArray[o].layer,l=c.getRenderer();if(!(l instanceof ni)){t=!0;continue}const u=c.getClassName();if((t||u!==n)&&(r+=1,t=!1),n=u,l===this)break}const s="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new hm({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),n&&(this.helper.getCanvas().className=n),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(zn.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const n=this.getLayer();if(n.hasListener(e)){ps(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new Tn(e,this.inversePixelTransform_,r,t);n.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(jt.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(jt.POSTRENDER,e,t)}}function rc(i,e){const t=i.viewState.projection,n=e.getSource().getWrapX()&&t.canWrapX(),s=t.getExtent(),o=i.extent,a=n?Me(s):null,c=n?Math.ceil((o[2]-s[2])/a)+1:1;return[n?Math.floor((o[0]-s[0])/a):0,c,a]}class ic extends ni{constructor(e,t){const r=t.uniforms||{},n=Fe();r[ft.PROJECTION_MATRIX]=n,super(e,{uniforms:r,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new mr(ri,$i),this.indicesBuffer_=new mr(ii,$i),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const s=t.attributes?t.attributes.map(function(a){return{name:"a_"+a.name,size:1,type:be.FLOAT}}):[];this.attributes=[{name:"a_position",size:2,type:be.FLOAT},{name:"a_index",size:1,type:be.FLOAT}],this.hitDetectionEnabled_&&(this.attributes.push({name:"a_hitColor",size:4,type:be.FLOAT}),this.attributes.push({name:"a_featureUid",size:1,type:be.FLOAT})),this.attributes.push(...s),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=Qr(),this.currentTransform_=n,this.renderTransform_=Fe(),this.invertRenderTransform_=Fe(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=tc(),this.worker_.addEventListener("message",a=>{const c=a.data;if(c.type===Ur.GENERATE_POINT_BUFFERS){const l=c.projectionTransform;this.verticesBuffer_.fromArrayBuffer(c.vertexBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.fromArrayBuffer(c.indexBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=l,Xr(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(a.data.renderInstructions),c.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const o=this.getLayer().getSource();this.sourceListenKeys_=[Et(o,It.ADDFEATURE,this.handleSourceFeatureAdded_,this),Et(o,It.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),Et(o,It.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),Et(o,It.CLEAR,this.handleSourceFeatureClear_,this)],o.forEachFeature(a=>{const c=a.getGeometry();c&&c.getType()==="Point"&&(this.featureCache_[he(a)]={feature:a,properties:a.getProperties(),flatCoordinates:c.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new ec(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,r=t.getGeometry();r&&r.getType()==="Point"&&(this.featureCache_[he(t)]={feature:t,properties:t.getProperties(),flatCoordinates:r.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,r=he(t),n=this.featureCache_[r],s=t.getGeometry();n?s&&s.getType()==="Point"?(n.properties=t.getProperties(),n.flatCoordinates=s.getFlatCoordinates()):(delete this.featureCache_[r],this.featureCount_--):s&&s.getType()==="Point"&&(this.featureCache_[r]={feature:t,properties:t.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,r=he(t);r in this.featureCache_&&(delete this.featureCache_[r],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,n,s]=rc(e,this.getLayer());return this.renderWorlds(e,!1,r,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),r=t.getSource(),n=e.viewState,s=!e.viewHints[Ot.ANIMATING]&&!e.viewHints[Ot.INTERACTING],o=!Vr(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const c=n.projection,l=n.resolution,u=t instanceof an?t.getRenderBuffer():0,h=ms(e.extent,u*l);r.loadFeatures(h,l,c),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes),!0}rebuildBuffers_(e){const t=Fe();this.helper.makeProjectionTransform(e,t);const n=(this.hitDetectionEnabled_?7:2)+this.customAttributes.length,s=n*this.featureCount_,o=this.renderInstructions_&&this.renderInstructions_.length===s?this.renderInstructions_:new Float32Array(s);this.renderInstructions_=null;let a=[];const c=[];let l=-1;e.viewState.projection;for(const h in this.featureCache_){const f=this.featureCache_[h];if(a[0]=f.flatCoordinates[0],a[1]=f.flatCoordinates[1],Tt(t,a),o[++l]=a[0],o[++l]=a[1],this.hitDetectionEnabled_){const d=ql(l+5,c);o[++l]=d[0],o[++l]=d[1],o[++l]=d[2],o[++l]=d[3],o[++l]=Number(h)}for(let d=0;d<this.customAttributes.length;d++){const g=this.customAttributes[d].callback(f.feature,f.properties);o[++l]=g}}const u={id:++this.lastSentId,type:Ur.GENERATE_POINT_BUFFERS,renderInstructions:o.buffer,customAttributesSize:n-2};u.projectionTransform=t,this.ready=!1,this.worker_.postMessage(u,[o.buffer])}forEachFeatureAtCoordinate(e,t,r,n,s){if(et(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const o=Tt(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),c=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],l=Kl(c),u=this.renderInstructions_[l],h=Math.floor(u).toString(),d=this.getLayer().getSource().getFeatureByUid(h);if(d)return n(d,this.getLayer(),null)}renderWorlds(e,t,r,n,s){let o=r;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0)),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes);do{this.helper.makeProjectionTransform(e,this.currentTransform_),_s(this.currentTransform_,o*s,0),jr(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const a=this.indicesBuffer_.getSize();this.helper.drawElements(0,a)}while(++o<n)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){Ui(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class dm extends ju{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(Be.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===K.LOADED,this.loaded)this.uploadTile();else{if(e instanceof ys){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(Be.CHANGE,this.handleTileChange_)}}uploadTile(){_t()}setReady(){this.ready=!0,this.dispatchEvent(Be.CHANGE)}handleTileChange_(){this.tile.getState()===K.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(Be.CHANGE,this.handleTileChange_)}}function nc(i,e,t){const r=t?i.LINEAR:i.NEAREST;i.bindTexture(i.TEXTURE_2D,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r)}function gm(i,e,t,r){nc(i,e,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t)}function ba(i,e,t,r,n,s){const o=i.getGL();let a,c;t instanceof Float32Array?(a=o.FLOAT,i.getExtension("OES_texture_float"),c=i.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,c=!0),nc(o,e,s&&c);const l=t.byteLength/r[1];let u=1;l%8===0?u=8:l%4===0?u=4:l%2===0&&(u=2);let h;switch(n){case 1:{h=o.LUMINANCE;break}case 2:{h=o.LUMINANCE_ALPHA;break}case 3:{h=o.RGB;break}case 4:{h=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${n}`)}const f=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,u),o.texImage2D(o.TEXTURE_2D,0,h,r[0],r[1],0,h,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,f)}let or=null;function pm(){or=Nt(1,1,void 0,{willReadFrequently:!0})}class mm extends dm{constructor(e){super(e),this.textures=[],this.renderSize_=nt(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new mr(ri,Xs);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var r;const t=(r=this.helper)==null?void 0:r.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let n=0;n<this.textures.length;++n)t.deleteTexture(this.textures[n])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),r=this.tile;this.textures.length=0;let n;r instanceof ys||r instanceof Vu?n=r.getImage():n=r.getData();const s=$n(n);if(s){const _=t.createTexture();this.textures.push(_),this.bandCount=4,gm(t,_,s,r.interpolate),this.setReady();return}n=kn(n);const o=r.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],c=n instanceof Float32Array,l=a[0]*a[1],u=c?Float32Array:Uint8Array,h=u.BYTES_PER_ELEMENT,f=n.byteLength/a[1];this.bandCount=Math.floor(f/h/a[0]);const d=Math.ceil(this.bandCount/4);if(d===1){const _=t.createTexture();this.textures.push(_),ba(e,_,n,a,this.bandCount,r.interpolate),this.setReady();return}const g=new Array(d);for(let _=0;_<d;++_){const E=t.createTexture();this.textures.push(E);const w=_<d-1?4:(this.bandCount-1)%4+1;g[_]=new u(l*w)}let p=0,m=0;const y=a[0]*this.bandCount;for(let _=0;_<a[1];++_){for(let E=0;E<y;++E){const w=n[m+E],S=Math.floor(p/this.bandCount),T=E%this.bandCount,v=Math.floor(T/4),I=g[v],A=I.length/l,R=T%4;I[S*A+R]=w,++p}m+=f/h}for(let _=0;_<d;++_){const E=this.textures[_],w=g[_],S=w.length/l;ba(e,E,w,a,S,r.interpolate)}this.setReady()}getImagePixelData_(e,t,r){const n=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];or||pm(),or.clearRect(0,0,1,1);const a=e.width,c=e.height,l=a-2*n,u=c-2*n,h=n+Math.floor(l*(t/s)),f=n+Math.floor(u*(r/o));let d;try{or.drawImage(e,h,f,1,1,0,0,1,1),d=or.getImageData(0,0,1,1).data}catch{return or=null,null}return d}getArrayPixelData_(e,t,r,n){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],c=t[0],l=t[1],u=c+2*s,h=l+2*s,f=s+Math.floor(c*(r/o)),d=s+Math.floor(l*(n/a));if(e instanceof DataView){const p=e.byteLength/(u*h),m=p*(d*u+f),y=e.buffer.slice(m,m+p);return new DataView(y)}const g=this.bandCount*(d*u+f);return e.slice(g,g+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof Es){const r=this.tile.getData(),n=kn(r);if(n){const s=this.tile.getSize();return this.getArrayPixelData_(n,s,e,t)}return this.getImagePixelData_($n(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}const _m={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function Ta(i){return 1/(i+2)}function ym(){return{tileIds:new Set,representationsByZ:{}}}function wa(i,e){return i.tileIds.has(he(e))}function Sa(i,e,t){const r=i.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),i.tileIds.add(he(e.tile))}function Rn(i,e){const t=i.layerStatesArray[i.layerIndex];t.extent&&(e=gt(e,al(t.extent,i.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const n=r.getTileGridForProjection(i.viewState.projection).getExtent();n&&(e=gt(e,n))}return e}function Kn(i,e){return`${i.getKey()},${i.getRevision()},${sr(e)}`}class Em extends ni{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=Fe(),this.tempMat4=Qt(),this.tempTileRange_=new Xu(0,0,0,0),this.tempTileCoord_=jn(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new Wu(r),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||on(Rn(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return _t()}enqueueTiles(e,t,r,n,s){const o=e.viewState,a=this.getLayer(),c=a.getRenderSource(),l=c.getTileGridForProjection(o.projection),u=c.getGutterForProjection(o.projection),h=he(c);h in e.wantedTiles||(e.wantedTiles[h]={});const f=e.wantedTiles[h],d=this.tileRepresentationCache,g=a.getMapInternal(),p=Math.max(r-s,l.getMinZoom(),l.getZForResolution(Math.min(a.getMaxResolution(),g?g.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):l.getResolution(0)),c.zDirection)),m=o.rotation,y=m?Hu(o.center,o.resolution,m,e.size):void 0;for(let _=r;_>=p;--_){const E=l.getTileRangeForExtentAndZ(t,_,this.tempTileRange_),w=l.getResolution(_);for(let S=E.minX;S<=E.maxX;++S)for(let T=E.minY;T<=E.maxY;++T){if(m&&!l.tileCoordIntersectsViewport([_,S,T],y))continue;const v=jn(_,S,T,this.tempTileCoord_),I=Kn(c,v);let A,R;if(d.containsKey(I)&&(A=d.get(I),R=A.tile),(!A||A.tile.key!==c.getKey())&&(R=c.getTile(_,S,T,e.pixelRatio,o.projection),!R)||wa(n,R))continue;A?A.setTile(R):(A=this.createTileRepresentation({tile:R,grid:l,helper:this.helper,gutter:u}),d.set(I,A)),Sa(n,A,_);const O=R.getKey();f[O]=!0,R.getState()===K.IDLE&&(e.tileQueue.isKeyQueued(O)||e.tileQueue.enqueue([R,h,l.getTileCoordCenter(v),w]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,r,n,s,o,a,c,l,u,h){}renderTileMask(e,t,r,n){}drawTile_(e,t,r,n,s,o,a){if(!t.ready)return;const l=t.tile.tileCoord,u=sr(l),h=u in o?o[u]:1,f=a.getResolution(r),d=nt(a.getTileSize(r),this.tempSize_),g=a.getOrigin(r),p=a.getTileCoordExtent(l),m=h<1?-1:Ta(r);h<1&&(e.animate=!0);const y=e.viewState,_=y.center[0],E=y.center[1],w=d[0]+2*n,S=d[1]+2*n,T=w/S,v=(_-g[0])/(d[0]*f),I=(g[1]-E)/(d[1]*f),A=y.resolution/f,R=l[1],O=l[2];Zu(this.tileTransform_),Oo(this.tileTransform_,2/(e.size[0]*A/w),-2/(e.size[1]*A/w)),Yu(this.tileTransform_,y.rotation),Oo(this.tileTransform_,1,1/T),_s(this.tileTransform_,(d[0]*(R-v)-n)/w,(d[1]*(O-I)-n)/S),this.renderTile(t,this.tileTransform_,e,s,f,d,g,p,m,n,h)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,n=this.getLayer(),s=n.getRenderSource(),o=s.getTileGridForProjection(r.projection),a=s.getGutterForProjection(r.projection),c=Rn(e,e.extent),l=o.getZForResolution(r.resolution,s.zDirection),u=ym(),h=n.getPreload();if(e.nextExtent){const E=o.getZForResolution(r.nextResolution,s.zDirection),w=Rn(e,e.nextExtent);this.enqueueTiles(e,w,E,u,h)}this.enqueueTiles(e,c,l,u,0),h>0&&setTimeout(()=>{this.enqueueTiles(e,c,l-1,u,h-1)},0);const f={};let d=!1;const g=u.representationsByZ;if(l in g){const E=he(this),w=e.time;for(const S of g[l]){const T=S.tile;if(T.getState()===K.EMPTY)continue;const v=T.tileCoord;if(S.ready){const R=T.getAlpha(E,w);if(R===1){T.endTransition(E);continue}d=!0;const O=sr(v);f[O]=R}if(this.renderComplete=!1,this.findAltTiles_(o,v,l+1,u))continue;const A=o.getMinZoom();for(let R=l-1;R>=A&&!this.findAltTiles_(o,v,R,u);--R);}}const p=Object.keys(g).map(Number).sort(qu);if(this.beforeTilesMaskRender(e))for(let E=0,w=p.length;E<w;++E){const S=p[E];for(const T of g[S]){const v=T.tile.tileCoord;if(sr(v)in f)continue;const A=o.getTileCoordExtent(v);this.renderTileMask(T,S,A,Ta(S))}}this.beforeTilesRender(e,d);for(let E=0,w=p.length;E<w;++E){const S=p[E];for(const T of g[S]){const v=T.tile.tileCoord;sr(v)in f||this.drawTile_(e,T,S,a,c,f,o)}}if(l in g)for(const E of g[l]){const w=E.tile.tileCoord;sr(w)in f&&this.drawTile_(e,E,l,a,c,f,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const y=this.helper.getCanvas(),_=this.tileRepresentationCache;for(;_.canExpireCache();)_.pop().dispose();return this.postRender(t,e),y}beforeFinalize(e){}findAltTiles_(e,t,r,n){const s=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,c=this.getLayer().getRenderSource();for(let l=s.minX;l<=s.maxX;++l)for(let u=s.minY;u<=s.maxY;++u){const h=Kn(c,[r,l,u]);let f=!1;if(a.containsKey(h)){const d=a.get(h);d.ready&&!wa(n,d.tile)&&(Sa(n,d,r),f=!0)}f||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const V={..._m,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},vi={TEXTURE_COORD:"a_textureCoord"},xm=[{name:vi.TEXTURE_COORD,size:2,type:be.FLOAT}];class bm extends Em{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new mr(ii,Xs),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const r of this.paletteTextures_)r.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const r of this.paletteTextures_)r.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new mm(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,n,s,o,a,c,l,u,h){const f=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(xm);let d=0;for(;d<e.textures.length;){const T=`${V.TILE_TEXTURE_ARRAY}[${d}]`;this.helper.bindTexture(e.textures[d],d,T),++d}for(let T=0;T<this.paletteTextures_.length;++T){const v=this.paletteTextures_[T],I=v.getTexture(f);this.helper.bindTexture(I,d,v.name),++d}const g=r.viewState,p=o[0]+2*u,m=o[1]+2*u,_=e.tile.tileCoord,E=_[1],w=_[2];this.helper.setUniformMatrixValue(V.TILE_TRANSFORM,ji(this.tempMat4,t)),this.helper.setUniformFloatValue(V.TRANSITION_ALPHA,h),this.helper.setUniformFloatValue(V.DEPTH,l);let S=n;u>0&&(S=c,gt(S,n,S)),this.helper.setUniformFloatVec4(V.RENDER_EXTENT,S),this.helper.setUniformFloatValue(V.RESOLUTION,g.resolution),this.helper.setUniformFloatValue(V.ZOOM,g.zoom),this.helper.setUniformFloatValue(V.TEXTURE_PIXEL_WIDTH,p),this.helper.setUniformFloatValue(V.TEXTURE_PIXEL_HEIGHT,m),this.helper.setUniformFloatValue(V.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(V.TEXTURE_ORIGIN_X,a[0]+E*o[0]*s-u*s),this.helper.setUniformFloatValue(V.TEXTURE_ORIGIN_Y,a[1]-w*o[1]*s+u*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const n=this.getLayer(),s=Tt(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=n.getExtent();if(a&&!cr(al(a,o.projection),s))return null;const c=n.getSources(gs([s]),o.resolution);let l,u,h;for(l=c.length-1;l>=0;--l)if(u=c[l],u.getState()==="ready"){if(h=u.getTileGridForProjection(o.projection),u.getWrapX())break;const d=h.getExtent();if(!d||cr(d,s))break}if(l<0)return null;const f=this.tileRepresentationCache;for(let d=h.getZForResolution(o.resolution);d>=h.getMinZoom();--d){const g=h.getTileCoordForCoordAndZ(s,d),p=Kn(u,g);if(!f.containsKey(p))continue;const m=f.get(p);if(m.tile.getState()===K.EMPTY)return null;if(!m.loaded)continue;const _=h.getOrigin(d),E=nt(h.getTileSize(d)),w=h.getResolution(d),S=(s[0]-_[0])/w-g[1]*E[0],T=(_[1]-s[1])/w-g[2]*E[1];return m.getPixelData(S,T)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const r of this.paletteTextures_)r.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class Tm{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function wm(i,e){return`operator_${i}_${Object.keys(e.functions).length}`}function Wt(i){const e=i.toString();return e.includes(".")?e:e+".0"}function Ws(i){if(i.length<2||i.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${i.length}(${i.map(Wt).join(", ")})`}function Pi(i){const e=Wr(i),t=e.length>3?e[3]:1;return Ws([e[0]/255,e[1]/255,e[2]/255,t])}function Sm(i){const e=nt(i);return Ws(e)}const vn={};let Rm=0;function ur(i){return i in vn||(vn[i]=Rm++),vn[i]}function yt(i){return Wt(ur(i))}function Hs(i){return"u_var_"+i}function Jn(){return{inFragmentShader:!1,variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const Pn="getBandValue",sc="u_paletteTextures",oc="featureId",ac="geometryType";function vm(i,e,t,r){const n=Ku(i,e,t);return Zs(n,e,r)}function ne(i){return(e,t,r)=>{const n=t.args.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=Zs(t.args[o],r,e);return i(s,e)}}const Pm={[H.Get]:(i,e)=>{const r=e.args[0].value;return r in i.properties||(i.properties[r]={name:r,type:e.type}),(i.inFragmentShader?"v_prop_":"a_prop_")+r},[H.Id]:i=>(i.featureId=!0,(i.inFragmentShader?"v_":"a_")+oc),[H.GeometryType]:i=>(i.geometryType=!0,(i.inFragmentShader?"v_":"a_")+ac),[H.LineMetric]:()=>"currentLineMetric",[H.Var]:(i,e)=>{const r=e.args[0].value;return r in i.variables||(i.variables[r]={name:r,type:e.type}),Hs(r)},[H.Resolution]:()=>"u_resolution",[H.Zoom]:()=>"u_zoom",[H.Time]:()=>"u_time",[H.Any]:ne(i=>`(${i.join(" || ")})`),[H.All]:ne(i=>`(${i.join(" && ")})`),[H.Not]:ne(([i])=>`(!${i})`),[H.Equal]:ne(([i,e])=>`(${i} == ${e})`),[H.NotEqual]:ne(([i,e])=>`(${i} != ${e})`),[H.GreaterThan]:ne(([i,e])=>`(${i} > ${e})`),[H.GreaterThanOrEqualTo]:ne(([i,e])=>`(${i} >= ${e})`),[H.LessThan]:ne(([i,e])=>`(${i} < ${e})`),[H.LessThanOrEqualTo]:ne(([i,e])=>`(${i} <= ${e})`),[H.Multiply]:ne(i=>`(${i.join(" * ")})`),[H.Divide]:ne(([i,e])=>`(${i} / ${e})`),[H.Add]:ne(i=>`(${i.join(" + ")})`),[H.Subtract]:ne(([i,e])=>`(${i} - ${e})`),[H.Clamp]:ne(([i,e,t])=>`clamp(${i}, ${e}, ${t})`),[H.Mod]:ne(([i,e])=>`mod(${i}, ${e})`),[H.Pow]:ne(([i,e])=>`pow(${i}, ${e})`),[H.Abs]:ne(([i])=>`abs(${i})`),[H.Floor]:ne(([i])=>`floor(${i})`),[H.Ceil]:ne(([i])=>`ceil(${i})`),[H.Round]:ne(([i])=>`floor(${i} + 0.5)`),[H.Sin]:ne(([i])=>`sin(${i})`),[H.Cos]:ne(([i])=>`cos(${i})`),[H.Atan]:ne(([i,e])=>e!==void 0?`atan(${i}, ${e})`:`atan(${i})`),[H.Sqrt]:ne(([i])=>`sqrt(${i})`),[H.Match]:ne(i=>{const e=i[0],t=i[i.length-1];let r=null;for(let n=i.length-3;n>=1;n-=2){const s=i[n],o=i[n+1];r=`(${e} == ${s} ? ${o} : ${r||t})`}return r}),[H.Between]:ne(([i,e,t])=>`(${i} >= ${e} && ${i} <= ${t})`),[H.Interpolate]:ne(([i,e,...t])=>{let r="";for(let n=0;n<t.length-2;n+=2){const s=t[n],o=r||t[n+1],a=t[n+2],c=t[n+3];let l;i===Wt(1)?l=`(${e} - ${s}) / (${a} - ${s})`:l=`(pow(${i}, (${e} - ${s})) - 1.0) / (pow(${i}, (${a} - ${s})) - 1.0)`,r=`mix(${o}, ${c}, clamp(${l}, 0.0, 1.0))`}return r}),[H.Case]:ne(i=>{const e=i[i.length-1];let t=null;for(let r=i.length-3;r>=0;r-=2){const n=i[r],s=i[r+1];t=`(${n} ? ${s} : ${t||e})`}return t}),[H.In]:ne(([i,...e],t)=>{const r=wm("in",t),n=[];for(let s=0;s<e.length;s+=1)n.push(`  if (inputValue == ${e[s]}) { return true; }`);return t.functions[r]=`bool ${r}(float inputValue) {
${n.join(`
`)}
  return false;
}`,`${r}(${i})`}),[H.Array]:ne(i=>`vec${i.length}(${i.join(", ")})`),[H.Color]:ne(i=>{if(i.length===1)return`vec4(vec3(${i[0]} / 255.0), 1.0)`;if(i.length===2)return`vec4(vec3(${i[0]} / 255.0), ${i[1]})`;const e=i.slice(0,3).map(r=>`${r} / 255.0`);if(i.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=i[3];return`vec4(${e.join(", ")}, ${t})`}),[H.Band]:ne(([i,e,t],r)=>{if(!(Pn in r.functions)){let n="";const s=r.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let c=o%4;o===s-1&&c===1&&(c=3);const l=`${V.TILE_TEXTURE_ARRAY}[${a}]`;n+=`  if (band == ${o+1}.0) {
    return texture2D(${l}, v_textureCoord + vec2(dx, dy))[${c}];
  }
`}r.functions[Pn]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${V.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${V.TEXTURE_PIXEL_HEIGHT};
${n}
}`}return`${Pn}(${i}, ${e??"0.0"}, ${t??"0.0"})`}),[H.Palette]:(i,e)=>{const[t,...r]=e.args,n=r.length,s=new Uint8Array(n*4);for(let l=0;l<r.length;l++){const u=r[l].value,h=Wr(u),f=l*4;s[f]=h[0],s[f+1]=h[1],s[f+2]=h[2],s[f+3]=h[3]*255}i.paletteTextures||(i.paletteTextures=[]);const o=`${sc}[${i.paletteTextures.length}]`,a=new Tm(o,s);i.paletteTextures.push(a);const c=Zs(t,fe,i);return`texture2D(${o}, vec2((${c} + 0.5) / ${n}.0, 0.5))`}};function Zs(i,e,t){if(i instanceof Ju){const r=Pm[i.operator];if(r===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(i.operator)}`);return r(t,i,e)}if((i.type&fe)>0)return Wt(i.value);if((i.type&xs)>0)return i.value.toString();if((i.type&Hr)>0)return yt(i.value.toString());if((i.type&$e)>0)return Pi(i.value);if((i.type&Dt)>0)return Ws(i.value);if((i.type&Tr)>0)return Sm(i.value);throw new Error(`Unexpected expression ${i.value} (expected type ${Qu(e)})`)}function Am(){return{"fill-color":"rgba(255,255,255,0.4)","stroke-color":"#3399CC","stroke-width":1.25,"circle-radius":5,"circle-fill-color":"rgba(255,255,255,0.4)","circle-stroke-width":1.25,"circle-stroke-color":"#3399CC"}}const tr=`#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform mat4 u_projectionMatrix;
uniform mat4 u_screenToWorldMatrix;
uniform vec2 u_viewportSizePx;
uniform float u_pixelRatio;
uniform float u_globalAlpha;
uniform float u_time;
uniform float u_zoom;
uniform float u_resolution;
uniform float u_rotation;
uniform vec4 u_renderExtent;
uniform vec2 u_patternOrigin;
uniform float u_depth;
uniform mediump int u_hitDetection;

const float PI = 3.141592653589793238;
const float TWO_PI = 2.0 * PI;
float currentLineMetric = 0.; // an actual value will be used in the stroke shaders
`,rr=Am();class lc{constructor(){this.uniforms_=[],this.attributes_=[],this.varyings_=[],this.hasSymbol_=!1,this.symbolSizeExpression_=`vec2(${Wt(rr["circle-radius"])} + ${Wt(rr["circle-stroke-width"]*.5)})`,this.symbolRotationExpression_="0.0",this.symbolOffsetExpression_="vec2(0.0)",this.symbolColorExpression_=Pi(rr["circle-fill-color"]),this.texCoordExpression_="vec4(0.0, 0.0, 1.0, 1.0)",this.discardExpression_="false",this.symbolRotateWithView_=!1,this.hasStroke_=!1,this.strokeWidthExpression_=Wt(rr["stroke-width"]),this.strokeColorExpression_=Pi(rr["stroke-color"]),this.strokeOffsetExpression_="0.",this.strokeCapExpression_=yt("round"),this.strokeJoinExpression_=yt("round"),this.strokeMiterLimitExpression_="10.",this.strokeDistanceFieldExpression_="-1000.",this.hasFill_=!1,this.fillColorExpression_=Pi(rr["fill-color"]),this.vertexShaderFunctions_=[],this.fragmentShaderFunctions_=[]}addUniform(e){return this.uniforms_.push(e),this}addAttribute(e){return this.attributes_.push(e),this}addVarying(e,t,r){return this.varyings_.push({name:e,type:t,expression:r}),this}setSymbolSizeExpression(e){return this.hasSymbol_=!0,this.symbolSizeExpression_=e,this}getSymbolSizeExpression(){return this.symbolSizeExpression_}setSymbolRotationExpression(e){return this.symbolRotationExpression_=e,this}setSymbolOffsetExpression(e){return this.symbolOffsetExpression_=e,this}getSymbolOffsetExpression(){return this.symbolOffsetExpression_}setSymbolColorExpression(e){return this.hasSymbol_=!0,this.symbolColorExpression_=e,this}getSymbolColorExpression(){return this.symbolColorExpression_}setTextureCoordinateExpression(e){return this.texCoordExpression_=e,this}setFragmentDiscardExpression(e){return this.discardExpression_=e,this}getFragmentDiscardExpression(){return this.discardExpression_}setSymbolRotateWithView(e){return this.symbolRotateWithView_=e,this}setStrokeWidthExpression(e){return this.hasStroke_=!0,this.strokeWidthExpression_=e,this}setStrokeColorExpression(e){return this.hasStroke_=!0,this.strokeColorExpression_=e,this}getStrokeColorExpression(){return this.strokeColorExpression_}setStrokeOffsetExpression(e){return this.strokeOffsetExpression_=e,this}setStrokeCapExpression(e){return this.strokeCapExpression_=e,this}setStrokeJoinExpression(e){return this.strokeJoinExpression_=e,this}setStrokeMiterLimitExpression(e){return this.strokeMiterLimitExpression_=e,this}setStrokeDistanceFieldExpression(e){return this.strokeDistanceFieldExpression_=e,this}setFillColorExpression(e){return this.hasFill_=!0,this.fillColorExpression_=e,this}getFillColorExpression(){return this.fillColorExpression_}addVertexShaderFunction(e){this.vertexShaderFunctions_.includes(e)||this.vertexShaderFunctions_.push(e)}addFragmentShaderFunction(e){this.fragmentShaderFunctions_.includes(e)||this.fragmentShaderFunctions_.push(e)}getSymbolVertexShader(){return this.hasSymbol_?`${tr}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
attribute vec2 a_position;
attribute float a_index;
attribute vec4 a_hitColor;
${this.attributes_.map(function(e){return"attribute "+e+";"}).join(`
`)}
varying vec2 v_texCoord;
varying vec2 v_quadCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 pxToScreen(vec2 coordPx) {
  vec2 scaled = coordPx / u_viewportSizePx / 0.5;
  return scaled;
}

vec2 screenToPx(vec2 coordScreen) {
  return (coordScreen * 0.5 + 0.5) * u_viewportSizePx;
}

void main(void) {
  v_quadSizePx = ${this.symbolSizeExpression_};
  vec2 halfSizePx = v_quadSizePx * 0.5;
  vec2 centerOffsetPx = ${this.symbolOffsetExpression_};
  vec2 offsetPx = centerOffsetPx;
  if (a_index == 0.0) {
    offsetPx -= halfSizePx;
  } else if (a_index == 1.0) {
    offsetPx += halfSizePx * vec2(1., -1.);
  } else if (a_index == 2.0) {
    offsetPx += halfSizePx;
  } else {
    offsetPx += halfSizePx * vec2(-1., 1.);
  }
  float angle = ${this.symbolRotationExpression_};
  ${this.symbolRotateWithView_?"angle += u_rotation;":""}
  float c = cos(-angle);
  float s = sin(-angle);
  offsetPx = vec2(c * offsetPx.x - s * offsetPx.y, s * offsetPx.x + c * offsetPx.y);
  vec4 center = u_projectionMatrix * vec4(a_position, 0.0, 1.0);
  gl_Position = center + vec4(pxToScreen(offsetPx), u_depth, 0.);
  vec4 texCoord = ${this.texCoordExpression_};
  float u = a_index == 0.0 || a_index == 3.0 ? texCoord.s : texCoord.p;
  float v = a_index == 2.0 || a_index == 3.0 ? texCoord.t : texCoord.q;
  v_texCoord = vec2(u, v);
  v_hitColor = a_hitColor;
  v_angle = angle;
  c = cos(-v_angle);
  s = sin(-v_angle);
  centerOffsetPx = vec2(c * centerOffsetPx.x - s * centerOffsetPx.y, s * centerOffsetPx.x + c * centerOffsetPx.y); 
  v_centerPx = screenToPx(center.xy) + centerOffsetPx;
${this.varyings_.map(function(e){return"  "+e.name+" = "+e.expression+";"}).join(`
`)}
}`:null}getSymbolFragmentShader(){return this.hasSymbol_?`${tr}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
varying vec2 v_texCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

void main(void) {
  if (${this.discardExpression_}) { discard; }
  vec2 coordsPx = gl_FragCoord.xy / u_pixelRatio - v_centerPx; // relative to center
  float c = cos(v_angle);
  float s = sin(v_angle);
  coordsPx = vec2(c * coordsPx.x - s * coordsPx.y, s * coordsPx.x + c * coordsPx.y);
  gl_FragColor = ${this.symbolColorExpression_};
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.05) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getStrokeVertexShader(){return this.hasStroke_?`${tr}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
attribute vec2 a_segmentStart;
attribute vec2 a_segmentEnd;
attribute float a_measureStart;
attribute float a_measureEnd;
attribute float a_parameters;
attribute float a_distance;
attribute vec2 a_joinAngles;
attribute vec4 a_hitColor;
${this.attributes_.map(function(e){return"attribute "+e+";"}).join(`
`)}
varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

vec4 pxToScreen(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return vec4(screenPos, u_depth, 1.0);
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

vec2 getJoinOffsetDirection(vec2 normalPx, float joinAngle) {
  float halfAngle = joinAngle / 2.0;
  float c = cos(halfAngle);
  float s = sin(halfAngle);
  vec2 angleBisectorNormal = vec2(s * normalPx.x + c * normalPx.y, -c * normalPx.x + s * normalPx.y);
  float length = 1.0 / s;
  return angleBisectorNormal * length;
}

vec2 getOffsetPoint(vec2 point, vec2 normal, float joinAngle, float offsetPx) {
  // if on a cap or the join angle is too high, offset the line along the segment normal
  if (cos(joinAngle) > 0.998 || isCap(joinAngle)) {
    return point - normal * offsetPx;
  }
  // offset is applied along the inverted normal (positive offset goes "right" relative to line direction)
  return point - getJoinOffsetDirection(normal, joinAngle) * offsetPx;
}

void main(void) {
  v_angleStart = a_joinAngles.x;
  v_angleEnd = a_joinAngles.y;
  float vertexNumber = floor(abs(a_parameters) / 10000. + 0.5);
  currentLineMetric = vertexNumber < 1.5 ? a_measureStart : a_measureEnd;
  // we're reading the fractional part while keeping the sign (so -4.12 gives -0.12, 3.45 gives 0.45)
  float angleTangentSum = fract(abs(a_parameters) / 10000.) * 10000. * sign(a_parameters);

  float lineWidth = ${this.strokeWidthExpression_};
  float lineOffsetPx = ${this.strokeOffsetExpression_};

  // compute segment start/end in px with offset
  vec2 segmentStartPx = worldToPx(a_segmentStart);
  vec2 segmentEndPx = worldToPx(a_segmentEnd);
  vec2 tangentPx = normalize(segmentEndPx - segmentStartPx);
  vec2 normalPx = vec2(-tangentPx.y, tangentPx.x);
  segmentStartPx = getOffsetPoint(segmentStartPx, normalPx, v_angleStart, lineOffsetPx),
  segmentEndPx = getOffsetPoint(segmentEndPx, normalPx, v_angleEnd, lineOffsetPx);
  
  // compute current vertex position
  float normalDir = vertexNumber < 0.5 || (vertexNumber > 1.5 && vertexNumber < 2.5) ? 1.0 : -1.0;
  float tangentDir = vertexNumber < 1.5 ? 1.0 : -1.0;
  float angle = vertexNumber < 1.5 ? v_angleStart : v_angleEnd;
  vec2 joinDirection;
  vec2 positionPx = vertexNumber < 1.5 ? segmentStartPx : segmentEndPx;
  // if angle is too high, do not make a proper join
  if (cos(angle) > ${pa} || isCap(angle)) {
    joinDirection = normalPx * normalDir - tangentPx * tangentDir;
  } else {
    joinDirection = getJoinOffsetDirection(normalPx * normalDir, angle);
  }
  positionPx = positionPx + joinDirection * (lineWidth * 0.5 + 1.); // adding 1 pixel for antialiasing
  gl_Position = pxToScreen(positionPx);

  v_segmentStart = segmentStartPx;
  v_segmentEnd = segmentEndPx;
  v_width = lineWidth;
  v_hitColor = a_hitColor;
  v_distanceOffsetPx = a_distance / u_resolution - (lineOffsetPx * angleTangentSum);
  v_measureStart = a_measureStart;
  v_measureEnd = a_measureEnd;
${this.varyings_.map(function(e){return"  "+e.name+" = "+e.expression+";"}).join(`
`)}
}`:null}getStrokeFragmentShader(){return this.hasStroke_?`${tr}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

float segmentDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  vec2 tangent = normalize(end - start);
  vec2 normal = vec2(-tangent.y, tangent.x);
  vec2 startToPoint = point - start;
  return abs(dot(startToPoint, normal)) - width * 0.5;
}

float buttCapDistanceField(vec2 point, vec2 start, vec2 end) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  return dot(startToPoint, -tangent);
}

float squareCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return buttCapDistanceField(point, start, end) - width * 0.5;
}

float roundCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  float onSegment = max(0., 1000. * dot(point - start, end - start)); // this is very high when inside the segment
  return length(point - start) - width * 0.5 - onSegment;
}

float roundJoinDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return roundCapDistanceField(point, start, end, width);
}

float bevelJoinField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  float c = cos(joinAngle * 0.5);
  float s = sin(joinAngle * 0.5);
  float direction = -sign(sin(joinAngle));
  vec2 bisector = vec2(c * tangent.x - s * tangent.y, s * tangent.x + c * tangent.y);
  float radius = width * 0.5 * s;
  return dot(startToPoint, bisector * direction) - radius;
}

float miterJoinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  if (cos(joinAngle) > ${pa}) { // avoid risking a division by zero
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  float miterLength = 1. / sin(joinAngle * 0.5);
  float miterLimit = ${this.strokeMiterLimitExpression_};
  if (miterLength > miterLimit) {
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  return -1000.;
}

float capDistanceField(vec2 point, vec2 start, vec2 end, float width, float capType) {
   if (capType == ${yt("butt")}) {
    return buttCapDistanceField(point, start, end);
  } else if (capType == ${yt("square")}) {
    return squareCapDistanceField(point, start, end, width);
  }
  return roundCapDistanceField(point, start, end, width);
}

float joinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float joinType) {
  if (joinType == ${yt("bevel")}) {
    return bevelJoinField(point, start, end, width, joinAngle);
  } else if (joinType == ${yt("miter")}) {
    return miterJoinDistanceField(point, start, end, width, joinAngle);
  }
  return roundJoinDistanceField(point, start, end, width);
}

float computeSegmentPointDistance(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float capType, float joinType) {
  if (isCap(joinAngle)) {
    return capDistanceField(point, start, end, width, capType);
  }
  return joinDistanceField(point, start, end, width, joinAngle, joinType);
}

void main(void) {
  vec2 currentPoint = gl_FragCoord.xy / u_pixelRatio;
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(currentPoint);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif

  float segmentLength = length(v_segmentEnd - v_segmentStart);
  vec2 segmentTangent = (v_segmentEnd - v_segmentStart) / segmentLength;
  vec2 segmentNormal = vec2(-segmentTangent.y, segmentTangent.x);
  vec2 startToPoint = currentPoint - v_segmentStart;
  float lengthToPoint = max(0., min(dot(segmentTangent, startToPoint), segmentLength));
  float currentLengthPx = lengthToPoint + v_distanceOffsetPx; 
  float currentRadiusPx = abs(dot(segmentNormal, startToPoint));
  float currentRadiusRatio = dot(segmentNormal, startToPoint) * 2. / v_width;
  currentLineMetric = mix(v_measureStart, v_measureEnd, lengthToPoint / segmentLength);

  if (${this.discardExpression_}) { discard; }

  vec4 color = ${this.strokeColorExpression_};
  float capType = ${this.strokeCapExpression_};
  float joinType = ${this.strokeJoinExpression_};
  float segmentStartDistance = computeSegmentPointDistance(currentPoint, v_segmentStart, v_segmentEnd, v_width, v_angleStart, capType, joinType);
  float segmentEndDistance = computeSegmentPointDistance(currentPoint, v_segmentEnd, v_segmentStart, v_width, v_angleEnd, capType, joinType);
  float distance = max(
    segmentDistanceField(currentPoint, v_segmentStart, v_segmentEnd, v_width),
    max(segmentStartDistance, segmentEndDistance)
  );
  distance = max(distance, ${this.strokeDistanceFieldExpression_});
  color.a *= smoothstep(0.5, -0.5, distance);
  gl_FragColor = color;
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getFillVertexShader(){return this.hasFill_?`${tr}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
attribute vec2 a_position;
attribute vec4 a_hitColor;
${this.attributes_.map(function(e){return"attribute "+e+";"}).join(`
`)}
varying vec4 v_hitColor;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
void main(void) {
  gl_Position = u_projectionMatrix * vec4(a_position, u_depth, 1.0);
  v_hitColor = a_hitColor;
${this.varyings_.map(function(e){return"  "+e.name+" = "+e.expression+";"}).join(`
`)}
}`:null}getFillFragmentShader(){return this.hasFill_?`${tr}
${this.uniforms_.map(function(e){return"uniform "+e+";"}).join(`
`)}
varying vec4 v_hitColor;
${this.varyings_.map(function(e){return"varying "+e.type+" "+e.name+";"}).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}
vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

void main(void) {
  vec2 pxPos = gl_FragCoord.xy / u_pixelRatio;
  vec2 pxOrigin = worldToPx(u_patternOrigin);
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(pxPos);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif
  if (${this.discardExpression_}) { discard; }
  gl_FragColor = ${this.fillColorExpression_};
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}}const tt={BLUR:"blur",GRADIENT:"gradient",RADIUS:"radius"},Lm=["#00f","#0ff","#0f0","#ff0","#f00"];class Im extends an{constructor(e){e=e||{};const t=Object.assign({},e);delete t.gradient,delete t.radius,delete t.blur,delete t.weight,super(t),this.gradient_=null,this.addChangeListener(tt.GRADIENT,this.handleGradientChanged_),this.setGradient(e.gradient?e.gradient:Lm),this.setBlur(e.blur!==void 0?e.blur:15),this.setRadius(e.radius!==void 0?e.radius:8);const r=e.weight?e.weight:"weight";this.weightFunction_=typeof r=="string"?n=>n.get(r):r,this.setRenderOrder(null)}getBlur(){return this.get(tt.BLUR)}getGradient(){return this.get(tt.GRADIENT)}getRadius(){return this.get(tt.RADIUS)}handleGradientChanged_(){this.gradient_=Cm(this.getGradient())}setBlur(e){this.set(tt.BLUR,e)}setGradient(e){this.set(tt.GRADIENT,e)}setRadius(e){this.set(tt.RADIUS,e)}createRenderer(){const e=new lc().addAttribute("float a_weight").addVarying("v_weight","float","a_weight").addUniform("float u_size").addUniform("float u_blurSlope").setSymbolSizeExpression("vec2(u_size)").setSymbolColorExpression("vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * u_blurSlope) * v_weight)");return new ic(this,{className:this.getClassName(),attributes:[{name:"weight",callback:t=>{const r=this.weightFunction_(t);return r!==void 0?Ee(r,0,1):1}}],uniforms:{u_size:()=>(this.get(tt.RADIUS)+this.get(tt.BLUR))*2,u_blurSlope:()=>this.get(tt.RADIUS)/Math.max(1,this.get(tt.BLUR))},hitDetectionEnabled:!0,vertexShader:e.getSymbolVertexShader(),fragmentShader:e.getSymbolFragmentShader(),postProcesses:[{fragmentShader:`
            precision mediump float;

            uniform sampler2D u_image;
            uniform sampler2D u_gradientTexture;
            uniform float u_opacity;

            varying vec2 v_texCoord;

            void main() {
              vec4 color = texture2D(u_image, v_texCoord);
              gl_FragColor.a = color.a * u_opacity;
              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;
              gl_FragColor.rgb *= gl_FragColor.a;
            }`,uniforms:{u_gradientTexture:()=>this.gradient_,u_opacity:()=>this.getOpacity()}}]})}renderDeclutter(){}}function Cm(i){const r=Nt(1,256),n=r.createLinearGradient(0,0,1,256),s=1/(i.length-1);for(let o=0,a=i.length;o<a;++o)n.addColorStop(o*s,i[o]);return r.fillStyle=n,r.fillRect(0,0,1,256),r.canvas}class Ys extends ll{constructor(e,t,r,n,s){const o=s!==void 0?Vt.IDLE:Vt.LOADED;super(e,t,r,o),this.loader_=s!==void 0?s:null,this.canvas_=n,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=Vt.ERROR):this.state=Vt.LOADED,this.changed()}load(){this.state==Vt.IDLE&&(this.state=Vt.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}class Fm extends eh{constructor(e){super(e),this.vectorRenderer_=new th(e),this.layerImageRatio_=e.getImageRatio(),this.coordinateToVectorPixelTransform_=Fe(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(e){if(!this.vectorRenderer_)return Promise.resolve([]);const t=Tt(this.coordinateToVectorPixelTransform_,Tt(this.renderedPixelToCoordinateTransform_,e.slice()));return this.vectorRenderer_.getFeatures(t)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(e){const t=e.pixelRatio,r=e.viewState,n=r.resolution,s=e.viewHints,o=this.vectorRenderer_;let a=e.extent;this.layerImageRatio_!==1&&(a=a.slice(0),cl(a,this.layerImageRatio_));const c=Me(a)/n,l=st(a)/n;if(!s[Ot.ANIMATING]&&!s[Ot.INTERACTING]&&!on(a)){o.useContainer(null,null);const u=o.context,h=e.layerStatesArray[e.layerIndex],f=Object.assign({},h,{opacity:1}),d=Object.assign({},e,{extent:a,size:[c,l],viewState:Object.assign({},e.viewState,{rotation:0}),layerStatesArray:[f],layerIndex:0,declutter:null}),g=this.getLayer().getDeclutter();g&&(d.declutter={[g]:new rh(9)});let p=!0;const m=new Ys(a,n,t,u.canvas,function(y){o.prepareFrame(d)&&o.replayGroupChanged&&(o.clipping=!1,o.renderFrame(d,null)&&(o.renderDeclutter(d),o.renderDeferred(d),p=!1),y())});m.addEventListener(Be.CHANGE,()=>{if(m.getState()!==Vt.LOADED)return;this.image=p?null:m;const y=m.getPixelRatio(),_=ih(m.getResolution())*t/y;this.renderedResolution=_,this.coordinateToVectorPixelTransform_=ps(this.coordinateToVectorPixelTransform_,c/2,l/2,1/_,-1/_,0,-r.center[0],-r.center[1])}),m.load()}return this.image&&(this.renderedPixelToCoordinateTransform_=e.pixelToCoordinateTransform.slice()),!!this.image}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(e,t,r,n,s){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(e,t,r,n,s):super.forEachFeatureAtCoordinate(e,t,r,n,s)}}class Mm extends an{constructor(e){e=e||{};const t=Object.assign({},e);delete t.imageRatio,super(t),this.imageRatio_=e.imageRatio!==void 0?e.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new Fm(this)}}function $(i,e,t){const r=ul();return vm(e,t,r,i)}function Om(i){const e=Wr(i),t=e[0]*256,r=e[1],n=e[2]*256,s=Math.round(e[3]*255);return[t+r,n+s]}const Nm=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    fract(floor(packedColor[0] / 256.0) / 256.0),
    fract(packedColor[0] / 256.0),
    fract(floor(packedColor[1] / 256.0) / 256.0),
    fract(packedColor[1] / 256.0)
  );
}`;function Qn(i){return i===$e||i===Tr?2:i===Dt?4:1}function xi(i){const e=Qn(i);return e>1?`vec${e}`:"float"}function Xi(i){return(JSON.stringify(i).split("").reduce((t,r)=>(t<<5)-t+r.charCodeAt(0),0)>>>0).toString()}function qs(i,e,t,r){if(`${r}radius`in i&&r!=="icon-"){let n=$(t,i[`${r}radius`],fe);if(`${r}radius2`in i){const s=$(t,i[`${r}radius2`],fe);n=`max(${n}, ${s})`}`${r}stroke-width`in i&&(n=`(${n} + ${$(t,i[`${r}stroke-width`],fe)} * 0.5)`),e.setSymbolSizeExpression(`vec2(${n} * 2. + 0.5)`)}if(`${r}scale`in i){const n=$(t,i[`${r}scale`],Tr);e.setSymbolSizeExpression(`${e.getSymbolSizeExpression()} * ${n}`)}`${r}displacement`in i&&e.setSymbolOffsetExpression($(t,i[`${r}displacement`],Dt)),`${r}rotation`in i&&e.setSymbolRotationExpression($(t,i[`${r}rotation`],fe)),`${r}rotate-with-view`in i&&e.setSymbolRotateWithView(!!i[`${r}rotate-with-view`])}function cc(i,e,t,r,n){let s="vec4(0.)";if(e!==null&&(s=e),t!==null&&r!==null){const c=`smoothstep(-${r} + 0.63, -${r} - 0.58, ${i})`;s=`mix(${t}, ${s}, ${c})`}const o=`(1.0 - smoothstep(-0.63, 0.58, ${i}))`;let a=`${s} * vec4(1.0, 1.0, 1.0, ${o})`;return n!==null&&(a=`${a} * vec4(1.0, 1.0, 1.0, ${n})`),a}function Ks(i,e,t,r,n){const s=new Image;s.crossOrigin=i[`${r}cross-origin`]===void 0?"anonymous":i[`${r}cross-origin`],et(typeof i[`${r}src`]=="string",`WebGL layers do not support expressions for the ${r}src style property`),s.src=i[`${r}src`],t[`u_texture${n}_size`]=()=>s.complete?[s.width,s.height]:[0,0],e.addUniform(`vec2 u_texture${n}_size`);const o=`u_texture${n}_size`;return t[`u_texture${n}`]=s,e.addUniform(`sampler2D u_texture${n}`),o}function Js(i,e,t,r,n){let s=$(t,i[`${e}offset`],Dt);if(`${e}offset-origin`in i)switch(i[`${e}offset-origin`]){case"top-right":s=`vec2(${r}.x, 0.) + ${n} * vec2(-1., 0.) + ${s} * vec2(-1., 1.)`;break;case"bottom-left":s=`vec2(0., ${r}.y) + ${n} * vec2(0., -1.) + ${s} * vec2(1., -1.)`;break;case"bottom-right":s=`${r} - ${n} - ${s}`;break}return s}function Dm(i,e,t,r,n){n.functions.circleDistanceField=`float circleDistanceField(vec2 point, float radius) {
  return length(point) - radius;
}`,qs(i,e,r,"circle-");let s=null;"circle-opacity"in i&&(s=$(n,i["circle-opacity"],fe));let o="coordsPx";"circle-scale"in i&&(o=`coordsPx / ${$(n,i["circle-scale"],Tr)}`);let a=null;"circle-fill-color"in i&&(a=$(n,i["circle-fill-color"],$e));let c=null;"circle-stroke-color"in i&&(c=$(n,i["circle-stroke-color"],$e));let l=$(n,i["circle-radius"],fe),u=null;"circle-stroke-width"in i&&(u=$(n,i["circle-stroke-width"],fe),l=`(${l} + ${u} * 0.5)`);const h=`circleDistanceField(${o}, ${l})`,f=cc(h,a,c,u,s);e.setSymbolColorExpression(f)}function Um(i,e,t,r,n){n.functions.round=`float round(float v) {
  return sign(v) * floor(abs(v) + 0.5);
}`,n.functions.starDistanceField=`float starDistanceField(vec2 point, float numPoints, float radius, float radius2, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round(beta / alpha) * alpha; // angle in sector
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  vec2 tipToPoint = inSector + vec2(-radius, 0.);
  vec2 edgeNormal = vec2(radius2 * sin(alpha * 0.5), -radius2 * cos(alpha * 0.5) + radius);
  return dot(normalize(edgeNormal), tipToPoint);
}`,n.functions.regularDistanceField=`float regularDistanceField(vec2 point, float numPoints, float radius, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float radiusIn = radius * cos(PI / numPoints);
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round((beta - alpha * 0.5) / alpha) * alpha + alpha * 0.5; // angle in sector from mid
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  return inSector.x - radiusIn;
}`,qs(i,e,r,"shape-");let s=null;"shape-opacity"in i&&(s=$(n,i["shape-opacity"],fe));let o="coordsPx";"shape-scale"in i&&(o=`coordsPx / ${$(n,i["shape-scale"],Tr)}`);let a=null;"shape-fill-color"in i&&(a=$(n,i["shape-fill-color"],$e));let c=null;"shape-stroke-color"in i&&(c=$(n,i["shape-stroke-color"],$e));let l=null;"shape-stroke-width"in i&&(l=$(n,i["shape-stroke-width"],fe));const u=$(n,i["shape-points"],fe);let h="0.";"shape-angle"in i&&(h=$(n,i["shape-angle"],fe));let f,d=$(n,i["shape-radius"],fe);if(l!==null&&(d=`${d} + ${l} * 0.5`),"shape-radius2"in i){let p=$(n,i["shape-radius2"],fe);l!==null&&(p=`${p} + ${l} * 0.5`),f=`starDistanceField(${o}, ${u}, ${d}, ${p}, ${h})`}else f=`regularDistanceField(${o}, ${u}, ${d}, ${h})`;const g=cc(f,a,c,l,s);e.setSymbolColorExpression(g)}function Gm(i,e,t,r,n){let s="vec4(1.0)";"icon-color"in i&&(s=$(n,i["icon-color"],$e)),"icon-opacity"in i&&(s=`${s} * vec4(1.0, 1.0, 1.0, ${$(n,i["icon-opacity"],fe)})`);const o=Xi(i["icon-src"]),a=Ks(i,e,t,"icon-",o);if(e.setSymbolColorExpression(`${s} * texture2D(u_texture${o}, v_texCoord)`).setSymbolSizeExpression(a),"icon-width"in i&&"icon-height"in i&&e.setSymbolSizeExpression(`vec2(${$(r,i["icon-width"],fe)}, ${$(r,i["icon-height"],fe)})`),"icon-offset"in i&&"icon-size"in i){const c=$(r,i["icon-size"],Dt),l=e.getSymbolSizeExpression();e.setSymbolSizeExpression(c);const u=Js(i,"icon-",r,"v_quadSizePx",c);e.setTextureCoordinateExpression(`(vec4((${u}).xyxy) + vec4(0., 0., ${c})) / (${l}).xyxy`)}if(qs(i,e,r,"icon-"),"icon-anchor"in i){const c=$(r,i["icon-anchor"],Dt);let l="1.0";"icon-scale"in i&&(l=$(r,i["icon-scale"],Tr));let u;i["icon-anchor-x-units"]==="pixels"&&i["icon-anchor-y-units"]==="pixels"?u=`${c} * ${l}`:i["icon-anchor-x-units"]==="pixels"?u=`${c} * vec2(vec2(${l}).x, v_quadSizePx.y)`:i["icon-anchor-y-units"]==="pixels"?u=`${c} * vec2(v_quadSizePx.x, vec2(${l}).x)`:u=`${c} * v_quadSizePx`;let h=`v_quadSizePx * vec2(0.5, -0.5) + ${u} * vec2(-1., 1.)`;if("icon-anchor-origin"in i)switch(i["icon-anchor-origin"]){case"top-right":h=`v_quadSizePx * -0.5 + ${u}`;break;case"bottom-left":h=`v_quadSizePx * 0.5 - ${u}`;break;case"bottom-right":h=`v_quadSizePx * vec2(-0.5, 0.5) + ${u} * vec2(1., -1.)`;break}e.setSymbolOffsetExpression(`${e.getSymbolOffsetExpression()} + ${h}`)}}function Bm(i,e,t,r,n){if("stroke-color"in i&&e.setStrokeColorExpression($(n,i["stroke-color"],$e)),"stroke-pattern-src"in i){const s=Xi(i["stroke-pattern-src"]),o=Ks(i,e,t,"stroke-pattern-",s);let a=o,c="vec2(0.)";"stroke-pattern-offset"in i&&"stroke-pattern-size"in i&&(a=$(n,i["stroke-pattern-size"],Dt),c=Js(i,"stroke-pattern-",n,o,a));let l="0.";"stroke-pattern-spacing"in i&&(l=$(n,i["stroke-pattern-spacing"],fe)),n.functions.sampleStrokePattern=`vec4 sampleStrokePattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, float spacingPx, float currentLengthPx, float currentRadiusRatio, float lineWidth) {
  float currentLengthScaled = currentLengthPx * sampleSize.y / lineWidth;
  float spacingScaled = spacingPx * sampleSize.y / lineWidth;
  float uCoordPx = mod(currentLengthScaled, (sampleSize.x + spacingScaled));
  // make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  uCoordPx = clamp(uCoordPx, 0.5, sampleSize.x - 0.5);
  float vCoordPx = (-currentRadiusRatio * 0.5 + 0.5) * sampleSize.y;
  vec2 texCoord = (vec2(uCoordPx, vCoordPx) + textureOffset) / textureSize;
  return texture2D(texture, texCoord);
}`;const u=`u_texture${s}`;let h="1.";"stroke-color"in i&&(h=e.getStrokeColorExpression()),e.setStrokeColorExpression(`${h} * sampleStrokePattern(${u}, ${o}, ${c}, ${a}, ${l}, currentLengthPx, currentRadiusRatio, v_width)`)}if("stroke-width"in i&&e.setStrokeWidthExpression($(r,i["stroke-width"],fe)),"stroke-offset"in i&&e.setStrokeOffsetExpression($(r,i["stroke-offset"],fe)),"stroke-line-cap"in i&&e.setStrokeCapExpression($(r,i["stroke-line-cap"],Hr)),"stroke-line-join"in i&&e.setStrokeJoinExpression($(r,i["stroke-line-join"],Hr)),"stroke-miter-limit"in i&&e.setStrokeMiterLimitExpression($(r,i["stroke-miter-limit"],fe)),"stroke-line-dash"in i){n.functions.getSingleDashDistance=`float getSingleDashDistance(float distance, float radius, float dashOffset, float dashLength, float dashLengthTotal, float capType) {
  float localDistance = mod(distance, dashLengthTotal);
  float distanceSegment = abs(localDistance - dashOffset - dashLength * 0.5) - dashLength * 0.5;
  distanceSegment = min(distanceSegment, dashLengthTotal - localDistance);
  if (capType == ${yt("square")}) {
    distanceSegment -= v_width * 0.5;
  } else if (capType == ${yt("round")}) {
    distanceSegment = min(distanceSegment, sqrt(distanceSegment * distanceSegment + radius * radius) - v_width * 0.5);
  }
  return distanceSegment;
}`;let s=i["stroke-line-dash"].map(d=>$(n,d,fe));s.length%2===1&&(s=[...s,...s]);let o="0.";"stroke-line-dash-offset"in i&&(o=$(r,i["stroke-line-dash-offset"],fe));const c=`dashDistanceField_${Xi(i["stroke-line-dash"])}`,l=s.map((d,g)=>`float dashLength${g} = ${d};`),u=s.map((d,g)=>`dashLength${g}`).join(" + ");let h="0.",f=`getSingleDashDistance(distance, radius, ${h}, dashLength0, totalDashLength, capType)`;for(let d=2;d<s.length;d+=2)h=`${h} + dashLength${d-2} + dashLength${d-1}`,f=`min(${f}, getSingleDashDistance(distance, radius, ${h}, dashLength${d}, totalDashLength, capType))`;n.functions[c]=`float ${c}(float distance, float radius, float capType) {
  ${l.join(`
  `)}
  float totalDashLength = ${u};
  return ${f};
}`,e.setStrokeDistanceFieldExpression(`${c}(currentLengthPx + ${o}, currentRadiusPx, capType)`)}}function zm(i,e,t,r,n){if("fill-color"in i&&e.setFillColorExpression($(n,i["fill-color"],$e)),"fill-pattern-src"in i){const s=Xi(i["fill-pattern-src"]),o=Ks(i,e,t,"fill-pattern-",s);let a=o,c="vec2(0.)";"fill-pattern-offset"in i&&"fill-pattern-size"in i&&(a=$(n,i["fill-pattern-size"],Dt),c=Js(i,"fill-pattern-",n,o,a)),n.functions.sampleFillPattern=`vec4 sampleFillPattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, vec2 pxOrigin, vec2 pxPosition) {
  float scaleRatio = pow(2., mod(u_zoom + 0.5, 1.) - 0.5);
  vec2 pxRelativePos = pxPosition - pxOrigin;
  // rotate the relative position from origin by the current view rotation
  pxRelativePos = vec2(pxRelativePos.x * cos(u_rotation) - pxRelativePos.y * sin(u_rotation), pxRelativePos.x * sin(u_rotation) + pxRelativePos.y * cos(u_rotation));
  // sample position is computed according to the sample offset & size
  vec2 samplePos = mod(pxRelativePos / scaleRatio, sampleSize);
  // also make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  samplePos = clamp(samplePos, vec2(0.5), sampleSize - vec2(0.5));
  samplePos.y = sampleSize.y - samplePos.y; // invert y axis so that images appear upright
  return texture2D(texture, (samplePos + textureOffset) / textureSize);
}`;const l=`u_texture${s}`;let u="1.";"fill-color"in i&&(u=e.getFillColorExpression()),e.setFillColorExpression(`${u} * sampleFillPattern(${l}, ${o}, ${c}, ${a}, pxOrigin, pxPos)`)}}function uc(i,e,t){const r=Jn(),n={...Jn(),inFragmentShader:!0,variables:r.variables},s=new lc,o={};if("icon-src"in i?Gm(i,s,o,r,n):"shape-points"in i?Um(i,s,o,r,n):"circle-radius"in i&&Dm(i,s,o,r,n),Bm(i,s,o,r,n),zm(i,s,o,r,n),t){const l=$(n,t,xs);s.setFragmentDiscardExpression(`!${l}`)}for(const l in n.variables){const u=n.variables[l],h=Hs(u.name);let f=xi(u.type);u.type===$e&&(f="vec4"),s.addUniform(`${f} ${h}`),o[h]=()=>{const d=e[u.name];return typeof d=="number"?d:typeof d=="boolean"?d?1:0:u.type===$e?Wr(d||"#eee"):typeof d=="string"?ur(d):d}}for(const l in n.properties){const u=n.properties[l];r.properties[l]||(r.properties[l]=u);let h=xi(u.type),f=`a_prop_${u.name}`;u.type===$e&&(h="vec4",f=`unpackColor(${f})`,s.addVertexShaderFunction(Nm)),s.addVarying(`v_prop_${u.name}`,h,f)}for(const l in r.properties){const u=r.properties[l];s.addAttribute(`${xi(u.type)} a_prop_${u.name}`)}for(const l in r.functions)s.addVertexShaderFunction(r.functions[l]);for(const l in n.functions)s.addFragmentShaderFunction(n.functions[l]);const a={};for(const l in r.properties){const u=r.properties[l],h=f=>{const d=f.get(u.name);return u.type===$e?Om([...Wr(d||"#eee")]):typeof d=="string"?ur(d):typeof d=="boolean"?d?1:0:d};a[`prop_${u.name}`]={size:Qn(u.type),callback:h}}function c(l,u,h,f){const d=r[l],g=n[l];if(!d&&!g)return;const p=xi(h),m=Qn(h);s.addAttribute(`${p} a_${u}`),g&&s.addVarying(`v_${u}`,p,`a_${u}`),a[u]={size:m,callback:f}}return c("geometryType",ac,Hr,l=>ur(hl(l.getGeometry()))),c("featureId",oc,Hr|fe,l=>{const u=l.getId()??null;return typeof u=="string"?ur(u):u}),{builder:s,attributes:a,uniforms:o}}class km extends bs{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=uc(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new ic(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}function Ra(i,e){const t=`
    attribute vec2 ${vi.TEXTURE_COORD};
    uniform mat4 ${V.TILE_TRANSFORM};
    uniform float ${V.TEXTURE_PIXEL_WIDTH};
    uniform float ${V.TEXTURE_PIXEL_HEIGHT};
    uniform float ${V.TEXTURE_RESOLUTION};
    uniform float ${V.TEXTURE_ORIGIN_X};
    uniform float ${V.TEXTURE_ORIGIN_Y};
    uniform float ${V.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${vi.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${V.TEXTURE_ORIGIN_X} + ${V.TEXTURE_RESOLUTION} * ${V.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${V.TEXTURE_ORIGIN_Y} - ${V.TEXTURE_RESOLUTION} * ${V.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${V.TILE_TRANSFORM} * vec4(${vi.TEXTURE_COORD}, ${V.DEPTH}, 1.0);
    }
  `,r={...Jn(),inFragmentShader:!0,bandCount:e},n=[];if(i.color!==void 0){const h=$(r,i.color,$e);n.push(`color = ${h};`)}if(i.contrast!==void 0){const h=$(r,i.contrast,fe);n.push(`color.rgb = clamp((${h} + 1.0) * color.rgb - (${h} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.exposure!==void 0){const h=$(r,i.exposure,fe);n.push(`color.rgb = clamp((${h} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.saturation!==void 0){const h=$(r,i.saturation,fe);n.push(`
      float saturation = ${h} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(i.gamma!==void 0){const h=$(r,i.gamma,fe);n.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${h}));`)}if(i.brightness!==void 0){const h=$(r,i.brightness,fe);n.push(`color.rgb = clamp(color.rgb + ${h}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(r.variables).length;if(o>1&&!i.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let h=0;h<o;++h){const f=r.variables[Object.keys(r.variables)[h]];if(!(f.name in i.variables))throw new Error(`Missing '${f.name}' in style variables`);const d=Hs(f.name);s[d]=function(){let g=i.variables[f.name];return typeof g=="string"&&(g=ur(g)),g!==void 0?g:-9999999}}const a=Object.keys(s).map(function(h){return`uniform float ${h};`}),c=Math.ceil(e/4);a.push(`uniform sampler2D ${V.TILE_TEXTURE_ARRAY}[${c}];`),r.paletteTextures&&a.push(`uniform sampler2D ${sc}[${r.paletteTextures.length}];`);const l=Object.keys(r.functions).map(function(h){return r.functions[h]}),u=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${V.RENDER_EXTENT};
    uniform float ${V.TRANSITION_ALPHA};
    uniform float ${V.TEXTURE_PIXEL_WIDTH};
    uniform float ${V.TEXTURE_PIXEL_HEIGHT};
    uniform float ${V.RESOLUTION};
    uniform float ${V.ZOOM};

    ${a.join(`
`)}

    ${l.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${V.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${V.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${V.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${V.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${V.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${n.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${V.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:u,uniforms:s,paletteTextures:r.paletteTextures}}class Wi extends nh{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(zn.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=Ra(this.style_,this.getSourceBandCount_());return new bm(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let n;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],r.prepareFrame(e)&&(n=r.renderFrame(e));return n}render(e,t){this.rendered=!0;const r=e.viewState,n=this.getSources(e.extent,r.resolution);let s=!0;for(let a=0,c=n.length;a<c;++a){const l=n[a],u=l.getState();if(u=="loading"){const h=()=>{l.getState()=="ready"&&(l.removeEventListener("change",h),this.changed())};l.addEventListener("change",h)}s=s&&u=="ready"}const o=this.renderSources(e,n);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(c=>!n.includes(c));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=Ra(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}Wi.prototype.dispose;class Qs{constructor(){this.globalCounter_=0,this.refToFeature_=new Map,this.uidToRef_=new Map,this.freeGlobalRef_=[],this.polygonBatch={entries:{},geometriesCount:0,verticesCount:0,ringsCount:0},this.pointBatch={entries:{},geometriesCount:0},this.lineStringBatch={entries:{},geometriesCount:0,verticesCount:0}}addFeatures(e,t){for(let r=0;r<e.length;r++)this.addFeature(e[r],t)}addFeature(e,t){let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}clearFeatureEntryInPointBatch_(e){const t=he(e),r=this.pointBatch.entries[t];if(r)return this.pointBatch.geometriesCount-=r.flatCoordss.length,delete this.pointBatch.entries[t],r}clearFeatureEntryInLineStringBatch_(e){const t=he(e),r=this.lineStringBatch.entries[t];if(r)return this.lineStringBatch.verticesCount-=r.verticesCount,this.lineStringBatch.geometriesCount-=r.flatCoordss.length,delete this.lineStringBatch.entries[t],r}clearFeatureEntryInPolygonBatch_(e){const t=he(e),r=this.polygonBatch.entries[t];if(r)return this.polygonBatch.verticesCount-=r.verticesCount,this.polygonBatch.ringsCount-=r.ringsCount,this.polygonBatch.geometriesCount-=r.flatCoordss.length,delete this.polygonBatch.entries[t],r}addGeometry_(e,t){var n;const r=e.getType();switch(r){case"GeometryCollection":{const s=e.getGeometriesArray();for(const o of s)this.addGeometry_(o,t);break}case"MultiPolygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEndss(),t,he(t),s.getStride());break}case"MultiLineString":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,he(t),s.getStride());break}case"MultiPoint":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,he(t),s.getStride());break}case"Polygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,he(t),s.getStride());break}case"Point":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,he(t),s.getStride());break}case"LineString":case"LinearRing":{const s=e,o=s.getStride();this.addCoordinates_(r,s.getFlatCoordinates(),null,t,he(t),o,(n=s.getLayout)==null?void 0:n.call(s));break}}}addCoordinates_(e,t,r,n,s,o,a){let c;switch(e){case"MultiPolygon":{const l=r;for(let u=0,h=l.length;u<h;u++){let f=l[u];const d=u>0?l[u-1]:null,g=d?d[d.length-1]:0,p=f[f.length-1];f=g>0?f.map(m=>m-g):f,this.addCoordinates_("Polygon",t.slice(g,p),f,n,s,o,a)}break}case"MultiLineString":{const l=r;for(let u=0,h=l.length;u<h;u++){const f=u>0?l[u-1]:0;this.addCoordinates_("LineString",t.slice(f,l[u]),null,n,s,o,a)}break}case"MultiPoint":for(let l=0,u=t.length;l<u;l+=o)this.addCoordinates_("Point",t.slice(l,l+2),null,n,s,null,null);break;case"Polygon":{const l=r;if(n instanceof sh){const f=oh(t,l);if(f.length>1){this.addCoordinates_("MultiPolygon",t,f,n,s,o,a);return}}this.polygonBatch.entries[s]||(this.polygonBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0,ringsCount:0,ringsVerticesCounts:[]})),c=t.length/o;const u=r.length,h=r.map((f,d,g)=>d>0?(f-g[d-1])/o:f/o);this.polygonBatch.verticesCount+=c,this.polygonBatch.ringsCount+=u,this.polygonBatch.geometriesCount++,this.polygonBatch.entries[s].flatCoordss.push($m(t,o)),this.polygonBatch.entries[s].ringsVerticesCounts.push(h),this.polygonBatch.entries[s].verticesCount+=c,this.polygonBatch.entries[s].ringsCount+=u;for(let f=0,d=l.length;f<d;f++){const g=f>0?l[f-1]:0;this.addCoordinates_("LinearRing",t.slice(g,l[f]),null,n,s,o,a)}break}case"Point":this.pointBatch.entries[s]||(this.pointBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[]})),this.pointBatch.geometriesCount++,this.pointBatch.entries[s].flatCoordss.push(t);break;case"LineString":case"LinearRing":this.lineStringBatch.entries[s]||(this.lineStringBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0})),c=t.length/o,this.lineStringBatch.verticesCount+=c,this.lineStringBatch.geometriesCount++,this.lineStringBatch.entries[s].flatCoordss.push(jm(t,o,a)),this.lineStringBatch.entries[s].verticesCount+=c;break}}addRefToEntry_(e,t){const r=this.uidToRef_.get(e),n=r||this.freeGlobalRef_.pop()||++this.globalCounter_;return t.ref=n,r||(this.refToFeature_.set(n,t.feature),this.uidToRef_.set(e,n)),t}returnRef_(e,t){if(!e)throw new Error("This feature has no ref: "+t);this.refToFeature_.delete(e),this.uidToRef_.delete(t),this.freeGlobalRef_.push(e)}changeFeature(e){this.removeFeature(e);const t=e.getGeometry();t&&this.addGeometry_(t,e)}removeFeature(e){let t=this.clearFeatureEntryInPointBatch_(e);t=this.clearFeatureEntryInPolygonBatch_(e)||t,t=this.clearFeatureEntryInLineStringBatch_(e)||t,t&&this.returnRef_(t.ref,he(t.feature))}clear(){this.polygonBatch.entries={},this.polygonBatch.geometriesCount=0,this.polygonBatch.verticesCount=0,this.polygonBatch.ringsCount=0,this.lineStringBatch.entries={},this.lineStringBatch.geometriesCount=0,this.lineStringBatch.verticesCount=0,this.pointBatch.entries={},this.pointBatch.geometriesCount=0,this.globalCounter_=0,this.freeGlobalRef_=[],this.refToFeature_.clear(),this.uidToRef_.clear()}getFeatureFromRef(e){return this.refToFeature_.get(e)}isEmpty(){return this.globalCounter_===0}filter(e){const t=new Qs;for(const r of this.refToFeature_.values())e(r)&&t.addFeature(r);return t}}function $m(i,e){return e===2?i:i.filter((t,r)=>r%e<2)}function jm(i,e,t){return e===3&&t==="XYM"?i:e===4?i.filter((r,n)=>n%e!==2):e===3?i.map((r,n)=>n%e!==2?r:0):new Array(i.length*1.5).fill(0).map((r,n)=>n%3===2?0:i[Math.round(n/1.5)])}function eo(i,e,t,r){let n=0;for(const s in e){const o=e[s],a=o.callback.call(t,t.feature);i[r+n++]=(a==null?void 0:a[0])??a,!(!o.size||o.size===1)&&(i[r+n++]=a[1],!(o.size<3)&&(i[r+n++]=a[2],!(o.size<4)&&(i[r+n++]=a[3])))}return n}function gn(i){return Object.keys(i).reduce((e,t)=>e+(i[t].size||1),0)}function Vm(i,e,t,r){const n=(2+gn(t))*i.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const c=i.entries[a];for(let l=0,u=c.flatCoordss.length;l<u;l++)s[0]=c.flatCoordss[l][0],s[1]=c.flatCoordss[l][1],Tt(r,s),e[o++]=s[0],e[o++]=s[1],o+=eo(e,t,c,o)}return e}function Xm(i,e,t,r){const n=3*i.verticesCount+(1+gn(t))*i.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const c=i.entries[a];for(let l=0,u=c.flatCoordss.length;l<u;l++){s.length=c.flatCoordss[l].length,fl(c.flatCoordss[l],0,s.length,3,r,s,3),o+=eo(e,t,c,o),e[o++]=s.length/3;for(let h=0,f=s.length;h<f;h+=3)e[o++]=s[h],e[o++]=s[h+1],e[o++]=s[h+2]}}return e}function Wm(i,e,t,r){const n=2*i.verticesCount+(1+gn(t))*i.geometriesCount+i.ringsCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const c=i.entries[a];for(let l=0,u=c.flatCoordss.length;l<u;l++){s.length=c.flatCoordss[l].length,fl(c.flatCoordss[l],0,s.length,2,r,s),o+=eo(e,t,c,o),e[o++]=c.ringsVerticesCounts[l].length;for(let h=0,f=c.ringsVerticesCounts[l].length;h<f;h++)e[o++]=c.ringsVerticesCounts[l][h];for(let h=0,f=s.length;h<f;h+=2)e[o++]=s[h],e[o++]=s[h+1]}}return e}const Hm=[];let An;function Zm(){return An||(An=tc()),An}let Ym=0;const lt={POSITION:"a_position",INDEX:"a_index",SEGMENT_START:"a_segmentStart",SEGMENT_END:"a_segmentEnd",MEASURE_START:"a_measureStart",MEASURE_END:"a_measureEnd",PARAMETERS:"a_parameters",JOIN_ANGLES:"a_joinAngles",DISTANCE:"a_distance"};class qm{constructor(e,t,r,n,s){this.helper_,this.hitDetectionEnabled_=!!n;let o=e;if(!("builder"in e)){const u=e,h=uc(u.style,t,u.filter);o={builder:h.builder,attributes:h.attributes,uniforms:h.uniforms}}this.fillProgram_,this.strokeProgram_,this.symbolProgram_,this.hasFill_=!!o.builder.getFillVertexShader(),this.hasFill_&&(this.fillVertexShader_=o.builder.getFillVertexShader(),this.fillFragmentShader_=o.builder.getFillFragmentShader()),this.hasStroke_=!!o.builder.getStrokeVertexShader(),this.hasStroke_&&(this.strokeVertexShader_=o.builder.getStrokeVertexShader(),this.strokeFragmentShader_=o.builder.getStrokeFragmentShader()),this.hasSymbol_=!!o.builder.getSymbolVertexShader(),this.hasSymbol_&&(this.symbolVertexShader_=o.builder.getSymbolVertexShader(),this.symbolFragmentShader_=o.builder.getSymbolFragmentShader()),this.featureFilter_=null,s&&(this.featureFilter_=this.computeFeatureFilter(s));const c=this.hitDetectionEnabled_?{hitColor:{callback(){return ql(this.ref,Hm)},size:4}}:{};this.customAttributes_=Object.assign({},c,o.attributes),this.uniforms_=o.uniforms;const l=Object.entries(this.customAttributes_).map(([u,h])=>({name:`a_${u}`,size:h.size||1,type:be.FLOAT}));this.polygonAttributesDesc_=[{name:lt.POSITION,size:2,type:be.FLOAT},...l],this.lineStringAttributesDesc_=[{name:lt.SEGMENT_START,size:2,type:be.FLOAT},{name:lt.MEASURE_START,size:1,type:be.FLOAT},{name:lt.SEGMENT_END,size:2,type:be.FLOAT},{name:lt.MEASURE_END,size:1,type:be.FLOAT},{name:lt.JOIN_ANGLES,size:2,type:be.FLOAT},{name:lt.DISTANCE,size:1,type:be.FLOAT},{name:lt.PARAMETERS,size:1,type:be.FLOAT},...l],this.pointAttributesDesc_=[{name:lt.POSITION,size:2,type:be.FLOAT},{name:lt.INDEX,size:1,type:be.FLOAT},...l],this.setHelper(r)}computeFeatureFilter(e){const t=ul();let r;try{r=ah(e,xs,t)}catch{return null}if(t.mapState||t.variables.size>0)return null;const n=lh();return s=>{if(n.properties=s.getPropertiesInternal(),t.featureId){const o=s.getId();o!==void 0?n.featureId=o:n.featureId=null}return n.geometryType=hl(s.getGeometry()),r(n)}}async generateBuffers(e,t){let r=e;if(this.featureFilter_&&(r=r.filter(this.featureFilter_),r.isEmpty()))return null;const n=this.generateRenderInstructions_(r,t),[s,o,a]=await Promise.all([this.generateBuffersForType_(n.polygonInstructions,"Polygon",t),this.generateBuffersForType_(n.lineStringInstructions,"LineString",t),this.generateBuffersForType_(n.pointInstructions,"Point",t)]),c=Xr(Fe(),t);return{polygonBuffers:s,lineStringBuffers:o,pointBuffers:a,invertVerticesTransform:c}}generateRenderInstructions_(e,t){const r=this.hasFill_?Wm(e.polygonBatch,new Float32Array(0),this.customAttributes_,t):null,n=this.hasStroke_?Xm(e.lineStringBatch,new Float32Array(0),this.customAttributes_,t):null,s=this.hasSymbol_?Vm(e.pointBatch,new Float32Array(0),this.customAttributes_,t):null;return{polygonInstructions:r,lineStringInstructions:n,pointInstructions:s}}generateBuffersForType_(e,t,r){if(e===null)return null;const n=Ym++;let s;switch(t){case"Polygon":s=Ur.GENERATE_POLYGON_BUFFERS;break;case"LineString":s=Ur.GENERATE_LINE_STRING_BUFFERS;break;case"Point":s=Ur.GENERATE_POINT_BUFFERS;break}const o={id:n,type:s,renderInstructions:e.buffer,renderInstructionsTransform:r,customAttributesSize:gn(this.customAttributes_)},a=Zm();return a.postMessage(o,[e.buffer]),e=null,new Promise(c=>{const l=u=>{const h=u.data;if(h.id!==n||(a.removeEventListener("message",l),!this.helper_.getGL()))return;const f=new mr(ri,$i).fromArrayBuffer(h.vertexBuffer),d=new mr(ii,$i).fromArrayBuffer(h.indexBuffer);this.helper_.flushBufferData(f),this.helper_.flushBufferData(d),c([d,f])};a.addEventListener("message",l)})}render(e,t,r){this.hasFill_&&this.renderInternal_(e.polygonBuffers[0],e.polygonBuffers[1],this.fillProgram_,this.polygonAttributesDesc_,t,r),this.hasStroke_&&this.renderInternal_(e.lineStringBuffers[0],e.lineStringBuffers[1],this.strokeProgram_,this.lineStringAttributesDesc_,t,r),this.hasSymbol_&&this.renderInternal_(e.pointBuffers[0],e.pointBuffers[1],this.symbolProgram_,this.pointAttributesDesc_,t,r)}renderInternal_(e,t,r,n,s,o){const a=e.getSize();a!==0&&(this.helper_.useProgram(r,s),this.helper_.bindBuffer(t),this.helper_.bindBuffer(e),this.helper_.enableAttributes(n),o(),this.helper_.drawElements(0,a))}setHelper(e,t=null){this.helper_=e,this.hasFill_&&(this.fillProgram_=this.helper_.getProgram(this.fillFragmentShader_,this.fillVertexShader_)),this.hasStroke_&&(this.strokeProgram_=this.helper_.getProgram(this.strokeFragmentShader_,this.strokeVertexShader_)),this.hasSymbol_&&(this.symbolProgram_=this.helper_.getProgram(this.symbolFragmentShader_,this.symbolVertexShader_)),this.helper_.addUniforms(this.uniforms_),t&&(t.polygonBuffers&&(this.helper_.flushBufferData(t.polygonBuffers[0]),this.helper_.flushBufferData(t.polygonBuffers[1])),t.lineStringBuffers&&(this.helper_.flushBufferData(t.lineStringBuffers[0]),this.helper_.flushBufferData(t.lineStringBuffers[1])),t.pointBuffers&&(this.helper_.flushBufferData(t.pointBuffers[0]),this.helper_.flushBufferData(t.pointBuffers[1])))}}const ir={...ft,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class Km extends ni{constructor(e,t){const r={[ir.RENDER_EXTENT]:[0,0,0,0],[ir.PATTERN_ORIGIN]:[0,0],[ir.GLOBAL_ALPHA]:1};super(e,{uniforms:r,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=Qr(),this.currentTransform_=Fe(),this.tmpCoords_=[0,0],this.tmpTransform_=Fe(),this.tmpMat4_=Qt(),this.currentFrameStateTransform_=Fe(),this.styleVariables_={},this.styles_=[],this.styleRenderers_=[],this.buffers_=[],this.applyOptions_(t),this.batch_=new Qs,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let r;this.batch_.addFeatures(t.getFeatures(),r),this.sourceListenKeys_=[Et(t,It.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,r)),Et(t,It.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),Et(t,It.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),Et(t,It.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.styles_=Jp(e.style)}createRenderers_(){this.buffers_=[],this.styleRenderers_=this.styles_.map(e=>new qm(e,this.styleVariables_,this.helper,this.hitDetectionEnabled_,"filter"in e?e.filter:null))}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderers_.length?this.styleRenderers_.forEach((e,t)=>e.setHelper(this.helper,this.buffers_[t])):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new ec(this.helper))}handleSourceFeatureAdded_(e,t){const r=t.feature;this.batch_.addFeature(r,e)}handleSourceFeatureChanged_(e){const t=e.feature;this.batch_.changeFeature(t)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){ch(this.tmpTransform_,this.currentFrameStateTransform_),jr(this.tmpTransform_,e),this.helper.setUniformMatrixValue(ir.PROJECTION_MATRIX,ji(this.tmpMat4_,this.tmpTransform_)),Xr(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(ir.SCREEN_TO_WORLD_MATRIX,ji(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,Xr(this.tmpTransform_,e),Tt(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(ir.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,n,s]=rc(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,r,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const o=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),o}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),r=t.getSource(),n=e.viewState,s=!e.viewHints[Ot.ANIMATING]&&!e.viewHints[Ot.INTERACTING],o=!Vr(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const c=n.projection,l=n.resolution,u=t instanceof an?t.getRenderBuffer():0,h=ms(e.extent,u*l);r.loadFeatures(h,l,c),this.ready=!1;const f=this.helper.makeProjectionTransform(e,Fe()),d=this.styleRenderers_.map((g,p)=>g.generateBuffers(this.batch_,f).then(m=>{this.buffers_[p]&&this.disposeBuffers(this.buffers_[p]),this.buffers_[p]=m}));Promise.all(d).then(()=>{this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,r,n,s){let o=r;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do{this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),_s(this.currentFrameStateTransform_,o*s,0);for(let a=0,c=this.styleRenderers_.length;a<c;a++){const l=this.styleRenderers_[a],u=this.buffers_[a];u&&l.render(u,e,()=>{this.applyUniforms_(u.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)})}}while(++o<n)}forEachFeatureAtCoordinate(e,t,r,n,s){if(et(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderers_.length||!this.hitDetectionEnabled_)return;const o=Tt(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),c=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],l=Kl(c),u=this.batch_.getFeatureFromRef(l);if(u)return n(u,this.getLayer(),null)}disposeBuffers(e){const t=r=>{for(const n of r)n&&this.helper.deleteBuffer(n)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_.forEach(e=>{e&&this.disposeBuffers(e)}),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){Ui(e)}),this.sourceListenKeys_=null),super.disposeInternal()}}class Jm extends bs{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new Km(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style=e,this.clearRenderer(),this.changed()}}var We=Uint8Array,hr=Uint16Array,Qm=Int32Array,hc=new We([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),fc=new We([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),e_=new We([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),dc=function(i,e){for(var t=new hr(31),r=0;r<31;++r)t[r]=e+=1<<i[r-1];for(var n=new Qm(t[30]),r=1;r<30;++r)for(var s=t[r];s<t[r+1];++s)n[s]=s-t[r]<<5|r;return{b:t,r:n}},gc=dc(hc,2),pc=gc.b,t_=gc.r;pc[28]=258,t_[258]=28;var r_=dc(fc,0),i_=r_.b,es=new hr(32768);for(var _e=0;_e<32768;++_e){var vt=(_e&43690)>>1|(_e&21845)<<1;vt=(vt&52428)>>2|(vt&13107)<<2,vt=(vt&61680)>>4|(vt&3855)<<4,es[_e]=((vt&65280)>>8|(vt&255)<<8)>>1}var Gr=function(i,e,t){for(var r=i.length,n=0,s=new hr(e);n<r;++n)i[n]&&++s[i[n]-1];var o=new hr(e);for(n=1;n<e;++n)o[n]=o[n-1]+s[n-1]<<1;var a;if(t){a=new hr(1<<e);var c=15-e;for(n=0;n<r;++n)if(i[n])for(var l=n<<4|i[n],u=e-i[n],h=o[i[n]-1]++<<u,f=h|(1<<u)-1;h<=f;++h)a[es[h]>>c]=l}else for(a=new hr(r),n=0;n<r;++n)i[n]&&(a[n]=es[o[i[n]-1]++]>>15-i[n]);return a},si=new We(288);for(var _e=0;_e<144;++_e)si[_e]=8;for(var _e=144;_e<256;++_e)si[_e]=9;for(var _e=256;_e<280;++_e)si[_e]=7;for(var _e=280;_e<288;++_e)si[_e]=8;var mc=new We(32);for(var _e=0;_e<32;++_e)mc[_e]=5;var n_=Gr(si,9,1),s_=Gr(mc,5,1),Ln=function(i){for(var e=i[0],t=1;t<i.length;++t)i[t]>e&&(e=i[t]);return e},rt=function(i,e,t){var r=e/8|0;return(i[r]|i[r+1]<<8)>>(e&7)&t},In=function(i,e){var t=e/8|0;return(i[t]|i[t+1]<<8|i[t+2]<<16)>>(e&7)},o_=function(i){return(i+7)/8|0},a_=function(i,e,t){return(t==null||t>i.length)&&(t=i.length),new We(i.subarray(e,t))},l_=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Xe=function(i,e,t){var r=new Error(e||l_[i]);if(r.code=i,Error.captureStackTrace&&Error.captureStackTrace(r,Xe),!t)throw r;return r},to=function(i,e,t,r){var n=i.length,s=0;if(!n||e.f&&!e.l)return t||new We(0);var o=!t,a=o||e.i!=2,c=e.i;o&&(t=new We(n*3));var l=function(ui){var hi=t.length;if(ui>hi){var fi=new We(Math.max(hi*2,ui));fi.set(t),t=fi}},u=e.f||0,h=e.p||0,f=e.b||0,d=e.l,g=e.d,p=e.m,m=e.n,y=n*8;do{if(!d){u=rt(i,h,1);var _=rt(i,h+1,3);if(h+=3,_)if(_==1)d=n_,g=s_,p=9,m=5;else if(_==2){var T=rt(i,h,31)+257,v=rt(i,h+10,15)+4,I=T+rt(i,h+5,31)+1;h+=14;for(var A=new We(I),R=new We(19),O=0;O<v;++O)R[e_[O]]=rt(i,h+O*3,7);h+=v*3;for(var N=Ln(R),k=(1<<N)-1,j=Gr(R,N,1),O=0;O<I;){var G=j[rt(i,h,k)];h+=G&15;var E=G>>4;if(E<16)A[O++]=E;else{var ee=0,B=0;for(E==16?(B=3+rt(i,h,3),h+=2,ee=A[O-1]):E==17?(B=3+rt(i,h,7),h+=3):E==18&&(B=11+rt(i,h,127),h+=7);B--;)A[O++]=ee}}var oe=A.subarray(0,T),W=A.subarray(T);p=Ln(oe),m=Ln(W),d=Gr(oe,p,1),g=Gr(W,m,1)}else Xe(1);else{var E=o_(h)+4,w=i[E-4]|i[E-3]<<8,S=E+w;if(S>n){c&&Xe(0);break}a&&l(f+w),t.set(i.subarray(E,S),f),e.b=f+=w,e.p=h=S*8,e.f=u;continue}if(h>y){c&&Xe(0);break}}a&&l(f+131072);for(var ie=(1<<p)-1,pe=(1<<m)-1,Te=h;;Te=h){var ee=d[In(i,h)&ie],re=ee>>4;if(h+=ee&15,h>y){c&&Xe(0);break}if(ee||Xe(2),re<256)t[f++]=re;else if(re==256){Te=h,d=null;break}else{var Pe=re-254;if(re>264){var O=re-257,Re=hc[O];Pe=rt(i,h,(1<<Re)-1)+pc[O],h+=Re}var ve=g[In(i,h)&pe],Ne=ve>>4;ve||Xe(3),h+=ve&15;var W=i_[Ne];if(Ne>3){var Re=fc[Ne];W+=In(i,h)&(1<<Re)-1,h+=Re}if(h>y){c&&Xe(0);break}a&&l(f+131072);var er=f+Pe;if(f<W){var zt=s-W,Rt=Math.min(W,er);for(zt+f<0&&Xe(3);f<Rt;++f)t[f]=r[zt+f]}for(;f<er;++f)t[f]=t[f-W]}}e.l=d,e.p=Te,e.b=f,e.f=u,d&&(u=1,e.m=p,e.d=g,e.n=m)}while(!u);return f!=t.length&&o?a_(t,0,f):t.subarray(0,f)},c_=new We(0),u_=function(i){(i[0]!=31||i[1]!=139||i[2]!=8)&&Xe(6,"invalid gzip data");var e=i[3],t=10;e&4&&(t+=(i[10]|i[11]<<8)+2);for(var r=(e>>3&1)+(e>>4&1);r>0;r-=!i[t++]);return t+(e&2)},h_=function(i){var e=i.length;return(i[e-4]|i[e-3]<<8|i[e-2]<<16|i[e-1]<<24)>>>0},f_=function(i,e){return((i[0]&15)!=8||i[0]>>4>7||(i[0]<<8|i[1])%31)&&Xe(6,"invalid zlib data"),(i[1]>>5&1)==1&&Xe(6,"invalid zlib data: "+(i[1]&32?"need":"unexpected")+" dictionary"),(i[1]>>3&4)+2};function d_(i,e){return to(i,{i:2},e,e)}function g_(i,e){var t=u_(i);return t+8>i.length&&Xe(6,"invalid gzip data"),to(i.subarray(t,-8),{i:2},new We(h_(i)),e)}function p_(i,e){return to(i.subarray(f_(i),-4),{i:2},e,e)}function m_(i,e){return i[0]==31&&i[1]==139&&i[2]==8?g_(i,e):(i[0]&15)!=8||i[0]>>4>7||(i[0]<<8|i[1])%31?d_(i,e):p_(i,e)}var __=typeof TextDecoder<"u"&&new TextDecoder,y_=0;try{__.decode(c_,{stream:!0}),y_=1}catch{}var E_=Object.defineProperty,Br=Math.pow,ge=(i,e)=>E_(i,"name",{value:e,configurable:!0}),Le=(i,e,t)=>new Promise((r,n)=>{var s=c=>{try{a(t.next(c))}catch(l){n(l)}},o=c=>{try{a(t.throw(c))}catch(l){n(l)}},a=c=>c.done?r(c.value):Promise.resolve(c.value).then(s,o);a((t=t.apply(i,e)).next())});ge((i,e)=>{let t=!1,r="",n=L.GridLayer.extend({createTile:ge((s,o)=>{let a=document.createElement("img"),c=new AbortController,l=c.signal;return a.cancel=()=>{c.abort()},t||(i.getHeader().then(u=>{u.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):u.tileType===2?r="image/png":u.tileType===3?r="image/jpeg":u.tileType===4?r="image/webp":u.tileType===5&&(r="image/avif")}),t=!0),i.getZxy(s.z,s.x,s.y,l).then(u=>{if(u){let h=new Blob([u.data],{type:r}),f=window.URL.createObjectURL(h);a.src=f,a.cancel=void 0,o(void 0,a)}}).catch(u=>{if(u.name!=="AbortError")throw u}),a},"createTile"),_removeTile:ge(function(s){let o=this._tiles[s];o&&(o.el.cancel&&o.el.cancel(),o.el.width=0,o.el.height=0,o.el.deleted=!0,L.DomUtil.remove(o.el),delete this._tiles[s],this.fire("tileunload",{tile:o.el,coords:this._keyToTileCoords(s)}))},"_removeTile")});return new n(e)},"leafletRasterLayer");var x_=ge(i=>(e,t)=>{if(t instanceof AbortController)return i(e,t);let r=new AbortController;return i(e,r).then(n=>t(void 0,n.data,n.cacheControl||"",n.expires||""),n=>t(n)).catch(n=>t(n)),{cancel:ge(()=>r.abort(),"cancel")}},"v3compat"),b_=class{constructor(e){this.tilev4=ge((t,r)=>Le(this,null,function*(){if(t.type==="json"){let d=t.url.substr(10),g=this.tiles.get(d);if(g||(g=new Yr(d),this.tiles.set(d,g)),this.metadata)return{data:yield g.getTileJson(t.url)};let p=yield g.getHeader();return(p.minLon>=p.maxLon||p.minLat>=p.maxLat)&&console.error(`Bounds of PMTiles archive ${p.minLon},${p.minLat},${p.maxLon},${p.maxLat} are not valid.`),{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:p.minZoom,maxzoom:p.maxZoom,bounds:[p.minLon,p.minLat,p.maxLon,p.maxLat]}}}let n=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=t.url.match(n);if(!s)throw new Error("Invalid PMTiles protocol URL");let o=s[1],a=this.tiles.get(o);a||(a=new Yr(o),this.tiles.set(o,a));let c=s[2],l=s[3],u=s[4],h=yield a.getHeader(),f=yield a==null?void 0:a.getZxy(+c,+l,+u,r.signal);if(f)return{data:new Uint8Array(f.data),cacheControl:f.cacheControl,expires:f.expires};if(h.tileType===1){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}),"tilev4"),this.tile=x_(this.tilev4),this.tiles=new Map,this.metadata=(e==null?void 0:e.metadata)||!1,this.errorOnMissingTile=(e==null?void 0:e.errorOnMissingTile)||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};ge(b_,"Protocol");function _c(i,e){return(e>>>0)*4294967296+(i>>>0)}ge(_c,"toNum");function yc(i,e){let t=e.buf,r=t[e.pos++],n=(r&112)>>4;if(r<128||(r=t[e.pos++],n|=(r&127)<<3,r<128)||(r=t[e.pos++],n|=(r&127)<<10,r<128)||(r=t[e.pos++],n|=(r&127)<<17,r<128)||(r=t[e.pos++],n|=(r&127)<<24,r<128)||(r=t[e.pos++],n|=(r&1)<<31,r<128))return _c(i,n);throw new Error("Expected varint not more than 10 bytes")}ge(yc,"readVarintRemainder");function ar(i){let e=i.buf,t=e[i.pos++],r=t&127;return t<128||(t=e[i.pos++],r|=(t&127)<<7,t<128)||(t=e[i.pos++],r|=(t&127)<<14,t<128)||(t=e[i.pos++],r|=(t&127)<<21,t<128)?r:(t=e[i.pos],r|=(t&15)<<28,yc(r,i))}ge(ar,"readVarint");function ro(i,e,t,r){if(r===0){t===1&&(e[0]=i-1-e[0],e[1]=i-1-e[1]);let n=e[0];e[0]=e[1],e[1]=n}}ge(ro,"rotate");function Ec(i,e){let t=Br(2,i),r=e,n=e,s=e,o=[0,0],a=1;for(;a<t;)r=1&s/2,n=1&(s^r),ro(a,o,r,n),o[0]+=a*r,o[1]+=a*n,s=s/4,a*=2;return[i,o[0],o[1]]}ge(Ec,"idOnLevel");var T_=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function xc(i,e,t){if(i>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(e>Br(2,i)-1||t>Br(2,i)-1)throw new Error("tile x/y outside zoom level bounds");let r=T_[i],n=Br(2,i),s=0,o=0,a=0,c=[e,t],l=n/2;for(;l>0;)s=(c[0]&l)>0?1:0,o=(c[1]&l)>0?1:0,a+=l*l*(3*s^o),ro(l,c,s,o),l=l/2;return r+a}ge(xc,"zxyToTileId");function w_(i){let e=0;for(let t=0;t<27;t++){let r=(1<<t)*(1<<t);if(e+r>i)return Ec(t,i-e);e+=r}throw new Error("Tile zoom level exceeds max safe number limit (26)")}ge(w_,"tileIdToZxy");var S_=(i=>(i[i.Unknown=0]="Unknown",i[i.None=1]="None",i[i.Gzip=2]="Gzip",i[i.Brotli=3]="Brotli",i[i.Zstd=4]="Zstd",i))(S_||{});function pn(i,e){return Le(this,null,function*(){if(e===1||e===0)return i;if(e===2){if(typeof globalThis.DecompressionStream>"u")return m_(new Uint8Array(i));let t=new Response(i).body;if(!t)throw new Error("Failed to read response stream");let r=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(r).arrayBuffer()}throw new Error("Compression method not supported")})}ge(pn,"defaultDecompress");var lr=(i=>(i[i.Unknown=0]="Unknown",i[i.Mvt=1]="Mvt",i[i.Png=2]="Png",i[i.Jpeg=3]="Jpeg",i[i.Webp=4]="Webp",i[i.Avif=5]="Avif",i))(lr||{});function bc(i){return i===1?".mvt":i===2?".png":i===3?".jpg":i===4?".webp":i===5?".avif":""}ge(bc,"tileTypeExt");var R_=127;function Tc(i,e){let t=0,r=i.length-1;for(;t<=r;){let n=r+t>>1,s=e-i[n].tileId;if(s>0)t=n+1;else if(s<0)r=n-1;else return i[n]}return r>=0&&(i[r].runLength===0||e-i[r].tileId<i[r].runLength)?i[r]:null}ge(Tc,"findTile");var v_=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return Le(this,null,function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}})}};ge(v_,"FileSource");var wc=class{constructor(e,t=new Headers){this.url=e,this.customHeaders=t,this.mustReload=!1;let r="";"navigator"in globalThis&&(r=globalThis.navigator.userAgent||"");let n=r.indexOf("Windows")>-1,s=/Chrome|Chromium|Edg|OPR|Brave/.test(r);this.chromeWindowsNoCache=!1,n&&s&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,r,n){return Le(this,null,function*(){let s,o;r?o=r:(s=new AbortController,o=s.signal);let a=new Headers(this.customHeaders);a.set("range",`bytes=${e}-${e+t-1}`);let c;this.mustReload?c="reload":this.chromeWindowsNoCache&&(c="no-store");let l=yield fetch(this.url,{signal:o,cache:c,headers:a});if(e===0&&l.status===416){let f=l.headers.get("Content-Range");if(!f||!f.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let d=+f.substr(8);l=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${d-1}`}})}let u=l.headers.get("Etag");if(u!=null&&u.startsWith("W/")&&(u=null),l.status===416||n&&u&&u!==n)throw this.mustReload=!0,new ts(`Server returned non-matching ETag ${n} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(l.status>=300)throw new Error(`Bad response code: ${l.status}`);let h=l.headers.get("Content-Length");if(l.status===200&&(!h||+h>t))throw s&&s.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield l.arrayBuffer(),etag:u||void 0,cacheControl:l.headers.get("Cache-Control")||void 0,expires:l.headers.get("Expires")||void 0}})}};ge(wc,"FetchSource");var P_=wc;function qe(i,e){let t=i.getUint32(e+4,!0),r=i.getUint32(e+0,!0);return t*Br(2,32)+r}ge(qe,"getUint64");function Sc(i,e){let t=new DataView(i),r=t.getUint8(7);if(r>3)throw new Error(`Archive is spec version ${r} but this library supports up to spec version 3`);return{specVersion:r,rootDirectoryOffset:qe(t,8),rootDirectoryLength:qe(t,16),jsonMetadataOffset:qe(t,24),jsonMetadataLength:qe(t,32),leafDirectoryOffset:qe(t,40),leafDirectoryLength:qe(t,48),tileDataOffset:qe(t,56),tileDataLength:qe(t,64),numAddressedTiles:qe(t,72),numTileEntries:qe(t,80),numTileContents:qe(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}ge(Sc,"bytesToHeader");function io(i){let e={buf:new Uint8Array(i),pos:0},t=ar(e),r=[],n=0;for(let s=0;s<t;s++){let o=ar(e);r.push({tileId:n+o,offset:0,length:0,runLength:1}),n+=o}for(let s=0;s<t;s++)r[s].runLength=ar(e);for(let s=0;s<t;s++)r[s].length=ar(e);for(let s=0;s<t;s++){let o=ar(e);o===0&&s>0?r[s].offset=r[s-1].offset+r[s-1].length:r[s].offset=o-1}return r}ge(io,"deserializeIndex");var Rc=class extends Error{};ge(Rc,"EtagMismatch");var ts=Rc;function no(i,e){return Le(this,null,function*(){let t=yield i.getBytes(0,16384);if(new DataView(t.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let r=t.data.slice(0,R_),n=Sc(r,t.etag),s=t.data.slice(n.rootDirectoryOffset,n.rootDirectoryOffset+n.rootDirectoryLength),o=`${i.getKey()}|${n.etag||""}|${n.rootDirectoryOffset}|${n.rootDirectoryLength}`,a=io(yield e(s,n.internalCompression));return[n,[o,a.length,a]]})}ge(no,"getHeaderAndRoot");function so(i,e,t,r,n){return Le(this,null,function*(){let s=yield i.getBytes(t,r,void 0,n.etag),o=yield e(s.data,n.internalCompression),a=io(o);if(a.length===0)throw new Error("Empty directory is invalid");return a})}ge(so,"getDirectory");var A_=class{constructor(e=100,t=!0,r=pn){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return Le(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,r.data;let n=yield no(e,this.decompress);return n[1]&&this.cache.set(n[1][0],{lastUsed:this.counter++,data:n[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:n[0]}),this.prune(),n[0]})}getDirectory(e,t,r,n){return Le(this,null,function*(){let s=`${e.getKey()}|${n.etag||""}|${t}|${r}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,o.data;let a=yield so(e,this.decompress,t,r,n);return this.cache.set(s,{lastUsed:this.counter++,data:a}),this.prune(),a})}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,n)=>{r.lastUsed<e&&(e=r.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e){return Le(this,null,function*(){this.cache.delete(e.getKey())})}};ge(A_,"ResolvedValueCache");var vc=class{constructor(e=100,t=!0,r=pn){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return Le(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,yield r.data;let n=new Promise((s,o)=>{no(e,this.decompress).then(a=>{a[1]&&this.cache.set(a[1][0],{lastUsed:this.counter++,data:Promise.resolve(a[1][2])}),s(a[0]),this.prune()}).catch(a=>{o(a)})});return this.cache.set(t,{lastUsed:this.counter++,data:n}),n})}getDirectory(e,t,r,n){return Le(this,null,function*(){let s=`${e.getKey()}|${n.etag||""}|${t}|${r}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,yield o.data;let a=new Promise((c,l)=>{so(e,this.decompress,t,r,n).then(u=>{c(u),this.prune()}).catch(u=>{l(u)})});return this.cache.set(s,{lastUsed:this.counter++,data:a}),a})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,n)=>{r.lastUsed<e&&(e=r.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e){return Le(this,null,function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let r=new Promise((n,s)=>{this.getHeader(e).then(o=>{n(),this.invalidations.delete(t)}).catch(o=>{s(o)})});this.invalidations.set(t,r)})}};ge(vc,"SharedPromiseCache");var L_=vc,Pc=class{constructor(e,t,r){typeof e=="string"?this.source=new P_(e):this.source=e,r?this.decompress=r:this.decompress=pn,t?this.cache=t:this.cache=new L_}getHeader(){return Le(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,r,n){return Le(this,null,function*(){let s=xc(e,t,r),o=yield this.cache.getHeader(this.source);if(e<o.minZoom||e>o.maxZoom)return;let a=o.rootDirectoryOffset,c=o.rootDirectoryLength;for(let l=0;l<=3;l++){let u=yield this.cache.getDirectory(this.source,a,c,o),h=Tc(u,s);if(h){if(h.runLength>0){let f=yield this.source.getBytes(o.tileDataOffset+h.offset,h.length,n,o.etag);return{data:yield this.decompress(f.data,o.tileCompression),cacheControl:f.cacheControl,expires:f.expires}}a=o.leafDirectoryOffset+h.offset,c=h.length}else return}throw new Error("Maximum directory depth exceeded")})}getZxy(e,t,r,n){return Le(this,null,function*(){try{return yield this.getZxyAttempt(e,t,r,n)}catch(s){if(s instanceof ts)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,r,n);throw s}})}getMetadataAttempt(){return Le(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),r=yield this.decompress(t.data,e.internalCompression),n=new TextDecoder("utf-8");return JSON.parse(n.decode(r))})}getMetadata(){return Le(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof ts)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return Le(this,null,function*(){let t=yield this.getHeader(),r=yield this.getMetadata(),n=bc(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${n}`],vector_layers:r.vector_layers,attribution:r.attribution,description:r.description,name:r.name,version:r.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}};ge(Pc,"PMTiles");var Yr=Pc;class I_ extends dl{constructor(e){super(Be.ERROR),this.error=e}}function Oe(i){return(e,...t)=>C_(i,e,t)}function Lr(i,e){return Oe(Ac(i,e).get)}const{apply:C_,getOwnPropertyDescriptor:Ac,getPrototypeOf:oo,ownKeys:F_}=Reflect,{iterator:oi,toStringTag:M_}=Symbol,O_=Object,{create:ao,defineProperty:N_}=O_,D_=Array,U_=D_.prototype,Lc=U_[oi],G_=Oe(Lc),Ic=ArrayBuffer,B_=Ic.prototype;Lr(B_,"byteLength");const va=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;va&&Lr(va.prototype,"byteLength");const Cc=oo(Uint8Array);Cc.from;const ze=Cc.prototype;ze[oi];Oe(ze.keys);Oe(ze.values);Oe(ze.entries);Oe(ze.set);Oe(ze.reverse);Oe(ze.fill);Oe(ze.copyWithin);Oe(ze.sort);Oe(ze.slice);Oe(ze.subarray);Lr(ze,"buffer");Lr(ze,"byteOffset");Lr(ze,"length");Lr(ze,M_);const z_=Uint8Array,Fc=Uint16Array,lo=Uint32Array,k_=Float32Array,qr=oo([][oi]()),Mc=Oe(qr.next),$_=Oe(function*(){}().next),j_=oo(qr),V_=DataView.prototype,X_=Oe(V_.getUint16),co=WeakMap,Oc=co.prototype,Nc=Oe(Oc.get),W_=Oe(Oc.set),Dc=new co,H_=ao(null,{next:{value:function(){const e=Nc(Dc,this);return Mc(e)}},[oi]:{value:function(){return this}}});function Z_(i){if(i[oi]===Lc&&qr.next===Mc)return i;const e=ao(H_);return W_(Dc,e,G_(i)),e}const Y_=new co,q_=ao(j_,{next:{value:function(){const e=Nc(Y_,this);return $_(e)},writable:!0,configurable:!0}});for(const i of F_(qr))i!=="next"&&N_(q_,i,Ac(qr,i));const Uc=new Ic(4),K_=new k_(Uc),J_=new lo(Uc),ct=new Fc(512),ut=new z_(512);for(let i=0;i<256;++i){const e=i-127;e<-24?(ct[i]=0,ct[i|256]=32768,ut[i]=24,ut[i|256]=24):e<-14?(ct[i]=1024>>-e-14,ct[i|256]=1024>>-e-14|32768,ut[i]=-e-1,ut[i|256]=-e-1):e<=15?(ct[i]=e+15<<10,ct[i|256]=e+15<<10|32768,ut[i]=13,ut[i|256]=13):e<128?(ct[i]=31744,ct[i|256]=64512,ut[i]=24,ut[i|256]=24):(ct[i]=31744,ct[i|256]=64512,ut[i]=13,ut[i|256]=13)}const uo=new lo(2048);for(let i=1;i<1024;++i){let e=i<<13,t=0;for(;!(e&8388608);)e<<=1,t-=8388608;e&=-8388609,t+=947912704,uo[i]=e|t}for(let i=1024;i<2048;++i)uo[i]=939524096+(i-1024<<13);const Ir=new lo(64);for(let i=1;i<31;++i)Ir[i]=i<<23;Ir[31]=1199570944;Ir[32]=2147483648;for(let i=33;i<63;++i)Ir[i]=2147483648+(i-32<<23);Ir[63]=3347054592;const Gc=new Fc(64);for(let i=1;i<64;++i)i!==32&&(Gc[i]=1024);function Q_(i){const e=i>>10;return J_[0]=uo[Gc[e]+(i&1023)]+Ir[e],K_[0]}function Bc(i,e,...t){return Q_(X_(i,e,...Z_(t)))}var ho={exports:{}};function zc(i,e,t){const r=t&&t.debug||!1;r&&console.log("[xml-utils] getting "+e+" in "+i);const n=typeof i=="object"?i.outer:i,s=n.slice(0,n.indexOf(">")+1),o=['"',"'"];for(let a=0;a<o.length;a++){const c=o[a],l=e+"\\="+c+"([^"+c+"]*)"+c;r&&console.log("[xml-utils] pattern:",l);const h=new RegExp(l).exec(s);if(r&&console.log("[xml-utils] match:",h),h)return h[1]}}ho.exports=zc;ho.exports.default=zc;var ey=ho.exports;const Cn=bl(ey);var fo={exports:{}},go={exports:{}},po={exports:{}};function kc(i,e,t){const n=new RegExp(e).exec(i.slice(t));return n?t+n.index:-1}po.exports=kc;po.exports.default=kc;var ty=po.exports,mo={exports:{}};function $c(i,e,t){const n=new RegExp(e).exec(i.slice(t));return n?t+n.index+n[0].length-1:-1}mo.exports=$c;mo.exports.default=$c;var ry=mo.exports,_o={exports:{}};function jc(i,e){const t=new RegExp(e,"g"),r=i.match(t);return r?r.length:0}_o.exports=jc;_o.exports.default=jc;var iy=_o.exports;const ny=ty,Fn=ry,Pa=iy;function Vc(i,e,t){const r=t&&t.debug||!1,n=!(t&&typeof t.nested===!1),s=t&&t.startIndex||0;r&&console.log("[xml-utils] starting findTagByName with",e," and ",t);const o=ny(i,`<${e}[ 
>/]`,s);if(r&&console.log("[xml-utils] start:",o),o===-1)return;const a=i.slice(o+e.length);let c=Fn(a,"^[^<]*[ /]>",0);const l=c!==-1&&a[c-1]==="/";if(r&&console.log("[xml-utils] selfClosing:",l),l===!1)if(n){let d=0,g=1,p=0;for(;(c=Fn(a,"[ /]"+e+">",d))!==-1;){const m=a.substring(d,c+1);if(g+=Pa(m,"<"+e+`[ 
	>]`),p+=Pa(m,"</"+e+">"),p>=g)break;d=c}}else c=Fn(a,"[ /]"+e+">",0);const u=o+e.length+c+1;if(r&&console.log("[xml-utils] end:",u),u===-1)return;const h=i.slice(o,u);let f;return l?f=null:f=h.slice(h.indexOf(">")+1,h.lastIndexOf("<")),{inner:f,outer:h,start:o,end:u}}go.exports=Vc;go.exports.default=Vc;var sy=go.exports;const oy=sy;function Xc(i,e,t){const r=[],n=t&&t.debug||!1,s=t&&typeof t.nested=="boolean"?t.nested:!0;let o=t&&t.startIndex||0,a;for(;a=oy(i,e,{debug:n,startIndex:o});)s?o=a.start+1+e.length:o=a.end,r.push(a);return n&&console.log("findTagsByName found",r.length,"tags"),r}fo.exports=Xc;fo.exports.default=Xc;var ay=fo.exports;const ly=bl(ay),zr={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},ht={};for(const i in zr)zr.hasOwnProperty(i)&&(ht[zr[i]]=parseInt(i,10));const cy=[ht.BitsPerSample,ht.ExtraSamples,ht.SampleFormat,ht.StripByteCounts,ht.StripOffsets,ht.StripRowCounts,ht.TileByteCounts,ht.TileOffsets,ht.SubIFDs],Mn={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},Z={};for(const i in Mn)Mn.hasOwnProperty(i)&&(Z[Mn[i]]=parseInt(i,10));const ke={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8,ICCLab:9},uy={Unspecified:0},yx={AddCompression:1},Ex={None:0,Deflate:1,Zstandard:2},hy={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function fy(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<i.length;++o,a+=3)s=256-i[o]/e*256,n[a]=s,n[a+1]=s,n[a+2]=s;return n}function dy(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<i.length;++o,a+=3)s=i[o]/e*256,n[a]=s,n[a+1]=s,n[a+2]=s;return n}function gy(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3),s=e.length/3,o=e.length/3*2;for(let a=0,c=0;a<i.length;++a,c+=3){const l=i[a];n[c]=e[l]/65536*256,n[c+1]=e[l+s]/65536*256,n[c+2]=e[l+o]/65536*256}return n}function py(i){const{width:e,height:t}=i,r=new Uint8Array(e*t*3);for(let n=0,s=0;n<i.length;n+=4,s+=3){const o=i[n],a=i[n+1],c=i[n+2],l=i[n+3];r[s]=255*((255-o)/256)*((255-l)/256),r[s+1]=255*((255-a)/256)*((255-l)/256),r[s+2]=255*((255-c)/256)*((255-l)/256)}return r}function my(i){const{width:e,height:t}=i,r=new Uint8ClampedArray(e*t*3);for(let n=0,s=0;n<i.length;n+=3,s+=3){const o=i[n],a=i[n+1],c=i[n+2];r[s]=o+1.402*(c-128),r[s+1]=o-.34414*(a-128)-.71414*(c-128),r[s+2]=o+1.772*(a-128)}return r}const _y=.95047,yy=1,Ey=1.08883;function xy(i){const{width:e,height:t}=i,r=new Uint8Array(e*t*3);for(let n=0,s=0;n<i.length;n+=3,s+=3){const o=i[n+0],a=i[n+1]<<24>>24,c=i[n+2]<<24>>24;let l=(o+16)/116,u=a/500+l,h=l-c/200,f,d,g;u=_y*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),l=yy*(l*l*l>.008856?l*l*l:(l-16/116)/7.787),h=Ey*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),f=u*3.2406+l*-1.5372+h*-.4986,d=u*-.9689+l*1.8758+h*.0415,g=u*.0557+l*-.204+h*1.057,f=f>.0031308?1.055*f**(1/2.4)-.055:12.92*f,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,g=g>.0031308?1.055*g**(1/2.4)-.055:12.92*g,r[s]=Math.max(0,Math.min(1,f))*255,r[s+1]=Math.max(0,Math.min(1,d))*255,r[s+2]=Math.max(0,Math.min(1,g))*255}return r}const Wc=new Map;function Bt(i,e){Array.isArray(i)||(i=[i]),i.forEach(t=>Wc.set(t,e))}async function Hc(i){const e=Wc.get(i.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${i.Compression}`);const t=await e();return new t(i)}Bt([void 0,1],()=>Gt(()=>import("./raw.DxtaBMev.js"),__vite__mapDeps([0,1])).then(i=>i.default));Bt(5,()=>Gt(()=>import("./lzw.BikwkTY2.js"),__vite__mapDeps([2,1])).then(i=>i.default));Bt(6,()=>{throw new Error("old style JPEG compression is not supported.")});Bt(7,()=>Gt(()=>import("./jpeg.CbvpOiPg.js"),__vite__mapDeps([3,1])).then(i=>i.default));Bt([8,32946],()=>Gt(()=>import("./deflate.B4_27dB1.js"),__vite__mapDeps([4,5,1])).then(i=>i.default));Bt(32773,()=>Gt(()=>import("./packbits.D6Qr5eNi.js"),__vite__mapDeps([6,1])).then(i=>i.default));Bt(34887,()=>Gt(()=>import("./lerc.zdXlyJRY.js"),__vite__mapDeps([7,5,8,1,9,10,11])).then(async i=>(await i.zstd.init(),i)).then(i=>i.default));Bt(50001,()=>Gt(()=>import("./webimage.CU41Mh7j.js"),__vite__mapDeps([12,1])).then(i=>i.default));function mn(i,e,t,r=1){return new(Object.getPrototypeOf(i)).constructor(e*t*r)}function by(i,e,t,r,n){const s=e/r,o=t/n;return i.map(a=>{const c=mn(a,r,n);for(let l=0;l<n;++l){const u=Math.min(Math.round(o*l),t-1);for(let h=0;h<r;++h){const f=Math.min(Math.round(s*h),e-1),d=a[u*e+f];c[l*r+h]=d}}return c})}function fr(i,e,t){return(1-t)*i+t*e}function Ty(i,e,t,r,n){const s=e/r,o=t/n;return i.map(a=>{const c=mn(a,r,n);for(let l=0;l<n;++l){const u=o*l,h=Math.floor(u),f=Math.min(Math.ceil(u),t-1);for(let d=0;d<r;++d){const g=s*d,p=g%1,m=Math.floor(g),y=Math.min(Math.ceil(g),e-1),_=a[h*e+m],E=a[h*e+y],w=a[f*e+m],S=a[f*e+y],T=fr(fr(_,E,p),fr(w,S,p),u%1);c[l*r+d]=T}}return c})}function wy(i,e,t,r,n,s="nearest"){switch(s.toLowerCase()){case"nearest":return by(i,e,t,r,n);case"bilinear":case"linear":return Ty(i,e,t,r,n);default:throw new Error(`Unsupported resampling method: '${s}'`)}}function Sy(i,e,t,r,n,s){const o=e/r,a=t/n,c=mn(i,r,n,s);for(let l=0;l<n;++l){const u=Math.min(Math.round(a*l),t-1);for(let h=0;h<r;++h){const f=Math.min(Math.round(o*h),e-1);for(let d=0;d<s;++d){const g=i[u*e*s+f*s+d];c[l*r*s+h*s+d]=g}}}return c}function Ry(i,e,t,r,n,s){const o=e/r,a=t/n,c=mn(i,r,n,s);for(let l=0;l<n;++l){const u=a*l,h=Math.floor(u),f=Math.min(Math.ceil(u),t-1);for(let d=0;d<r;++d){const g=o*d,p=g%1,m=Math.floor(g),y=Math.min(Math.ceil(g),e-1);for(let _=0;_<s;++_){const E=i[h*e*s+m*s+_],w=i[h*e*s+y*s+_],S=i[f*e*s+m*s+_],T=i[f*e*s+y*s+_],v=fr(fr(E,w,p),fr(S,T,p),u%1);c[l*r*s+d*s+_]=v}}}return c}function vy(i,e,t,r,n,s,o="nearest"){switch(o.toLowerCase()){case"nearest":return Sy(i,e,t,r,n,s);case"bilinear":case"linear":return Ry(i,e,t,r,n,s);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function Py(i,e,t){let r=0;for(let n=e;n<t;++n)r+=i[n];return r}function rs(i,e,t){switch(i){case 1:if(e<=8)return new Uint8Array(t);if(e<=16)return new Uint16Array(t);if(e<=32)return new Uint32Array(t);break;case 2:if(e===8)return new Int8Array(t);if(e===16)return new Int16Array(t);if(e===32)return new Int32Array(t);break;case 3:switch(e){case 16:case 32:return new Float32Array(t);case 64:return new Float64Array(t)}break}throw Error("Unsupported data format/bitsPerSample")}function Ay(i,e){return(i===1||i===2)&&e<=32&&e%8===0?!1:!(i===3&&(e===16||e===32||e===64))}function Ly(i,e,t,r,n,s,o){const a=new DataView(i),c=t===2?o*s:o*s*r,l=t===2?1:r,u=rs(e,n,c),h=parseInt("1".repeat(n),2);if(e===1){let f;t===1?f=r*n:f=n;let d=s*f;d&7&&(d=d+7&-8);for(let g=0;g<o;++g){const p=g*d;for(let m=0;m<s;++m){const y=p+m*l*n;for(let _=0;_<l;++_){const E=y+_*n,w=(g*s+m)*l+_,S=Math.floor(E/8),T=E%8;if(T+n<=8)u[w]=a.getUint8(S)>>8-n-T&h;else if(T+n<=16)u[w]=a.getUint16(S)>>16-n-T&h;else if(T+n<=24){const v=a.getUint16(S)<<8|a.getUint8(S+2);u[w]=v>>24-n-T&h}else u[w]=a.getUint32(S)>>32-n-T&h}}}}return u.buffer}class Zc{constructor(e,t,r,n,s,o){this.fileDirectory=e,this.geoKeys=t,this.dataView=r,this.littleEndian=n,this.tiles=s?{}:null,this.isTiled=!e.StripOffsets;const a=e.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(e){return this.isTiled||(e+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-e*this.getTileHeight()}getBytesPerPixel(){let e=0;for(let t=0;t<this.fileDirectory.BitsPerSample.length;++t)e+=this.getSampleByteSize(t);return e}getSampleByteSize(e){if(e>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${e} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[e]/8)}getReaderForSample(e){const t=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,r=this.fileDirectory.BitsPerSample[e];switch(t){case 1:if(r<=8)return DataView.prototype.getUint8;if(r<=16)return DataView.prototype.getUint16;if(r<=32)return DataView.prototype.getUint32;break;case 2:if(r<=8)return DataView.prototype.getInt8;if(r<=16)return DataView.prototype.getInt16;if(r<=32)return DataView.prototype.getInt32;break;case 3:switch(r){case 16:return function(n,s){return Bc(this,n,s)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(e=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1}getBitsPerSample(e=0){return this.fileDirectory.BitsPerSample[e]}getArrayForSample(e,t){const r=this.getSampleFormat(e),n=this.getBitsPerSample(e);return rs(r,n,t)}async getTileOrStrip(e,t,r,n,s){const o=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight());let c;const{tiles:l}=this;this.planarConfiguration===1?c=t*o+e:this.planarConfiguration===2&&(c=r*o*a+t*o+e);let u,h;this.isTiled?(u=this.fileDirectory.TileOffsets[c],h=this.fileDirectory.TileByteCounts[c]):(u=this.fileDirectory.StripOffsets[c],h=this.fileDirectory.StripByteCounts[c]);const f=(await this.source.fetch([{offset:u,length:h}],s))[0];let d;return l===null||!l[c]?(d=(async()=>{let g=await n.decode(this.fileDirectory,f);const p=this.getSampleFormat(),m=this.getBitsPerSample();return Ay(p,m)&&(g=Ly(g,p,this.planarConfiguration,this.getSamplesPerPixel(),m,this.getTileWidth(),this.getBlockHeight(t))),g})(),l!==null&&(l[c]=d)):d=l[c],{x:e,y:t,sample:r,data:await d}}async _readRaster(e,t,r,n,s,o,a,c,l){const u=this.getTileWidth(),h=this.getTileHeight(),f=this.getWidth(),d=this.getHeight(),g=Math.max(Math.floor(e[0]/u),0),p=Math.min(Math.ceil(e[2]/u),Math.ceil(f/u)),m=Math.max(Math.floor(e[1]/h),0),y=Math.min(Math.ceil(e[3]/h),Math.ceil(d/h)),_=e[2]-e[0];let E=this.getBytesPerPixel();const w=[],S=[];for(let I=0;I<t.length;++I)this.planarConfiguration===1?w.push(Py(this.fileDirectory.BitsPerSample,0,t[I])/8):w.push(0),S.push(this.getReaderForSample(t[I]));const T=[],{littleEndian:v}=this;for(let I=m;I<y;++I)for(let A=g;A<p;++A){let R;this.planarConfiguration===1&&(R=this.getTileOrStrip(A,I,0,s,l));for(let O=0;O<t.length;++O){const N=O,k=t[O];this.planarConfiguration===2&&(E=this.getSampleByteSize(k),R=this.getTileOrStrip(A,I,k,s,l));const j=R.then(G=>{const ee=G.data,B=new DataView(ee),oe=this.getBlockHeight(G.y),W=G.y*h,ie=G.x*u,pe=W+oe,Te=(G.x+1)*u,re=S[N],Pe=Math.min(oe,oe-(pe-e[3]),d-W),Re=Math.min(u,u-(Te-e[2]),f-ie);for(let ve=Math.max(0,e[1]-W);ve<Pe;++ve)for(let Ne=Math.max(0,e[0]-ie);Ne<Re;++Ne){const er=(ve*u+Ne)*E,zt=re.call(B,er+w[N],v);let Rt;n?(Rt=(ve+W-e[1])*_*t.length+(Ne+ie-e[0])*t.length+N,r[Rt]=zt):(Rt=(ve+W-e[1])*_+Ne+ie-e[0],r[N][Rt]=zt)}});T.push(j)}}if(await Promise.all(T),o&&e[2]-e[0]!==o||a&&e[3]-e[1]!==a){let I;return n?I=vy(r,e[2]-e[0],e[3]-e[1],o,a,t.length,c):I=wy(r,e[2]-e[0],e[3]-e[1],o,a,c),I.width=o,I.height=a,I}return r.width=o||e[2]-e[0],r.height=a||e[3]-e[1],r}async readRasters({window:e,samples:t=[],interleave:r,pool:n=null,width:s,height:o,resampleMethod:a,fillValue:c,signal:l}={}){const u=e||[0,0,this.getWidth(),this.getHeight()];if(u[0]>u[2]||u[1]>u[3])throw new Error("Invalid subsets");const h=u[2]-u[0],f=u[3]-u[1],d=h*f,g=this.getSamplesPerPixel();if(!t||!t.length)for(let _=0;_<g;++_)t.push(_);else for(let _=0;_<t.length;++_)if(t[_]>=g)return Promise.reject(new RangeError(`Invalid sample index '${t[_]}'.`));let p;if(r){const _=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,E=Math.max.apply(null,this.fileDirectory.BitsPerSample);p=rs(_,E,d*t.length),c&&p.fill(c)}else{p=[];for(let _=0;_<t.length;++_){const E=this.getArrayForSample(t[_],d);Array.isArray(c)&&_<c.length?E.fill(c[_]):c&&!Array.isArray(c)&&E.fill(c),p.push(E)}}const m=n||await Hc(this.fileDirectory);return await this._readRaster(u,t,p,r,m,s,o,a,l)}async readRGB({window:e,interleave:t=!0,pool:r=null,width:n,height:s,resampleMethod:o,enableAlpha:a=!1,signal:c}={}){const l=e||[0,0,this.getWidth(),this.getHeight()];if(l[0]>l[2]||l[1]>l[3])throw new Error("Invalid subsets");const u=this.fileDirectory.PhotometricInterpretation;if(u===ke.RGB){let y=[0,1,2];if(this.fileDirectory.ExtraSamples!==uy.Unspecified&&a){y=[];for(let _=0;_<this.fileDirectory.BitsPerSample.length;_+=1)y.push(_)}return this.readRasters({window:e,interleave:t,samples:y,pool:r,width:n,height:s,resampleMethod:o,signal:c})}let h;switch(u){case ke.WhiteIsZero:case ke.BlackIsZero:case ke.Palette:h=[0];break;case ke.CMYK:h=[0,1,2,3];break;case ke.YCbCr:case ke.CIELab:h=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const f={window:l,interleave:!0,samples:h,pool:r,width:n,height:s,resampleMethod:o,signal:c},{fileDirectory:d}=this,g=await this.readRasters(f),p=2**this.fileDirectory.BitsPerSample[0];let m;switch(u){case ke.WhiteIsZero:m=fy(g,p);break;case ke.BlackIsZero:m=dy(g,p);break;case ke.Palette:m=gy(g,d.ColorMap);break;case ke.CMYK:m=py(g);break;case ke.YCbCr:m=my(g);break;case ke.CIELab:m=xy(g);break;default:throw new Error("Unsupported photometric interpretation.")}if(!t){const y=new Uint8Array(m.length/3),_=new Uint8Array(m.length/3),E=new Uint8Array(m.length/3);for(let w=0,S=0;w<m.length;w+=3,++S)y[S]=m[w],_[S]=m[w+1],E[S]=m[w+2];m=[y,_,E]}return m.width=g.width,m.height=g.height,m}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const e=[];for(let t=0;t<this.fileDirectory.ModelTiepoint.length;t+=6)e.push({i:this.fileDirectory.ModelTiepoint[t],j:this.fileDirectory.ModelTiepoint[t+1],k:this.fileDirectory.ModelTiepoint[t+2],x:this.fileDirectory.ModelTiepoint[t+3],y:this.fileDirectory.ModelTiepoint[t+4],z:this.fileDirectory.ModelTiepoint[t+5]});return e}getGDALMetadata(e=null){const t={};if(!this.fileDirectory.GDAL_METADATA)return null;const r=this.fileDirectory.GDAL_METADATA;let n=ly(r,"Item");e===null?n=n.filter(s=>Cn(s,"sample")===void 0):n=n.filter(s=>Number(Cn(s,"sample"))===e);for(let s=0;s<n.length;++s){const o=n[s];t[Cn(o,"name")]=o.inner}return t}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const e=this.fileDirectory.GDAL_NODATA;return Number(e.substring(0,e.length-1))}getOrigin(){const e=this.fileDirectory.ModelTiepoint,t=this.fileDirectory.ModelTransformation;if(e&&e.length===6)return[e[3],e[4],e[5]];if(t)return[t[3],t[7],t[11]];throw new Error("The image does not have an affine transformation.")}getResolution(e=null){const t=this.fileDirectory.ModelPixelScale,r=this.fileDirectory.ModelTransformation;if(t)return[t[0],-t[1],t[2]];if(r)return r[1]===0&&r[4]===0?[r[0],-r[5],r[10]]:[Math.sqrt(r[0]*r[0]+r[4]*r[4]),-Math.sqrt(r[1]*r[1]+r[5]*r[5]),r[10]];if(e){const[n,s,o]=e.getResolution();return[n*e.getWidth()/this.getWidth(),s*e.getHeight()/this.getHeight(),o*e.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(e=!1){const t=this.getHeight(),r=this.getWidth();if(this.fileDirectory.ModelTransformation&&!e){const[n,s,o,a,c,l,u,h]=this.fileDirectory.ModelTransformation,d=[[0,0],[0,t],[r,0],[r,t]].map(([m,y])=>[a+n*m+s*y,h+c*m+l*y]),g=d.map(m=>m[0]),p=d.map(m=>m[1]);return[Math.min(...g),Math.min(...p),Math.max(...g),Math.max(...p)]}else{const n=this.getOrigin(),s=this.getResolution(),o=n[0],a=n[1],c=o+s[0]*r,l=a+s[1]*t;return[Math.min(o,c),Math.min(a,l),Math.max(o,c),Math.max(a,l)]}}}class Iy{constructor(e){this._dataView=new DataView(e)}get buffer(){return this._dataView.buffer}getUint64(e,t){const r=this.getUint32(e,t),n=this.getUint32(e+4,t);let s;if(t){if(s=r+2**32*n,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}if(s=2**32*r+n,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}getInt64(e,t){let r=0;const n=(this._dataView.getUint8(e+(t?7:0))&128)>0;let s=!0;for(let o=0;o<8;o++){let a=this._dataView.getUint8(e+(t?o:7-o));n&&(s?a!==0&&(a=~(a-1)&255,s=!1):a=~a&255),r+=a*256**o}return n&&(r=-r),r}getUint8(e,t){return this._dataView.getUint8(e,t)}getInt8(e,t){return this._dataView.getInt8(e,t)}getUint16(e,t){return this._dataView.getUint16(e,t)}getInt16(e,t){return this._dataView.getInt16(e,t)}getUint32(e,t){return this._dataView.getUint32(e,t)}getInt32(e,t){return this._dataView.getInt32(e,t)}getFloat16(e,t){return Bc(this._dataView,e,t)}getFloat32(e,t){return this._dataView.getFloat32(e,t)}getFloat64(e,t){return this._dataView.getFloat64(e,t)}}class Cy{constructor(e,t,r,n){this._dataView=new DataView(e),this._sliceOffset=t,this._littleEndian=r,this._bigTiff=n}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(e,t){return this.sliceOffset<=e&&this.sliceTop>=e+t}readUint8(e){return this._dataView.getUint8(e-this._sliceOffset,this._littleEndian)}readInt8(e){return this._dataView.getInt8(e-this._sliceOffset,this._littleEndian)}readUint16(e){return this._dataView.getUint16(e-this._sliceOffset,this._littleEndian)}readInt16(e){return this._dataView.getInt16(e-this._sliceOffset,this._littleEndian)}readUint32(e){return this._dataView.getUint32(e-this._sliceOffset,this._littleEndian)}readInt32(e){return this._dataView.getInt32(e-this._sliceOffset,this._littleEndian)}readFloat32(e){return this._dataView.getFloat32(e-this._sliceOffset,this._littleEndian)}readFloat64(e){return this._dataView.getFloat64(e-this._sliceOffset,this._littleEndian)}readUint64(e){const t=this.readUint32(e),r=this.readUint32(e+4);let n;if(this._littleEndian){if(n=t+2**32*r,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}if(n=2**32*t+r,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}readInt64(e){let t=0;const r=(this._dataView.getUint8(e+(this._littleEndian?7:0))&128)>0;let n=!0;for(let s=0;s<8;s++){let o=this._dataView.getUint8(e+(this._littleEndian?s:7-s));r&&(n?o!==0&&(o=~(o-1)&255,n=!1):o=~o&255),t+=o*256**s}return r&&(t=-t),t}readOffset(e){return this._bigTiff?this.readUint64(e):this.readUint32(e)}}const Fy=typeof navigator<"u"&&navigator.hardwareConcurrency||2;class My{constructor(e=Fy,t){this.workers=null,this._awaitingDecoder=null,this.size=e,this.messageId=0,e&&(this._awaitingDecoder=t?Promise.resolve(t):new Promise(r=>{Gt(()=>import("./decoder.CaSv2t6h.js"),[]).then(n=>{r(n.create)})}),this._awaitingDecoder.then(r=>{this._awaitingDecoder=null,this.workers=[];for(let n=0;n<e;n++)this.workers.push({worker:r(),idle:!0})}))}async decode(e,t){return this._awaitingDecoder&&await this._awaitingDecoder,this.size===0?Hc(e).then(r=>r.decode(e,t)):new Promise(r=>{const n=this.workers.find(a=>a.idle)||this.workers[Math.floor(Math.random()*this.size)];n.idle=!1;const s=this.messageId++,o=a=>{a.data.id===s&&(n.idle=!0,r(a.data.decoded),n.worker.removeEventListener("message",o))};n.worker.addEventListener("message",o),n.worker.postMessage({fileDirectory:e,buffer:t,id:s},[t])})}destroy(){this.workers&&(this.workers.forEach(e=>{e.worker.terminate()}),this.workers=null)}}const Aa=`\r
\r
`;function Yc(i){if(typeof Object.fromEntries<"u")return Object.fromEntries(i);const e={};for(const[t,r]of i)e[t.toLowerCase()]=r;return e}function Oy(i){const e=i.split(`\r
`).map(t=>{const r=t.split(":").map(n=>n.trim());return r[0]=r[0].toLowerCase(),r});return Yc(e)}function Ny(i){const[e,...t]=i.split(";").map(n=>n.trim()),r=t.map(n=>n.split("="));return{type:e,params:Yc(r)}}function is(i){let e,t,r;return i&&([,e,t,r]=i.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),t=parseInt(t,10),r=parseInt(r,10)),{start:e,end:t,total:r}}function Dy(i,e){let t=null;const r=new TextDecoder("ascii"),n=[],s=`--${e}`,o=`${s}--`;for(let a=0;a<10;++a)r.decode(new Uint8Array(i,a,s.length))===s&&(t=a);if(t===null)throw new Error("Could not find initial boundary");for(;t<i.byteLength;){const a=r.decode(new Uint8Array(i,t,Math.min(s.length+1024,i.byteLength-t)));if(a.length===0||a.startsWith(o))break;if(!a.startsWith(s))throw new Error("Part does not start with boundary");const c=a.substr(s.length+2);if(c.length===0)break;const l=c.indexOf(Aa),u=Oy(c.substr(0,l)),{start:h,end:f,total:d}=is(u["content-range"]),g=t+s.length+l+Aa.length,p=parseInt(f,10)+1-parseInt(h,10);n.push({headers:u,data:i.slice(g,g+p),offset:h,length:p,fileSize:d}),t=g+p+4}return n}class yo{async fetch(e,t=void 0){return Promise.all(e.map(r=>this.fetchSlice(r,t)))}async fetchSlice(e){throw new Error(`fetching of slice ${e} not possible, not implemented`)}get fileSize(){return null}async close(){}}class Uy extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,r]of e)this.onEviction(t,r.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const r=t.get(e);return this._getItemValue(e,r)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield e)}for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:r=this.maxAge}={}){const n=typeof r=="number"&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:n}):this._set(e,{value:t,expiry:n}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],r=t.length-e;r<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(r>0&&this._emitEvictions(t.slice(0,r)),this.oldCache=new Map(t.slice(r)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;this._deleteIfExpired(n,s)===!1&&(yield[n,s.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;this.cache.has(n)||this._deleteIfExpired(n,s)===!1&&(yield[n,s.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,n]of this.entriesAscending())e.call(t,n,r,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function Gy(i){return new Promise(e=>setTimeout(e,i))}function By(i,e){const t=Array.isArray(i)?i:Array.from(i),r=Array.isArray(e)?e:Array.from(e);return t.map((n,s)=>[n,r[s]])}class _r extends Error{constructor(e){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,_r),this.name="AbortError"}}class zy extends Error{constructor(e,t){super(t),this.errors=e,this.message=t,this.name="AggregateError"}}const ky=zy;class $y{constructor(e,t,r=null){this.offset=e,this.length=t,this.data=r}get top(){return this.offset+this.length}}class La{constructor(e,t,r){this.offset=e,this.length=t,this.blockIds=r}}class jy extends yo{constructor(e,{blockSize:t=65536,cacheSize:r=100}={}){super(),this.source=e,this.blockSize=t,this.blockCache=new Uy({maxSize:r,onEviction:(n,s)=>{this.evictedBlocks.set(n,s)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(e,t){const r=[],n=[],s=[];this.evictedBlocks.clear();for(const{offset:f,length:d}of e){let g=f+d;const{fileSize:p}=this;p!==null&&(g=Math.min(g,p));const m=Math.floor(f/this.blockSize)*this.blockSize;for(let y=m;y<g;y+=this.blockSize){const _=Math.floor(y/this.blockSize);!this.blockCache.has(_)&&!this.blockRequests.has(_)&&(this.blockIdsToFetch.add(_),n.push(_)),this.blockRequests.has(_)&&r.push(this.blockRequests.get(_)),s.push(_)}}await Gy(),this.fetchBlocks(t);const o=[];for(const f of n)this.blockRequests.has(f)&&o.push(this.blockRequests.get(f));await Promise.allSettled(r),await Promise.allSettled(o);const a=[],c=s.filter(f=>this.abortedBlockIds.has(f)||!this.blockCache.has(f));if(c.forEach(f=>this.blockIdsToFetch.add(f)),c.length>0&&t&&!t.aborted){this.fetchBlocks(null);for(const f of c){const d=this.blockRequests.get(f);if(!d)throw new Error(`Block ${f} is not in the block requests`);a.push(d)}await Promise.allSettled(a)}if(t&&t.aborted)throw new _r("Request was aborted");const l=s.map(f=>this.blockCache.get(f)||this.evictedBlocks.get(f)),u=l.filter(f=>!f);if(u.length)throw new ky(u,"Request failed");const h=new Map(By(s,l));return this.readSliceData(e,h)}fetchBlocks(e){if(this.blockIdsToFetch.size>0){const t=this.groupBlocks(this.blockIdsToFetch),r=this.source.fetch(t,e);for(let n=0;n<t.length;++n){const s=t[n];for(const o of s.blockIds)this.blockRequests.set(o,(async()=>{try{const a=(await r)[n],c=o*this.blockSize,l=c-a.offset,u=Math.min(l+this.blockSize,a.data.byteLength),h=a.data.slice(l,u),f=new $y(c,h.byteLength,h,o);this.blockCache.set(o,f),this.abortedBlockIds.delete(o)}catch(a){if(a.name==="AbortError")a.signal=e,this.blockCache.delete(o),this.abortedBlockIds.add(o);else throw a}finally{this.blockRequests.delete(o)}})())}this.blockIdsToFetch.clear()}}groupBlocks(e){const t=Array.from(e).sort((o,a)=>o-a);if(t.length===0)return[];let r=[],n=null;const s=[];for(const o of t)n===null||n+1===o?(r.push(o),n=o):(s.push(new La(r[0]*this.blockSize,r.length*this.blockSize,r)),r=[o],n=o);return s.push(new La(r[0]*this.blockSize,r.length*this.blockSize,r)),s}readSliceData(e,t){return e.map(r=>{let n=r.offset+r.length;this.fileSize!==null&&(n=Math.min(this.fileSize,n));const s=Math.floor(r.offset/this.blockSize),o=Math.floor(n/this.blockSize),a=new ArrayBuffer(r.length),c=new Uint8Array(a);for(let l=s;l<=o;++l){const u=t.get(l),h=u.offset-r.offset,f=u.top-n;let d=0,g=0,p;h<0?d=-h:h>0&&(g=h),f<0?p=u.length-d:p=n-u.offset-d;const m=new Uint8Array(u.data,d,p);c.set(m,g)}return a})}}class Eo{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(e){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class xo{constructor(e){this.url=e}async request({headers:e,signal:t}={}){throw new Error("request is not implemented")}}class Vy extends Eo{constructor(e){super(),this.response=e}get status(){return this.response.status}getHeader(e){return this.response.headers.get(e)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class Xy extends xo{constructor(e,t){super(e),this.credentials=t}async request({headers:e,signal:t}={}){const r=await fetch(this.url,{headers:e,credentials:this.credentials,signal:t});return new Vy(r)}}class Wy extends Eo{constructor(e,t){super(),this.xhr=e,this.data=t}get status(){return this.xhr.status}getHeader(e){return this.xhr.getResponseHeader(e)}async getData(){return this.data}}class Hy extends xo{constructRequest(e,t){return new Promise((r,n)=>{const s=new XMLHttpRequest;s.open("GET",this.url),s.responseType="arraybuffer";for(const[o,a]of Object.entries(e))s.setRequestHeader(o,a);s.onload=()=>{const o=s.response;r(new Wy(s,o))},s.onerror=n,s.onabort=()=>n(new _r("Request aborted")),s.send(),t&&(t.aborted&&s.abort(),t.addEventListener("abort",()=>s.abort()))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}const On={};class Zy extends Eo{constructor(e,t){super(),this.response=e,this.dataPromise=t}get status(){return this.response.statusCode}getHeader(e){return this.response.headers[e]}async getData(){return await this.dataPromise}}class Yy extends xo{constructor(e){super(e),this.parsedUrl=On.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",On)}constructRequest(e,t){return new Promise((r,n)=>{const s=this.httpApi.get({...this.parsedUrl,headers:e},o=>{const a=new Promise(c=>{const l=[];o.on("data",u=>{l.push(u)}),o.on("end",()=>{const u=Buffer.concat(l).buffer;c(u)}),o.on("error",n)});r(new Zy(o,a))});s.on("error",n),t&&(t.aborted&&s.destroy(new _r("Request aborted")),t.addEventListener("abort",()=>s.destroy(new _r("Request aborted"))))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class bo extends yo{constructor(e,t,r,n){super(),this.client=e,this.headers=t,this.maxRanges=r,this.allowFullFile=n,this._fileSize=null}async fetch(e,t){return this.maxRanges>=e.length?this.fetchSlices(e,t):(this.maxRanges>0&&e.length>1,Promise.all(e.map(r=>this.fetchSlice(r,t))))}async fetchSlices(e,t){const r=await this.client.request({headers:{...this.headers,Range:`bytes=${e.map(({offset:n,length:s})=>`${n}-${n+s}`).join(",")}`},signal:t});if(r.ok)if(r.status===206){const{type:n,params:s}=Ny(r.getHeader("content-type"));if(n==="multipart/byteranges"){const h=Dy(await r.getData(),s.boundary);return this._fileSize=h[0].fileSize||null,h}const o=await r.getData(),{start:a,end:c,total:l}=is(r.getHeader("content-range"));this._fileSize=l||null;const u=[{data:o,offset:a,length:c-a}];if(e.length>1){const h=await Promise.all(e.slice(1).map(f=>this.fetchSlice(f,t)));return u.concat(h)}return u}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const n=await r.getData();return this._fileSize=n.byteLength,[{data:n,offset:0,length:n.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(e,t){const{offset:r,length:n}=e,s=await this.client.request({headers:{...this.headers,Range:`bytes=${r}-${r+n}`},signal:t});if(s.ok)if(s.status===206){const o=await s.getData(),{total:a}=is(s.getHeader("content-range"));return this._fileSize=a||null,{data:o,offset:r,length:n}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const o=await s.getData();return this._fileSize=o.byteLength,{data:o,offset:0,length:o.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function To(i,{blockSize:e,cacheSize:t}){return e===null?i:new jy(i,{blockSize:e,cacheSize:t})}function qy(i,{headers:e={},credentials:t,maxRanges:r=0,allowFullFile:n=!1,...s}={}){const o=new Xy(i,t),a=new bo(o,e,r,n);return To(a,s)}function Ky(i,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...n}={}){const s=new Hy(i),o=new bo(s,e,t,r);return To(o,n)}function Jy(i,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...n}={}){const s=new Yy(i),o=new bo(s,e,t,r);return To(o,n)}function ns(i,{forceXHR:e=!1,...t}={}){return typeof fetch=="function"&&!e?qy(i,t):typeof XMLHttpRequest<"u"?Ky(i,t):Jy(i,t)}class Qy extends yo{constructor(e){super(),this.file=e}async fetchSlice(e,t){return new Promise((r,n)=>{const s=this.file.slice(e.offset,e.offset+e.length),o=new FileReader;o.onload=a=>r(a.target.result),o.onerror=n,o.onabort=n,o.readAsArrayBuffer(s),t&&t.addEventListener("abort",()=>o.abort())})}}function e0(i){return new Qy(i)}function ss(i){switch(i){case Z.BYTE:case Z.ASCII:case Z.SBYTE:case Z.UNDEFINED:return 1;case Z.SHORT:case Z.SSHORT:return 2;case Z.LONG:case Z.SLONG:case Z.FLOAT:case Z.IFD:return 4;case Z.RATIONAL:case Z.SRATIONAL:case Z.DOUBLE:case Z.LONG8:case Z.SLONG8:case Z.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${i}`)}}function t0(i){const e=i.GeoKeyDirectory;if(!e)return null;const t={};for(let r=4;r<=e[3]*4;r+=4){const n=hy[e[r]],s=e[r+1]?zr[e[r+1]]:null,o=e[r+2],a=e[r+3];let c=null;if(!s)c=a;else{if(c=i[s],typeof c>"u"||c===null)throw new Error(`Could not get value of geoKey '${n}'.`);typeof c=="string"?c=c.substring(a,a+o-1):c.subarray&&(c=c.subarray(a,a+o),o===1&&(c=c[0]))}t[n]=c}return t}function nr(i,e,t,r){let n=null,s=null;const o=ss(e);switch(e){case Z.BYTE:case Z.ASCII:case Z.UNDEFINED:n=new Uint8Array(t),s=i.readUint8;break;case Z.SBYTE:n=new Int8Array(t),s=i.readInt8;break;case Z.SHORT:n=new Uint16Array(t),s=i.readUint16;break;case Z.SSHORT:n=new Int16Array(t),s=i.readInt16;break;case Z.LONG:case Z.IFD:n=new Uint32Array(t),s=i.readUint32;break;case Z.SLONG:n=new Int32Array(t),s=i.readInt32;break;case Z.LONG8:case Z.IFD8:n=new Array(t),s=i.readUint64;break;case Z.SLONG8:n=new Array(t),s=i.readInt64;break;case Z.RATIONAL:n=new Uint32Array(t*2),s=i.readUint32;break;case Z.SRATIONAL:n=new Int32Array(t*2),s=i.readInt32;break;case Z.FLOAT:n=new Float32Array(t),s=i.readFloat32;break;case Z.DOUBLE:n=new Float64Array(t),s=i.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e===Z.RATIONAL||e===Z.SRATIONAL)for(let a=0;a<t;a+=2)n[a]=s.call(i,r+a*o),n[a+1]=s.call(i,r+(a*o+4));else for(let a=0;a<t;++a)n[a]=s.call(i,r+a*o);return e===Z.ASCII?new TextDecoder("utf-8").decode(n):n}class r0{constructor(e,t,r){this.fileDirectory=e,this.geoKeyDirectory=t,this.nextIFDByteOffset=r}}class bi extends Error{constructor(e){super(`No image at index ${e}`),this.index=e}}class qc{async readRasters(e={}){const{window:t,width:r,height:n}=e;let{resX:s,resY:o,bbox:a}=e;const c=await this.getImage();let l=c;const u=await this.getImageCount(),h=c.getBoundingBox();if(t&&a)throw new Error('Both "bbox" and "window" passed.');if(r||n){if(t){const[g,p]=c.getOrigin(),[m,y]=c.getResolution();a=[g+t[0]*m,p+t[1]*y,g+t[2]*m,p+t[3]*y]}const d=a||h;if(r){if(s)throw new Error("Both width and resX passed");s=(d[2]-d[0])/r}if(n){if(o)throw new Error("Both width and resY passed");o=(d[3]-d[1])/n}}if(s||o){const d=[];for(let g=0;g<u;++g){const p=await this.getImage(g),{SubfileType:m,NewSubfileType:y}=p.fileDirectory;(g===0||m===2||y&1)&&d.push(p)}d.sort((g,p)=>g.getWidth()-p.getWidth());for(let g=0;g<d.length;++g){const p=d[g],m=(h[2]-h[0])/p.getWidth(),y=(h[3]-h[1])/p.getHeight();if(l=p,s&&s>m||o&&o>y)break}}let f=t;if(a){const[d,g]=c.getOrigin(),[p,m]=l.getResolution(c);f=[Math.round((a[0]-d)/p),Math.round((a[1]-g)/m),Math.round((a[2]-d)/p),Math.round((a[3]-g)/m)],f=[Math.min(f[0],f[2]),Math.min(f[1],f[3]),Math.max(f[0],f[2]),Math.max(f[1],f[3])]}return l.readRasters({...e,window:f})}}class yr extends qc{constructor(e,t,r,n,s={}){super(),this.source=e,this.littleEndian=t,this.bigTiff=r,this.firstIFDOffset=n,this.cache=s.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(e,t){const r=this.bigTiff?4048:1024;return new Cy((await this.source.fetch([{offset:e,length:typeof t<"u"?t:r}]))[0],e,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(e){const t=this.bigTiff?20:12,r=this.bigTiff?8:2;let n=await this.getSlice(e);const s=this.bigTiff?n.readUint64(e):n.readUint16(e),o=s*t+(this.bigTiff?16:6);n.covers(e,o)||(n=await this.getSlice(e,o));const a={};let c=e+(this.bigTiff?8:2);for(let h=0;h<s;c+=t,++h){const f=n.readUint16(c),d=n.readUint16(c+2),g=this.bigTiff?n.readUint64(c+4):n.readUint32(c+4);let p,m;const y=ss(d),_=c+(this.bigTiff?12:8);if(y*g<=(this.bigTiff?8:4))p=nr(n,d,g,_);else{const E=n.readOffset(_),w=ss(d)*g;if(n.covers(E,w))p=nr(n,d,g,E);else{const S=await this.getSlice(E,w);p=nr(S,d,g,E)}}g===1&&cy.indexOf(f)===-1&&!(d===Z.RATIONAL||d===Z.SRATIONAL)?m=p[0]:m=p,a[zr[f]]=m}const l=t0(a),u=n.readOffset(e+r+t*s);return new r0(a,l,u)}async requestIFD(e){if(this.ifdRequests[e])return this.ifdRequests[e];if(e===0)return this.ifdRequests[e]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[e];if(!this.ifdRequests[e-1])try{this.ifdRequests[e-1]=this.requestIFD(e-1)}catch(t){throw t instanceof bi?new bi(e):t}return this.ifdRequests[e]=(async()=>{const t=await this.ifdRequests[e-1];if(t.nextIFDByteOffset===0)throw new bi(e);return this.parseFileDirectoryAt(t.nextIFDByteOffset)})(),this.ifdRequests[e]}async getImage(e=0){const t=await this.requestIFD(e);return new Zc(t.fileDirectory,t.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let e=0,t=!0;for(;t;)try{await this.requestIFD(e),++e}catch(r){if(r instanceof bi)t=!1;else throw r}return e}async getGhostValues(){const e=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const t="GDAL_STRUCTURAL_METADATA_SIZE=",r=t.length+100;let n=await this.getSlice(e,r);if(t===nr(n,Z.ASCII,t.length,e)){const o=nr(n,Z.ASCII,r,e).split(`
`)[0],a=Number(o.split("=")[1].split(" ")[0])+o.length;a>r&&(n=await this.getSlice(e,a));const c=nr(n,Z.ASCII,a,e);this.ghostValues={},c.split(`
`).filter(l=>l.length>0).map(l=>l.split("=")).forEach(([l,u])=>{this.ghostValues[l]=u})}return this.ghostValues}static async fromSource(e,t,r){const n=(await e.fetch([{offset:0,length:1024}],r))[0],s=new Iy(n),o=s.getUint16(0,0);let a;if(o===18761)a=!0;else if(o===19789)a=!1;else throw new TypeError("Invalid byte order value.");const c=s.getUint16(2,a);let l;if(c===42)l=!1;else if(c===43){if(l=!0,s.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const u=l?s.getUint64(8,a):s.getUint32(4,a);return new yr(e,a,l,u,t)}close(){return typeof this.source.close=="function"?this.source.close():!1}}class i0 extends qc{constructor(e,t){super(),this.mainFile=e,this.overviewFiles=t,this.imageFiles=[e].concat(t),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}async parseFileDirectoriesPerFile(){const e=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map(t=>t.parseFileDirectoryAt(t.firstIFDOffset)));return this.fileDirectoriesPerFile=await Promise.all(e),this.fileDirectoriesPerFile}async getImage(e=0){await this.getImageCount(),await this.parseFileDirectoriesPerFile();let t=0,r=0;for(let n=0;n<this.imageFiles.length;n++){const s=this.imageFiles[n];for(let o=0;o<this.imageCounts[n];o++){if(e===t){const a=await s.requestIFD(r);return new Zc(a.fileDirectory,a.geoKeyDirectory,s.dataView,s.littleEndian,s.cache,s.source)}t++,r++}r=0}throw new RangeError("Invalid image index")}async getImageCount(){if(this.imageCount!==null)return this.imageCount;const e=[this.mainFile.getImageCount()].concat(this.overviewFiles.map(t=>t.getImageCount()));return this.imageCounts=await Promise.all(e),this.imageCount=this.imageCounts.reduce((t,r)=>t+r,0),this.imageCount}}async function n0(i,e={},t){return yr.fromSource(ns(i,e),t)}async function s0(i,e){return yr.fromSource(e0(i),e)}async function o0(i,e=[],t={},r){const n=await yr.fromSource(ns(i,t),r),s=await Promise.all(e.map(o=>yr.fromSource(ns(o,t))));return new i0(n,s)}const a0=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,l0=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class c0{constructor(e){this.gl_=e,this.program_=os(e,l0,a0),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,r,n,s,o,a,c,l,u,h,f,d){const g=this.gl_;c===void 0&&(c=n),l===void 0&&(l=s),o===void 0&&(o=t),a===void 0&&(a=r),u===void 0&&(u=o),h===void 0&&(h=a),f===void 0&&(f=g.canvas.width),d===void 0&&(d=g.canvas.height),g.bindTexture(g.TEXTURE_2D,e),g.useProgram(this.program_),g.bindBuffer(g.ARRAY_BUFFER,this.positionBuffer),g.enableVertexAttribArray(this.positionLocation),g.vertexAttribPointer(this.positionLocation,2,g.FLOAT,!1,0,0),g.bindBuffer(g.ARRAY_BUFFER,this.texcoordBuffer),g.enableVertexAttribArray(this.texcoordLocation),g.vertexAttribPointer(this.texcoordLocation,2,g.FLOAT,!1,0,0);let p=qn(0,f,0,d,-1,1);p=nm(p,c,l,0),p=_a(p,u,h,1),g.uniformMatrix4fv(this.matrixLocation,!1,p);let m=sm(n/t,s/r,0);m=_a(m,o/t,a/r,1),g.uniformMatrix4fv(this.textureMatrixLocation,!1,m),g.uniform1i(this.textureLocation,0),g.drawArrays(g.TRIANGLES,0,this.positions.length/2)}}function Ia(i,e,t){const r=i.createShader(e);if(r===null)throw new Error("Shader compilation failed");if(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){const n=i.getShaderInfoLog(r);throw n===null?new Error("Shader info log creation failed"):new Error(n)}return r}function os(i,e,t){const r=i.createProgram(),n=Ia(i,i.VERTEX_SHADER,t),s=Ia(i,i.FRAGMENT_SHADER,e);if(r===null)throw new Error("Program creation failed");if(i.attachShader(r,n),i.attachShader(r,s),i.linkProgram(r),!i.getProgramParameter(r,i.LINK_STATUS))throw i.getProgramInfoLog(r)===null?new Error("Program info log creation failed"):new Error;return r}const u0=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,h0=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,f0=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,d0=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function g0(i,e,t,r){let n;return t&&t.length?n=t.shift():uh?n=new OffscreenCanvas(i||300,e||300):n=document.createElement("canvas"),i&&(n.width=i),e&&(n.height=e),n.getContext("webgl",r)}function p0(i){const e=i.canvas;e.width=1,e.height=1,i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT|i.STENCIL_BUFFER_BIT)}const Ca=[];function m0(i,e,t,r,n,s,o,a,c,l,u,h,f,d){const g=Math.round(r*e),p=Math.round(r*t);i.canvas.width=g,i.canvas.height=p;let m,y;if(y=i.createTexture(),i.bindTexture(i.TEXTURE_2D,y),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),f?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,g,p,0,i.RGBA,u,null),m=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,m),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,y,0),m===null)throw new Error("Could not create framebuffer");if(y===null)throw new Error("Could not create texture");if(c.length===0)return{width:g,height:p,framebuffer:m,texture:y};const _=Qr();c.forEach(function(R,O,N){hh(_,R.extent)});let E,w,S;const T=1/n;{if(E=i.createTexture(),y===null)throw new Error("Could not create texture");w=Math.round(Me(_)*T),S=Math.round(st(_)*T);const R=i.getParameter(i.MAX_TEXTURE_SIZE),O=Math.max(w,S),N=O>R?R/O:1,k=Math.round(w*N),j=Math.round(S*N);i.bindTexture(i.TEXTURE_2D,E),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),f?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,k,j,0,i.RGBA,u,null);const G=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,G),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,E,0);const ee=new c0(i);c.forEach(function(B,oe,W){const ie=(B.extent[0]-_[0])*T*N,pe=-(B.extent[3]-_[3])*T*N,Te=Me(B.extent)*T*N,re=st(B.extent)*T*N;if(i.bindFramebuffer(i.FRAMEBUFFER,G),i.viewport(0,0,k,j),B.clipExtent){const Pe=(B.clipExtent[0]-_[0])*T*N,Re=-(B.clipExtent[3]-_[3])*T*N,ve=Me(B.clipExtent)*T*N,Ne=st(B.clipExtent)*T*N;i.enable(i.SCISSOR_TEST),i.scissor(f?Pe:Math.round(Pe),f?Re:Math.round(Re),f?ve:Math.round(Pe+ve)-Math.round(Pe),f?Ne:Math.round(Re+Ne)-Math.round(Re))}ee.drawImage(B.texture,B.width,B.height,l,l,B.width-2*l,B.height-2*l,f?ie:Math.round(ie),f?pe:Math.round(pe),f?Te:Math.round(ie+Te)-Math.round(ie),f?re:Math.round(pe+re)-Math.round(pe),k,j),i.disable(i.SCISSOR_TEST)}),i.deleteFramebuffer(G)}const v=Vn(o),I=Vn(_),A=R=>{const O=(R[0][0]-v[0])/s*r,N=-(R[0][1]-v[1])/s*r,k=(R[1][0]-v[0])/s*r,j=-(R[1][1]-v[1])/s*r,G=(R[2][0]-v[0])/s*r,ee=-(R[2][1]-v[1])/s*r;return{u1:k,v1:j,u0:O,v0:N,u2:G,v2:ee}};i.bindFramebuffer(i.FRAMEBUFFER,m),i.viewport(0,0,g,p);{const R=[],O=[],N=os(i,d0,f0);i.useProgram(N);const k=i.getUniformLocation(N,"u_texture");i.bindTexture(i.TEXTURE_2D,E),i.uniform1i(k,0),a.getTriangles().forEach(function(ie,pe,Te){const re=ie.source,Pe=ie.target,{u1:Re,v1:ve,u0:Ne,v0:er,u2:zt,v2:Rt}=A(Pe),ui=(re[0][0]-I[0])/n/w,hi=-(re[0][1]-I[1])/n/S,fi=(re[1][0]-I[0])/n/w,mu=-(re[1][1]-I[1])/n/S,_u=(re[2][0]-I[0])/n/w,yu=-(re[2][1]-I[1])/n/S;R.push(Re,ve,Ne,er,zt,Rt),O.push(fi,mu,ui,hi,_u,yu)});const j=qn(0,g,p,0,-1,1),G=i.getUniformLocation(N,"u_matrix");i.uniformMatrix4fv(G,!1,j);const ee=i.getAttribLocation(N,"a_position"),B=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,B),i.bufferData(i.ARRAY_BUFFER,new Float32Array(R),i.STATIC_DRAW),i.vertexAttribPointer(ee,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(ee);const oe=i.getAttribLocation(N,"a_texcoord"),W=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,W),i.bufferData(i.ARRAY_BUFFER,new Float32Array(O),i.STATIC_DRAW),i.vertexAttribPointer(oe,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(oe),i.drawArrays(i.TRIANGLES,0,R.length/2)}if(h){const R=os(i,h0,u0);i.useProgram(R);const O=qn(0,g,p,0,-1,1),N=i.getUniformLocation(R,"u_matrix");i.uniformMatrix4fv(N,!1,O);const k=Array.isArray(h)?h:[0,0,0,255],j=i.getUniformLocation(R,"u_val");i.uniform4fv(j,k);const G=i.getAttribLocation(R,"a_position"),ee=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,ee),i.vertexAttribPointer(G,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(G);const B=a.getTriangles().reduce(function(oe,W){const ie=W.target,{u1:pe,v1:Te,u0:re,v0:Pe,u2:Re,v2:ve}=A(ie);return oe.concat([pe,Te,re,Pe,re,Pe,Re,ve,Re,ve,pe,Te])},[]);i.bufferData(i.ARRAY_BUFFER,new Float32Array(B),i.STATIC_DRAW),i.drawArrays(i.LINES,0,B.length/2)}return{width:g,height:p,framebuffer:m,texture:y}}class _0 extends Es{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,r=t.getExtent(),n=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?n?gt(r,n):r:n;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const c=o?gt(s,o):s;if(No(c)===0){this.state=K.EMPTY;return}r&&(a?a=gt(a,r):a=r);const l=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),u=e.targetProj,h=fh(t,u,c,l);if(!isFinite(h)||h<=0){this.state=K.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:dh;if(this.triangulation_=new gh(t,u,c,a,h*f,l,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=K.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(h);let d=this.triangulation_.calculateSourceExtent();if(a&&(t.canWrapX()?(d[1]=Ee(d[1],a[1],a[3]),d[3]=Ee(d[3],a[1],a[3])):d=gt(d,a)),!No(d))this.state=K.EMPTY;else{let g=0,p=0;t.canWrapX()&&(g=Me(r),p=Math.floor((d[0]-r[0])/g)),ph(d.slice(),t,!0).forEach(y=>{const _=this.sourceTileGrid_.getTileRangeForExtentAndZ(y,this.sourceZ_),E=e.getTileFunction;for(let w=_.minX;w<=_.maxX;w++)for(let S=_.minY;S<=_.maxY;S++){const T=E(this.sourceZ_,w,S,this.pixelRatio_);if(T){const v=p*g;this.sourceTiles_.push({tile:T,offset:v})}}++p}),this.sourceTiles_.length===0&&(this.state=K.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(w=>{var pe;const S=w.tile;if(!S||S.getState()!==K.LOADED)return;const T=S.getSize(),v=this.gutter_;let I;const A=kn(S.getData());A?I=A:(t=!0,I=mh($n(S.getData())));const R=[T[0]+2*v,T[1]+2*v],O=I instanceof Float32Array,N=R[0]*R[1],k=O?Float32Array:Uint8ClampedArray,j=new k(I.buffer),G=k.BYTES_PER_ELEMENT,ee=G*j.length/N,B=j.byteLength/R[1],oe=Math.floor(B/G/R[0]),W=this.sourceTileGrid_.getTileCoordExtent(S.tileCoord);W[0]+=w.offset,W[2]+=w.offset;const ie=(pe=this.clipExtent_)==null?void 0:pe.slice();ie&&(ie[0]+=w.offset,ie[2]+=w.offset),e.push({extent:W,clipExtent:ie,data:j,dataType:k,bytesPerPixel:ee,pixelSize:R,bandCount:oe})}),this.sourceTiles_.length=0,e.length===0){this.state=K.ERROR,this.changed();return}const r=this.wrappedTileCoord_[0],n=this.targetTileGrid_.getTileSize(r),s=typeof n=="number"?n:n[0],o=typeof n=="number"?n:n[1],a=s*this.pixelRatio_,c=o*this.pixelRatio_,l=this.targetTileGrid_.getResolution(r),u=this.sourceTileGrid_.getResolution(this.sourceZ_),h=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),f=e[0].bandCount,d=new e[0].dataType(f*a*c),g=g0(a,c,Ca,{premultipliedAlpha:!1,antialias:!1});let p;const m=g.RGBA;let y;e[0].dataType==Float32Array?(y=g.FLOAT,g.getExtension("WEBGL_color_buffer_float"),g.getExtension("OES_texture_float"),g.getExtension("EXT_float_blend"),p=g.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(y=g.UNSIGNED_BYTE,p=this.interpolate);const _=4,E=Math.ceil(f/_);for(let w=E-1;w>=0;--w){const S=[];for(let k=0,j=e.length;k<j;++k){const G=e[k],ee=G.pixelSize,B=ee[0],oe=ee[1],W=new G.dataType(_*B*oe),ie=G.data;let pe=w*_;for(let re=0,Pe=W.length;re<Pe;re+=_)W[re]=ie[pe],W[re+1]=ie[pe+1],W[re+2]=ie[pe+2],W[re+3]=ie[pe+3],pe+=f;const Te=g.createTexture();g.bindTexture(g.TEXTURE_2D,Te),p?(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR)):(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.NEAREST)),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE),g.texImage2D(g.TEXTURE_2D,0,m,B,oe,0,m,y,W),S.push({extent:G.extent,clipExtent:G.clipExtent,texture:Te,width:B,height:oe})}const{framebuffer:T,width:v,height:I}=m0(g,s,o,this.pixelRatio_,u,l,h,this.triangulation_,S,this.gutter_,y,this.renderEdges_,p),A=v,R=I*_,O=new e[0].dataType(A*R);g.bindFramebuffer(g.FRAMEBUFFER,T),g.readPixels(0,0,v,I,g.RGBA,y,O);let N=w*_;for(let k=0,j=O.length;k<j;k+=_){const G=(A-1-(k/R|0))*R+k%R;d[N]=O[G],d[N+1]=O[G+1],d[N+2]=O[G+2],d[N+3]=O[G+3],N+=f}}if(p0(g),Ca.push(g.canvas),t){const w=Nt(s,o),S=new ImageData(d,s);w.putImageData(S,0,0),this.reprojData_=w.canvas}else this.reprojData_=d;this.reprojSize_=[Math.round(a),Math.round(c)],this.state=K.LOADED,this.changed()}load(){if(this.state!==K.IDLE&&this.state!==K.ERROR)return;this.state=K.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const r=t.getState();if(r!==K.IDLE&&r!==K.LOADING)return;e++;const n=Et(t,Be.CHANGE,()=>{const s=t.getState();(s==K.LOADED||s==K.ERROR||s==K.EMPTY)&&(Ui(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(n)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==K.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(Ui),this.sourcesListenerKeys_=null}}class ai extends Ts{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let r=e.tileGrid;r===void 0&&t&&(r=qt({extent:Kt(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:r,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?nt(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?nt(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return(!t||Ri(t,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,r,n,s){const o=this.tileGrid||this.getTileGridForProjection(s||n),a=Math.max.apply(null,o.getResolutions().map((d,g)=>{const p=nt(o.getTileSize(g)),m=this.getTileSize(g);return Math.max(m[0]/p[0],m[1]/p[1])})),c=this.getTileGridForProjection(n),l=[e,t,r],u=this.getTileCoordForTileUrlFunction(l,n),h=Object.assign({sourceProj:s||n,sourceTileGrid:o,targetProj:n,targetTileGrid:c,tileCoord:l,wrappedTileCoord:u,pixelRatio:a,gutter:this.gutter_,getTileFunction:(d,g,p,m)=>this.getTile(d,g,p,m),transformMatrix:this.transformMatrix},this.tileOptions),f=new _0(h);return f.key=this.getKey(),f}getTile(e,t,r,n,s){var E;const o=this.getProjection();if(s&&(o&&!Ri(o,s)||this.transformMatrix))return this.getReprojTile_(e,t,r,s,o);const a=this.getTileSize(e),c=this.loader_,l=new AbortController,u={signal:l.signal,crossOrigin:this.crossOrigin_},h=this.getTileCoordForTileUrlFunction([e,t,r]);if(!h)return null;const f=h[0],d=h[1],g=h[2],p=(E=this.getTileGrid())==null?void 0:E.getFullTileRange(f);p&&(u.maxY=p.getHeight()-1);function m(){return Eh(function(){return c(f,d,g,u)})}const y=Object.assign({tileCoord:[e,t,r],loader:m,size:a,controller:l},this.tileOptions),_=new Es(y);return _.key=this.getKey(),_.addEventListener(Be.CHANGE,this.handleTileChange_),_}handleTileChange_(e){const t=e.target,r=he(t),n=t.getState();let s;n==K.LOADING?(this.tileLoadingKeys_[r]=!0,s=wn.TILELOADSTART):r in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[r],s=n==K.ERROR?wn.TILELOADERROR:n==K.LOADED?wn.TILELOADEND:void 0),s&&this.dispatchEvent(new _h(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||Ri(t,e))&&!this.transformMatrix)return this.tileGrid;const r=he(e);return r in this.tileGridForProjection_||(this.tileGridForProjection_[r]=yh(e)),this.tileGridForProjection_[r]}setTileGridForProjection(e,t){const r=se(e);if(r){const n=he(r);n in this.tileGridForProjection_||(this.tileGridForProjection_[n]=t)}}}function y0(i){return((i.fileDirectory.NewSubfileType||0)&4)===4}function E0(i,e){if(!i)return!1;if(i===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,r=ke;return t===r.CMYK||t===r.YCbCr||t===r.CIELab||t===r.ICCLab}const Fa="STATISTICS_MAXIMUM",Ma="STATISTICS_MINIMUM",Nn=256;let Dn;function x0(){return Dn||(Dn=new My),Dn}function b0(i){try{return i.getBoundingBox(!0)}catch{return[0,0,i.getWidth(),i.getHeight()]}}function T0(i){try{return i.getOrigin().slice(0,2)}catch{return[0,i.getHeight()]}}function w0(i,e){try{return i.getResolution(e)}catch{return[e.getWidth()/i.getWidth(),e.getHeight()/i.getHeight()]}}function S0(i){const e=i.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let r=se(t);if(!r){const n=Do(e.ProjLinearUnitsGeoKey);n&&(r=new Uo({code:t,units:n}))}return r}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let r=se(t);if(!r){const n=Do(e.GeogAngularUnitsGeoKey);n&&(r=new Uo({code:t,units:n}))}return r}return null}function R0(i){return i.getImageCount().then(function(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=i.getImage(r);return Promise.all(t)})}function v0(i,e){let t;return i.blob?t=s0(i.blob):i.overviews?t=o0(i.url,i.overviews,e):t=n0(i.url,e),t.then(R0)}function Dr(i,e,t,r,n){if(Array.isArray(i)){const s=i.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(r);throw n(o),o}for(let o=0;o<s;++o)Dr(i[o],e[o],t,r,n);return}if(e=e,Math.abs(i-e)>t*i)throw new Error(r)}function P0(i){return i instanceof Int8Array?-128:i instanceof Int16Array?-32768:i instanceof Int32Array?-2147483648:i instanceof Float32Array?12e-39:0}function A0(i){return i instanceof Int8Array?127:i instanceof Uint8Array||i instanceof Uint8ClampedArray?255:i instanceof Int16Array?32767:i instanceof Uint16Array?65535:i instanceof Int32Array?2147483647:i instanceof Uint32Array?4294967295:i instanceof Float32Array?34e37:255}class wo extends ai{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const r=this,n=new Array(t);for(let s=0;s<t;++s)n[s]=v0(this.sourceInfo_[s],this.sourceOptions_);Promise.all(n).then(function(s){r.configure_(s)}).catch(function(s){Zr(s),r.error_=s,r.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const n=t[r],s=S0(n);if(s){this.projection=s;break}}}determineTransformMatrix(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const s=t[r].fileDirectory.ModelTransformation;if(s){const[o,a,c,l,u,h,f,d]=s,g=jr(jr([1/Math.sqrt(o*o+u*u),0,0,-1/Math.sqrt(a*a+h*h),l,d],[o,u,a,h,0,0]),[1,0,0,1,-l,-d]);this.transformMatrix=g,this.addAlpha_=!0;break}}}configure_(e){let t,r,n,s,o;const a=new Array(e.length),c=new Array(e.length),l=new Array(e.length);let u=0;const h=e.length;for(let m=0;m<h;++m){const y=[],_=[];e[m].forEach(A=>{y0(A)?_.push(A):y.push(A)});const E=y.length;if(_.length>0&&_.length!==E)throw new Error(`Expected one mask per image found ${_.length} masks and ${E} images`);let w,S;const T=new Array(E),v=new Array(E),I=new Array(E);c[m]=new Array(E),l[m]=new Array(E);for(let A=0;A<E;++A){const R=y[A],O=R.getGDALNoData();l[m][A]=R.getGDALMetadata(0),c[m][A]=O;const N=this.sourceInfo_[m].bands;a[m]=N?N.length:R.getSamplesPerPixel();const k=E-(A+1);w||(w=b0(R)),S||(S=T0(R));const j=w0(R,y[0]);I[k]=j[0];const G=[R.getTileWidth(),R.getTileHeight()];G[0]!==G[1]&&G[1]<Nn&&(G[0]=Nn,G[1]=Nn),T[k]=G;const ee=j[0]/Math.abs(j[1]);v[k]=[G[0],G[1]/ee]}if(t?gt(t,w,t):t=w,!r)r=S;else{const A=`Origin mismatch for source ${m}, got [${S}] but expected [${r}]`;Dr(r,S,0,A,this.viewRejector)}if(!o)o=I,this.resolutionFactors_[m]=1;else{o.length-u>I.length&&(u=o.length-I.length);const A=o[o.length-1]/I[I.length-1];this.resolutionFactors_[m]=A;const R=I.map(N=>N*=A),O=`Resolution mismatch for source ${m}, got [${R}] but expected [${o}]`;Dr(o.slice(u,o.length),R,.02,O,this.viewRejector)}n?Dr(n.slice(u,n.length),v,.01,`Tile size mismatch for source ${m}`,this.viewRejector):n=v,s?Dr(s.slice(u,s.length),T,0,`Tile size mismatch for source ${m}`,this.viewRejector):s=T,this.sourceImagery_[m]=y.reverse(),this.sourceMasks_[m]=_.reverse()}for(let m=0,y=this.sourceImagery_.length;m<y;++m){const _=this.sourceImagery_[m];for(;_.length<o.length;)_.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=a,this.nodataValues_=c,this.metadata_=l;e:for(let m=0;m<h;++m){if(this.sourceInfo_[m].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[m].length){this.addAlpha_=!0;break}const y=c[m],_=this.sourceInfo_[m].bands;if(_){for(let E=0;E<_.length;++E)if(y[_[E]-1]!==null){this.addAlpha_=!0;break e}continue}for(let E=0;E<y.length;++E)if(y[E]!==null){this.addAlpha_=!0;break e}}let f=this.addAlpha_?1:0;for(let m=0;m<h;++m)f+=a[m];this.bandCount=f;const d=new ln({extent:t,minZoom:u,origin:r,resolutions:o,tileSizes:n});this.tileGrid=d,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const g=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]);let p=t;if(this.transformMatrix){const m=Xr(Fe(),this.transformMatrix.slice()),y=xh(_=>Tt(m,_));p=pr(t,y)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:Th(Ft(p),this.projection),extent:bh(p,this.projection),zoom:g})}loadTile_(e,t,r,n){const s=this.getTileSize(e),o=this.sourceImagery_.length,a=new Array(o*2),c=this.nodataValues_,l=this.sourceInfo_,u=x0();for(let h=0;h<o;++h){const f=l[h],d=this.resolutionFactors_[h],g=[Math.round(t*(s[0]*d)),Math.round(r*(s[1]*d)),Math.round((t+1)*(s[0]*d)),Math.round((r+1)*(s[1]*d))],p=this.sourceImagery_[h][e];let m;f.bands&&(m=f.bands.map(function(S){return S-1}));let y;"nodata"in f&&f.nodata!==null?y=f.nodata:m?y=m.map(function(S){return c[h][S]}):y=c[h];const _={window:g,width:s[0],height:s[1],samples:m,fillValue:y,pool:u,interleave:!1,signal:n.signal};E0(this.convertToRGB_,p)?a[h]=p.readRGB(_):a[h]=p.readRasters(_);const E=o+h,w=this.sourceMasks_[h][e];if(!w){a[E]=Promise.resolve(null);continue}a[E]=w.readRasters({window:g,width:s[0],height:s[1],samples:[0],pool:u,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,s)).catch(function(h){throw Zr(h),h})}composeTile_(e,t){const r=this.metadata_,n=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,c=this.nodataValues_,l=this.normalize_,u=this.addAlpha_,h=e[0]*e[1],f=h*o;let d;l?d=new Uint8Array(f):d=new Float32Array(f);let g=0;for(let p=0;p<h;++p){let m=u;for(let y=0;y<s;++y){const _=n[y];let E=_.min,w=_.max,S,T;if(l){const v=r[y][0];E===void 0&&(v&&Ma in v?E=parseFloat(v[Ma]):E=P0(t[y][0])),w===void 0&&(v&&Fa in v?w=parseFloat(v[Fa]):w=A0(t[y][0])),S=255/(w-E),T=-E*S}for(let v=0;v<a[y];++v){const I=t[y][v][p];let A;if(l?A=Ee(S*I+T,0,255):A=I,!u)d[g]=A;else{let R=_.nodata;if(R===void 0){let N;_.bands?N=_.bands[v]-1:N=v,R=c[y][N]}const O=isNaN(R);(!O&&I!==R||O&&!isNaN(I))&&(m=!1,d[g]=A)}g++}if(!m){const v=s+y,I=t[v];I&&!I[0][p]&&(m=!0)}}u&&(m||(d[g]=255),g++)}return d}}wo.prototype.getView;class me{constructor(e){this.name=e}toString(){return this.name}}me.GeoTIFF=new me("GeoTIFF");me.ImageStatic=new me("ImageStatic");me.PMTilesRaster=new me("PMTilesRaster");me.PMTilesVector=new me("PMTilesVector");me.TileJSON=new me("TileJSON");me.TileWMS=new me("TileWMS");me.WMTS=new me("WMTS");me.XYZ=new me("XYZ");function L0(i){const e=i.load||wr,t=i.imageExtent,r=i.crossOrigin??null;return()=>{const n=new Image;return n.crossOrigin=r,e(n,i.url).then(s=>{const o=Me(t)/s.width,a=st(t)/s.height;return{image:s,extent:t,resolution:o!==a?[o,a]:a,pixelRatio:1}})}}class Kc extends Jt{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,r=e.imageLoadFunction!==void 0?e.imageLoadFunction:ws;super({attributions:e.attributions,interpolate:e.interpolate,projection:se(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new ll(this.imageExtent_,void 0,1,L0({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(n,s)=>(this.image.setImage(n),r(this.image,s),wr(n))})),this.image.addEventListener(Be.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,r,n){return gr(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}function So(i,e,t,r){const n=document.createElement("script"),s="olc_"+he(e);function o(){delete window[s],n.parentNode.removeChild(n)}n.async=!0,n.src=i+(i.includes("?")?"&":"?")+"callback="+s;const a=setTimeout(function(){o(),t&&t()},1e4);window[s]=function(c){clearTimeout(a),o(),e(c)},document.head.appendChild(n)}class I0 extends Error{constructor(e){const t="Unexpected response status: "+e.status;super(t),this.name="ResponseError",this.response=e}}class C0 extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function Jc(i){return new Promise(function(e,t){function r(o){const a=o.target;if(!a.status||a.status>=200&&a.status<300){let c;try{c=JSON.parse(a.responseText)}catch(l){const u="Error parsing response text as JSON: "+l.message;t(new Error(u));return}e(c);return}t(new I0(a))}function n(o){t(new C0(o.target))}const s=new XMLHttpRequest;s.addEventListener("load",r),s.addEventListener("error",n),s.open("GET",i),s.setRequestHeader("Accept","application/json"),s.send()})}function Qc(i,e){return e.includes("://")?e:new URL(e,i).href}class eu extends St{constructor(e){if(super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:se("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.tileJSON_=null,this.tileSize_=e.tileSize,e.url)if(e.jsonp)So(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTileJSON(){return this.tileJSON_}handleTileJSONResponse(e){const t=se("EPSG:4326"),r=this.getProjection();let n;if(e.bounds!==void 0){const l=Ss(t,r);n=pr(e.bounds,l)}const s=Kt(r),o=e.minzoom||0,a=e.maxzoom||22,c=qt({extent:s,maxZoom:a,minZoom:o,tileSize:this.tileSize_});if(this.tileGrid=c,this.tileUrlFunction=gl(e.tiles,c),e.attribution&&!this.getAttributions()){const l=n!==void 0?n:s;this.setAttributions(function(u){return gr(l,u.extent)?[e.attribution]:null})}this.tileJSON_=e,this.setState("ready")}handleTileJSONError(){this.setState("error")}}const F0="https://stac-extensions.github.io/label/v1.*/schema.json",tu=new Di({color:"rgba(0,0,0,0)"});function ru(i,e,t="rgba(255,255,255,0.4)",r=5){let n=tu;t&&(n=new Di({color:t}));const s=new Ni({color:i,width:e});return new Si({image:new wh({fill:n,stroke:s,radius:r}),fill:n,stroke:s})}const M0=ru("#3399CC",3),Oa=ru("#ff9933",2,null);function O0(i,e){const t={url:i.getAbsoluteUrl()};let r=i;i.getBands().length===1&&(r=i.getBand(0));const{minimum:n,maximum:s}=r.getMinMaxValues();typeof n=="number"&&(t.min=n),typeof s=="number"&&(t.max=s);const o=r.getNoDataValues();return o.length>0&&(t.nodata=o[0]),e.length>0&&(t.bands=e),t}async function Na(i,e=void 0){let t=e;if(Sh()){const r=i.getMetadata("proj:code");if(r)try{if(r.startsWith("EPSG:")){const n=parseInt(r.replace("EPSG:",""),10);t=await Rh(n)}}catch{}}return t}function Da(i,e){const t=i.clone();return e.hasOnlyBounds()||t.setFill(tu),t}function N0(i){let e=i.href;if(e.includes("{s}"))if(Array.isArray(i["href:servers"])&&i["href:servers"].length>0){const t=Math.random()*i["href:servers"].length|0;e=e.replace("{s}",i["href:servers"][t])}else return null;return e}var iu=Object.defineProperty,Ua=Object.getOwnPropertySymbols,D0=Object.prototype.hasOwnProperty,U0=Object.prototype.propertyIsEnumerable,Ga=(i,e,t)=>e in i?iu(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Hi=(i,e)=>{for(var t in e||(e={}))D0.call(e,t)&&Ga(i,t,e[t]);if(Ua)for(var t of Ua(e))U0.call(e,t)&&Ga(i,t,e[t]);return i},_n=(i,e)=>iu(i,"name",{value:e,configurable:!0}),G0=(i,e,t)=>new Promise((r,n)=>{var s=c=>{try{a(t.next(c))}catch(l){n(l)}},o=c=>{try{a(t.throw(c))}catch(l){n(l)}},a=c=>c.done?r(c.value):Promise.resolve(c.value).then(s,o);a((t=t.apply(i,e)).next())}),nu=class extends ai{constructor(e){super(Hi(Hi({},e),{state:"loading"})),this.loadImage=_n(r=>new Promise((n,s)=>{const o=new Image;o.addEventListener("load",()=>n(o)),o.addEventListener("error",()=>s(new Error("load failed"))),o.src=r}),"loadImage");const t=new Yr(e.url);t.getHeader().then(r=>{const n=e.projection===void 0?"EPSG:3857":e.projection;this.tileGrid=e.tileGrid||qt({extent:Kt(n),maxResolution:e.maxResolution,minZoom:r.minZoom,maxZoom:r.maxZoom,tileSize:e.tileSize}),this.setLoader((s,o,a)=>G0(this,null,function*(){const c=yield t.getZxy(s,o,a);if(!c)return new Uint8Array;const l=URL.createObjectURL(new Blob([c.data])),u=yield this.loadImage(l);return URL.revokeObjectURL(l),u})),this.setState("ready")})}};_n(nu,"PMTilesRasterSource");var Ba=nu,su=class extends Rs{constructor(e){super(Hi(Hi({},e),{state:"loading",url:"pmtiles://{z}/{x}/{y}",format:e.format||new vh})),this.tileLoadFunction=_n((t,r)=>{const n=t,s=new RegExp(/pmtiles:\/\/(\d+)\/(\d+)\/(\d+)/),o=r.match(s);if(!(o&&o.length>=4))throw Error("Could not parse tile URL");const a=+o[1],c=+o[2],l=+o[3];n.setLoader((u,h,f)=>{this.pmtiles_.getZxy(a,c,l).then(d=>{if(d){const g=n.getFormat();n.setFeatures(g.readFeatures(d.data,{extent:u,featureProjection:f})),n.setState(K.LOADED)}else n.setFeatures([]),n.setState(K.EMPTY)}).catch(d=>{n.setFeatures([]),n.setState(K.ERROR)})})},"tileLoadFunction"),this.pmtiles_=new Yr(e.url),this.pmtiles_.getHeader().then(t=>{const r=e.projection||"EPSG:3857",n=e.extent||Kt(r);this.tileGrid=e.tileGrid||qt({extent:n,maxResolution:e.maxResolution,maxZoom:e.maxZoom!==void 0?e.maxZoom:t.maxZoom,minZoom:t.minZoom,tileSize:e.tileSize||512}),this.setTileLoadFunction(this.tileLoadFunction),this.setState("ready")})}};_n(su,"PMTilesVectorSource");var B0=su;class Ro extends Ph{constructor(e){const t={};if(["opacity","visible","zIndex","minResolution","maxResolution","minZoom","maxZoom","properties"].forEach(r=>t[r]=e[r]),super(t),this.getSourceOptions_=e.getSourceOptions,this.children_=null,this.childrenOptions_=e.childrenOptions||{},this.assets_=null,this.bands_=[],this.crossOrigin_=e.crossOrigin||null,this.displayFootprint_=e.displayFootprint!==!1,this.displayGeoTiffByDefault_=!!e.displayGeoTiffByDefault,this.displayPreview_=!!e.displayPreview,this.displayOverview_=e.displayOverview!==!1,this.displayWebMapLink_=e.displayWebMapLink||!1,this.buildTileUrlTemplate_=e.buildTileUrlTemplate||null,this.useTileLayerAsFallback_=e.useTileLayerAsFallback||!1,this.boundsStyle_=e.boundsStyle||M0,this.collectionStyle_=e.collectionStyle||Oa,this.boundsLayer_=null,this.disableMigration_=e.disableMigration||!1,this.map_=null,this.eventQueue_=[],e.httpRequestFn&&(this.fetch_=e.httpRequestFn),e.data){try{this.configure_(e.data,e.url,e.children,e.assets,e.bands)}catch(r){this.handleError_(r)}return}if(!e.url)throw new Error("Either url or data must be provided");this.fetch_(e.url).then(r=>this.configure_(r,e.url,e.children,e.assets,e.bands)).catch(r=>this.handleError_(r))}async fetch_(e,t="json"){const r=await fetch(e);if(!r.ok)throw new Error(`Unexpected response from ${e}: ${r.status}`);return t==="json"?await r.json():t==="text"?await r.text():null}getBoundsLayer(){return this.boundsLayer_}isEmpty(){var e;if(this.getLayers().getLength()>1)return!1;const r=(e=this.getData())===null||e===void 0?void 0:e.getBoundingBox();return!r||on(r)?!0:!this.boundsLayer_||!this.displayFootprint_}handleError_(e){this.dispatch_(new I_(e))}configure_(e,t=null,r=null,n=null,s=[]){let o;e instanceof di||e instanceof Fr?o=e:(o=gi(e,!this.disableMigration_),t&&t.includes("://")&&o.setAbsoluteUrl(t)),this.set("stac",o),this.bands_=s,this.boundsLayer_=this.addFootprint_();const a=()=>{this.boundsLayer_&&this.boundsLayer_.setStyle(Da(this.boundsStyle_,this))};this.getLayers().on("add",a),this.getLayers().on("remove",a);const c=h=>this.handleError_(h),l=this.setChildren(r).catch(c),u=this.setAssets(n).catch(c);Promise.all([l,u]).then(()=>this.dispatch_("layersready")),this.dispatch_("sourceready")}dispatch_(e){this.eventQueue_.push(e),this.flush_()}flush_(){if(this.map_){for(const e of this.eventQueue_)this.dispatchEvent(e);this.eventQueue_=[]}}setMap_(e){this.map_!==e&&(this.map_=e,this.flush_())}async addChildren_(e,t={}){const r=e.map(n=>{const s={data:n,crossOrigin:this.crossOrigin_,boundsStyle:this.collectionStyle_,displayGeoTiffByDefault:this.displayGeoTiffByDefault_,displayOverview:this.displayOverview_,displayPreview:this.displayPreview_,displayFootprint:this.displayFootprint_,useTileLayerAsFallback:this.useTileLayerAsFallback_,buildTileUrlTemplate:this.buildTileUrlTemplate_},o=new Ro(Object.assign(s,t));return o.on("sourceready",()=>{o.map_&&this.setMap_(o.map_)}),this.addLayer_(o,null),o});return await Promise.all(r)}async addPreviewImage_(e){const t=await Na(e,"EPSG:4326"),r=e.getContext().getBoundingBoxes();if(r.length!==1)return;const n=r[0];let s={url:e.getAbsoluteUrl(),projection:t,imageExtent:Xn(n,"EPSG:4326",t),crossOrigin:this.crossOrigin_};this.getSourceOptions_&&(s=await this.getSourceOptions_(me.ImageStatic,s,e));const o=new pl({source:new Kc(s)});return this.addLayer_(o,e),o}async addLayerForLink(e){const t=N0(e);if(!t)return;const r={attributions:e.getMetadata("attribution")||this.getData().getMetadata("attribution"),crossOrigin:this.crossOrigin_,url:t},n=async(o,a)=>(this.getSourceOptions_&&(a=await this.getSourceOptions_(o,a,e)),a),s=[];switch(e.rel){case"pmtiles":const a=await new Yr(r.url).getHeader();let c;switch(a.tileType){case lr.Mvt:c=new B0(await n(me.PMTilesVector,r));break;case lr.Avif:case lr.Jpeg:case lr.Png:case lr.Webp:c=new Ba(await n(me.PMTilesRaster,r));break;default:return}s.push(c);break;case"tilejson":s.push(new eu(await n(me.TileJSON,r)));break;case"wms":if(!Array.isArray(e["wms:layers"]))break;for(const h in e["wms:layers"]){const f=e["wms:layers"][h]||"";let d="";Array.isArray(e["wms:styles"])&&typeof e["wms:styles"][h]=="string"&&(d=e["wms:styles"][h]);const g=Object.assign({LAYERS:f,STYLES:d},e["wms:dimensions"]);typeof e["wms:transparent"]=="boolean"&&(g.TRANSPARENT=String(e["wms:transparent"])),typeof e.type=="string"&&e.type.startsWith("image/")&&(g.FORMAT=e.type);const p=await n(me.TileWMS,Object.assign({},r,{params:g}));s.push(new Lh(p))}break;case"wmts":const l=await this.getWmtsCapabilities_(t);if(!l)return;const u=Array.isArray(e["wmts:layer"])?e["wmts:layer"]:[e["wmts:layer"]];for(const h of u){let f=Object.assign({},r,{layer:h});typeof e.type=="string"&&e.type.startsWith("image/")&&(f.format=e.type),f=await n(me.WMTS,f),s.push(new Ah(ml(l,f)))}break;case"xyz":s.push(new Gi(await n(me.XYZ,r)));break;default:return}return s.map(o=>{let a;return o instanceof Rs?a=new Ih({source:o,declutter:!0}):o instanceof Ba?a=new Wi({source:o}):a=new Wn({source:o}),this.addLayer_(a,e),a})}async addGeoTiff_(e){if(this.buildTileUrlTemplate_&&!this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);let r={sources:[O0(e,this.bands_)],convertToRGB:"auto"};const n=await Na(e);n&&(r.projection=n),this.getSourceOptions_&&(r=await this.getSourceOptions_(me.GeoTIFF,r,e));const s=new wo(r),o=new Promise((a,c)=>{s.on("error",c),s.on("change",()=>{s.getState()==="error"?c(s.getError()):a()})});try{await o;const a=new Wi({source:s});return this.addLayer_(a,e),a}catch(a){if(this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);this.handleError_(a)}}async addTileLayerForImagery_(e){let t=this.buildTileUrlTemplate_(e);t instanceof Promise&&(t=await t);let r={crossOrigin:this.crossOrigin_,url:t};this.getSourceOptions_&&(r=await this.getSourceOptions_(me.XYZ,r,e));const n=new Wn({source:new Gi(r)});return this.addLayer_(n,e),n}addLayer_(e,t=null,r=0){t&&e.set("stac",t),e.setZIndex(r),this.getLayers().push(e)}addFootprint_(){let e=null;const t=this.getData();if(t.isItemCollection()||t.isCollectionCollection()?e=Jh(t.getBoundingBox()):e=t.toGeoJSON(),e){const r=this.createGeoJsonLayer_(e,Da(this.boundsStyle_,this),this.displayFootprint_);return r.set("bounds",!0),r.on("change",()=>this.setMap_(r.getMapInternal())),this.addLayer_(r,t,1),r}return null}async addGeoJson_(e){try{const t=await this.fetch_(e.getAbsoluteUrl()),r=this.createGeoJsonLayer_(t);return this.addLayer_(r,e),r}catch(t){this.handleError_(t)}}createGeoJsonLayer_(e,t=null,r=!0){const n=new _l,s=new sn({format:n,loader:(o,a,c)=>{e=Qh(e);const l=n.readFeatures(e,{featureProjection:c});s.addFeatures(l)}});return t||(t=Oa),new sl({source:s,style:t,visible:r})}async addLabelExtension_(){const e=this.getData();if(!(e instanceof Ls))return;let t=e.getAssetsWithRoles(["labels","labels-vector"],!0),r;t.length>1&&(r=t.find(s=>s.roles.includes("labels-vector"))),r||(r=e.getAsset("vector_labels")),r||(t=e.getAssets().filter(s=>s.type===ko&&!s.roles),t.length===1&&(r=t[0]));const n=e.getLinksWithRels(["source"]);if(r&&n.length>0){const s=n.map(async a=>{try{const c=await this.fetch_(a.getAbsoluteUrl());return gi(c)}catch(c){return this.handleError_(c),null}}),o=(await Promise.all(s)).filter(a=>a instanceof Fr);await this.addChildren_(o,{displayFootprint:!1})}try{await this.addGeoJson_(r)}catch(s){this.handleError_(s)}}async updateLayers_(){const e=this.getLayers();for(let n=e.getLength()-1;n>=0;n--){const s=e.item(n);s.get("stac")&&!s.get("bounds")&&e.removeAt(n)}const t=this.getData();if(Array.isArray(this.displayWebMapLink_)){const n=this.getWebMapLinks().map(async s=>await this.addLayerForLink(s));await Promise.all(n)}this.children_&&await this.addChildren_(this.children_,this.childrenOptions_);const r=this.getAssets();if(r){const n=r.map(async s=>{if(s){if(s.type===ko)return await this.addGeoJson_(s);if(s.isGeoTIFF())return await this.addGeoTiff_(s);if(s.canBrowserDisplayImage())return await this.addPreviewImage_(s)}});await Promise.all(n)}if(this.hasOnlyBounds()){if(t instanceof Is)await this.addChildren_(t.getAll(),this.childrenOptions_);else if(t instanceof Fr){if(t.isItem()&&t.supportsExtension(F0)&&t.getMetadata("label:type")==="vector"){await this.addLabelExtension_();return}const n=this.getWebMapLinks();if(n.length>0)await this.addLayerForLink(n[0]);else{const s=t.getDefaultGeoTIFF(!0,!this.displayGeoTiffByDefault_);let o;if(s&&this.displayOverview_&&(o=await this.addGeoTiff_(s)),this.displayPreview_&&(!s||!o)){const a=t.getThumbnails(!0,"overview");a.length>0&&await this.addPreviewImage_(a[0])}}}}}hasOnlyBounds(){const e=this.getBoundsLayer();return typeof this.getLayersArray().find(r=>r!==e)>"u"}getWebMapLinks(){const e=this.getData();if(e instanceof di)return[];let t=["xyz","tilejson","pmtiles","wmts","wms"];typeof this.displayWebMapLink_=="string"&&(t=[this.displayWebMapLink_]);let r=e.getLinksWithRels(t);return Array.isArray(this.displayWebMapLink_)?r=this.displayWebMapLink_.map(n=>{if(typeof n=="string"){const s=r.find(o=>o.id===n);return s||null}return n}).filter(n=>!!n):r.sort((n,s)=>{const o=t.indexOf(n.rel),a=t.indexOf(s.rel);return o-a}),r}async setAssets(e){if(Array.isArray(e)){const t=this.getData();this.assets_=e.map(r=>t instanceof Fr&&typeof r=="string"?t.getAsset(r):r instanceof di?r:new di(r))}else this.assets_=null;await this.updateLayers_()}async setChildren(e,t=null){e instanceof Sl?this.children_=e.getAll():$o(e)&&e.type==="FeatureCollection"?this.children_=gi(e,!this.disableMigration_).getAll():Array.isArray(e)?this.children_=e.map(r=>r instanceof Fr?r:gi(r,!this.disableMigration_)):this.children_=null,this.children_&&this.children_.length===0&&(this.children_=null),this.children_&&$o(t)&&(this.childrenOptions_=t),await this.updateLayers_()}getData(){return this.get("stac")}getChildren(){return this.children_}getAssets(){return this.assets_}getExtent(){if(!this.map_)return;const e=this.map_.getView();if(!e)return;let t;const r=this.getData();r&&(t=r.getBoundingBox());const n=this.getChildren();if(n){const s=n.map(o=>o.getBoundingBox());t=As(s)}if(t)return Xn(t,"EPSG:4326",e.getProjection())}getLayerState(){const e=super.getLayerState();return e.extent=void 0,e}getAttributions(){const e=[],t=this.getData();if(t){const r=t.getMetadata("attribution");r&&r.push(r)}return e}getSource(){return null}async getWmtsCapabilities_(e){try{const t=new URL(e);t.searchParams.set("service","wmts"),t.searchParams.set("request","GetCapabilities");const r=await this.fetch_(t.toString(),"text");return new Vs().read(r)}catch{return null}}}Ch(Fh);window.eoxMapAdvancedOlLayers={Graticule:Kp,Heatmap:Im,Image,Layer:bs,VectorImage:Mm,WebGLPoints:km,WebGLTile:Wi,WebGLVector:Jm,STAC:Ro};function z0(i){const e=i[0],t=new Array(e);let r=1<<e-1,n,s;for(n=0;n<e;++n)s=48,i[1]&r&&(s+=1),i[2]&r&&(s+=2),t[n]=String.fromCharCode(s),r>>=1;return t.join("")}const k0='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class $0 extends St{constructor(e){const t=e.hidpi!==void 0?e.hidpi:!1;super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:se("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=e.culture!==void 0?e.culture:"en-us",this.maxZoom_=e.maxZoom!==void 0?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,this.placeholderTiles_=e.placeholderTiles;const r="https://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_;fetch(r).then(n=>n.json()).then(n=>this.handleImageryMetadataResponse(n))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(e.statusCode!=200||e.statusDescription!="OK"||e.authenticationResultCode!="ValidCredentials"||e.resourceSets.length!=1||e.resourceSets[0].resources.length!=1){this.setState("error");return}const t=e.resourceSets[0].resources[0],r=this.maxZoom_==-1?t.zoomMax:this.maxZoom_,n=this.getProjection(),s=Kt(n),o=this.hidpi_?2:1,a=t.imageWidth==t.imageHeight?t.imageWidth/o:[t.imageWidth/o,t.imageHeight/o],c=qt({extent:s,minZoom:t.zoomMin,maxZoom:r,tileSize:a});this.tileGrid=c;const l=this.culture_,u=this.hidpi_,h=this.placeholderTiles_;if(this.tileUrlFunction=vs(t.imageUrlSubdomains.map(function(f){const d=[0,0,0],g=t.imageUrl.replace("{subdomain}",f).replace("{culture}",l);return function(p,m,y){if(!p)return;jn(p[0],p[1],p[2],d);const _=new URL(g.replace("{quadkey}",z0(d))),E=_.searchParams;return u&&(E.set("dpi","d1"),E.set("device","mobile")),h===!0?E.delete("n"):h===!1&&E.set("n","z"),_.toString()}})),t.imageryProviders){const f=Ss(se("EPSG:4326"),this.getProjection());this.setAttributions(d=>{const g=[],p=d.viewState,m=this.getTileGrid(),y=m.getZForResolution(p.resolution,this.zDirection),E=m.getTileCoordForCoordAndZ(p.center,y)[0];return t.imageryProviders.map(function(w){let S=!1;const T=w.coverageAreas;for(let v=0,I=T.length;v<I;++v){const A=T[v];if(E>=A.zoomMin&&E<=A.zoomMax){const R=A.bbox,O=[R[1],R[0],R[3],R[2]],N=pr(O,f);if(gr(N,d.extent)){S=!0;break}}}S&&g.push(w.attribution)}),g.push(k0),g})}this.setState("ready")}}class j0 extends Gi{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,maxZoom:e.maxZoom!==void 0?e.maxZoom:18,minZoom:e.minZoom,projection:e.projection,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection}),this.account_=e.account,this.mapId_=e.map||"",this.config_=e.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(e){Object.assign(this.config_,e),this.initializeMap_()}setConfig(e){this.config_=e||{},this.initializeMap_()}initializeMap_(){const e=JSON.stringify(this.config_);if(this.templateCache_[e]){this.applyTemplate_(this.templateCache_[e]);return}let t="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(t+="/named/"+this.mapId_);const r=new XMLHttpRequest;r.addEventListener("load",this.handleInitResponse_.bind(this,e)),r.addEventListener("error",this.handleInitError_.bind(this)),r.open("POST",t),r.setRequestHeader("Content-type","application/json"),r.send(JSON.stringify(this.config_))}handleInitResponse_(e,t){const r=t.target;if(!r.status||r.status>=200&&r.status<300){let n;try{n=JSON.parse(r.responseText)}catch{this.setState("error");return}this.applyTemplate_(n),this.templateCache_[e]=n,this.setState("ready")}else this.setState("error")}handleInitError_(e){this.setState("error")}applyTemplate_(e){const t="https://"+e.cdn_url.https+"/"+this.account_+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(t)}}const V0="https://tile.googleapis.com/v1/createSession",X0="https://tile.googleapis.com/v1/2dtiles",W0="https://tile.googleapis.com/tile/v1/viewport",H0=22;class Z0 extends St{constructor(e){const t=!!e.highDpi;super({attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.apiKey_=e.key,this.error_=null;const r={mapType:e.mapType||"roadmap",language:e.language||"en-US",region:e.region||"US"};e.imageFormat&&(r.imageFormat=e.imageFormat),e.scale&&(r.scale=e.scale),t&&(r.highDpi=!0),e.layerTypes&&(r.layerTypes=e.layerTypes),e.styles&&(r.styles=e.styles),e.overlay===!0&&(r.overlay=!0),e.apiOptions&&(r.apiOptions=e.apiOptions),this.sessionTokenRequest_=r,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_,this.createSession_()}getError(){return this.error_}fetchSessionToken(e,t){return fetch(e,t)}async createSession_(){const e=V0+"?key="+this.apiKey_,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},r=await this.fetchSessionToken(e,t);if(!r.ok){try{const h=await r.json();this.error_=new Error(h.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}const n=await r.json(),s=this.getTilePixelRatio(1),o=[n.tileWidth/s,n.tileHeight/s];this.tileGrid=qt({extent:Kt(this.getProjection()),maxZoom:H0,tileSize:o});const a=n.session;this.sessionTokenValue_=a;const c=this.apiKey_;this.tileUrlFunction=function(h,f,d){const g=h[0],p=h[1],m=h[2];return`${X0}/${g}/${p}/${m}?session=${a}&key=${c}`};const l=parseInt(n.expiry,10)*1e3,u=Math.max(l-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),u),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")}async fetchAttributions_(e){if(e.viewHints[Ot.ANIMATING]||e.viewHints[Ot.INTERACTING]||e.animate)return this.previousViewportAttribution_;const[t,r]=Go(Mh(e.extent),e.viewState.projection),[n,s]=Go(Oh(e.extent),e.viewState.projection),c=`zoom=${this.getTileGrid().getZForResolution(e.viewState.resolution,this.zDirection)}&north=${s}&south=${r}&east=${n}&west=${t}`;if(this.previousViewportExtent_==c)return this.previousViewportAttribution_;this.previousViewportExtent_=c;const l=this.sessionTokenValue_,u=this.apiKey_,h=`${W0}?session=${l}&key=${u}&${c}`;return this.previousViewportAttribution_=await fetch(h).then(f=>f.json()).then(f=>f.copyright),this.previousViewportAttribution_}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}}let ou=class extends ys{constructor(e,t,r,n,s,o,a){super(t,r,n,s,o,a),this.zoomifyImage_=null,this.tileSize_=e}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;const e=super.getImage();if(this.state==K.LOADED){const t=this.tileSize_;if(e.width==t[0]&&e.height==t[1])return this.zoomifyImage_=e,e;const r=Nt(t[0],t[1]);return r.drawImage(e,0,0),this.zoomifyImage_=r.canvas,r.canvas}return e}};class Y0 extends St{constructor(e){const t=e.size,r=e.tierSizeCalculation!==void 0?e.tierSizeCalculation:"default",n=e.tilePixelRatio||1,s=t[0],o=t[1],a=[],c=e.tileSize||Hn;let l=c*n;switch(r){case"default":for(;s>l||o>l;)a.push([Math.ceil(s/l),Math.ceil(o/l)]),l+=l;break;case"truncated":let T=s,v=o;for(;T>l||v>l;)a.push([Math.ceil(T/l),Math.ceil(v/l)]),T>>=1,v>>=1;break;default:throw new Error("Unknown `tierSizeCalculation` configured")}a.push([1,1]),a.reverse();const u=[n],h=[0];for(let T=1,v=a.length;T<v;T++)u.push(n<<T),h.push(a[T-1][0]*a[T-1][1]+h[T-1]);u.reverse();const f=new ln({tileSize:c,extent:e.extent||[0,-o,s,0],resolutions:u});let d=e.url;d&&!d.includes("{TileGroup}")&&!d.includes("{tileIndex}")&&(d+="{TileGroup}/{z}-{x}-{y}.jpg");const g=yl(d);let p=c*n;function m(T){return function(v,I,A){if(!v)return;const R=v[0],O=v[1],N=v[2],k=O+N*a[R][0],j=(k+h[R])/p|0,G={z:R,x:O,y:N,tileIndex:k,TileGroup:"TileGroup"+j};return T.replace(/\{(\w+?)\}/g,function(ee,B){return G[B]})}}const y=vs(g.map(m)),_=ou.bind(null,nt(c*n));super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,tilePixelRatio:n,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:_,tileGrid:f,tileUrlFunction:y,transition:e.transition}),this.zDirection=e.zDirection;const E=f.getTileCoordForCoordAndResolution(Ft(f.getExtent()),u[u.length-1]),w=y(E,1,null),S=new Image;S.addEventListener("error",()=>{p=c,this.changed()}),S.src=w}}function Mr(i){return i.toLocaleString("en",{maximumFractionDigits:10})}class q0 extends St{constructor(e){const t=e||{};let r=t.url||"";r=r+(r.lastIndexOf("/")===r.length-1||r===""?"":"/");const n=t.version||we.VERSION2,s=t.sizes||[],o=t.size;et(o!=null&&Array.isArray(o)&&o.length==2&&!isNaN(o[0])&&o[0]>0&&!isNaN(o[1])&&o[1]>0,"Missing or invalid `size`");const a=o[0],c=o[1],l=t.tileSize,u=t.tilePixelRatio||1,h=t.format||"jpg",f=t.quality||(t.version==we.VERSION1?"native":"default");let d=t.resolutions||[];const g=t.supports||[],p=t.extent||[0,-c,a,0],m=s!=null&&Array.isArray(s)&&s.length>0,y=l!==void 0&&(typeof l=="number"&&Number.isInteger(l)&&l>0||Array.isArray(l)&&l.length>0),_=g!=null&&Array.isArray(g)&&(g.includes("regionByPx")||g.includes("regionByPct"))&&(g.includes("sizeByWh")||g.includes("sizeByH")||g.includes("sizeByW")||g.includes("sizeByPct"));let E,w,S;if(d.sort(function(A,R){return R-A}),y||_)if(l!=null&&(typeof l=="number"&&Number.isInteger(l)&&l>0?(E=l,w=l):Array.isArray(l)&&l.length>0&&((l.length==1||l[1]==null&&Number.isInteger(l[0]))&&(E=l[0],w=l[0]),l.length==2&&(Number.isInteger(l[0])&&Number.isInteger(l[1])?(E=l[0],w=l[1]):l[0]==null&&Number.isInteger(l[1])&&(E=l[1],w=l[1])))),(E===void 0||w===void 0)&&(E=Hn,w=Hn),d.length==0){S=Math.max(Math.ceil(Math.log(a/E)/Math.LN2),Math.ceil(Math.log(c/w)/Math.LN2));for(let A=S;A>=0;A--)d.push(Math.pow(2,A))}else{const A=Math.max(...d);S=Math.round(Math.log(A)/Math.LN2)}else if(E=a,w=c,d=[],m){s.sort(function(R,O){return R[0]-O[0]}),S=-1;const A=[];for(let R=0;R<s.length;R++){const O=a/s[R][0];if(d.length>0&&d[d.length-1]==O){A.push(R);continue}d.push(O),S++}if(A.length>0)for(let R=0;R<A.length;R++)s.splice(A[R]-R,1)}else d.push(1),s.push([a,c]),S=0;const T=new ln({tileSize:[E,w],extent:p,origin:Vn(p),resolutions:d}),v=function(A,R,O){let N,k;const j=A[0];if(j>S)return;const G=A[1],ee=A[2],B=d[j];if(!(G===void 0||ee===void 0||B===void 0||G<0||Math.ceil(a/B/E)<=G||ee<0||Math.ceil(c/B/w)<=ee)){if(_||y){const oe=G*E*B,W=ee*w*B;let ie=E*B,pe=w*B,Te=E,re=w;if(oe+ie>a&&(ie=a-oe),W+pe>c&&(pe=c-W),oe+E*B>a&&(Te=Math.floor((a-oe+B-1)/B)),W+w*B>c&&(re=Math.floor((c-W+B-1)/B)),oe==0&&ie==a&&W==0&&pe==c)N="full";else if(!_||g.includes("regionByPx"))N=oe+","+W+","+ie+","+pe;else if(g.includes("regionByPct")){const Pe=Mr(oe/a*100),Re=Mr(W/c*100),ve=Mr(ie/a*100),Ne=Mr(pe/c*100);N="pct:"+Pe+","+Re+","+ve+","+Ne}n==we.VERSION3&&(!_||g.includes("sizeByWh"))?k=Te+","+re:!_||g.includes("sizeByW")?k=Te+",":g.includes("sizeByH")?k=","+re:g.includes("sizeByWh")?k=Te+","+re:g.includes("sizeByPct")&&(k="pct:"+Mr(100/B))}else if(N="full",m){const oe=s[j][0],W=s[j][1];n==we.VERSION3?oe==a&&W==c?k="max":k=oe+","+W:oe==a?k="full":k=oe+","}else k=n==we.VERSION3?"max":"full";return r+N+"/"+k+"/0/"+f+"."+h}},I=ou.bind(null,nt(l||256).map(function(A){return A*u}));super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:t.state,tileClass:I,tileGrid:T,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:v,transition:t.transition}),this.zDirection=t.zDirection}}function au(i,e,t,r,n,s){const o=n.getCode().split(/:(?=\d+$)/).pop(),a=t/r,c=[Bo(Me(e)/a,zo),Bo(st(e)/a,zo)];s.SIZE=c[0]+","+c[1],s.BBOX=e.join(","),s.BBOXSR=o,s.IMAGESR=o,s.DPI=Math.round(s.DPI?s.DPI*r:90*r);const l=i.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return Bi(l,s)}function K0(i){const e=i.load?i.load:wr,t=se(i.projection||"EPSG:3857"),r=i.ratio??1.5,n=i.crossOrigin??null;return function(s,o,a){a=i.hidpi?a:1;const c={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};Object.assign(c,i.params),s=El(s,o,a,r);const l=au(i.url,s,o,a,t,c),u=new Image;return u.crossOrigin=n,e(u,l).then(h=>{const f=Me(s)/h.width*a;return{image:h,extent:s,resolution:f,pixelRatio:a}})}}class J0 extends Jt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:ws,this.params_=Object.assign({},e.params),this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=K0({crossOrigin:this.crossOrigin_,params:this.params_,projection:n,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),wr(s))})),super.getImageInternal(e,t,r,n))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}class Q0 extends Jt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions,state:e.state}),this.canvasFunction_=e.canvasFunction,this.canvas_=null,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5}getImageInternal(e,t,r,n){t=this.findNearestResolution(t);let s=this.canvas_;if(s&&this.renderedRevision_==this.getRevision()&&s.getResolution()==t&&s.getPixelRatio()==r&&Ai(s.getExtent(),e))return s;e=e.slice(),cl(e,this.ratio_);const o=Me(e)/t,a=st(e)/t,c=[o*r,a*r],l=this.canvasFunction_.call(this,e,t,r,c,n);return l&&(s=new Ys(e,t,r,l)),this.canvas_=s,this.renderedRevision_=this.getRevision(),s}}function eE(i,e,t,r){const n=Me(i),s=st(i),o=e[0],a=e[1],c=.0254/r;return a*n>o*s?n*t/(o*c):s*t/(a*c)}function tE(i,e,t,r,n,s,o){const a=eE(t,r,s,o),c=Ft(t),l={OPERATION:n?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:o,SETDISPLAYWIDTH:Math.round(r[0]),SETDISPLAYHEIGHT:Math.round(r[1]),SETVIEWSCALE:a,SETVIEWCENTERX:c[0],SETVIEWCENTERY:c[1]};return Object.assign(l,e),Bi(i,l)}function rE(i){const e=i.load||wr,t=i.useOverlay??!1,r=i.metersPerUnit||1,n=i.displayDpi||96,s=i.ratio??1,o=i.crossOrigin??null;return function(a,c,l){const u=new Image;u.crossOrigin=o,a=El(a,c,l,s);const h=Me(a)/c,f=st(a)/c,d=[h*l,f*l],g=tE(i.url,i.params,a,d,t,r,n);return e(u,g).then(p=>({image:p,extent:a,pixelRatio:l}))}}class iE extends Jt{constructor(e){super({interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.displayDpi_=e.displayDpi!==void 0?e.displayDpi:96,this.params_=Object.assign({},e.params),this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:ws,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.metersPerUnit_=e.metersPerUnit!==void 0?e.metersPerUnit:1,this.ratio_=e.ratio!==void 0?e.ratio:1,this.useOverlay_=e.useOverlay!==void 0?e.useOverlay:!1,this.renderedRevision_=0,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=rE({crossOrigin:this.crossOrigin_,params:this.params_,hidpi:this.hidpi_,metersPerUnit:this.metersPerUnit_,url:this.url_,useOverlay:this.useOverlay_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),wr(s))})),super.getImageInternal(e,t,r,n))}getImageLoadFunction(){return this.imageLoadFunction_}updateParams(e){Object.assign(this.params_,e),this.changed()}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}changed(){this.image=null,super.changed()}}const nE=new Error("Image failed to load");function lu(i,e,t,r,n){return new Promise((s,o)=>{const a=new Image;a.crossOrigin=n.crossOrigin??null,a.addEventListener("load",()=>s(a)),a.addEventListener("error",()=>o(nE)),a.src=xl(i,e,t,r,n.maxY)})}function za(i){return function(e,t,r,n){const s=Nh(i,e,t,r);return lu(s,e,t,r,n)}}function sE(i){return function(e,t,r,n){const s=i(e,t,r,n);return lu(s,e,t,r,n)}}function ka(i){let e;if(Array.isArray(i))e=za(i);else if(typeof i=="string"){const t=yl(i);e=za(t)}else if(typeof i=="function")e=sE(i);else throw new Error("The url option must be a single template, an array of templates, or a function for getting a URL");return e}let $a=0;function ja(i){return Array.isArray(i)?i.join(`
`):typeof i=="string"?i:(++$a,"url-function-key-"+$a)}class cu extends ai{constructor(e){e=e||{};let t=e.loader,r;e.url&&(t=ka(e.url),r=ja(e.url));const n=t?e.state:"loading",s=e.wrapX===void 0?!0:e.wrapX;super({loader:t,key:r,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize,gutter:e.gutter,maxResolution:e.maxResolution,projection:e.projection,tileGrid:e.tileGrid,state:n,wrapX:s,transition:e.transition,interpolate:e.interpolate!==!1,crossOrigin:e.crossOrigin,zDirection:e.zDirection})}setUrl(e){const t=ka(e);this.setLoader(t),this.setKey(ja(e)),this.getState()!=="ready"&&this.setState("ready")}}const oE={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},aE={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function uu(i,e){if(!e.length)return i;const t=new URL(i,"file:/");if(t.pathname.split("/").includes("collections"))return Zr('The "collections" query parameter cannot be added to collection endpoints'),i;const r=e.map(o=>encodeURIComponent(o)).join(",");t.searchParams.append("collections",r);const n=i.split("?")[0],s=decodeURIComponent(t.searchParams.toString());return`${n}?${s}`}function lE(i,e,t){let r,n;for(let s=0;s<i.length;++s){const o=i[s];if(o.rel==="item"){if(o.type===e){r=o.href;break}(oE[o.type]||!n&&o.type.startsWith("image/"))&&(n=o.href)}}if(!r)if(n)r=n;else throw new Error('Could not find "item" link');return t&&(r=uu(r,t)),r}function cE(i,e,t,r){let n,s;const o={};for(let a=0;a<i.length;++a){const c=i[a];if(o[c.type]=c.href,c.rel==="item"){if(c.type===e){n=c.href;break}aE[c.type]&&(s=c.href)}}if(!n&&t)for(let a=0;a<t.length;++a){const c=t[a];if(o[c]){n=o[c];break}}if(!n)if(s)n=s;else throw new Error('Could not find "item" link');return r&&(n=uu(n,r)),n}function Va(i,e,t,r){let n=i.projection;if(!n&&(typeof e.crs=="string"?n=se(e.crs):"uri"in e.crs&&(n=se(e.crs.uri)),!n))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);const s=e.orderedAxes,a=!(s?s.slice(0,2).map(T=>T.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):n.getAxisOrientation()).startsWith("en"),c=e.tileMatrices,l={};for(let T=0;T<c.length;++T){const v=c[T];l[v.id]=v}const u={},h=[];if(r)for(let T=0;T<r.length;++T){const v=r[T],I=v.tileMatrix;h.push(I),u[I]=v}else for(let T=0;T<c.length;++T){const v=c[T].id;h.push(v)}const f=h.length,d=new Array(f),g=new Array(f),p=new Array(f),m=new Array(f),y=[-1/0,-1/0,1/0,1/0];for(let T=0;T<f;++T){const v=h[T],I=l[v],A=I.pointOfOrigin;a?d[T]=[A[1],A[0]]:d[T]=A,g[T]=I.cellSize,p[T]=[I.matrixWidth,I.matrixHeight],m[T]=[I.tileWidth,I.tileHeight];const R=u[v];if(R){const O=I.cellSize*I.tileWidth,N=d[T][0]+R.minTileCol*O,k=d[T][0]+(R.maxTileCol+1)*O,j=I.cellSize*I.tileHeight,G=I.cornerOfOrigin==="bottomLeft";let ee,B;G?(ee=d[T][1]+R.minTileRow*j,B=d[T][1]+(R.maxTileRow+1)*j):(ee=d[T][1]-(R.maxTileRow+1)*j,B=d[T][1]-R.minTileRow*j),gt(y,[N,ee,k,B],y)}}const _=new ln({origins:d,resolutions:g,sizes:p,tileSizes:m,extent:r?y:void 0}),E=i.context,w=i.url;function S(T,v,I){if(!T)return;const A=h[T[0]],R=l[A],O=R.cornerOfOrigin==="bottomLeft",N={tileMatrix:A,tileCol:T[1],tileRow:O?-T[2]-1:T[2]};if(r){const j=u[R.id];if(N.tileCol<j.minTileCol||N.tileCol>j.maxTileCol||N.tileRow<j.minTileRow||N.tileRow>j.maxTileRow)return}Object.assign(N,E);const k=t.replace(/\{(\w+?)\}/g,function(j,G){return N[G]});return Qc(w,k)}return{grid:_,projection:n,urlTemplate:t,urlFunction:S}}function uE(i,e){const t=e.tileMatrixSetLimits;let r;if(e.dataType==="map")r=lE(e.links,i.mediaType,i.collections);else if(e.dataType==="vector")r=cE(e.links,i.mediaType,i.supportedMediaTypes,i.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return Va(i,e.tileMatrixSet,r,t);const n=e.links.find(a=>a.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!n)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=n.href,o=Qc(i.url,s);return Jc(o).then(function(a){return Va(i,a,r,t)})}function hu(i){return Jc(i.url).then(function(e){return uE(i,e)})}class hE extends St{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,context:e.context||null,collections:e.collections};hu(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){Zr(e),this.setState("error")}}class fE extends Rs{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,format:e.format,overlaps:e.overlaps,projection:e.projection,tileClass:e.tileClass,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection,state:"loading"});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,supportedMediaTypes:e.format.supportedMediaTypes,context:e.context||null,collections:e.collections};hu(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){Zr(e),this.setState("error")}}function fu(i){return function(e){const t=e.buffers,r=e.meta,n=e.imageOps,s=e.width,o=e.height,a=t.length,c=t[0].byteLength;if(n){const f=new Array(a);for(let g=0;g<a;++g)f[g]=new ImageData(new Uint8ClampedArray(t[g]),s,o);return i(f,r).data.buffer}const l=new Uint8ClampedArray(c),u=new Array(a),h=new Array(a);for(let f=0;f<a;++f)u[f]=new Uint8ClampedArray(t[f]),h[f]=[0,0,0,0];for(let f=0;f<c;f+=4){for(let g=0;g<a;++g){const p=u[g];h[g][0]=p[f],h[g][1]=p[f+1],h[g][2]=p[f+2],h[g][3]=p[f+3]}const d=i(h,r);l[f]=d[0],l[f+1]=d[1],l[f+2]=d[2],l[f+3]=d[3]}return l.buffer}}function dE(i,e){const r=Object.keys(i.lib||{}).map(function(s){return"const "+s+" = "+i.lib[s].toString()+";"}).concat(["const __minion__ = ("+fu.toString()+")(",i.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),n=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(r.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(r,{type:"text/javascript"})));return n.addEventListener("message",e),n}function gE(i,e){const t=fu(i.operation);let r=!1;return{postMessage:function(n){setTimeout(function(){r||e({data:{buffer:t(n),meta:n.meta}})},0)},terminate:function(){r=!0}}}class pE extends ol{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;const r=new Array(t);if(t)for(let n=0;n<t;++n)r[n]=dE(e,this.onWorkerMessage_.bind(this,n));else r[0]=gE(e,this.onWorkerMessage_.bind(this,0));this.workers_=r,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,r){this.enqueue_({inputs:e,meta:t,callback:r}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const e=this.queue_.shift();this.job_=e;const t=e.inputs[0].width,r=e.inputs[0].height,n=e.inputs.map(function(c){return c.data.buffer}),s=this.workers_.length;if(this.running_=s,s===1){this.workers_[0].postMessage({buffers:n,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},n);return}const o=e.inputs[0].data.length,a=4*Math.ceil(o/4/s);for(let c=0;c<s;++c){const l=c*a,u=[];for(let h=0,f=n.length;h<f;++h)u.push(n[h].slice(l,l+a));this.workers_[c].postMessage({buffers:u,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},u)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const e=this.job_,t=this.workers_.length;let r,n;if(t===1)r=new Uint8ClampedArray(this.dataLookup_[0].buffer),n=this.dataLookup_[0].meta;else{const s=e.inputs[0].data.length;r=new Uint8ClampedArray(s),n=new Array(t);const o=4*Math.ceil(s/4/t);for(let a=0;a<t;++a){const c=this.dataLookup_[a].buffer,l=a*o;r.set(new Uint8ClampedArray(c),l),n[a]=this.dataLookup_[a].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(r,e.inputs[0].width,e.inputs[0].height),n),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}}const Xa={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class Wa extends dl{constructor(e,t,r){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=r}}class du extends Jt{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=yE(e.sources);const t=this.changed.bind(this);for(let r=0,n=this.layers_.length;r<n;++r)this.layers_[r].addEventListener(Be.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new Dh(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:Fe(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:_E(this.layers_),pixelRatio:1,pixelToCoordinateTransform:Fe(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:he(this),renderTargets:{}},this.setAttributions(function(r){var s;const n=[];for(let o=0,a=e.sources.length;o<a;++o){const c=e.sources[o],l=c instanceof Ps?c:c.getSource();if(!l)continue;const u=(s=l.getAttributions())==null?void 0:s(r);typeof u=="string"?n.push(u):u!==void 0&&n.push(...u)}return n}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new pE({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,r){const n=Object.assign({},this.frameState_);n.viewState=Object.assign({},n.viewState);const s=Ft(e);n.size[0]=Math.ceil(Me(e)/t),n.size[1]=Math.ceil(st(e)/t),n.extent=[s[0]-n.size[0]*t/2,s[1]-n.size[1]*t/2,s[0]+n.size[0]*t/2,s[1]+n.size[1]*t/2],n.time=Date.now();const o=n.viewState;return o.center=s,o.projection=r,o.resolution=t,n}allSourcesReady_(){let e=!0,t;for(let r=0,n=this.layers_.length;r<n;++r)if(t=this.layers_[r].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,r,n){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);const s=this.updateFrameState_(e,t,n);if(this.requestedFrameState_=s,this.renderedImageCanvas_){const o=this.renderedImageCanvas_.getResolution(),a=this.renderedImageCanvas_.getExtent();(t!==o||!Vr(s.extent,a))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),s.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,r=new Array(t);for(let s=0;s<t;++s){e.layerIndex=s,e.renderTargets={};const o=mE(this.layers_[s],e);if(o)r[s]=o;else return}const n={};this.dispatchEvent(new Wa(Xa.BEFOREOPERATIONS,e,n)),this.processor_.process(r,n,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,r,n){if(t||!r)return;const s=e.extent,o=e.viewState.resolution;if(o!==this.requestedFrameState_.viewState.resolution||!Vr(s,this.requestedFrameState_.extent))return;let a;if(this.renderedImageCanvas_)a=this.renderedImageCanvas_.getImage().getContext("2d");else{const c=Math.round(Me(s)/o),l=Math.round(st(s)/o);a=Nt(c,l),this.renderedImageCanvas_=new Ys(s,o,1,a.canvas)}a.putImageData(r,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new Wa(Xa.AFTEROPERATIONS,e,n))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let r=0,n=this.layers_.length;r<n&&(t=this.layers_[r].getSource().getResolutions(e),!t);++r);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}du.prototype.dispose;let $t=null;function mE(i,e){const t=i.getRenderer();if(!t)throw new Error("Unsupported layer type: "+i);if(!t.prepareFrame(e))return null;const r=e.size[0],n=e.size[1];if(r===0||n===0)return null;const s=t.renderFrame(e,null);let o;if(s instanceof HTMLCanvasElement)o=s;else{if(s&&(o=s.firstElementChild),!(o instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+o);if(o.width===r&&o.height===n)return o.getContext("2d").getImageData(0,0,r,n)}if(!$t)$t=Nt(r,n,void 0,{willReadFrequently:!0});else{const a=$t.canvas;a.width!==r||a.height!==n?$t=Nt(r,n,void 0,{willReadFrequently:!0}):$t.clearRect(0,0,r,n)}return $t.drawImage(o,0,0,r,n),$t.getImageData(0,0,r,n)}function _E(i){return i.map(function(e){return e.getLayerState()})}function yE(i){const e=i.length,t=new Array(e);for(let r=0;r<e;++r)t[r]=EE(i[r]);return t}function EE(i){let e;return i instanceof Ps?i instanceof Ts?e=new Wn({source:i}):i instanceof Jt&&(e=new pl({source:i})):e=i,e}const xE='&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a>',bE='&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',TE='&copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a>',wE={stamen_terrain:{extension:"png"},stamen_terrain_background:{extension:"png"},stamen_terrain_labels:{extension:"png"},stamen_terrain_lines:{extension:"png"},stamen_toner_background:{extension:"png"},stamen_toner:{extension:"png"},stamen_toner_labels:{extension:"png"},stamen_toner_lines:{extension:"png"},stamen_toner_lite:{extension:"png"},stamen_watercolor:{extension:"jpg"},alidade_smooth:{extension:"png"},alidade_smooth_dark:{extension:"png"},alidade_satellite:{extension:"png"},outdoors:{extension:"png"},osm_bright:{extension:"png"}},SE={stamen_terrain:{minZoom:0,maxZoom:18,retina:!0},stamen_toner:{minZoom:0,maxZoom:20,retina:!0},stamen_watercolor:{minZoom:1,maxZoom:18,retina:!1}};class RE extends Gi{constructor(e){const t=e.layer.indexOf("-"),r=t==-1?e.layer:e.layer.slice(0,t),n=SE[r]||{minZoom:0,maxZoom:20,retina:!0},s=wE[e.layer],o=e.apiKey?"?api_key="+e.apiKey:"",a=n.retina&&e.retina?"@2x":"",c=e.url!==void 0?e.url:"https://tiles.stadiamaps.com/tiles/"+e.layer+"/{z}/{x}/{y}"+a+"."+s.extension+o,l=[xE,bE,Uh];e.layer.startsWith("stamen_")&&l.splice(1,0,TE),super({attributions:l,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:n.maxZoom,minZoom:e.minZoom!==void 0?e.minZoom:n.minZoom,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:c,tilePixelRatio:a?2:1,wrapX:e.wrapX,zDirection:e.zDirection})}}class vE extends St{constructor(e){e=e||{},super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.params_=Object.assign({},e.params),this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=Qr(),this.setKey(this.getKeyForParams_())}getKeyForParams_(){let e=0;const t=[];for(const r in this.params_)t[e++]=r+"-"+this.params_[r];return t.join("/")}getParams(){return this.params_}getRequestUrl_(e,t,r,n,s,o){const a=this.urls;if(!a)return;let c;if(a.length==1)c=a[0];else{const l=Gh(Bh(e),a.length);c=a[l]}return au(c,r,(this.tileGrid||this.getTileGridForProjection(s)).getResolution(e[0]),n,s,o)}getTilePixelRatio(e){return this.hidpi_?e:1}updateParams(e){Object.assign(this.params_,e),this.setKey(this.getKeyForParams_())}tileUrlFunction(e,t,r){let n=this.getTileGrid();if(n||(n=this.getTileGridForProjection(r)),n.getResolutions().length<=e[0])return;t!=1&&!this.hidpi_&&(t=1);const s=n.getTileCoordExtent(e,this.tmpExtent_);let o=nt(n.getTileSize(e[0]),this.tmpSize);t!=1&&(o=zh(o,t,this.tmpSize));const a={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};return Object.assign(a,this.params_),this.getRequestUrl_(e,o,s,t,r,a)}}class PE extends cu{constructor(e){e=e||{};const t=e.template||"z:{z} x:{x} y:{y}",r=e.source;super({transition:0,wrapX:e.wrapX!==void 0?e.wrapX:r!==void 0?r.getWrapX():void 0});const n=()=>{var o;this.projection=e.projection!==void 0?se(e.projection):r!==void 0?r.getProjection():this.projection,this.tileGrid=e.tileGrid!==void 0?e.tileGrid:r!==void 0?r.getTileGrid():this.tileGrid,this.zDirection=e.zDirection!==void 0?e.zDirection:r!==void 0?r.zDirection:this.zDirection,r instanceof ai&&(this.transformMatrix=((o=r.transformMatrix)==null?void 0:o.slice())||null);const s=this.tileGrid;s&&this.setTileSizes(s.getResolutions().map((a,c)=>nt(s.getTileSize(c)).map(l=>Math.max(Math.floor(l),1)))),this.setLoader((a,c,l,u)=>{const h=xl(t,a,c,l,u.maxY),[f,d]=this.getTileSize(a),g=Nt(f,d);return g.strokeStyle="grey",g.strokeRect(.5,.5,f+.5,d+.5),g.fillStyle="grey",g.strokeStyle="white",g.textAlign="center",g.textBaseline="middle",g.font="24px sans-serif",g.lineWidth=4,g.strokeText(h,f/2,d/2,f),g.fillText(h,f/2,d/2,f),g.canvas}),this.setState("ready")};if(r===void 0||r.getState()==="ready")n();else{const s=()=>{r.getState()==="ready"&&(r.removeEventListener(Be.CHANGE,s),n())};r.addEventListener(Be.CHANGE,s)}}}class AE extends $h{constructor(e,t,r,n,s,o){super(e,t),this.src_=r,this.extent_=n,this.preemptive_=s,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=o}getImage(){return null}getData(e){if(!this.grid_||!this.keys_)return null;const t=(e[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),r=(e[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),n=this.grid_[Math.floor((1-r)*this.grid_.length)];if(typeof n!="string")return null;let s=n.charCodeAt(Math.floor(t*n.length));s>=93&&s--,s>=35&&s--,s-=32;let o=null;if(s in this.keys_){const a=this.keys_[s];this.data_&&a in this.data_?o=this.data_[a]:o=a}return o}forDataAtCoordinate(e,t,r){this.state==K.EMPTY&&r===!0?(this.state=K.IDLE,jh(this,Be.CHANGE,n=>{t(this.getData(e))}),this.loadInternal_()):r===!0?setTimeout(()=>{t(this.getData(e))},0):t(this.getData(e))}getKey(){return this.src_}handleError_(){this.state=K.ERROR,this.changed()}handleLoad_(e){this.grid_=e.grid,this.keys_=e.keys,this.data_=e.data,this.state=K.LOADED,this.changed()}loadInternal_(){if(this.state==K.IDLE)if(this.state=K.LOADING,this.jsonp_)So(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{const e=new XMLHttpRequest;e.addEventListener("load",this.onXHRLoad_.bind(this)),e.addEventListener("error",this.onXHRError_.bind(this)),e.open("GET",this.src_),e.send()}}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleError_();return}this.handleLoad_(r)}else this.handleError_()}onXHRError_(e){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(K.EMPTY)}}class LE extends Ts{constructor(e){if(super({projection:se("EPSG:3857"),state:"loading",wrapX:e.wrapX!==void 0?e.wrapX:!0,zDirection:e.zDirection}),this.preemptive_=e.preemptive!==void 0?e.preemptive:!0,this.tileUrlFunction_=kh,this.template_=void 0,this.jsonp_=e.jsonp||!1,e.url)if(this.jsonp_)So(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(e,t,r,n){if(this.tileGrid){const s=this.tileGrid.getZForResolution(t,this.zDirection),o=this.tileGrid.getTileCoordForCoordAndZ(e,s);this.getTile(o[0],o[1],o[2],1,this.getProjection()).forDataAtCoordinate(e,r,n)}else n===!0?setTimeout(function(){r(null)},0):r(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(e){const t=se("EPSG:4326"),r=this.getProjection();let n;if(e.bounds!==void 0){const u=Ss(t,r);n=pr(e.bounds,u)}const s=Kt(r),o=e.minzoom||0,a=e.maxzoom||22,c=qt({extent:s,maxZoom:a,minZoom:o});this.tileGrid=c,this.template_=e.template;const l=e.grids;if(!l){this.setState("error");return}if(this.tileUrlFunction_=gl(l,c),e.attribution){const u=n!==void 0?n:s;this.setAttributions(function(h){return gr(u,h.extent)?[e.attribution]:null})}this.setState("ready")}getTile(e,t,r,n,s){const o=[e,t,r],a=this.getTileCoordForTileUrlFunction(o,s),c=this.tileUrlFunction_(a,n,s);return new AE(o,c!==void 0?K.IDLE:K.EMPTY,c!==void 0?c:"",this.tileGrid.getTileCoordExtent(o),this.preemptive_,this.jsonp_)}}class IE extends sn{constructor(e){e=e||{},super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const r=t.getGeometry();return et(!r||r.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),r},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,r){var n;(n=this.source)==null||n.loadFeatures(e,t,r),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(Be.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(Be.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const r=e===0?0:Math.min(t,e)/e,n=e!==this.distance||this.interpolationRatio!==r;this.distance=e,this.minDistance=t,this.interpolationRatio=r,n&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=Qr(),t=this.distance*this.resolution,r=this.source.getFeatures(),n={};for(let s=0,o=r.length;s<o;s++){const a=r[s];if(!(he(a)in n)){const c=this.geometryFunction(a);if(c){const l=c.getCoordinates();Vh(l,e),ms(e,t,e);const u=this.source.getFeaturesInExtent(e).filter(function(h){const f=he(h);return f in n?!1:(n[f]=!0,!0)});this.features.push(this.createCluster(u,e))}}}}createCluster(e,t){const r=[0,0];for(let a=e.length-1;a>=0;--a){const c=this.geometryFunction(e[a]);c?Xh(r,c.getCoordinates()):e.splice(a,1)}Wh(r,1/e.length);const n=Ft(t),s=this.interpolationRatio,o=new Qe([r[0]*(1-s)+n[0]*s,r[1]*(1-s)+n[1]*s]);return this.createCustomCluster_?this.createCustomCluster_(o,e):new je({geometry:o,features:e})}}class Zi extends IE{constructor(e={}){super({...e,createCluster:Zi.defaultCreateCluster,geometryFunction:Zi.defaultGeometryFunction})}static defaultCreateCluster(e,t){const r=t.length===1&&t[0].getGeometry()instanceof Ht?t[0].getGeometry():e,n=new je({geometry:r,features:t});if(t.length===1){const s=t[0];for(const o in s.getProperties())o!=="geometry"&&n.set(o,s.get(o))}return n}static defaultGeometryFunction(e){const t=e&&e.getGeometry();return t instanceof Qe?t:t instanceof Ht?t.getInteriorPoint():null}}class CE extends St{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,tilePixelRatio:e.tilePixelRatio,transition:e.transition,interpolate:e.interpolate!==void 0?e.interpolate:!0,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection,wrapX:e.wrapX}),this.version_=e.version!==void 0?e.version:"1.0.0",this.dimensions_=e.dimensions!==void 0?e.dimensions:{},this.layer_=e.layer,fetch(e.url).then(t=>t.text()).then(t=>new window.DOMParser().parseFromString(t,"application/xml")).then(t=>{this.handleCapabilitiesResponse(t,e)})}handleCapabilitiesResponse(e,t){const n=new Vs().read(e),s=ml(n,t);this.crossOrigin=s.crossOrigin,this.projection=s.projection,this.tileGrid=s.tileGrid,this.requestEncoding_=s.requestEncoding,this.matrixSet_=s.matrixSet,this.style_=s.style,this.format_=s.format,this.dimensions_=s.dimensions,this.setUrls(s.urls),this.urls&&this.urls.length>0&&(this.tileUrlFunction=vs(this.urls.map(this.createFromWMTSTemplate.bind(this)))),this.setState("ready")}createFromWMTSTemplate(e){const t=this.requestEncoding_,r={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};t==="KVP"&&Object.assign(r,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),e=t==="KVP"?Bi(e,r):e.replace(/\{(\w+?)\}/g,(o,a)=>a.toLowerCase()in r?r[a.toLowerCase()]:o);const n=this.tileGrid,s=this.dimensions_;return function(o){if(!o)return;const a={TileMatrix:n.getMatrixId(o[0]),TileCol:o[1],TileRow:o[2]};Object.assign(a,s);let c=e;return t==="KVP"?c=Bi(c,a):c=c.replace(/\{(\w+?)\}/g,(l,u)=>a[u]),c}}}const xt=new Uint8Array([102,103,98,3,102,103,98,0]),He=4,Or=4,Nr=4,li=4,At=new Int32Array(2),Ha=new Float32Array(At.buffer),Za=new Float64Array(At.buffer),Ti=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;var as;(function(i){i[i.UTF8_BYTES=1]="UTF8_BYTES",i[i.UTF16_STRING=2]="UTF16_STRING"})(as||(as={}));class ot{constructor(e){this.bytes_=e,this.position_=0,this.text_decoder_=new TextDecoder}static allocate(e){return new ot(new Uint8Array(e))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(e){this.position_=e}capacity(){return this.bytes_.length}readInt8(e){return this.readUint8(e)<<24>>24}readUint8(e){return this.bytes_[e]}readInt16(e){return this.readUint16(e)<<16>>16}readUint16(e){return this.bytes_[e]|this.bytes_[e+1]<<8}readInt32(e){return this.bytes_[e]|this.bytes_[e+1]<<8|this.bytes_[e+2]<<16|this.bytes_[e+3]<<24}readUint32(e){return this.readInt32(e)>>>0}readInt64(e){return BigInt.asIntN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readUint64(e){return BigInt.asUintN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readFloat32(e){return At[0]=this.readInt32(e),Ha[0]}readFloat64(e){return At[Ti?0:1]=this.readInt32(e),At[Ti?1:0]=this.readInt32(e+4),Za[0]}writeInt8(e,t){this.bytes_[e]=t}writeUint8(e,t){this.bytes_[e]=t}writeInt16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeUint16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeInt32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeUint32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeInt64(e,t){this.writeInt32(e,Number(BigInt.asIntN(32,t))),this.writeInt32(e+4,Number(BigInt.asIntN(32,t>>BigInt(32))))}writeUint64(e,t){this.writeUint32(e,Number(BigInt.asUintN(32,t))),this.writeUint32(e+4,Number(BigInt.asUintN(32,t>>BigInt(32))))}writeFloat32(e,t){Ha[0]=t,this.writeInt32(e,At[0])}writeFloat64(e,t){Za[0]=t,this.writeInt32(e,At[Ti?0:1]),this.writeInt32(e+4,At[Ti?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+Or+Nr)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let e="";for(let t=0;t<Nr;t++)e+=String.fromCharCode(this.readInt8(this.position_+Or+t));return e}__offset(e,t){const r=e-this.readInt32(e);return t<this.readInt16(r)?this.readInt16(r+t):0}__union(e,t){return e.bb_pos=t+this.readInt32(t),e.bb=this,e}__string(e,t){e+=this.readInt32(e);const r=this.readInt32(e);e+=Or;const n=this.bytes_.subarray(e,e+r);return t===as.UTF8_BYTES?n:this.text_decoder_.decode(n)}__union_with_string(e,t){return typeof e=="string"?this.__string(t):this.__union(e,t)}__indirect(e){return e+this.readInt32(e)}__vector(e){return e+this.readInt32(e)+Or}__vector_len(e){return this.readInt32(e+this.readInt32(e))}__has_identifier(e){if(e.length!=Nr)throw new Error("FlatBuffers: file identifier must be length "+Nr);for(let t=0;t<Nr;t++)if(e.charCodeAt(t)!=this.readInt8(this.position()+Or+t))return!1;return!0}createScalarList(e,t){const r=[];for(let n=0;n<t;++n){const s=e(n);s!==null&&r.push(s)}return r}createObjList(e,t){const r=[];for(let n=0;n<t;++n){const s=e(n);s!==null&&r.push(s.unpack())}return r}}var ae,Ce=((ae={})[ae.Byte=0]="Byte",ae[ae.UByte=1]="UByte",ae[ae.Bool=2]="Bool",ae[ae.Short=3]="Short",ae[ae.UShort=4]="UShort",ae[ae.Int=5]="Int",ae[ae.UInt=6]="UInt",ae[ae.Long=7]="Long",ae[ae.ULong=8]="ULong",ae[ae.Float=9]="Float",ae[ae.Double=10]="Double",ae[ae.String=11]="String",ae[ae.Json=12]="Json",ae[ae.DateTime=13]="DateTime",ae[ae.Binary=14]="Binary",ae);class Ae{constructor(){Q(this,"bb",null);Q(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsColumn(e,t){return(t||new Ae).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsColumn(e,t){return e.setPosition(e.position()+li),(t||new Ae).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}type(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readUint8(this.bb_pos+e):Ce.Byte}title(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}width(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.readInt32(this.bb_pos+e):-1}precision(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readInt32(this.bb_pos+e):-1}scale(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readInt32(this.bb_pos+e):-1}nullable(){let e=this.bb.__offset(this.bb_pos,18);return!e||!!this.bb.readInt8(this.bb_pos+e)}unique(){let e=this.bb.__offset(this.bb_pos,20);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}primaryKey(){let e=this.bb.__offset(this.bb_pos,22);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}metadata(e){let t=this.bb.__offset(this.bb_pos,24);return t?this.bb.__string(this.bb_pos+t,e):null}static startColumn(e){e.startObject(11)}static addName(e,t){e.addFieldOffset(0,t,0)}static addType(e,t){e.addFieldInt8(1,t,Ce.Byte)}static addTitle(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWidth(e,t){e.addFieldInt32(4,t,-1)}static addPrecision(e,t){e.addFieldInt32(5,t,-1)}static addScale(e,t){e.addFieldInt32(6,t,-1)}static addNullable(e,t){e.addFieldInt8(7,+t,1)}static addUnique(e,t){e.addFieldInt8(8,+t,0)}static addPrimaryKey(e,t){e.addFieldInt8(9,+t,0)}static addMetadata(e,t){e.addFieldOffset(10,t,0)}static endColumn(e){let t=e.endObject();return e.requiredField(t,4),t}static createColumn(e,t,r,n,s,o,a,c,l,u,h,f){return Ae.startColumn(e),Ae.addName(e,t),Ae.addType(e,r),Ae.addTitle(e,n),Ae.addDescription(e,s),Ae.addWidth(e,o),Ae.addPrecision(e,a),Ae.addScale(e,c),Ae.addNullable(e,l),Ae.addUnique(e,u),Ae.addPrimaryKey(e,h),Ae.addMetadata(e,f),Ae.endColumn(e)}}var J,De=((J={})[J.Unknown=0]="Unknown",J[J.Point=1]="Point",J[J.LineString=2]="LineString",J[J.Polygon=3]="Polygon",J[J.MultiPoint=4]="MultiPoint",J[J.MultiLineString=5]="MultiLineString",J[J.MultiPolygon=6]="MultiPolygon",J[J.GeometryCollection=7]="GeometryCollection",J[J.CircularString=8]="CircularString",J[J.CompoundCurve=9]="CompoundCurve",J[J.CurvePolygon=10]="CurvePolygon",J[J.MultiCurve=11]="MultiCurve",J[J.MultiSurface=12]="MultiSurface",J[J.Curve=13]="Curve",J[J.Surface=14]="Surface",J[J.PolyhedralSurface=15]="PolyhedralSurface",J[J.TIN=16]="TIN",J[J.Triangle=17]="Triangle",J);class Ge{constructor(){Q(this,"bb",null);Q(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsGeometry(e,t){return(t||new Ge).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsGeometry(e,t){return e.setPosition(e.position()+li),(t||new Ge).__init(e.readInt32(e.position())+e.position(),e)}ends(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.readUint32(this.bb.__vector(this.bb_pos+t)+4*e):0}endsLength(){let e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__vector_len(this.bb_pos+e):0}endsArray(){let e=this.bb.__offset(this.bb_pos,4);return e?new Uint32Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}xy(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}xyLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}xyArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}z(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}zLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}zArray(){let e=this.bb.__offset(this.bb_pos,8);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}m(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}mLength(){let e=this.bb.__offset(this.bb_pos,10);return e?this.bb.__vector_len(this.bb_pos+e):0}mArray(){let e=this.bb.__offset(this.bb_pos,10);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}t(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}tLength(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.__vector_len(this.bb_pos+e):0}tArray(){let e=this.bb.__offset(this.bb_pos,12);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}tm(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.readUint64(this.bb.__vector(this.bb_pos+t)+8*e):BigInt(0)}tmLength(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.__vector_len(this.bb_pos+e):0}type(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readUint8(this.bb_pos+e):De.Unknown}parts(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new Ge).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}partsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}static startGeometry(e){e.startObject(8)}static addEnds(e,t){e.addFieldOffset(0,t,0)}static createEndsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addInt32(t[r]);return e.endVector()}static startEndsVector(e,t){e.startVector(4,t,4)}static addXy(e,t){e.addFieldOffset(1,t,0)}static createXyVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startXyVector(e,t){e.startVector(8,t,8)}static addZ(e,t){e.addFieldOffset(2,t,0)}static createZVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startZVector(e,t){e.startVector(8,t,8)}static addM(e,t){e.addFieldOffset(3,t,0)}static createMVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startMVector(e,t){e.startVector(8,t,8)}static addT(e,t){e.addFieldOffset(4,t,0)}static createTVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startTVector(e,t){e.startVector(8,t,8)}static addTm(e,t){e.addFieldOffset(5,t,0)}static createTmVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addInt64(t[r]);return e.endVector()}static startTmVector(e,t){e.startVector(8,t,8)}static addType(e,t){e.addFieldInt8(6,t,De.Unknown)}static addParts(e,t){e.addFieldOffset(7,t,0)}static createPartsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startPartsVector(e,t){e.startVector(4,t,4)}static endGeometry(e){return e.endObject()}static createGeometry(e,t,r,n,s,o,a,c,l){return Ge.startGeometry(e),Ge.addEnds(e,t),Ge.addXy(e,r),Ge.addZ(e,n),Ge.addM(e,s),Ge.addT(e,o),Ge.addTm(e,a),Ge.addType(e,c),Ge.addParts(e,l),Ge.endGeometry(e)}}class Je{constructor(){Q(this,"bb",null);Q(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsFeature(e,t){return(t||new Je).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsFeature(e,t){return e.setPosition(e.position()+li),(t||new Je).__init(e.readInt32(e.position())+e.position(),e)}geometry(e){let t=this.bb.__offset(this.bb_pos,4);return t?(e||new Ge).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}properties(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readUint8(this.bb.__vector(this.bb_pos+t)+e):0}propertiesLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}propertiesArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Uint8Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}columns(e,t){let r=this.bb.__offset(this.bb_pos,8);return r?(t||new Ae).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}static startFeature(e){e.startObject(3)}static addGeometry(e,t){e.addFieldOffset(0,t,0)}static addProperties(e,t){e.addFieldOffset(1,t,0)}static createPropertiesVector(e,t){e.startVector(1,t.length,1);for(let r=t.length-1;r>=0;r--)e.addInt8(t[r]);return e.endVector()}static startPropertiesVector(e,t){e.startVector(1,t,1)}static addColumns(e,t){e.addFieldOffset(2,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static endFeature(e){return e.endObject()}static finishFeatureBuffer(e,t){e.finish(t)}static finishSizePrefixedFeatureBuffer(e,t){e.finish(t,void 0,!0)}static createFeature(e,t,r,n){return Je.startFeature(e),Je.addGeometry(e,t),Je.addProperties(e,r),Je.addColumns(e,n),Je.endFeature(e)}}function Un(i,e){let t=[];for(let r=0;r<i.length;r+=2){let n=[i[r],i[r+1]];e&&n.push(e[r>>1]),t.push(n)}return t}new TextEncoder;let Ya=new TextDecoder;function FE(i,e){let t={};if(!e||e.length===0)return t;let r=i.propertiesArray();if(!r)return t;let n=new DataView(r.buffer,r.byteOffset),s=i.propertiesLength(),o=0;for(;o<s;){let a=n.getUint16(o,!0);o+=2;let c=e[a],l=c.name;switch(c.type){case Ce.Bool:t[l]=!!n.getUint8(o),o+=1;break;case Ce.Byte:t[l]=n.getInt8(o),o+=1;break;case Ce.UByte:t[l]=n.getUint8(o),o+=1;break;case Ce.Short:t[l]=n.getInt16(o,!0),o+=2;break;case Ce.UShort:t[l]=n.getUint16(o,!0),o+=2;break;case Ce.Int:t[l]=n.getInt32(o,!0),o+=4;break;case Ce.UInt:t[l]=n.getUint32(o,!0),o+=4;break;case Ce.Long:t[l]=Number(n.getBigInt64(o,!0)),o+=8;break;case Ce.ULong:t[l]=Number(n.getBigUint64(o,!0)),o+=8;break;case Ce.Float:t[l]=n.getFloat32(o,!0),o+=4;break;case Ce.Double:t[l]=n.getFloat64(o,!0),o+=8;break;case Ce.DateTime:case Ce.String:{let u=n.getUint32(o,!0);o+=4,t[l]=Ya.decode(r.subarray(o,o+u)),o+=u;break}case Ce.Json:{let u=n.getUint32(o,!0);o+=4;let h=Ya.decode(r.subarray(o,o+u));t[l]=JSON.parse(h),o+=u;break}case Ce.Binary:{let u=n.getUint32(o,!0);o+=4,t[l]=r.subarray(o,o+u),o+=u;break}default:throw Error(`Unknown type ${c.type}`)}}return t}const vo=new Uint8Array(0);function ME(){return this._source.cancel()}function OE(i,e){if(!i.length)return e;if(!e.length)return i;var t=new Uint8Array(i.length+e.length);return t.set(i),t.set(e,i.length),t}function NE(){var i=this,e=i._array.subarray(i._index);return i._source.read().then(function(t){return i._array=vo,i._index=0,t.done?e.length>0?{done:!1,value:e}:{done:!0,value:void 0}:{done:!1,value:OE(e,t.value)}})}function DE(i){if((i|=0)<0)throw new Error("invalid length");var e=this,t=this._array.length-this._index;if(this._index+i<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=i));var r=new Uint8Array(i);return r.set(this._array.subarray(this._index)),function n(){return e._source.read().then(function(s){return s.done?(e._array=vo,e._index=0,t>0?r.subarray(0,t):null):t+s.value.length>=i?(e._array=s.value,e._index=i-t,r.set(s.value.subarray(0,i-t),t),r):(r.set(s.value,t),t+=s.value.length,n())})}()}function UE(i){return typeof i.slice=="function"?i:new yn(typeof i.read=="function"?i:i.getReader())}function yn(i){this._source=i,this._array=vo,this._index=0}yn.prototype.read=NE;yn.prototype.slice=DE;yn.prototype.cancel=ME;class Ke{constructor(){Q(this,"bb",null);Q(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsCrs(e,t){return(t||new Ke).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsCrs(e,t){return e.setPosition(e.position()+li),(t||new Ke).__init(e.readInt32(e.position())+e.position(),e)}org(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}code(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readInt32(this.bb_pos+e):0}name(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}wkt(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.__string(this.bb_pos+t,e):null}codeString(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.__string(this.bb_pos+t,e):null}static startCrs(e){e.startObject(6)}static addOrg(e,t){e.addFieldOffset(0,t,0)}static addCode(e,t){e.addFieldInt32(1,t,0)}static addName(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWkt(e,t){e.addFieldOffset(4,t,0)}static addCodeString(e,t){e.addFieldOffset(5,t,0)}static endCrs(e){return e.endObject()}static createCrs(e,t,r,n,s,o,a){return Ke.startCrs(e),Ke.addOrg(e,t),Ke.addCode(e,r),Ke.addName(e,n),Ke.addDescription(e,s),Ke.addWkt(e,o),Ke.addCodeString(e,a),Ke.endCrs(e)}}class Yi{constructor(){Q(this,"bb",null);Q(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsHeader(e,t){return(t||new Yi).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsHeader(e,t){return e.setPosition(e.position()+li),(t||new Yi).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}envelope(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}envelopeLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}envelopeArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}geometryType(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.readUint8(this.bb_pos+e):De.Unknown}hasZ(){let e=this.bb.__offset(this.bb_pos,10);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasM(){let e=this.bb.__offset(this.bb_pos,12);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasT(){let e=this.bb.__offset(this.bb_pos,14);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasTm(){let e=this.bb.__offset(this.bb_pos,16);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}columns(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new Ae).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}featuresCount(){let e=this.bb.__offset(this.bb_pos,20);return e?this.bb.readUint64(this.bb_pos+e):BigInt("0")}indexNodeSize(){let e=this.bb.__offset(this.bb_pos,22);return e?this.bb.readUint16(this.bb_pos+e):16}crs(e){let t=this.bb.__offset(this.bb_pos,24);return t?(e||new Ke).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}title(e){let t=this.bb.__offset(this.bb_pos,26);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,28);return t?this.bb.__string(this.bb_pos+t,e):null}metadata(e){let t=this.bb.__offset(this.bb_pos,30);return t?this.bb.__string(this.bb_pos+t,e):null}static startHeader(e){e.startObject(14)}static addName(e,t){e.addFieldOffset(0,t,0)}static addEnvelope(e,t){e.addFieldOffset(1,t,0)}static createEnvelopeVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startEnvelopeVector(e,t){e.startVector(8,t,8)}static addGeometryType(e,t){e.addFieldInt8(2,t,De.Unknown)}static addHasZ(e,t){e.addFieldInt8(3,+t,0)}static addHasM(e,t){e.addFieldInt8(4,+t,0)}static addHasT(e,t){e.addFieldInt8(5,+t,0)}static addHasTm(e,t){e.addFieldInt8(6,+t,0)}static addColumns(e,t){e.addFieldOffset(7,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static addFeaturesCount(e,t){e.addFieldInt64(8,t,BigInt("0"))}static addIndexNodeSize(e,t){e.addFieldInt16(9,t,16)}static addCrs(e,t){e.addFieldOffset(10,t,0)}static addTitle(e,t){e.addFieldOffset(11,t,0)}static addDescription(e,t){e.addFieldOffset(12,t,0)}static addMetadata(e,t){e.addFieldOffset(13,t,0)}static endHeader(e){return e.endObject()}static finishHeaderBuffer(e,t){e.finish(t)}static finishSizePrefixedHeaderBuffer(e,t){e.finish(t,void 0,!0)}}function En(i){let e=Yi.getRootAsHeader(i),t=e.featuresCount(),r=e.indexNodeSize(),n=[];for(let a=0;a<e.columnsLength();a++){let c=e.columns(a);if(!c)throw Error("Column unexpectedly missing");if(!c.name())throw Error("Column name unexpectedly missing");n.push({name:c.name(),type:c.type(),title:c.title(),description:c.description(),width:c.width(),precision:c.precision(),scale:c.scale(),nullable:c.nullable(),unique:c.unique(),primary_key:c.primaryKey()})}let s=e.crs(),o=s?{org:s.org(),code:s.code(),name:s.name(),description:s.description(),wkt:s.wkt(),code_string:s.codeString()}:null;return{geometryType:e.geometryType(),columns:n,envelope:null,featuresCount:Number(t),indexNodeSize:r,crs:o,title:e.title(),description:e.description(),metadata:e.metadata()}}const en=class en{constructor(){Q(this,"_extraRequestThreshold",262144)}extraRequestThreshold(){return this._extraRequestThreshold}setExtraRequestThreshold(e){if(e<0)throw Error("extraRequestThreshold cannot be negative");this._extraRequestThreshold=e}};Q(en,"global",new en);let qi=en;const GE=40,BE=16;function xn(i,e){e=Math.min(Math.max(+e,2),65535);let t=i,r=t;do r+=t=Math.ceil(t/e);while(t!==1);return 40*r}function zE(i,e){if(e<2)throw Error("Node size must be at least 2");if(i===0)throw Error("Number of items must be greater than 0");let t=i,r=t,n=[t];do r+=t=Math.ceil(t/e),n.push(t);while(t!==1);let s=[];for(let a of(t=r,n))s.push(t-a),t-=a;let o=[];for(let a=0;a<n.length;a++)o.push([s[a],s[a]+n[a]]);return o}async function*gu(i,e,t,r){class n{constructor(d,g){Q(this,"_level");Q(this,"nodes");this._level=g,this.nodes=d}level(){return this._level}startNodeIdx(){return this.nodes[0]}endNodeIdx(){return this.nodes[1]}extendEndNodeIdx(d){this.nodes[1]=d}toString(){return`[NodeRange level: ${this._level}, nodes: ${this.nodes[0]}-${this.nodes[1]}]`}}let{minX:s,minY:o,maxX:a,maxY:c}=t,l=zE(i,e),u=l[0][0],h=[new n([0,1],l.length-1)];for(;h.length!==0;){let f=h.shift(),d=f.startNodeIdx(),g=d>=u,p=(()=>{let[,_]=l[f.level()],E=Math.min(f.endNodeIdx()+e,_);return g&&E<_?E+1:E})(),m=p-d,y=new DataView(await r(40*d,40*m));for(let _=d;_<p;_++){let E=_-d,w=40*E;if(a<y.getFloat64(w+0,!0)||c<y.getFloat64(w+8,!0)||s>y.getFloat64(w+16,!0)||o>y.getFloat64(w+24,!0))continue;let S=y.getBigUint64(w+32,!0);if(g){let A=(()=>{if(_<i-1){let O=(E+1)*40;return y.getBigUint64(O+32,!0)-S}return null})(),R=_-u;yield[Number(S),R,Number(A)];continue}let T=qi.global.extraRequestThreshold()/40,v=h[h.length-1];if(v!==void 0&&v.level()===f.level()-1&&S<v.endNodeIdx()+T){v.extendEndNodeIdx(Number(S));continue}let I=(()=>{let A=f.level()-1;return new n([Number(S),Number(S)+1],A)})();v!==void 0&&(v.level(),I.level()),h.push(I)}}}class Po{constructor(e,t,r,n){Q(this,"bytes");Q(this,"header");Q(this,"headerLength");Q(this,"indexLength");this.bytes=e,this.header=t,this.headerLength=r,this.indexLength=n}static open(e){if(!e.subarray(0,3).every((o,a)=>xt[a]===o))throw Error("Not a FlatGeobuf file");let t=new DataView(e.buffer).getUint32(8,!0);if(t>10485760||t<8)throw Error("Invalid header size");let r=e.subarray(12,12+t),n=En(new ot(r)),s=xn(n.featuresCount,n.indexNodeSize);return new Po(e,n,t,s)}async*selectBbox(e){let t=this.lengthBeforeTree(),r=async(n,s)=>{let o=t+n;return this.bytes.slice(o,o+s).buffer};for await(let n of gu(this.header.featuresCount,this.header.indexNodeSize,e,r)){let[s,o]=n,a=this.readFeature(s);yield{id:o,feature:a}}}lengthBeforeTree(){return xt.length+He+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}readFeature(e){let t=e+this.lengthBeforeFeatures(),r=new DataView(this.bytes.buffer).getUint32(t,!0),n=this.bytes.subarray(t+4,t+4+r),s=new Uint8Array(r+He);s.set(n,He);let o=new ot(s);return o.setPosition(He),Je.getRootAsFeature(o)}}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var ls=function(i,e){return ls=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var n in r)r.hasOwnProperty(n)&&(t[n]=r[n])},ls(i,e)};function kE(i,e){ls(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function Er(i,e,t,r){function n(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{l(r.next(u))}catch(h){o(h)}}function c(u){try{l(r.throw(u))}catch(h){o(h)}}function l(u){u.done?s(u.value):n(u.value).then(a,c)}l((r=r.apply(i,[])).next())})}function Ut(i,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},r,n,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(l){return function(u){return c([l,u])}}function c(l){if(r)throw new TypeError("Generator is already executing.");for(;t;)try{if(r=1,n&&(s=l[0]&2?n.return:l[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,l[1])).done)return s;switch(n=0,s&&(l=[l[0]&2,s.value]),l[0]){case 0:case 1:s=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,n=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!s||l[1]>s[0]&&l[1]<s[3])){t.label=l[1];break}if(l[0]===6&&t.label<s[1]){t.label=s[1],s=l;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(l);break}s[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(i,t)}catch(u){l=[6,u],n=0}finally{r=s=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function Cr(i){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&i[e],r=0;if(t)return t.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&r>=i.length&&(i=void 0),{value:i&&i[r++],done:!i}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Kr(i){return this instanceof Kr?(this.v=i,this):new Kr(i)}function $E(i,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(i,e||[]),n,s=[];return n={},o("next"),o("throw"),o("return"),n[Symbol.asyncIterator]=function(){return this},n;function o(f){r[f]&&(n[f]=function(d){return new Promise(function(g,p){s.push([f,d,g,p])>1||a(f,d)})})}function a(f,d){try{c(r[f](d))}catch(g){h(s[0][3],g)}}function c(f){f.value instanceof Kr?Promise.resolve(f.value.v).then(l,u):h(s[0][2],f)}function l(f){a("next",f)}function u(f){a("throw",f)}function h(f,d){f(d),s.shift(),s.length&&a(s[0][0],s[0][1])}}var pu=function(i){kE(e,i);function e(t){var r=i.call(this,t)||this;return Object.defineProperty(r,"name",{value:"RepeaterOverflowError",enumerable:!1}),typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(r,r.constructor.prototype):r.__proto__=r.constructor.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(r,r.constructor),r}return e}(Error);(function(){function i(e){if(e<0)throw new RangeError("Capacity may not be less than 0");this._c=e,this._q=[]}return Object.defineProperty(i.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"full",{get:function(){return this._q.length>=this._c},enumerable:!1,configurable:!0}),i.prototype.add=function(e){if(this.full)throw new Error("Buffer full");this._q.push(e)},i.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},i})();(function(){function i(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(i.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),i.prototype.add=function(e){for(;this._q.length>=this._c;)this._q.shift();this._q.push(e)},i.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},i})();(function(){function i(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(i.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),i.prototype.add=function(e){this._q.length<this._c&&this._q.push(e)},i.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},i})();function cs(i){i!=null&&typeof i.then=="function"&&i.then(Qi,Qi)}var Gn=0,qa=1,Yt=2,Ki=3,us=4,Ji=1024,Qi=function(){};function dr(i){var e=i.err,t=Promise.resolve(i.execution).then(function(r){if(e!=null)throw e;return r});return i.err=void 0,i.execution=t.then(function(){},function(){}),i.pending===void 0?t:i.pending.then(function(){return t})}function Xt(i,e){var t=i.state>=Ki;return Promise.resolve(e).then(function(r){return!t&&i.state>=us?dr(i).then(function(n){return{value:n,done:!0}}):{value:r,done:t}})}function Ao(i,e){var t,r;if(!(i.state>=Yt))if(i.state=Yt,i.onnext(),i.onstop(),i.err==null&&(i.err=e),i.pushes.length===0&&(typeof i.buffer>"u"||i.buffer.empty))kr(i);else try{for(var n=Cr(i.pushes),s=n.next();!s.done;s=n.next()){var o=s.value;o.resolve()}}catch(a){t={error:a}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}}function kr(i){var e,t;if(!(i.state>=Ki)){i.state<Yt&&Ao(i),i.state=Ki,i.buffer=void 0;try{for(var r=Cr(i.nexts),n=r.next();!n.done;n=r.next()){var s=n.value,o=i.pending===void 0?dr(i):i.pending.then(function(){return dr(i)});s.resolve(Xt(i,o))}}catch(a){e={error:a}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}i.pushes=[],i.nexts=[]}}function Ka(i){i.state>=us||(i.state<Ki&&kr(i),i.state=us)}function jE(i,e){if(cs(e),i.pushes.length>=Ji)throw new pu("No more than "+Ji+" pending calls to push are allowed on a single repeater.");if(i.state>=Yt)return Promise.resolve(void 0);var t=i.pending===void 0?Promise.resolve(e):i.pending.then(function(){return e});t=t.catch(function(c){i.state<Yt&&(i.err=c),Ka(i)});var r;if(i.nexts.length){var n=i.nexts.shift();n.resolve(Xt(i,t)),i.nexts.length?r=Promise.resolve(i.nexts[0].value):typeof i.buffer<"u"&&!i.buffer.full?r=Promise.resolve(void 0):r=new Promise(function(c){return i.onnext=c})}else typeof i.buffer<"u"&&!i.buffer.full?(i.buffer.add(t),r=Promise.resolve(void 0)):r=new Promise(function(c){return i.pushes.push({resolve:c,value:t})});var s=!0,o={},a=r.catch(function(c){if(s)throw c});return o.then=function(c,l){return s=!1,Promise.prototype.then.call(r,c,l)},o.catch=function(c){return s=!1,Promise.prototype.catch.call(r,c)},o.finally=r.finally.bind(r),i.pending=t.then(function(){return a}).catch(function(c){i.err=c,Ka(i)}),o}function VE(i){var e=Ao.bind(null,i),t=new Promise(function(r){return i.onstop=r});return e.then=t.then.bind(t),e.catch=t.catch.bind(t),e.finally=t.finally.bind(t),e}function XE(i){if(!(i.state>=qa)){i.state=qa;var e=jE.bind(null,i),t=VE(i);i.execution=new Promise(function(r){return r(i.executor(e,t))}),i.execution.catch(function(){return Ao(i)})}}var wi=new WeakMap,ci=function(){function i(e,t){wi.set(this,{executor:e,buffer:t,err:void 0,state:Gn,pushes:[],nexts:[],pending:void 0,execution:void 0,onnext:Qi,onstop:Qi})}return i.prototype.next=function(e){cs(e);var t=wi.get(this);if(t===void 0)throw new Error("WeakMap error");if(t.nexts.length>=Ji)throw new pu("No more than "+Ji+" pending calls to next are allowed on a single repeater.");if(t.state<=Gn&&XE(t),t.onnext(e),typeof t.buffer<"u"&&!t.buffer.empty){var r=Xt(t,t.buffer.remove());if(t.pushes.length){var n=t.pushes.shift();t.buffer.add(n.value),t.onnext=n.resolve}return r}else if(t.pushes.length){var s=t.pushes.shift();return t.onnext=s.resolve,Xt(t,s.value)}else if(t.state>=Yt)return kr(t),Xt(t,dr(t));return new Promise(function(o){return t.nexts.push({resolve:o,value:e})})},i.prototype.return=function(e){cs(e);var t=wi.get(this);if(t===void 0)throw new Error("WeakMap error");return kr(t),t.execution=Promise.resolve(t.execution).then(function(){return e}),Xt(t,dr(t))},i.prototype.throw=function(e){var t=wi.get(this);if(t===void 0)throw new Error("WeakMap error");return t.state<=Gn||t.state>=Yt||typeof t.buffer<"u"&&!t.buffer.empty?(kr(t),t.err==null&&(t.err=e),Xt(t,dr(t))):this.next(Promise.reject(e))},i.prototype[Symbol.asyncIterator]=function(){return this},i.race=WE,i.merge=HE,i.zip=ZE,i.latest=YE,i}();function bn(i,e){var t,r,n=[],s=function(l){l!=null&&typeof l[Symbol.asyncIterator]=="function"?n.push(l[Symbol.asyncIterator]()):l!=null&&typeof l[Symbol.iterator]=="function"?n.push(l[Symbol.iterator]()):n.push(function(){return $E(this,arguments,function(){return Ut(this,function(f){switch(f.label){case 0:return e.yieldValues?[4,Kr(l)]:[3,3];case 1:return[4,f.sent()];case 2:f.sent(),f.label=3;case 3:return e.returnValues?[4,Kr(l)]:[3,5];case 4:return[2,f.sent()];case 5:return[2]}})})}())};try{for(var o=Cr(i),a=o.next();!a.done;a=o.next()){var c=a.value;s(c)}}catch(l){t={error:l}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return n}function WE(i){var e=this,t=bn(i,{returnValues:!0});return new ci(function(r,n){return Er(e,void 0,void 0,function(){var s,o,a,c,l,u;return Ut(this,function(h){switch(h.label){case 0:if(!t.length)return n(),[2];o=!1,n.then(function(){s(),o=!0}),h.label=1;case 1:h.trys.push([1,,5,7]),c=void 0,l=0,u=function(){var f,d,g,p,m,y;return Ut(this,function(_){switch(_.label){case 0:f=l;try{for(d=(m=void 0,Cr(t)),g=d.next();!g.done;g=d.next())p=g.value,Promise.resolve(p.next()).then(function(E){E.done?(n(),a===void 0&&(a=E)):l===f&&(l++,s(E))},function(E){return n(E)})}catch(E){m={error:E}}finally{try{g&&!g.done&&(y=d.return)&&y.call(d)}finally{if(m)throw m.error}}return[4,new Promise(function(E){return s=E})];case 1:return c=_.sent(),c===void 0?[3,3]:[4,r(c.value)];case 2:_.sent(),_.label=3;case 3:return[2]}})},h.label=2;case 2:return o?[3,4]:[5,u()];case 3:return h.sent(),[3,2];case 4:return[2,a&&a.value];case 5:return n(),[4,Promise.race(t.map(function(f){return f.return&&f.return()}))];case 6:return h.sent(),[7];case 7:return[2]}})})})}function HE(i){var e=this,t=bn(i,{yieldValues:!0});return new ci(function(r,n){return Er(e,void 0,void 0,function(){var s,o,a,c=this;return Ut(this,function(l){switch(l.label){case 0:if(!t.length)return n(),[2];s=[],o=!1,n.then(function(){var u,h;o=!0;try{for(var f=Cr(s),d=f.next();!d.done;d=f.next()){var g=d.value;g()}}catch(p){u={error:p}}finally{try{d&&!d.done&&(h=f.return)&&h.call(f)}finally{if(u)throw u.error}}}),l.label=1;case 1:return l.trys.push([1,,3,4]),[4,Promise.all(t.map(function(u,h){return Er(c,void 0,void 0,function(){var f,d;return Ut(this,function(g){switch(g.label){case 0:g.trys.push([0,,6,9]),g.label=1;case 1:return o?[3,5]:(Promise.resolve(u.next()).then(function(p){return s[h](p)},function(p){return n(p)}),[4,new Promise(function(p){s[h]=p})]);case 2:return f=g.sent(),f===void 0?[3,4]:f.done?(a=f,[2]):[4,r(f.value)];case 3:g.sent(),g.label=4;case 4:return[3,1];case 5:return[3,9];case 6:return d=u.return,d?[4,u.return()]:[3,8];case 7:d=g.sent(),g.label=8;case 8:return[7];case 9:return[2]}})})}))];case 2:return l.sent(),[2,a&&a.value];case 3:return n(),[7];case 4:return[2]}})})})}function ZE(i){var e=this,t=bn(i,{returnValues:!0});return new ci(function(r,n){return Er(e,void 0,void 0,function(){var s,o,a,c;return Ut(this,function(l){switch(l.label){case 0:if(!t.length)return n(),[2,[]];o=!1,n.then(function(){s(),o=!0}),l.label=1;case 1:l.trys.push([1,,6,8]),l.label=2;case 2:return o?[3,5]:(Promise.all(t.map(function(u){return u.next()})).then(function(u){return s(u)},function(u){return n(u)}),[4,new Promise(function(u){return s=u})]);case 3:return a=l.sent(),a===void 0?[2]:(c=a.map(function(u){return u.value}),a.some(function(u){return u.done})?[2,c]:[4,r(c)]);case 4:return l.sent(),[3,2];case 5:return[3,8];case 6:return n(),[4,Promise.all(t.map(function(u){return u.return&&u.return()}))];case 7:return l.sent(),[7];case 8:return[2]}})})})}function YE(i){var e=this,t=bn(i,{yieldValues:!0,returnValues:!0});return new ci(function(r,n){return Er(e,void 0,void 0,function(){var s,o,a,c,l,u=this;return Ut(this,function(h){switch(h.label){case 0:if(!t.length)return n(),[2,[]];o=[],a=!1,n.then(function(){var f,d;s();try{for(var g=Cr(o),p=g.next();!p.done;p=g.next()){var m=p.value;m()}}catch(y){f={error:y}}finally{try{p&&!p.done&&(d=g.return)&&d.call(g)}finally{if(f)throw f.error}}a=!0}),h.label=1;case 1:return h.trys.push([1,,5,7]),Promise.all(t.map(function(f){return f.next()})).then(function(f){return s(f)},function(f){return n(f)}),[4,new Promise(function(f){return s=f})];case 2:return c=h.sent(),c===void 0?[2]:(l=c.map(function(f){return f.value}),c.every(function(f){return f.done})?[2,l]:[4,r(l.slice())]);case 3:return h.sent(),[4,Promise.all(t.map(function(f,d){return Er(u,void 0,void 0,function(){var g;return Ut(this,function(p){switch(p.label){case 0:if(c[d].done)return[2,c[d].value];p.label=1;case 1:return a?[3,4]:(Promise.resolve(f.next()).then(function(m){return o[d](m)},function(m){return n(m)}),[4,new Promise(function(m){return o[d]=m})]);case 2:return g=p.sent(),g===void 0?[2,c[d].value]:g.done?[2,g.value]:(l[d]=g.value,[4,r(l.slice())]);case 3:return p.sent(),[3,1];case 4:return[2]}})})}))];case 4:return[2,h.sent()];case 5:return n(),[4,Promise.all(t.map(function(f){return f.return&&f.return()}))];case 6:return h.sent(),[7];case 7:return[2]}})})})}class Lo{constructor(e,t,r,n,s,o={}){Q(this,"headerClient");Q(this,"header");Q(this,"headerLength");Q(this,"indexLength");Q(this,"nocache");Q(this,"headers");this.headerClient=e,this.header=t,this.headerLength=r,this.indexLength=n,this.nocache=s,this.headers=o}static async open(e,t,r={}){let n,s=new Ja(e,t,r),o=2024+(()=>{let u,h=0;for(u=0;u<3;u++)h+=BE**u*GE;return h})();if(!new Uint8Array(await s.getRange(0,8,o,"header")).subarray(0,3).every((u,h)=>xt[h]===u))throw Error("Not a FlatGeobuf file");if((n=new DataView(await s.getRange(8,4,o,"header")).getUint32(0,!0))>10485760||n<8)throw Error("Invalid header size");let a=await s.getRange(12,n,o,"header"),c=En(new ot(new Uint8Array(a)));if(c.indexNodeSize===0)throw Error("No index found, cannot read features filtered by bbox");let l=xn(c.featuresCount,c.indexNodeSize);return new Lo(s,c,n,l,t,r)}async*selectBbox(e){let t=this.lengthBeforeTree(),r=this.headerClient,n=async(c,l)=>r.getRange(t+c,l,0,"index"),s=[],o=[];for await(let c of gu(this.header.featuresCount,this.header.indexNodeSize,e,n)){let[l,u]=c,[,,h]=c;if(h||(h=4),o.length===0){o.push([l,h,u]);continue}let f=o[o.length-1];l-(f[0]+f[1])>qi.global.extraRequestThreshold()&&(s.push(o),o=[]),o.push([l,h,u])}this.headerClient.logUsage("header+index"),o.length>0&&s.push(o);let a=s.flatMap(c=>this.readFeatureBatch(c,this.nocache));yield*ci.merge(a)}lengthBeforeTree(){return xt.length+He+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}buildFeatureClient(e){return new Ja(this.headerClient.httpClient,e,this.headers)}async*readFeatureBatch(e,t){let[r]=e[0],[n,s]=e[e.length-1],o=this.buildFeatureClient(t),a=n+s-r;for(let[c,,l]of e){let u=await this.readFeature(o,c,a);yield{id:l,feature:u},a=0}o.logUsage("feature")}async readFeature(e,t,r){let n,s=t+this.lengthBeforeFeatures();n=new DataView(await e.getRange(s,4,r,"feature length")).getUint32(0,!0);let o=new Uint8Array(await e.getRange(s+4,n,r,"feature data")),a=new Uint8Array(n+He);a.set(o,He);let c=new ot(a);return c.setPosition(He),Je.getRootAsFeature(c)}}class Ja{constructor(e,t,r={}){Q(this,"httpClient");Q(this,"bytesEverUsed",0);Q(this,"bytesEverFetched",0);Q(this,"buffer",new ArrayBuffer(0));Q(this,"head",0);if(typeof e=="string")this.httpClient=new Qa(e,t,r);else if(e instanceof Qa)this.httpClient=e;else throw Error("Unknown source")}async getRange(e,t,r,n){this.bytesEverUsed+=t;let s=e-this.head,o=s+t;if(s>=0&&o<=this.buffer.byteLength)return this.buffer.slice(s,o);let a=Math.max(t,r);return this.bytesEverFetched+=a,this.buffer=await this.httpClient.getRange(e,a,n),this.head=e,this.buffer.slice(0,t)}logUsage(e){e.split(" ")[0],(100*this.bytesEverUsed/this.bytesEverFetched).toFixed(2)}}class Qa{constructor(e,t,r={}){Q(this,"url");Q(this,"nocache");Q(this,"headers");Q(this,"requestsEverMade",0);Q(this,"bytesEverRequested",0);this.url=e,this.nocache=t,this.headers=r}async getRange(e,t,r){this.requestsEverMade+=1,this.bytesEverRequested+=t;let n=`bytes=${e}-${e+t-1}`,s=new Headers(this.headers);return s.set("Range",n),this.nocache&&s.set("Cache-Control","no-cache, no-store"),await(await fetch(this.url,{headers:s})).arrayBuffer()}}async function*qE(i,e,t,r){if(!i.subarray(0,3).every((h,f)=>xt[f]===h))throw Error("Not a FlatGeobuf file");if(t){let h=Po.open(i);for await(let f of h.selectBbox(t))yield e(f.id,f.feature,h.header);return}let n=new ot(i),s=n.readUint32(xt.length);n.setPosition(xt.length+He);let o=En(n),a=xt.length+He+s,{indexNodeSize:c,featuresCount:l}=o;c>0&&(a+=xn(l,c));let u=0;for(;a<n.capacity();){let h=n.readUint32(a);n.setPosition(a+He);let f=Je.getRootAsFeature(n);yield e(u++,f,o),a+=He+h}}async function*KE(i,e,t){let r,n=UE(i),s=async d=>await n.slice(d),o=new Uint8Array(await s(8));if(!o.subarray(0,3).every((d,g)=>xt[g]===d))throw Error("Not a FlatGeobuf file");o=new Uint8Array(await s(4));let a=new ot(o),c=a.readUint32(0);o=new Uint8Array(await s(c));let l=En(a=new ot(o)),{indexNodeSize:u,featuresCount:h}=l;if(u>0){let d=xn(h,u);await s(d)}let f=0;for(;r=await QE(s,l,e,f++);)yield r}async function*JE(i,e,t,r,n=!1,s={}){let o=await Lo.open(i,n,s);for await(let a of o.selectBbox(e))yield t(a.id,a.feature,o.header)}async function QE(i,e,t,r){let n=new Uint8Array(await i(4,"feature length"));if(n.byteLength===0)return;let s=new ot(n),o=s.readUint32(0);n=new Uint8Array(await i(o,"feature data"));let a=new Uint8Array(o+4);return a.set(n,4),(s=new ot(a)).setPosition(He),t(r,Je.getRootAsFeature(s),e)}function hs(i,e){let t=e;if(t===De.Unknown&&(t=i.type()),t===De.GeometryCollection){let n=[];for(let s=0;s<i.partsLength();s++){let o=i.parts(s),a=o.type();n.push(hs(o,a))}return{type:De[t],geometries:n}}if(t===De.MultiPolygon){let n=[];for(let s=0;s<i.partsLength();s++)n.push(hs(i.parts(s),De.Polygon));return{type:De[t],coordinates:n.map(s=>s.coordinates)}}let r=function(n,s){let o=n.xyArray(),a=n.zArray();switch(s){case De.Point:{let c=Array.from(o);return a&&c.push(a[0]),c}case De.MultiPoint:case De.LineString:return Un(o,a);case De.MultiLineString:case De.Polygon:return function(c,l,u){let h;if(!u||u.length===0)return[Un(c,l)];let f=0,d=Array.from(u).map(g=>c.slice(f,f=g<<1));return l&&(f=0,h=Array.from(u).map(g=>l.slice(f,f=g))),d.map((g,p)=>Un(g,h?h[p]:void 0))}(o,a,n.endsArray())}}(i,t);return{type:De[t],coordinates:r}}function Io(i,e,t){let r=t.columns;return{type:"Feature",id:i,geometry:hs(e.geometry(),t.geometryType),properties:FE(e,r)}}async function*ex(i,e,t){yield*qE(i,Io,e)}function tx(i,e){return KE(i,Io)}function rx(i,e,t,r=!1,n={}){return JE(i,e,Io,t,r,n)}function ix(i,e,t,r=!1,n={}){return i instanceof Uint8Array?ex(i,e):i instanceof ReadableStream?tx(i):rx(i,e,t,r,n)}const el=new _l({featureProjection:"EPSG:3857"});class nx extends sn{constructor(e){super({url:e.url,attributions:e.attributions,wrapX:e.wrapX,format:el,strategy:Hh}),this.ressourceURL=e.url,super.setLoader(this.loader)}fgbBoundingBox(e,t){const r=Xn(e,t.getCode(),"EPSG:4326");return{minX:r[0],minY:r[1],maxX:r[2],maxY:r[3]}}async loader(e,t,r,n,s){const o=this.fgbBoundingBox(e,r);try{if(o.minX!==-1/0){const a=[],c=ix(this.ressourceURL,o);for await(const l of c){const u=el.readFeature(l);a.push(u)}super.clear(),super.addFeatures(a),n(a)}}catch{s()}}}window.eoxMapAdvancedOlSources={BingMaps:$0,CartoDB:j0,Cluster:Zi,DataTile:ai,GeoTIFF:wo,Google:Z0,IIIF:q0,Image:Jt,ImageArcGISRest:J0,ImageCanvas:Q0,ImageMapGuide:iE,ImageStatic:Kc,ImageTile:cu,OGCMapTile:hE,OGCVectorTile:fE,Raster:du,Source:Ps,StadiaMaps:RE,TileArcGISRest:vE,TileDebug:PE,TileImage:St,TileJSON:eu,UrlTile:Zh,UTFGrid:LE,Zoomify:Y0,WMTSCapabilities:CE,FlatGeoBuf:nx};const wx=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{yx as L,Ex as a,wx as i};
