import{a3 as w,s as G,a as I,k as te,j as ae,d as U,f as V,l as N,a4 as ie,a5 as le,o as ne,n as ue,h as ce,a6 as pe,a7 as D,a0 as H,a8 as R}from"./eo-dash.BUHB21yp.js";import{r as O,al as Z,f as A,p as $,a as ye,o as fe,g as z,N as q,j as W,q as E,m as ve}from"./framework.BOzV7DRY.js";import"./item.koN_VtZd.js";import"./commonjsHelpers.BosuxZz1.js";const K=async(e,a,n)=>{N.debug("Creating layers config",e,a,n);const r=[],t={type:"Group",properties:{id:"AnalysisGroup",title:"Data Layers",layerControlExpand:!0},layers:[]};for(const i of a){let y;n?y=await i.createLayersJson(new Date(n)):y=await i.createLayersJson(),y.forEach(l=>{l.properties.layerControlExpand=!0,l.properties.layerControlToolsExpand=!0}),t.layers.push(...y)}r.push(t);const u=await R.getIndicatorLayers(e),d=R.getObservationPointsLayer(a);d&&t.layers.unshift(d);const c={type:"Group",properties:{id:"BaseLayersGroup",title:"Base Layers"},layers:[]},s=u.filter(i=>i.properties.group==="baselayer");if(s.length){let i=0,y=0;for(let l=0;l<s.length;l++){const v=s[l];"visible"in v.properties||(v.properties.visible=!1),v.properties.visible&&(i++,y=l)}i===0&&(s[0].properties.visible=!0),i>0&&s.forEach((l,v)=>{v!==y?l.properties.visible=!1:l.properties.visible=!0}),c.layers.push(...s),c.layers.forEach(l=>{l.properties.layerControlExclusive=!0})}else c.layers.push({type:"Tile",properties:{id:"osm",title:"Background",layerControlExclusive:!0},source:{type:"OSM"}});c.layers.length&&r.push(c);const g={type:"Group",properties:{id:"OverlayGroup",title:"Overlay Layers"},layers:[]},p=u.filter(i=>i.properties.group==="overlay");return p.length&&(g.layers.push(...p),r.unshift(g)),r};let J=null;const de=(e,a)=>{const n=r=>{var c;const t=r.map,u=(c=e.value)==null?void 0:c.lonLatCenter,d=t==null?void 0:t.getView().getZoom();u&&!Number.isNaN(u[0])&&!Number.isNaN(u[1])&&!Number.isNaN(d)&&(a.value=[u[0],u[1],d])};$(()=>{var r,t;(t=(r=e.value)==null?void 0:r.map)==null||t.on("moveend",n)}),E(()=>{var r,t;(t=(r=e.value)==null?void 0:r.map)==null||t.un("moveend",n)})},Q=(e,a,n,r,t,u,d)=>{N.debug("InitMap",e.value,a.value,n.values,r.value);const c=ve([a,r],async([s,g],[p,i])=>{var y,l,v,m,_,T,h,x,P,f,L,C,B,j,F,S;if(s){N.debug("Selected Indicator watch triggered",s,g),((y=e==null?void 0:e.value)==null?void 0:y.id)==="main"&&J!==null&&((l=e==null?void 0:e.value)==null||l.map.setView(J),J=null);let b=[];const ee=(s==null?void 0:s.id)===(p==null?void 0:p.id)&&g!==i,{selectedCompareStac:oe}=G(I());if(((v=e==null?void 0:e.value)==null?void 0:v.id)==="main"?await pe(s):oe.value!==null&&(J=((m=e==null?void 0:e.value)==null?void 0:m.map.getView())??null,e.value.sync=u.value),ee){b=await K(s,n,g),N.debug("Assigned layers after changing time only",JSON.parse(JSON.stringify(b))),t.value=b,D(((_=e.value)==null?void 0:_.id)==="compare"?"compareTime:updated":"time:updated",e.value,b);return}b=await K(s,n,r.value);let M=null;const k=(h=(T=s==null?void 0:s.extent)==null?void 0:T.temporal)==null?void 0:h.interval;if(k&&k.length>0&&k[0].length>1&&(M=new Date(k[0][1]),N.debug("Indicator load: found stac extent, setting time to latest value",M)),M!==null&&M.toISOString()!==r.value&&!H.value&&(r.value=M.toISOString()),d&&((x=e==null?void 0:e.value)==null?void 0:x.id)==="main"&&(P=s.extent)!=null&&P.spatial.bbox&&!(H.value&&((f=w.value)!=null&&f[0])&&((L=w.value)!=null&&L[1]))){const o=(C=s.extent)==null?void 0:C.spatial.bbox[0],re=[(o==null?void 0:o[0])>-180?o==null?void 0:o[0]:-180,(o==null?void 0:o[1])>-90?o==null?void 0:o[1]:-90,(o==null?void 0:o[2])<180?o==null?void 0:o[2]:180,(o==null?void 0:o[3])<90?o==null?void 0:o[3]:90],se=(F=e.value)==null?void 0:F.transformExtent(re,"EPSG:4326",(j=(B=e.value)==null?void 0:B.map)==null?void 0:j.getView().getProjection());e.value.zoomExtent=se}N.debug("Assigned layers",JSON.parse(JSON.stringify(b))),t.value=b,await D(((S=e.value)==null?void 0:S.id)==="compare"?"compareLayers:updated":"layers:updated",e.value,t.value)}},{immediate:!0});E(()=>{c()})},X=(e,a)=>{ie(async(n,r)=>{if(n.includes("compare"))return;const t=[];for(const u of e)t.push(...await u.getToolTipProperties());a.value=t,N.debug("Updated tooltip properties",a.value)})};function ge(e){return 3*e*e-2*e*e*e}const he=[".enabled"],xe=[".center",".zoom",".layers"],Ce=[".propertyTransform"],be=[".layers"],we=[".propertyTransform"];var Y;const Te={__name:"index",props:{enableCompare:{type:Boolean,default:!1},center:{type:Array,default:()=>{var e,a;return[((e=w.value)==null?void 0:e[0])??15,((a=w.value)==null?void 0:a[1])??48]}},zoom:{type:Number,default:((Y=w.value)==null?void 0:Y[2])??4},zoomToExtent:{type:Boolean,default:!0}},setup(e){var T;const a=e,n=O([]),r=O([]),t={Attribution:{collapsible:!0}},u=Z(a.center),d=Z(((T=w.value)==null?void 0:T[2])??a.zoom),c=O([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),s=O([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),g={duration:1200,easing:ge},p=O(null),i=O(null),{selectedCompareStac:y}=G(I()),l=A(()=>a.enableCompare&&y.value?"":"first");de(p,w),$(()=>{const{selectedCompareStac:h,selectedStac:x}=G(I());te.value=p.value,a.enableCompare&&(ae.value=i.value),a.enableCompare&&(Q(i,h,ce,U,s,p,!1),X(V,r)),Q(p,x,V,U,c,i,a.zoomToExtent)}),X(V,n);const v=A(()=>({visibility:n.value.length?"visible":"hidden"})),m=A(()=>({visibility:r.value.length?"visible":"hidden"})),_=h=>{const x=h==="main"?n:r,P=h=="main"?ne:ue;return f=>{const L=JSON.parse(le.render(JSON.stringify(x.value),{...P.value??{}})),C=L==null?void 0:L.find(B=>B.id===f.key);if(C)return typeof f.value=="object"&&(f.value=JSON.stringify(f.value)),isNaN(Number(f.value))||(f.value=Number(f.value).toFixed(4).toString()),{key:C.title||C.id,value:f.value+" "+(C.appendix||"")}}};return(h,x)=>(fe(),ye("eox-map-compare",{class:"fill-height fill-width overflow-none",".enabled":l.value},[z("eox-map",{class:"fill-height fill-width overflow-none",slot:"first",ref_key:"eoxMap",ref:p,id:"main",".animationOptions":g,".center":W(u),".zoom":W(d),".layers":c.value,".controls":t},[z("eox-map-tooltip",{style:q(v.value),".propertyTransform":_("main")},null,44,Ce)],40,xe),z("eox-map",{class:"fill-height fill-width overflow-none",id:"compare",slot:"second",ref_key:"compareMap",ref:i,".layers":s.value},[z("eox-map-tooltip",{style:q(m.value),".propertyTransform":_("compare")},null,44,we)],40,be)],40,he))}};export{Te as default};
