import"./main.ChxorWrH.js";import"./index.DnBw_NRj.js";import{a4 as m,s as G,a as I,n as se,k as ae,d as U,i as V,l as w,a5 as ie,a6 as le,p as ne,o as ue,j as pe,a7 as ce,a8 as D,a1 as H,a9 as R}from"./eo-dash.DJZ__uOH.js";import{i as ye}from"./easing-CH0-9wR8.CTB3jml5.js";import{r as L,au as Z,f as A,p as $,a as fe,o as ve,g as z,N as q,j as W,q as E,m as de}from"./framework.CY4kwWiL.js";import"./lit-element.Deg-YTNa.js";import"./WMTS.BM-gKQKI.js";import"./Group.DfJ6KxFj.js";import"./extent.CajDHjk1.js";import"./GeoJSON.Br7Jz3X5.js";import"./getElement.CdRlZPdn.js";import"./addCommonStyleSheet.BpSJpEYw.js";import"./WKT.CRW3-4HE.js";import"./commonjsHelpers.BosuxZz1.js";import"./item.CC2Khh23.js";const K=async(e,a,n)=>{w.debug("Creating layers config",e,a,n);const r=[],s={type:"Group",properties:{id:"AnalysisGroup",title:"Data Layers",layerControlExpand:!0},layers:[]};for(const i of a){let y;n?y=await i.createLayersJson(new Date(n)):y=await i.createLayersJson(),y.forEach(l=>{l.properties.layerControlExpand=!0,l.properties.layerControlToolsExpand=!0}),s.layers.push(...y)}r.push(s);const u=await R.getIndicatorLayers(e),d=R.getObservationPointsLayer(a);d&&s.layers.unshift(d);const p={type:"Group",properties:{id:"BaseLayersGroup",title:"Base Layers"},layers:[]},t=u.filter(i=>i.properties.group==="baselayer");if(t.length){let i=0,y=0;for(let l=0;l<t.length;l++){const v=t[l];"visible"in v.properties||(v.properties.visible=!1),v.properties.visible&&(i++,y=l)}i===0&&(t[0].properties.visible=!0),i>0&&t.forEach((l,v)=>{v!==y?l.properties.visible=!1:l.properties.visible=!0}),p.layers.push(...t),p.layers.forEach(l=>{l.properties.layerControlExclusive=!0})}else p.layers.push({type:"Tile",properties:{id:"osm",title:"Background",layerControlExclusive:!0},source:{type:"OSM"}});p.layers.length&&r.push(p);const g={type:"Group",properties:{id:"OverlayGroup",title:"Overlay Layers"},layers:[]},c=u.filter(i=>i.properties.group==="overlay");return c.length&&(g.layers.push(...c),r.unshift(g)),r};let J=null;const ge=(e,a)=>{const n=r=>{var p;const s=r.map,u=(p=e.value)==null?void 0:p.lonLatCenter,d=s==null?void 0:s.getView().getZoom();u&&!Number.isNaN(u[0])&&!Number.isNaN(u[1])&&!Number.isNaN(d)&&(a.value=[u[0],u[1],d])};$(()=>{var r,s;(s=(r=e.value)==null?void 0:r.map)==null||s.on("moveend",n)}),E(()=>{var r,s;(s=(r=e.value)==null?void 0:r.map)==null||s.un("moveend",n)})},Q=(e,a,n,r,s,u,d)=>{w.debug("InitMap",e.value,a.value,n.values,r.value);const p=de([a,r],async([t,g],[c,i])=>{var y,l,v,M,O,_,h,x,P,f,N,C,B,j,F,S;if(t){w.debug("Selected Indicator watch triggered",t,g),((y=e==null?void 0:e.value)==null?void 0:y.id)==="main"&&J!==null&&((l=e==null?void 0:e.value)==null||l.map.setView(J),J=null);let b=[];const ee=(t==null?void 0:t.id)===(c==null?void 0:c.id)&&g!==i,{selectedCompareStac:oe}=G(I());if(((v=e==null?void 0:e.value)==null?void 0:v.id)==="main"?await ce(t):oe.value!==null&&(J=((M=e==null?void 0:e.value)==null?void 0:M.map.getView())??null,e.value.sync=u.value),ee){b=await K(t,n,g),w.debug("Assigned layers after changing time only",JSON.parse(JSON.stringify(b))),s.value=b,D(((O=e.value)==null?void 0:O.id)==="compare"?"compareTime:updated":"time:updated",e.value,b);return}b=await K(t,n,r.value);let T=null;const k=(h=(_=t==null?void 0:t.extent)==null?void 0:_.temporal)==null?void 0:h.interval;if(k&&k.length>0&&k[0].length>1&&(T=new Date(k[0][1]),w.debug("Indicator load: found stac extent, setting time to latest value",T)),T!==null&&T.toISOString()!==r.value&&!H.value&&(r.value=T.toISOString()),d&&((x=e==null?void 0:e.value)==null?void 0:x.id)==="main"&&(P=t.extent)!=null&&P.spatial.bbox&&!(H.value&&((f=m.value)!=null&&f[0])&&((N=m.value)!=null&&N[1]))){const o=(C=t.extent)==null?void 0:C.spatial.bbox[0],re=[(o==null?void 0:o[0])>-180?o==null?void 0:o[0]:-180,(o==null?void 0:o[1])>-90?o==null?void 0:o[1]:-90,(o==null?void 0:o[2])<180?o==null?void 0:o[2]:180,(o==null?void 0:o[3])<90?o==null?void 0:o[3]:90],te=(F=e.value)==null?void 0:F.transformExtent(re,"EPSG:4326",(j=(B=e.value)==null?void 0:B.map)==null?void 0:j.getView().getProjection());e.value.zoomExtent=te}w.debug("Assigned layers",JSON.parse(JSON.stringify(b))),s.value=b,await D(((S=e.value)==null?void 0:S.id)==="compare"?"compareLayers:updated":"layers:updated",e.value,s.value)}},{immediate:!0});E(()=>{p()})},X=(e,a)=>{ie(async(n,r)=>{if(n.includes("compare"))return;const s=[];for(const u of e)s.push(...await u.getToolTipProperties());a.value=s,w.debug("Updated tooltip properties",a.value)})},he=[".enabled"],xe=[".center",".zoom",".layers"],Ce=[".propertyTransform"],be=[".layers"],me=[".propertyTransform"];var Y;const Ie={__name:"index",props:{enableCompare:{type:Boolean,default:!1},center:{type:Array,default:()=>{var e,a;return[((e=m.value)==null?void 0:e[0])??15,((a=m.value)==null?void 0:a[1])??48]}},zoom:{type:Number,default:((Y=m.value)==null?void 0:Y[2])??4},zoomToExtent:{type:Boolean,default:!0}},setup(e){var _;const a=e,n=L([]),r=L([]),s={Attribution:{collapsible:!0}},u=Z(a.center),d=Z(((_=m.value)==null?void 0:_[2])??a.zoom),p=L([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),t=L([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),g={duration:1200,easing:ye},c=L(null),i=L(null),{selectedCompareStac:y}=G(I()),l=A(()=>a.enableCompare&&y.value?"":"first");ge(c,m),$(()=>{const{selectedCompareStac:h,selectedStac:x}=G(I());se.value=c.value,a.enableCompare&&(ae.value=i.value),a.enableCompare&&(Q(i,h,pe,U,t,c,!1),X(V,r)),Q(c,x,V,U,p,i,a.zoomToExtent)}),X(V,n);const v=A(()=>({visibility:n.value.length?"visible":"hidden"})),M=A(()=>({visibility:r.value.length?"visible":"hidden"})),O=h=>{const x=h==="main"?n:r,P=h=="main"?ne:ue;return f=>{const N=JSON.parse(le.render(JSON.stringify(x.value),{...P.value??{}})),C=N==null?void 0:N.find(B=>B.id===f.key);if(C)return typeof f.value=="object"&&(f.value=JSON.stringify(f.value)),isNaN(Number(f.value))||(f.value=Number(f.value).toFixed(4).toString()),{key:C.title||C.id,value:f.value+" "+(C.appendix||"")}}};return(h,x)=>(ve(),fe("eox-map-compare",{class:"fill-height fill-width overflow-none",".enabled":l.value},[z("eox-map",{class:"fill-height fill-width overflow-none",slot:"first",ref_key:"eoxMap",ref:c,id:"main",".animationOptions":g,".center":W(u),".zoom":W(d),".layers":p.value,".controls":s},[z("eox-map-tooltip",{style:q(v.value),".propertyTransform":O("main")},null,44,Ce)],40,xe),z("eox-map",{class:"fill-height fill-width overflow-none",id:"compare",slot:"second",ref_key:"compareMap",ref:i,".layers":t.value},[z("eox-map-tooltip",{style:q(M.value),".propertyTransform":O("compare")},null,44,me)],40,be)],40,he))}};export{Ie as default};
